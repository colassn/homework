<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›»å­æ‰‹å†Š (å®Œæ•´ç‰ˆ)</title>
    
    <!-- Core Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.5); --glass-bg: rgba(255, 255, 255, 0.75); --primary: #4f46e5; }
        body { font-family: "Nunito", "M PLUS Rounded 1c", sans-serif; background-color: #f0f2f5; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .aurora-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); background: radial-gradient(at 0% 0%, hsla(252,100%,94%,1) 0, transparent 50%), radial-gradient(at 50% 100%, hsla(222,100%,94%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(322,100%,94%,1) 0, transparent 50%), radial-gradient(at 0% 100%, hsla(262,100%,94%,1) 0, transparent 50%), radial-gradient(at 80% 50%, hsla(202,100%,94%,1) 0, transparent 50%), radial-gradient(at 0% 50%, hsla(302,100%,94%,1) 0, transparent 50%); z-index: -1; filter: blur(60px); animation: aurora 30s ease infinite alternate; }
        @keyframes aurora { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--glass-border); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
        .glass-card:hover { transform: translateY(-4px) scale(1.02); background: rgba(255, 255, 255, 0.9); border-color: #fff; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .glass-card:active { transform: scale(0.96); }

        .modern-input { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(209, 213, 219, 0.6); transition: all 0.3s ease; }
        .modern-input:focus { background: #fff; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); border-color: var(--primary); }
        
        .page-enter { animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .item-enter { animation: popIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .modal-enter { animation: modalZoom 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes modalZoom { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .island-enter { animation: islandDrop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes islandDrop { 0% { transform: translate(-50%, -150%); } 60% { transform: translate(-50%, 15px); } 100% { transform: translate(-50%, 0); } }

        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        .station-active { animation: pulse-ring 2s infinite; }

        .scrollbar-hide::-webkit-scrollbar { display: none; } 
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        input[type="file"]::file-selector-button { display: none; }
    </style>
</head>
<body class="text-slate-800 antialiased">
    <div class="aurora-bg"></div>
    <div id="root"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyB3gYuwnyoTUwO7PFh4Nuue-Ud8GTruuRk", authDomain: "recordhwv2.firebaseapp.com", projectId: "recordhwv2", storageBucket: "recordhwv2.firebasestorage.app", messagingSenderId: "599261009391", appId: "1:599261009391:web:66cd7f932650bebc0e521a", measurementId: "G-C51XDYW67W" };
        const app = initializeApp(firebaseConfig);
        window.firebaseServices = { auth: getAuth(app), db: getFirestore(app), googleProvider: new GoogleAuthProvider(), signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc };
    </script>

    <!-- React App -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const ADMIN_EMAIL = 'chimhinhin@gmail.com';
        
        // --- 1. CONSTANTS ---
        const DEFAULT_SUBJECTS = [
            { name: 'ä¸­æ–‡', color: 'bg-rose-50 text-rose-600 border-rose-200 ring-rose-100' },
            { name: 'è‹±æ–‡', color: 'bg-indigo-50 text-indigo-600 border-indigo-200 ring-indigo-100' },
            { name: 'æ•¸å­¸', color: 'bg-emerald-50 text-emerald-600 border-emerald-200 ring-emerald-100' },
            { name: 'å…¬ç¤¾', color: 'bg-orange-50 text-orange-600 border-orange-200 ring-orange-100' },
            { name: 'ä½›å­¸', color: 'bg-amber-50 text-amber-600 border-amber-100 ring-amber-100' },
            { name: 'ç”Ÿç‰©', color: 'bg-teal-50 text-teal-600 border-teal-100 ring-teal-100' },
            { name: 'ç‰©ç†', color: 'bg-sky-50 text-sky-600 border-sky-100 ring-sky-100' },
            { name: 'åŒ–å­¸', color: 'bg-purple-50 text-purple-600 border-purple-100 ring-purple-100' },
            { name: 'åœ°ç†', color: 'bg-cyan-50 text-cyan-600 border-cyan-100 ring-cyan-100' },
            { name: 'æ­·å²', color: 'bg-stone-50 text-stone-600 border-stone-200 ring-stone-100' },
            { name: 'ä¸­å²', color: 'bg-yellow-50 text-yellow-700 border-yellow-100 ring-yellow-100' },
            { name: 'é«”è‚²', color: 'bg-lime-50 text-lime-600 border-lime-100 ring-lime-100' },
            { name: 'é›»è…¦', color: 'bg-blue-50 text-blue-600 border-blue-100 ring-blue-100' },
            { name: 'STEAM', color: 'bg-violet-50 text-violet-600 border-violet-100 ring-violet-100' },
            { name: 'æ™®é€šè©±', color: 'bg-pink-50 text-pink-600 border-pink-100 ring-pink-100' },
            { name: 'è¦–è—', color: 'bg-fuchsia-50 text-fuchsia-600 border-fuchsia-100 ring-fuchsia-100' },
            { name: 'å…¨æ–¹ä½', color: 'bg-red-50 text-red-600 border-red-100 ring-red-100' },
            { name: 'éŸ³æ¨‚', color: 'bg-cyan-50 text-cyan-600 border-cyan-100 ring-cyan-100' },
            { name: 'å…¶ä»–', color: 'bg-slate-50 text-slate-600 border-slate-200 ring-slate-100' }
        ];

        const SUBJECTS = DEFAULT_SUBJECTS;

        const DEFAULT_SCHEDULE = { 
            1: ["æ™®é€šé›»è…¦", "æ™®é€šé›»è…¦", "è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "æ™®é€šè©±", "ä½›å­¸", "æ­·å²", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ"], 
            2: ["è‹±æ–‡", "è‹±æ–‡", "éŸ³æ¨‚", "åœ°ç†", "ç‰©ç†", "ç‰©ç†", "ä¸­æ–‡", "ä¸­æ–‡", "æ•¸å­¸", "æ•¸å­¸"], 
            3: ["åŒ–å­¸", "åŒ–å­¸", "è‹±æ–‡", "è‹±æ–‡", "æ•¸å­¸", "ä¸­æ–‡", "è¦–è—", "è¦–è—", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ", "ä¸­å²"], 
            4: ["STEAM", "STEAM", "æ•¸å­¸", "æ­·å²", "è‹±æ–‡", "è‹±æ–‡", "ç”Ÿç‰©", "ç”Ÿç‰©", "ä¸­å²", "åœ°ç†"], 
            5: ["è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "é«”è‚²", "é«”è‚²", "æ•¸å­¸", "æ•¸å­¸", "å…¨æ–¹ä½", "å…¨æ–¹ä½"] 
        };

        const LESSON_SLOTS = [35,35,15,35,35,10,35,35,70,35,35,10,35,35];
        const SLOT_TYPES = ['L','L','B','L','L','B','L','L','LU','L','L','B','L','L'];

        // --- 2. HELPER FUNCTIONS ---
        const Icon = ({ name, className }) => { const ref = useRef(null); useEffect(() => { if (window.lucide && ref.current) { ref.current.innerHTML = ''; const i = document.createElement('i'); i.setAttribute('data-lucide', name); if(className) i.setAttribute('class', className); ref.current.appendChild(i); try { window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' }); } catch(e) {} } }, [name, className]); return <span ref={ref} style={{display:'inline-flex', alignItems:'center', justifyContent:'center'}}></span>; };
        
        const getDaysRemaining = (dateStr) => { 
            if (!dateStr) return 999;
            const today = new Date(); today.setHours(0, 0, 0, 0); 
            const due = new Date(dateStr); due.setHours(0, 0, 0, 0); 
            return Math.ceil((due - today) / (1000 * 60 * 60 * 24)); 
        };

        const getTodayDateString = () => new Date().toLocaleDateString('zh-HK', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        
        const getNextLesson = (subjectName, now, currentSchedule, settings) => {
            if (!subjectName || subjectName === 'å…¶ä»–' || !currentSchedule || !settings) return null;
            const today = now.getDay();
            
            const [startH, startM] = settings.startTime.split(':').map(Number);
            
            const getSlotTimes = () => {
                let t = new Date(now); t.setHours(startH, startM, 0, 0);
                const slots = [];
                let lessonIdx = 0;
                settings.slots.forEach((s, idx) => {
                    const start = new Date(t);
                    const end = new Date(t.getTime() + s.duration * 60000);
                    if (s.type === 'lesson') {
                        slots.push({ idx: lessonIdx, start, end });
                        lessonIdx++;
                    }
                    t = end;
                });
                return slots;
            };

            const slots = getSlotTimes();
            
            for (let d = 0; d < 7; d++) {
                const checkDay = (today + d) % 7;
                if (checkDay === 0 || checkDay === 6) continue;
                const dailySubjects = currentSchedule[checkDay];
                if (!dailySubjects) continue;

                for (let i = 0; i < dailySubjects.length; i++) {
                    if (dailySubjects[i].includes(subjectName) || subjectName.includes(dailySubjects[i])) {
                        const slot = slots.find(s => s.idx === i);
                        if (!slot) continue;

                        if (d === 0) { 
                             if (now >= slot.start && now < slot.end) return { type: 'now', diff: 0 };
                             if (now < slot.start) return { type: 'future', diff: slot.start - now, date: slot.start };
                        } else {
                             const target = new Date(slot.start);
                             target.setDate(target.getDate() + d);
                             return { type: 'future', diff: target - now };
                        }
                    }
                }
            }
            return null;
        };

        const formatCountdown = (ms) => { 
            const totalSeconds = Math.floor(ms / 1000); 
            const hours = Math.floor(totalSeconds / 3600); 
            const minutes = Math.floor((totalSeconds % 3600) / 60); 
            const seconds = totalSeconds % 60; 
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; 
        };

        // --- 3. SHARED COMPONENTS ---
        function DynamicIsland({ message, type, isVisible }) {
            if (!isVisible) return null;
            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[300] island-enter">
                    <div className={`backdrop-blur-xl px-6 py-3 rounded-full flex items-center gap-3 shadow-2xl min-w-[200px] justify-center ${type==='error'?'bg-red-500/90 text-white':'bg-slate-900/90 text-white'}`}>
                        <Icon name={type==='error'?'alert-circle':'check-circle-2'} className="w-5 h-5"/>
                        <span className="text-sm font-bold tracking-wide">{message}</span>
                    </div>
                </div>
            );
        }

        function BlockScreen({ type, estimatedTime, customMessage, systemConfig, onLogin, user }) {
            let title = 'é™åˆ¶æ¸¬è©¦éšæ®µ';
            let message = 'æ„Ÿè¬æ‚¨é€ è¨ªé›»å­æ‰‹å†Šã€‚ç‚ºç¢ºä¿æœå‹™å“è³ªï¼Œç›®å‰åƒ…å°ç™½åå–®ç”¨æˆ¶é–‹æ”¾ã€‚';
            let icon = 'shield-alert';
            let iconColor = 'text-indigo-500';

            if (type === 'updating') { 
                title = 'ç³»çµ±æ›´æ–°ä¸­'; 
                icon = 'hammer'; 
                iconColor = 'text-orange-500'; 
                message = 'ç‚ºäº†æä¾›æ›´å„ªè³ªçš„æœå‹™ï¼Œæˆ‘å€‘æ­£åœ¨é€²è¡Œç³»çµ±æ›´æ–°ã€‚è«‹ç¨å¾Œå†å›ä¾†ã€‚'; 
            } 
            
            return (
                <div className="fixed inset-0 z-40 flex flex-col items-center justify-center p-6 text-center overflow-hidden bg-white/80 backdrop-blur-3xl">
                    <div className="glass-panel p-10 rounded-[2.5rem] w-full max-w-md relative z-10 modal-animate border border-white/60 shadow-2xl">
                        <div className="w-24 h-24 bg-white/80 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm ring-4 ring-white/50 animate-bounce">
                            <Icon name={icon} className={`w-12 h-12 ${iconColor}`} />
                        </div>
                        <h1 className="text-3xl font-black text-slate-800 mb-4 tracking-tight">{title}</h1>
                        <div className="text-slate-600 font-medium mb-10 leading-relaxed whitespace-pre-wrap max-w-xs mx-auto text-sm">{message}</div>
                        {!user && (<button onClick={onLogin} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold text-base hover:bg-slate-800 transition-all shadow-xl hover:shadow-2xl hover:translate-y-[-2px] active:scale-95 flex items-center justify-center gap-3"><Icon name="log-in" className="w-5 h-5" /> ç™»å…¥</button>)}
                        {user && (<div className="mt-2"><p className="text-xs text-slate-400 mb-4 font-bold">{user.email}</p><button onClick={() => window.firebaseServices.signOut(window.firebaseServices.auth)} className="text-sm font-bold text-slate-500 hover:text-slate-800 underline transition-colors">ç™»å‡º</button></div>)}
                    </div>
                </div>
            );
        }

        function NameSetupModal({ onSave, loading }) {
            const [name, setName] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) return; onSave(name.trim()); };
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity duration-500"></div>
                    <div className="modal-animate glass-panel w-full max-w-sm p-8 rounded-3xl relative z-10 text-center shadow-2xl bg-white/90">
                        <div className="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 shadow-sm"><Icon name="sparkles" className="w-12 h-12" /></div>
                        <h2 className="text-3xl font-black text-slate-800 mb-2">æ­¡è¿åŠ å…¥ï¼</h2>
                        <p className="text-slate-500 mb-8 text-base leading-relaxed">ç‚ºäº†æ–¹ä¾¿è¾¨è­˜ï¼Œ<br/>è«‹è¼¸å…¥ä½ çš„ <strong>è‹±æ–‡çŸ­å</strong> (ä¾‹å¦‚: Peter)</p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" className="w-full px-4 py-4 rounded-2xl modern-input text-center font-bold text-xl text-slate-800 placeholder-slate-300 focus:outline-none" placeholder="è¼¸å…¥åå­—..." value={name} onChange={e => setName(e.target.value)} autoFocus required />
                            <button type="submit" disabled={loading} className="w-full py-4 rounded-2xl bg-indigo-600 text-white font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg hover:shadow-indigo-200 active:scale-95 disabled:opacity-70 hover:translate-y-[-2px]">{loading ? 'è¨­å®šä¸­...' : 'é–‹å§‹ä½¿ç”¨'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function UserProfilePanel({ user, onClose, triggerIsland }) {
            const [name, setName] = useState(user.displayName || '');
            const { updateProfile } = window.firebaseServices;
            
            const handleSave = async () => {
                if(!name.trim()) return;
                try {
                    await updateProfile(user, { displayName: name });
                    triggerIsland("æš±ç¨±å·²æ›´æ–°", "success");
                    setTimeout(() => window.location.reload(), 1000);
                } catch(e) {
                    triggerIsland("æ›´æ–°å¤±æ•—: " + e.message, "error");
                }
            };

            return (
                <div className="glass-panel p-6 rounded-[2rem] page-enter mb-8 border border-white/60 bg-white/80">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                            <Icon name="user-cog" className="w-6 h-6 text-slate-600"/> å€‹äººè¨­å®š
                        </h2>
                        <button onClick={onClose} className="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition">è¿”å›</button>
                    </div>
                    
                    <div className="mb-6">
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">ä¿®æ”¹æš±ç¨±</h3>
                        <div className="flex gap-2">
                            <input value={name} onChange={e=>setName(e.target.value)} className="flex-1 p-3 rounded-xl border border-white/50 bg-white text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-100" placeholder="è¼¸å…¥æ–°æš±ç¨±"/>
                            <button onClick={handleSave} className="bg-indigo-600 text-white px-4 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition">å„²å­˜</button>
                        </div>
                    </div>
                    
                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <p className="text-xs text-slate-400 font-bold text-center">æ›´å¤šåŠŸèƒ½å³å°‡æ¨å‡º...</p>
                    </div>
                </div>
            );
        }

        function AuthModal({ isOpen, onClose, triggerAlert }) {
            if (!isOpen) return null;
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [loading, setLoading] = useState(false);
            const { auth, googleProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword } = window.firebaseServices;

            const handleGoogle = async () => { try { await signInWithPopup(auth, googleProvider); onClose(); } catch (e) { triggerAlert("Google ç™»å…¥å¤±æ•—"); } };
            const handleEmail = async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    if (isLogin) await signInWithEmailAndPassword(auth, email, pass);
                    else await createUserWithEmailAndPassword(auth, email, pass);
                    onClose();
                } catch (e) { triggerAlert("éŒ¯èª¤: " + e.message, "error"); } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity" onClick={onClose}></div>
                    <div className="modal-enter glass-panel w-full max-w-sm p-8 rounded-[2rem] relative z-10 overflow-hidden shadow-2xl border border-white/50 bg-white/90">
                        <button onClick={onClose} className="absolute top-5 right-5 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"><Icon name="x" className="w-5 h-5"/></button>
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 shadow-sm transform rotate-3"><Icon name="user-circle-2" className="w-8 h-8" /></div>
                            <h2 className="text-2xl font-black text-slate-800 tracking-tight mb-1">{isLogin ? 'æ­¡è¿å›ä¾†' : 'å»ºç«‹å¸³æˆ¶'}</h2>
                            <p className="text-sm text-slate-500 font-bold">è«‹ç™»å…¥ä»¥ç®¡ç†å€‹äººåŠŸèª²ç´€éŒ„</p>
                        </div>
                        <form onSubmit={handleEmail} className="space-y-4">
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"><Icon name="mail" className="w-5 h-5" /></div><input type="email" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 transition-all font-bold text-slate-700 outline-none placeholder:text-slate-400" placeholder="é›»å­éƒµä»¶" value={email} onChange={e=>setEmail(e.target.value)} required /></div>
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"><Icon name="lock" className="w-5 h-5" /></div><input type="password" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 transition-all font-bold text-slate-700 outline-none placeholder:text-slate-400" placeholder="å¯†ç¢¼" value={pass} onChange={e=>setPass(e.target.value)} required /></div>
                            <button type="submit" disabled={loading} className="w-full py-3.5 rounded-xl bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold text-lg shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transform hover:-translate-y-0.5 transition-all active:scale-[0.98] disabled:opacity-70 flex items-center justify-center gap-2">{loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}</button>
                        </form>
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-xs uppercase tracking-wider font-bold text-slate-400"><span className="px-4 bg-white">æˆ–</span></div></div>
                        <button onClick={handleGoogle} disabled={loading} className="w-full py-3.5 rounded-xl bg-white border border-slate-200 text-slate-700 font-bold hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center justify-center gap-3 shadow-sm hover:shadow-md active:scale-[0.98]"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-5 h-5"/>Google ç™»å…¥</button>
                        <div className="mt-6 text-center"><button onClick={()=>setIsLogin(!isLogin)} className="text-indigo-600 font-bold underline decoration-2 underline-offset-4">{isLogin ? 'ç«‹å³è¨»å†Š' : 'ç›´æ¥ç™»å…¥'}</button></div>
                    </div>
                </div>
            );
        }

        function CustomDropdown({ value, onChange, options }) { 
            const [isOpen, setIsOpen] = useState(false); const dropdownRef = useRef(null); 
            useEffect(() => { const handleClickOutside = (event) => { if (dropdownRef.current && !dropdownRef.current.contains(event.target)) { setIsOpen(false); } }; document.addEventListener('mousedown', handleClickOutside); return () => document.removeEventListener('mousedown', handleClickOutside); }, []); 
            const selectedLabel = options.find(o => o.value === value)?.label || 'æ’åº'; 
            return ( 
                <div className="relative" ref={dropdownRef}> 
                    <button type="button" onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 bg-white/60 backdrop-blur border border-white/50 text-slate-600 text-xs rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-100 font-bold hover:bg-white transition-all shadow-sm active:scale-95 hover:shadow-md hover:translate-y-[-1px]"> 
                        <span>{selectedLabel}</span> <Icon name="chevron-down" className={`w-3.5 h-3.5 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} /> 
                    </button> 
                    {isOpen && ( <div className="absolute right-0 mt-2 w-40 glass-panel rounded-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 origin-top-right z-50 bg-white/95"> {options.map((opt) => ( <button key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`w-full text-left px-5 py-3 text-sm font-bold flex items-center gap-3 transition-colors ${value === opt.value ? 'bg-indigo-50/80 text-indigo-600' : 'text-slate-600 hover:bg-slate-50/50'}`}> {opt.icon && <Icon name={opt.icon} className="w-4 h-4 opacity-70" />}{opt.label} </button> ))} </div> )} 
                </div> 
            ); 
        }

        function EditModal({ item, onClose, onSave, triggerAlert, subjectConfig }) { 
            const [description, setDescription] = useState(item.description || ''); 
            const [subject, setSubject] = useState(item.subject || 'å…¶ä»–'); 
            const [dueDate, setDueDate] = useState(item.dueDate || ''); 
            const [loading, setLoading] = useState(false); 
            const subjects = subjectConfig || DEFAULT_SUBJECTS;
            const handleSave = async (e) => { e.preventDefault(); setLoading(true); try { await onSave(item.id, { description, subject, dueDate }); onClose(); } catch (error) { console.error(error); triggerAlert("æ›´æ–°å¤±æ•—"); } finally { setLoading(false); } }; 
            return ( 
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4"> 
                    <div className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity duration-300" onClick={onClose}></div> 
                    <div className="modal-animate glass-panel rounded-3xl w-full max-w-md p-0 relative z-10 overflow-hidden shadow-2xl bg-white"> 
                        <div className="p-6 border-b border-white/20 flex justify-between items-center bg-white/30 backdrop-blur-md"> 
                            <h3 className="text-xl font-bold text-slate-800">ä¿®æ”¹ç´€éŒ„</h3> 
                            <button onClick={onClose} className="p-2 hover:bg-white/50 rounded-full transition-colors"><Icon name="x" className="w-5 h-5 text-slate-500" /></button> 
                        </div> 
                        <form onSubmit={handleSave} className="p-6 space-y-6"> 
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-3 pl-1">ç§‘ç›®</label><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2">{subjects.map(sub => ( <button key={sub.name} type="button" onClick={() => setSubject(sub.name)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border transition-all shadow-sm ${subject === sub.name ? sub.color + ' ring-2 ring-offset-1 scale-105' : 'bg-white border-slate-100 text-slate-500 hover:bg-slate-50'}`}>{sub.name}</button> ))}</div></div> 
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2 pl-1">å…§å®¹</label><textarea value={description} onChange={(e) => setDescription(e.target.value)} rows="3" className="w-full rounded-2xl modern-input p-4 text-slate-700 text-sm font-medium resize-none focus:outline-none" required /></div> 
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2 pl-1">ç¹³äº¤/è€ƒè©¦æ—¥æœŸ</label><input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full h-12 rounded-2xl modern-input px-4 text-slate-600 font-bold text-sm focus:outline-none" required /></div> 
                            <button type="submit" disabled={loading} className="w-full py-3.5 rounded-2xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95 disabled:opacity-70 flex items-center justify-center gap-2 hover:translate-y-[-2px]">{loading ? 'å„²å­˜ä¸­...' : <><Icon name="save" className="w-4 h-4" /> å„²å­˜ä¿®æ”¹</>}</button> 
                        </form> 
                    </div> 
                </div> 
            ); 
        }

        // --- 4. FEATURE COMPONENTS ---

        function ItemCard({ item, onDelete, onToggle, subjects, style }) {
            const days = getDaysRemaining(item.dueDate);
            const isLate = days < 0 && !item.completed;
            const isToday = days === 0 && !item.completed;
            const subjectObj = subjects.find(s => s.name === item.subject) || { color: 'bg-slate-100 text-slate-600 border-slate-200' };
            const subColor = subjectObj.color;
            
            return (
                <div className={`item-enter bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-start gap-4 transition-all group hover:shadow-lg hover:border-indigo-100 hover:-translate-y-0.5 ${item.completed?'opacity-50 grayscale':''}`} style={style}>
                    <button onClick={()=>onToggle(item)} className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0 ${item.completed?'bg-green-500 border-green-500 text-white':'border-slate-300 hover:border-indigo-500'}`}>
                        {item.completed && <Icon name="check" className="w-3.5 h-3.5"/>}
                    </button>
                    <div className="flex-1 min-w-0">
                        <div className="flex flex-wrap gap-2 mb-1.5">
                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded-md border ${subColor}`}>{item.subject}</span>
                            {item.type==='test' && <span className="text-[10px] font-bold bg-purple-100 text-purple-600 px-2 py-0.5 rounded-md border border-purple-200">æ¸¬é©—</span>}
                            {isLate && <span className="text-[10px] font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded-md border border-red-200 flex items-center gap-1"><Icon name="alert-triangle" className="w-3 h-3"/>é²äº¤</span>}
                            {isToday && <span className="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded-md border border-orange-200 flex items-center gap-1"><Icon name="clock" className="w-3 h-3"/>ä»Šå¤©</span>}
                        </div>
                        <div className={`font-bold text-slate-800 text-sm leading-relaxed ${item.completed?'line-through':''}`}>{item.description}</div>
                        <div className="text-xs text-slate-400 mt-2 flex items-center gap-1.5 font-medium">
                            <Icon name="calendar" className="w-3 h-3"/> {item.dueDate}
                            {!item.completed && days > 0 && <span className="text-indigo-400">({days}å¤©å¾Œ)</span>}
                        </div>
                    </div>
                    <button onClick={()=>onDelete(item.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl opacity-0 group-hover:opacity-100 transition-all"><Icon name="trash-2" className="w-4 h-4"/></button>
                </div>
            );
        }

        function DetailModal({ isOpen, onClose, title, items, onDelete, onToggle, subjects }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-enter glass-panel w-full max-w-lg p-0 rounded-[2rem] relative z-10 overflow-hidden shadow-2xl flex flex-col max-h-[85vh] bg-white/90">
                        <div className="p-5 border-b border-white/40 flex justify-between items-center bg-white/50 backdrop-blur-md sticky top-0 z-10">
                            <h3 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                <div className="w-1 h-6 bg-indigo-500 rounded-full"></div> {title}
                            </h3>
                            <button onClick={onClose} className="p-2 hover:bg-white/50 rounded-full transition-colors"><Icon name="x" className="w-6 h-6 text-slate-500"/></button>
                        </div>
                        <div className="p-5 overflow-y-auto flex-1 custom-scrollbar space-y-3 bg-slate-50/30">
                            {items.length === 0 ? (
                                <div className="text-center py-12 text-slate-400 font-bold flex flex-col items-center">
                                    <Icon name="check-circle" className="w-12 h-12 mb-2 opacity-20"/>
                                    å¤ªæ£’äº†ï¼æš«æ™‚æ²’æœ‰é …ç›®
                                </div>
                            ) : (
                                items.map((item, idx) => <ItemCard key={item.id} item={item} onDelete={onDelete} onToggle={onToggle} subjects={subjects} style={{animationDelay: idx*0.05+'s'}} />)
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ db, onClose, currentSubjects, triggerIsland, systemConfig }) {
            const [localSubjects, setLocalSubjects] = useState(currentSubjects || DEFAULT_SUBJECTS);
            const [newName, setNewName] = useState('');
            const [newColor, setNewColor] = useState(DEFAULT_SUBJECTS[0].color);
            const { setDoc, doc } = window.firebaseServices;
            
            const colorOpts = [
                {n:'ç´…',c:'bg-red-50 text-red-600 border-red-200'}, {n:'æ©™',c:'bg-orange-50 text-orange-600 border-orange-200'},
                {n:'é»ƒ',c:'bg-yellow-50 text-yellow-600 border-yellow-200'}, {n:'ç¶ ',c:'bg-emerald-50 text-emerald-600 border-emerald-200'},
                {n:'é’',c:'bg-cyan-50 text-cyan-600 border-cyan-200'}, {n:'è—',c:'bg-blue-50 text-blue-600 border-blue-200'},
                {n:'ç´«',c:'bg-purple-50 text-purple-600 border-purple-200'}, {n:'ç²‰',c:'bg-pink-50 text-pink-600 border-pink-200'}
            ];

            const saveSubjects = async (list) => { await setDoc(doc(db,"system_settings","subjects_config"), {list}); triggerIsland("ç§‘ç›®å·²æ›´æ–°"); };
            const addSub = () => { if(!newName)return; const n = [...localSubjects, {name:newName, color:newColor}]; setLocalSubjects(n); setNewName(''); saveSubjects(n); };
            const delSub = (i) => { const n=[...localSubjects]; n.splice(i,1); setLocalSubjects(n); saveSubjects(n); };
            const setMode = async (m) => { await setDoc(doc(db,"system_settings","config"), { maintenanceMode: m==='maintenance'?'updating':'normal', whitelistEnabled: m==='private' }, {merge:true}); triggerIsland("æ¨¡å¼å·²æ›´æ”¹"); };

            return (
                <div className="glass-panel p-6 rounded-[2rem] page-enter mb-8 border border-white/60 bg-white/80">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-black text-slate-800 flex items-center gap-2"><Icon name="settings" className="w-6 h-6 text-slate-600"/> ç³»çµ±å¾Œå°</h2><button onClick={onClose} className="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition">è¿”å›</button></div>
                    <div className="mb-8"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">ç³»çµ±æ¨¡å¼</h3><div className="grid grid-cols-3 gap-2"><button onClick={()=>setMode('public')} className={`p-3 rounded-xl border text-sm font-bold transition ${!systemConfig?.whitelistEnabled && systemConfig?.maintenanceMode!=='updating' ? 'bg-green-50 border-green-200 text-green-600':'bg-white text-slate-500 hover:bg-slate-50'}`}>å…¬é–‹</button><button onClick={()=>setMode('private')} className={`p-3 rounded-xl border text-sm font-bold transition ${systemConfig?.whitelistEnabled ? 'bg-indigo-50 border-indigo-200 text-indigo-600':'bg-white text-slate-500 hover:bg-slate-50'}`}>é™åˆ¶</button><button onClick={()=>setMode('maintenance')} className={`p-3 rounded-xl border text-sm font-bold transition ${systemConfig?.maintenanceMode==='updating' ? 'bg-orange-50 border-orange-200 text-orange-600':'bg-white text-slate-500 hover:bg-slate-50'}`}>ç¶­è­·</button></div></div>
                    <div><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">ç§‘ç›®ç®¡ç†</h3><div className="flex flex-wrap gap-2 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">{localSubjects.map((s,i)=><div key={i} className={`px-2 py-1 rounded-lg border text-xs font-bold flex items-center gap-1 ${s.color}`}>{s.name}<button onClick={()=>delSub(i)} className="hover:text-red-600"><Icon name="x" className="w-3 h-3"/></button></div>)}</div><div className="flex gap-2"><input value={newName} onChange={e=>setNewName(e.target.value)} className="flex-1 p-2 rounded-lg bg-white border text-sm outline-none focus:ring-2 focus:ring-indigo-100" placeholder="æ–°ç§‘ç›®å"/><div className="flex gap-1 overflow-x-auto w-32 p-1 bg-white rounded-lg border items-center scrollbar-hide">{colorOpts.map((c,i)=><button key={i} onClick={()=>setNewColor(c.c)} className={`w-6 h-6 rounded-full flex-shrink-0 border-2 ${c.c} ${newColor===c.c?'border-slate-800 scale-110 ring-2 ring-slate-200':''}`}></button>)}</div><button onClick={addSub} className="bg-slate-800 text-white px-3 rounded-lg hover:bg-slate-900 transition"><Icon name="plus" className="w-4 h-4"/></button></div></div>
                </div>
            );
        }

        function TimetableEditorModal({ onClose, timetableConfig, triggerIsland }) {
            const [localTimetable, setLocalTimetable] = useState(timetableConfig || DEFAULT_SCHEDULE);
            const [activeTab, setActiveTab] = useState(1);
            const { setDoc, doc, db } = window.firebaseServices;
            const handleSave = async () => { await setDoc(doc(db,"system_settings","timetable"), localTimetable); triggerIsland("å·²å„²å­˜"); onClose(); };
            const handleChange = (i, v) => { const n={...localTimetable}; n[activeTab]=[...n[activeTab]]; n[activeTab][i]=v; setLocalTimetable(n); };

            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onClick={onClose}></div>
                    <div className="modal-enter glass-panel w-full max-w-2xl p-6 rounded-3xl relative z-10 shadow-2xl flex flex-col max-h-[80vh] bg-white/95">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold">ç·¨è¼¯æ™‚é–“è¡¨</h3><button onClick={onClose}><Icon name="x" className="w-6 h-6"/></button></div>
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">{[1,2,3,4,5].map(d=><button key={d} onClick={()=>setActiveTab(d)} className={`px-4 py-2 rounded-xl font-bold whitespace-nowrap ${activeTab===d?'bg-indigo-600 text-white':'bg-white border'}`}>é€±{['','ä¸€','äºŒ','ä¸‰','å››','äº”'][d]}</button>)}</div>
                        <div className="grid grid-cols-2 gap-3 overflow-y-auto flex-1 custom-scrollbar pr-2 pb-4">
                            {localTimetable[activeTab]?.map((s,i)=><input key={i} value={s} onChange={e=>handleChange(i,e.target.value)} className="p-2 rounded-lg border text-sm font-bold"/>)}
                        </div>
                        <button onClick={handleSave} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜</button>
                    </div>
                </div>
            );
        }

        function Timetable({ currentDay, subjects, triggerIsland, userDayOverride, setUserDayOverride, isAdmin, onEdit }) {
            const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            const [viewDay, setViewDay] = useState(1);
            const [isSelectorOpen, setIsSelectorOpen] = useState(false);

            useEffect(() => { let d = currentDay; if(userDayOverride && userDayOverride!=='auto') d=parseInt(userDayOverride); if(d===0||d===6)d=1; setViewDay(d); }, [currentDay, userDayOverride]);
            
            const handlePrev = () => { let n = viewDay-1; if(n<1)n=5; setViewDay(n); };
            const handleNext = () => { let n = viewDay+1; if(n>5)n=1; setViewDay(n); };
            
            const dailySubs = subjects[viewDay] || [];
            let lIdx = 0; let t = new Date(); t.setHours(8,30,0,0);
            const scheduleData = LESSON_SLOTS.map((dur, i) => {
                const start = new Date(t); const end = new Date(t.getTime()+dur*60000);
                let sub = SLOT_TYPES[i]==='L' ? (dailySubs[lIdx++]||'ç©ºå ‚') : (SLOT_TYPES[i]==='B'?'å°æ¯':'åˆè†³');
                const timeStr = `${start.getHours().toString().padStart(2,'0')}:${start.getMinutes().toString().padStart(2,'0')}`;
                t = end;
                const now = new Date();
                const isNow = now >= start && now < end && viewDay === new Date().getDay();
                return { timeStr, sub, type: SLOT_TYPES[i], isNow };
            });

            return (
                <div className="page-enter space-y-4">
                    <div className="flex justify-between items-center bg-white/60 p-2 rounded-2xl shadow-sm border border-white/50">
                        <button onClick={handlePrev} className="p-2"><Icon name="chevron-left" className="w-6 h-6 text-indigo-600"/></button>
                        <div className="text-xl font-black text-indigo-800">æ˜ŸæœŸ{['','ä¸€','äºŒ','ä¸‰','å››','äº”'][viewDay]}</div>
                        <button onClick={handleNext} className="p-2"><Icon name="chevron-right" className="w-6 h-6 text-indigo-600"/></button>
                    </div>
                    <div className="flex justify-end gap-2">
                        <div className="relative">
                            <button onClick={()=>setIsSelectorOpen(!isSelectorOpen)} className="px-4 py-2 bg-white rounded-xl text-xs font-bold shadow-sm flex items-center gap-2 border border-slate-100">{userDayOverride==='auto'?'ğŸ”„ ç³»çµ±é è¨­':`ğŸ“… è‡ªè¨‚:é€±${['','ä¸€','äºŒ','ä¸‰','å››','äº”'][parseInt(userDayOverride)]}`} <Icon name="chevron-down" className="w-3 h-3"/></button>
                            {isSelectorOpen && (
                                <div className="absolute right-0 mt-2 w-40 glass-panel rounded-2xl overflow-hidden shadow-xl bg-white/95 z-50">
                                    {[{v:'auto',l:'ğŸ”„ ç³»çµ±é è¨­'},{v:'1',l:'ğŸ“… é€±ä¸€'},{v:'2',l:'ğŸ“… é€±äºŒ'},{v:'3',l:'ğŸ“… é€±ä¸‰'},{v:'4',l:'ğŸ“… é€±å››'},{v:'5',l:'ğŸ“… é€±äº”'}].map(o=><button key={o.v} onClick={()=>{setUserDayOverride(o.v);setIsSelectorOpen(false)}} className="w-full text-left px-5 py-3 text-sm font-bold hover:bg-indigo-50 border-b border-slate-50 last:border-0 text-slate-600">{o.l}</button>)}
                                </div>
                            )}
                        </div>
                        {isAdmin && <button onClick={onEdit} className="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold border border-indigo-100">ç·¨è¼¯èª²è¡¨</button>}
                    </div>
                    <div className="glass-panel p-6 rounded-[2rem] relative border border-white/60 bg-white/80">
                        <div className="absolute left-[29px] top-8 bottom-8 w-1 bg-slate-200 rounded-full"></div>
                        <div className="space-y-6 relative">
                            {scheduleData.map((item, i) => (
                                <div key={i} className={`flex items-center gap-4 relative group ${item.isNow ? 'scale-105 transition-transform' : 'opacity-80'}`}>
                                    <div className={`z-10 w-4 h-4 rounded-full border-[3px] box-content ${item.isNow ? 'bg-white border-indigo-500 station-active shadow-lg shadow-indigo-300' : (item.type==='L'?'bg-slate-300 border-white':'bg-white border-slate-300')}`}></div>
                                    <div className={`flex-1 flex justify-between items-center p-3 rounded-xl transition-all ${item.isNow ? 'bg-white shadow-md border border-indigo-100' : 'hover:bg-white/50'}`}>
                                        <div className="font-bold text-slate-700">{item.sub}</div>
                                        <div className="text-xs font-mono font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg">{item.timeStr}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 5. MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [items, setItems] = useState([]);
            const [subjectConfig, setSubjectConfig] = useState(null);
            const [systemConfig, setSystemConfig] = useState(null);
            const [timetableConfig, setTimetableConfig] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [view, setView] = useState('home');
            
            const [desc, setDesc] = useState('');
            const [subject, setSubject] = useState('ä¸­æ–‡');
            const [dueDate, setDueDate] = useState(new Date().toISOString().split('T')[0]);
            const [inputType, setInputType] = useState('homework');
            const [filter, setFilter] = useState('All');
            const [sort, setSort] = useState('date');
            const [island, setIsland] = useState({visible:false, msg:'', type:'success'});
            const [authOpen, setAuthOpen] = useState(false);
            const [detailModal, setDetailModal] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [editTimetable, setEditTimetable] = useState(false);
            const [userDayOverride, setUserDayOverride] = useState(localStorage.getItem('userDayOverride') || 'auto');

            const { auth, db, onAuthStateChanged, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, signOut } = window.firebaseServices;
            const triggerIsland = (msg, type='success') => { setIsland({visible:true, msg, type}); setTimeout(()=>setIsland({visible:false, msg:'', type:'success'}), 2000); };
            const subjects = subjectConfig || DEFAULT_SUBJECTS;

            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, u => { setUser(u); setIsAdmin(u?.email === ADMIN_EMAIL); setLoading(false); });
                const unsubSub = onSnapshot(doc(db,"system_settings","subjects_config"), s => s.exists() && setSubjectConfig(s.data().list));
                const unsubSys = onSnapshot(doc(db,"system_settings","config"), s => s.exists() && setSystemConfig(s.data()));
                const unsubTime = onSnapshot(doc(db,"system_settings","timetable"), s => s.exists() && setTimetableConfig(s.data()));
                return () => { unsubAuth(); unsubSub(); unsubSys(); unsubTime(); };
            }, []);

            useEffect(() => {
                if(!user) { setItems([]); return; }
                const q = query(collection(db, "users", user.uid, "items"), orderBy("dueDate"));
                return onSnapshot(q, s => setItems(s.docs.map(d=>({id:d.id, ...d.data()}))));
            }, [user]);

            const handleAdd = async (e) => { e.preventDefault(); if(!user){setAuthOpen(true);return;} if(!desc.trim())return; await addDoc(collection(db,"users",user.uid,"items"),{description:desc,subject,dueDate,type:inputType,completed:false,createdAt:new Date().toISOString()}); setDesc(''); triggerIsland("æ–°å¢æˆåŠŸ"); };
            const toggleItem = async (item) => { await updateDoc(doc(db,"users",user.uid,"items",item.id),{completed:!item.completed}); if(!item.completed)triggerIsland("å®Œæˆï¼"); };
            const deleteItem = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")){ await deleteDoc(doc(db,"users",user.uid,"items",id)); triggerIsland("å·²åˆªé™¤"); }};
            const handleUpdateItem = async (id, data) => { await updateDoc(doc(db,"users",user.uid,"items",id), data); triggerIsland("æ›´æ–°æˆåŠŸ"); };

            const activeItems = items.filter(i => !i.completed);
            const dashboardCounts = {
                today: activeItems.filter(i => getDaysRemaining(i.dueDate) <= 0 && i.type==='homework').length,
                tmr: activeItems.filter(i => getDaysRemaining(i.dueDate) === 1 && i.type==='homework').length,
                future: activeItems.filter(i => getDaysRemaining(i.dueDate) > 1 && i.type==='homework').length,
                test: activeItems.filter(i => i.type === 'test').length
            };

            const getFilteredItems = () => {
                let res = items.filter(i => filter === 'All' ? !i.completed : (!i.completed && i.subject === filter));
                if (sort === 'type') res.sort((a,b) => (a.type === b.type ? 0 : a.type==='test'?-1:1));
                return res;
            };

            const getModalItems = () => {
                if(!detailModal) return [];
                return activeItems.filter(i => {
                    const d = getDaysRemaining(i.dueDate);
                    if(detailModal==='today') return d<=0 && i.type==='homework';
                    if(detailModal==='tmr') return d===1 && i.type==='homework';
                    if(detailModal==='future') return d>1 && i.type==='homework';
                    if(detailModal==='test') return i.type==='test';
                    return false;
                });
            };

            if(loading) return <div className="flex h-screen items-center justify-center text-slate-500 font-bold">è¼‰å…¥ä¸­...</div>;
            const isBlocked = systemConfig?.maintenanceMode==='updating' && !isAdmin;
            if(isBlocked) return <BlockScreen type="updating" onLogin={()=>setAuthOpen(true)} user={user}/>;

            return (
                <div className="min-h-screen p-4 max-w-3xl mx-auto pb-24 relative">
                    <DynamicIsland message={island.msg} type={island.type} isVisible={island.visible}/>
                    <div className="flex justify-between items-center mb-6 page-enter relative z-50">
                        <div><h1 className="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 flex items-center gap-2"><Icon name="graduation-cap" className="w-8 h-8 text-indigo-600"/> é›»å­æ‰‹å†Š</h1><p className="text-xs font-bold text-slate-400 ml-1">{getTodayDateString()}</p></div>
                        <div className="flex gap-2">
                            {isAdmin ? <button onClick={()=>setView(view==='home'?'admin':'home')} className="p-2 bg-white rounded-xl shadow-sm"><Icon name="settings" className="w-5 h-5 text-slate-600"/></button> : user && <button onClick={()=>setView(view==='settings'?'home':'settings')} className="p-2 bg-white rounded-xl shadow-sm"><Icon name="settings" className="w-5 h-5 text-slate-600"/></button>}
                            <button onClick={()=>setView(view==='timetable'?'home':'timetable')} className={`p-2 rounded-xl shadow-sm ${view==='timetable'?'bg-indigo-600 text-white':'bg-white text-slate-600'}`}><Icon name="calendar" className="w-5 h-5"/></button>
                            {user ? <button onClick={()=>signOut(auth)} className="p-2 bg-white rounded-xl shadow-sm text-red-500 hover:bg-red-50 transition"><Icon name="log-out" className="w-5 h-5"/></button> : <button onClick={()=>setAuthOpen(true)} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-md hover:bg-indigo-700 transition">ç™»å…¥</button>}
                        </div>
                    </div>

                    {view === 'admin' ? (
                        <AdminPanel db={db} onClose={()=>setView('home')} currentSubjects={subjects} triggerIsland={triggerIsland} systemConfig={systemConfig} />
                    ) : view === 'settings' ? (
                        <UserProfilePanel user={user} onClose={()=>setView('home')} triggerIsland={triggerIsland} />
                    ) : view === 'timetable' ? (
                        <>
                            <Timetable currentDay={(systemConfig?.dailyScheduleOverride&&systemConfig.dailyScheduleOverride!=='auto')?parseInt(systemConfig.dailyScheduleOverride):new Date().getDay()} subjects={timetableConfig||DEFAULT_SCHEDULE} triggerIsland={triggerIsland} userDayOverride={userDayOverride} setUserDayOverride={(v)=>{setUserDayOverride(v);localStorage.setItem('userDayOverride',v)}} isAdmin={isAdmin} onEdit={()=>setEditTimetable(true)} />
                            {editTimetable && <TimetableEditorModal onClose={()=>setEditTimetable(false)} timetableConfig={timetableConfig} triggerIsland={triggerIsland}/>}
                        </>
                    ) : (
                        <div className={!user ? "filter blur-sm pointer-events-none select-none transition duration-500" : "transition duration-500"}>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 page-enter">
                                {[{id:'today',t:'ä»Šæ—¥è¦äº¤',c:'text-red-500 bg-red-50',i:'flame',v:dashboardCounts.today},{id:'tmr',t:'è½æ—¥è¦äº¤',c:'text-orange-500 bg-orange-50',i:'sun',v:dashboardCounts.tmr},{id:'future',t:'æ—¥å¾Œè¦äº¤',c:'text-sky-500 bg-sky-50',i:'calendar',v:dashboardCounts.future},{id:'test',t:'æº«ç¿’è€ƒæ ¸',c:'text-purple-500 bg-purple-50',i:'brain-circuit',v:dashboardCounts.test}].map(c => (
                                    <div key={c.id} onClick={()=>setDetailModal(c.id)} className="glass-card p-4 rounded-2xl flex flex-col items-center justify-center text-center"><div className={`p-2 rounded-xl mb-2 ${c.c}`}><Icon name={c.i} className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{c.v}</div><div className="text-[10px] font-bold text-slate-400 uppercase">{c.t}</div></div>
                                ))}
                            </div>

                            <div className="glass-panel p-5 rounded-[2rem] mb-6 page-enter">
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4"><button onClick={()=>setInputType('homework')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition ${inputType==='homework'?'bg-white shadow text-indigo-600':'text-slate-400'}`}>ğŸ“– åšåŠŸèª²</button><button onClick={()=>setInputType('test')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition ${inputType==='test'?'bg-white shadow text-purple-600':'text-slate-400'}`}>ğŸ“ æº«æ¸¬é©—</button></div>
                                <form onSubmit={handleAdd} className="space-y-3">
                                    <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1">{subjects.map(s => <button key={s.name} type="button" onClick={()=>setSubject(s.name)} className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold border transition ${subject===s.name ? s.color+' ring-2 ring-offset-1 border-transparent':'bg-white border-slate-200 text-slate-500'}`}>{s.name}</button>)}</div>
                                    <div className="flex gap-2"><input value={desc} onChange={e=>setDesc(e.target.value)} className="flex-1 p-3 rounded-xl modern-input text-sm font-bold text-slate-700" placeholder="è¼¸å…¥å…§å®¹..." /><input type="date" value={dueDate} onChange={e=>setDueDate(e.target.value)} className="w-28 p-3 rounded-xl modern-input text-sm font-bold text-slate-500" /></div>
                                    <button type="submit" disabled={!user} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-md active:scale-95 transition flex justify-center gap-2 items-center"><Icon name="plus" className="w-4 h-4"/> æ–°å¢</button>
                                </form>
                            </div>

                            <div className="flex justify-between items-center mb-4 page-enter">
                                <div className="flex gap-2 overflow-x-auto scrollbar-hide flex-1 mr-4"><button onClick={()=>setFilter('All')} className={`flex-shrink-0 px-3 py-1 rounded-lg text-xs font-bold transition ${filter==='All'?'bg-slate-800 text-white':'bg-white/60 text-slate-500 hover:bg-white'}`}>å…¨éƒ¨</button>{subjects.map(s=><button key={s.name} onClick={()=>setFilter(s.name)} className={`flex-shrink-0 px-3 py-1 rounded-lg text-xs font-bold transition ${filter===s.name?s.color:'bg-white/60 text-slate-500 hover:bg-white'}`}>{s.name}</button>)}</div>
                                <CustomDropdown value={sort} onChange={(v)=>{setSort(v);triggerIsland(v==='date'?'æŒ‰æ—¥æœŸæ’åº':'æŒ‰é¡å‹æ’åº')}} options={[{value:'date',label:'æ—¥æœŸ',icon:'calendar'},{value:'type',label:'é¡å‹',icon:'layout-list'}]} />
                            </div>

                            <div className="space-y-3 pb-20">{getFilteredItems().map((item, i) => <ItemCard key={item.id} item={item} onDelete={deleteItem} onToggle={toggleItem} subjects={subjects} style={{animationDelay: i*0.05+'s'}} />)}{getFilteredItems().length===0 && <div className="text-center py-10 text-slate-400 font-bold opacity-60">æš«ç„¡ç›¸é—œé …ç›®</div>}</div>
                        </div>
                    )}

                    {!user && <div className="fixed inset-0 top-0 z-20 flex flex-col items-center justify-center pointer-events-none"><div className="bg-white/90 backdrop-blur-xl p-8 rounded-[2rem] shadow-2xl border border-white text-center transform translate-y-[-20%] pointer-events-auto modal-animate max-w-xs w-full"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400"><Icon name="lock" className="w-8 h-8"/></div><h3 className="text-xl font-black text-slate-800 mb-2">å…§å®¹å·²é–å®š</h3><p className="text-slate-500 text-sm font-bold mb-6">è«‹ç™»å…¥ä»¥ç®¡ç†ä½ çš„åŠŸèª²</p><button onClick={()=>setAuthOpen(true)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">ç«‹å³ç™»å…¥</button></div></div>}
                    <AuthModal isOpen={authOpen} onClose={()=>setAuthOpen(false)} triggerAlert={(m)=>alert(m)} />
                    <DetailModal isOpen={!!detailModal} onClose={()=>setDetailModal(null)} title={detailModal==='today'?'ä»Šæ—¥è¦äº¤':detailModal==='tmr'?'è½æ—¥è¦äº¤':detailModal==='future'?'æ—¥å¾Œè¦äº¤':'æº«ç¿’è€ƒæ ¸'} items={getModalItems()} onDelete={deleteItem} onToggle={toggleItem} subjects={subjects} />
                    {user && !user.displayName && <NameSetupModal onSave={async(n)=>{await window.firebaseServices.updateProfile(user,{displayName:n});window.location.reload()}} loading={false} triggerAlert={(m)=>alert(m)} />}
                    {editingItem && <EditModal item={editingItem} onClose={() => setEditingItem(null)} onSave={handleUpdateItem} triggerAlert={(msg) => triggerIsland(msg, "success")} subjectConfig={subjects} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>