<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›»å­æ‰‹å†Š | Smart Student Helper</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="file"]::file-selector-button { display: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 70% { transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .gradient-bg { background-size: 200% 200%; animation: gradientFlow 15s ease infinite; }
        .modal-animate { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .page-enter { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .list-item-enter { animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        
        /* Glassmorphism */
        .glass-card { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .blur-layer {
            filter: blur(12px) grayscale(0.2);
            pointer-events: none;
            transform: scale(1.02);
            transition: all 0.5s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input[type="time"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(0.5); }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 overflow-x-hidden">
    <div id="root"></div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyB3gYuwnyoTUwO7PFh4Nuue-Ud8GTruuRk",
            authDomain: "recordhwv2.firebaseapp.com",
            projectId: "recordhwv2",
            storageBucket: "recordhwv2.firebasestorage.app",
            messagingSenderId: "599261009391",
            appId: "1:599261009391:web:66cd7f932650bebc0e521a",
            measurementId: "G-C51XDYW67W"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const app = initializeApp(firebaseConfig);
            window.fb = { 
                auth: getAuth(app), 
                db: getFirestore(app), 
                googleProvider: new GoogleAuthProvider(), 
                signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, 
                collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc, serverTimestamp,
                isReady: true 
            };
            window.dispatchEvent(new Event('fb-ready'));
        } catch (e) {
            console.error(e);
            document.body.innerHTML = `<div style="padding:20px;text-align:center;color:red;">é€£ç·šå¤±æ•—: ${e.message}</div>`;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;
        const ADMIN_EMAIL = 'chimhinhin@gmail.com';

        // --- CONSTANTS ---
        const SUBJECTS = [{ name: 'ä¸­æ–‡', color: 'bg-red-100 text-red-700 border-red-200', category: 'ä¸»ç§‘' }, { name: 'è‹±æ–‡', color: 'bg-blue-100 text-blue-700 border-blue-200', category: 'ä¸»ç§‘' }, { name: 'æ•¸å­¸', color: 'bg-green-100 text-green-700 border-green-200', category: 'ä¸»ç§‘' }, { name: 'å¸¸è­˜/å…¬ç¤¾', color: 'bg-orange-100 text-orange-700 border-orange-200', category: 'ä¸»ç§‘' }, { name: 'ç‰©ç†', color: 'bg-cyan-100 text-cyan-700 border-cyan-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'åŒ–å­¸', color: 'bg-purple-100 text-purple-700 border-purple-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ç”Ÿç‰©', color: 'bg-emerald-100 text-emerald-700 border-emerald-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ä¸­å²', color: 'bg-amber-100 text-amber-800 border-amber-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'æ­·å²', color: 'bg-stone-100 text-stone-700 border-stone-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'åœ°ç†', color: 'bg-teal-100 text-teal-700 border-teal-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ç¶“æ¿Ÿ', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ä¼æœƒè²¡', color: 'bg-lime-100 text-lime-700 border-lime-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'è³‡è¨Šç§‘æŠ€', color: 'bg-indigo-100 text-indigo-700 border-indigo-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ä½›å­¸/å®—æ•™', color: 'bg-yellow-50 text-yellow-600 border-yellow-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'æ™®é€šè©±', color: 'bg-pink-100 text-pink-700 border-pink-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'è¦–è—', color: 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'éŸ³æ¨‚', color: 'bg-sky-100 text-sky-700 border-sky-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'é«”è‚²', color: 'bg-lime-50 text-lime-600 border-lime-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'è¨­è¨ˆèˆ‡ç§‘æŠ€', color: 'bg-zinc-100 text-zinc-700 border-zinc-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'å®¶æ”¿', color: 'bg-rose-100 text-rose-700 border-rose-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'æ–‡å­¸', color: 'bg-violet-100 text-violet-700 border-violet-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'STEAM', color: 'bg-violet-50 text-violet-600 border-violet-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'å…¨æ–¹ä½', color: 'bg-rose-50 text-rose-600 border-rose-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'å…¶ä»–', color: 'bg-gray-100 text-gray-700 border-gray-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ç©ºå ‚', color: 'bg-slate-100 text-slate-500 border-slate-200', category: 'å‰¯ç§‘/å…¶ä»–' }];
        const COLOR_PRESETS = [{ label: 'ç´…', value: 'bg-red-100 text-red-700 border-red-200' }, { label: 'æ©™', value: 'bg-orange-100 text-orange-700 border-orange-200' }, { label: 'é»ƒ', value: 'bg-yellow-100 text-yellow-700 border-yellow-200' }, { label: 'ç¶ ', value: 'bg-green-100 text-green-700 border-green-200' }, { label: 'è—', value: 'bg-blue-100 text-blue-700 border-blue-200' }, { label: 'ç´«', value: 'bg-purple-100 text-purple-700 border-purple-200' }, { label: 'ç²‰', value: 'bg-pink-100 text-pink-700 border-pink-200' }, { label: 'ç°', value: 'bg-gray-100 text-gray-700 border-gray-200' }, { label: 'é’', value: 'bg-cyan-100 text-cyan-700 border-cyan-200' }, { label: 'çŸ³', value: 'bg-stone-100 text-stone-700 border-stone-200' }];
        const DEFAULT_SCHEDULE = { 1: ["æ™®é€šé›»è…¦", "æ™®é€šé›»è…¦", "è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "æ™®é€šè©±", "ä½›å­¸", "æ­·å²", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ"], 2: ["è‹±æ–‡", "è‹±æ–‡", "éŸ³æ¨‚", "åœ°ç†", "ç‰©ç†", "ç‰©ç†", "ä¸­æ–‡", "ä¸­æ–‡", "æ•¸å­¸", "æ•¸å­¸"], 3: ["åŒ–å­¸", "åŒ–å­¸", "è‹±æ–‡", "è‹±æ–‡", "æ•¸å­¸", "ä¸­æ–‡", "è¦–è—", "è¦–è—", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ", "ä¸­å²"], 4: ["STEAM", "STEAM", "æ•¸å­¸", "æ­·å²", "è‹±æ–‡", "è‹±æ–‡", "ç”Ÿç‰©", "ç”Ÿç‰©", "ä¸­å²", "åœ°ç†"], 5: ["è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "é«”è‚²", "é«”è‚²", "æ•¸å­¸", "æ•¸å­¸", "å…¨æ–¹ä½", "å…¨æ–¹ä½"] };
        const DEFAULT_START_TIMES = [510, 545, 595, 630, 675, 710, 815, 850, 895, 930]; 
        const DEFAULT_DURATIONS = [35, 35, 35, 35, 35, 35, 35, 35, 35, 35];
        const MAINTENANCE_PRESETS = [{ id: 1, title: "ç³»çµ±å‡ç´š", msg: "æˆ‘å€‘æ­£åœ¨é€²è¡Œå‡ç´šï¼Œé è¨ˆ15åˆ†é˜å¾Œæ¢å¾©ã€‚" }, { id: 2, title: "æ•¸æ“šç¶­è­·", msg: "æ­£åœ¨é€²è¡Œè³‡æ–™å‚™ä»½ã€‚" }, { id: 3, title: "ç·Šæ€¥ä¿®å¾©", msg: "æª¢æ¸¬åˆ°ç•°å¸¸ï¼Œä¿®å¾©ä¸­ã€‚" }];

        // --- Helpers ---
        function Icon({name, className}) {
            const ref = useRef(null);
            useEffect(() => {
                if(window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if(className) i.className = className;
                    ref.current.appendChild(i);
                    window.lucide.createIcons({root:ref.current});
                }
            }, [name, className]);
            return <span ref={ref} style={{display:'inline-flex', alignItems:'center', justifyContent:'center'}}></span>;
        }

        const normalizeDate = (d) => { const n = d ? new Date(d) : new Date(); n.setHours(0,0,0,0); return n; };
        const getDaysRemaining = (dateString) => { const today = normalizeDate(); const due = normalizeDate(dateString); return Math.ceil((due - today) / (1000 * 60 * 60 * 24)); };
        const minutesToTimeStr = (m) => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
        const timeStrToMinutes = (s) => { const [h,m] = s.split(':').map(Number); return h*60+m; };
        const formatCountdown = (ms) => { const totalSeconds = Math.floor(ms / 1000); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
        const getNextSchoolDay = () => { const d = new Date(); const day = d.getDay(); let addDays = 1; if (day === 5) addDays = 3; else if (day === 6) addDays = 2; else if (day === 0) addDays = 1; d.setDate(d.getDate() + addDays); return d.toISOString().split('T')[0]; };
        const compressImage = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const MAX_WIDTH = 1024; const scale = MAX_WIDTH / img.width; if(scale < 1) { canvas.width = MAX_WIDTH; canvas.height = img.height * scale; } else { canvas.width = img.width; canvas.height = img.height; } const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; img.onerror = reject; }; reader.onerror = reject; });

        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
            render() { if (this.state.hasError) return <div className="p-4 text-center text-red-500">âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹åˆ·æ–°ã€‚</div>; return this.props.children; }
        }

        // --- COMPONENTS ---

        function NotificationModal({ isOpen, type, message, onConfirm, onClose }) {
            if (!isOpen) return null;
            const isConfirm = type === 'confirm';
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={!isConfirm ? onClose : undefined}></div>
                    <div className="glass-card bg-white/95 p-6 rounded-3xl shadow-2xl w-full max-w-sm relative z-10 modal-animate text-center">
                        <div className={`w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 ${isConfirm ? 'bg-orange-100 text-orange-500' : 'bg-indigo-100 text-indigo-500'}`}><Icon name={isConfirm ? 'alert-triangle' : 'info'} className="w-8 h-8"/></div>
                        <h3 className="text-lg font-black text-slate-800 mb-2">{isConfirm ? 'ç¢ºèªæ“ä½œ' : 'æç¤º'}</h3>
                        <p className="text-slate-600 font-medium mb-6 text-sm whitespace-pre-wrap">{message}</p>
                        <div className="flex gap-2">
                            {isConfirm ? (<><button onClick={onClose} className="flex-1 py-3 border rounded-xl font-bold text-slate-500">å–æ¶ˆ</button><button onClick={()=>{onConfirm();onClose();}} className="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold">ç¢ºèª</button></>) 
                            : (<button onClick={onClose} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">çŸ¥é“äº†</button>)}
                        </div>
                    </div>
                </div>
            );
        }

        function LiveLessonCard({ schedule, times, durations, currentDay, user }) {
            const [now, setNow] = useState(new Date());
            useEffect(() => { const t = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(t); }, []);
            
            const daySubjects = schedule[currentDay] || [];
            const curMin = now.getHours() * 60 + now.getMinutes();
            let status = "æ”¾å­¸å•¦ / ä¼‘æ¯ä¸­", subStatus = "", nextInfo = "æ²’æœ‰ä¸‹ä¸€ç¯€", icon = "moon", bg = "from-slate-700 to-slate-900";

            if (currentDay === 0 || currentDay === 6) {
                status = "æ”¾å‡å•¦ï¼"; subStatus = "å¥½å¥½ä¼‘æ¯ï¼Œäº«å—é€±æœ« ğŸ–ï¸"; nextInfo = "ä¸‹é€±è¦‹"; icon = "coffee"; bg = "from-teal-400 to-emerald-500";
            } else if (times.length > 0) {
                const getEnd = (i) => times[i] + (durations[i]||35);
                if (curMin < times[0]) {
                    status = "æ—©æ™¨ï¼æœªä¸Šå ‚"; subStatus = `ç¬¬ä¸€å ‚: ${daySubjects[0]||'æœªçŸ¥'}`; icon = "sun"; bg = "from-orange-400 to-red-500";
                } else {
                    let found = false;
                    for(let i=0; i<10; i++) {
                        const s = times[i]; const e = getEnd(i);
                        if(curMin >= s && curMin < e) {
                            status = `ä¸Šç·Š: ${daySubjects[i]||'ç©ºå ‚'}`; subStatus = `ä»²æœ‰ ${e-curMin} åˆ†é˜`; nextInfo = i<9 ? `ä¸‹ä¸€ç¯€: ${daySubjects[i+1]}` : "æ”¾å­¸"; icon = "book-open"; bg = "from-indigo-500 to-purple-600"; found = true; break;
                        }
                    }
                    if(!found && curMin >= getEnd(9)) { status = "æ”¾å­¸å•¦ï¼"; subStatus = "å¥½å¥½ä¼‘æ¯"; icon="moon"; bg="from-slate-600 to-slate-800"; }
                }
            }
            let dayDisplay = currentDay === 0 ? "æ˜ŸæœŸæ—¥" : currentDay === 6 ? "æ˜ŸæœŸå…­" : `Day ${currentDay}`;
            return (
                <div className={`relative overflow-hidden rounded-3xl p-6 text-white shadow-xl bg-gradient-to-r ${bg} mb-6 gradient-bg`}>
                    <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name={icon} className="w-32 h-32" /></div>
                    <div className="relative z-10">
                        <div className="flex justify-between mb-4"><div><div className="text-xs opacity-80 mb-1 flex gap-1"><Icon name="user" className="w-3 h-3"/> {user?.displayName||'åŒå­¸'}</div><h2 className="text-2xl font-black">{status}</h2><p className="text-lg font-bold opacity-90">{subStatus}</p></div><div className="text-right"><div className="text-2xl font-black font-mono">{now.toLocaleTimeString('zh-HK',{hour:'2-digit',minute:'2-digit'})}</div><div className="mt-1 inline-block bg-white/20 px-3 py-1 rounded-full text-xs font-bold">{dayDisplay}</div></div></div>
                        <div className="inline-flex items-center gap-2 bg-black/20 px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-sm"><Icon name="arrow-right-circle" className="w-4 h-4"/> {nextInfo}</div>
                    </div>
                </div>
            );
        }

        function BlockScreen({ type, estimatedTime, customConfig, onLogin, user, triggerAlert }) {
            const [showRequest, setShowRequest] = useState(false);
            const [email, setEmail] = useState(''); const [name, setName] = useState('');
            const { db, setDoc, doc } = window.fb || {};
            useEffect(() => { if(user) { setEmail(user.email||''); setName(user.displayName||''); } }, [user]);

            const title = customConfig?.customBlockTitle || "å­˜å–æ¬Šé™å—é™";
            const msg = customConfig?.customBlockMessage || "æœ¬ç¶²ç«™åƒ…é–‹æ”¾ç™½åå–®ç”¨æˆ¶ã€‚";

            const handleReq = async (e) => {
                e.preventDefault();
                try {
                    await setDoc(doc(db, "access_requests", user.uid), { email, displayName: name, status: 'pending', requestTime: new Date().toISOString(), uid: user.uid });
                    triggerAlert("ç”³è«‹å·²é€å‡ºï¼", 'success'); setShowRequest(false);
                } catch(e) { 
                    if(e.code === 'permission-denied') alert("ç”³è«‹å·²åœ¨å¯©æ ¸ä¸­ã€‚");
                    else triggerAlert("éŒ¯èª¤: " + e.message, 'error'); 
                }
            };

            return (
                <div className="fixed inset-0 z-40 flex flex-col items-center justify-center bg-slate-900 p-6 text-center mesh-bg">
                    <div className="glass-card p-10 rounded-[2rem] shadow-2xl max-w-md w-full relative z-10 modal-animate">
                        <div className="w-16 h-16 bg-white/50 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="lock" className="w-8 h-8 text-slate-800"/></div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">{title}</h2>
                        <p className="text-slate-600 mb-6 whitespace-pre-wrap">{msg}</p>
                        {!showRequest ? <button onClick={()=>setShowRequest(true)} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">ç”³è«‹æ¬Šé™</button> 
                        : <form onSubmit={handleReq} className="space-y-3"><input value={name} onChange={e=>setName(e.target.value)} className="w-full p-3 bg-white/50 rounded-xl" placeholder="åå­—" required /><button className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">ç¢ºèªç”³è«‹</button></form>}
                        <div className="mt-4"><button onClick={()=>window.fb.signOut(window.fb.auth)} className="text-xs text-slate-500 underline">ç™»å‡º</button></div>
                    </div>
                </div>
            );
        }

        function AuthModal({ onClose, onLogin, onEmailLogin }) {
            const [email, setEmail] = useState(''); const [pwd, setPwd] = useState(''); const [isReg, setIsReg] = useState(false); const [name, setName] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onEmailLogin(email, pwd, isReg, name); };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="glass-card p-8 rounded-3xl w-full max-w-sm relative z-10 modal-animate">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-slate-100 rounded-full"><Icon name="x" className="w-5 h-5 text-slate-400"/></button>
                        <h2 className="text-2xl font-black text-center mb-6 text-slate-800">{isReg ? 'è¨»å†Š' : 'ç™»å…¥'}</h2>
                        <button onClick={onLogin} className="w-full py-3 bg-white border rounded-xl font-bold text-slate-600 flex justify-center gap-2 mb-4 hover:bg-slate-50"><Icon name="log-in" className="w-4 h-4"/> Google ç™»å…¥</button>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            {isReg && <input placeholder="åå­—" className="w-full p-3 bg-slate-50 rounded-xl" value={name} onChange={e=>setName(e.target.value)} required />}
                            <input placeholder="Email" className="w-full p-3 bg-slate-50 rounded-xl" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input type="password" placeholder="å¯†ç¢¼" className="w-full p-3 bg-slate-50 rounded-xl" value={pwd} onChange={e=>setPwd(e.target.value)} required />
                            <button className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">{isReg ? 'è¨»å†Š' : 'ç™»å…¥'}</button>
                        </form>
                        <div className="mt-4 text-center text-xs text-slate-400"><button onClick={()=>setIsReg(!isReg)} className="text-indigo-600 font-bold hover:underline">{isReg ? 'å·²æœ‰å¸³è™Ÿï¼Ÿç™»å…¥' : 'æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š'}</button></div>
                    </div>
                </div>
            );
        }

        function Timetable({ currentDay, subjects, timeConfig, durations, onDayChange, isEditing, manualDay, setManualDay }) {
            const isWeekend = !isEditing && (manualDay === 0 || manualDay === 6);
            const renderSchedule = () => {
                const list = [];
                if(timeConfig && subjects[currentDay]) {
                    for(let i=0; i<timeConfig.length; i++) {
                        list.push({ time: minutesToTimeStr(timeConfig[i]), subject: subjects[currentDay][i] || 'ç©ºå ‚', type:'lesson' });
                        if(i===1 || i===3 || i===5 || i===7) list.push({ type: 'break', name: i===5?'åˆè†³':'å°æ¯' });
                    }
                }
                return list;
            };
            const list = renderSchedule();

            return (
                <div className="space-y-4 page-enter">
                    <div className="flex justify-between items-center bg-white rounded-xl p-3 shadow-sm border border-slate-100">
                        {isEditing ? <div className="text-sm font-bold text-slate-500">è«‹åœ¨è¨­å®šä¸­ç·¨è¼¯</div> : 
                        <select value={manualDay} onChange={(e)=>setManualDay(parseInt(e.target.value))} className="w-full p-2 bg-indigo-50 text-indigo-700 rounded-lg font-bold outline-none text-sm"><option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option><option value="4">Day 4</option><option value="5">Day 5</option><option disabled>---</option><option value="6">æ˜ŸæœŸå…­</option><option value="0">æ˜ŸæœŸæ—¥</option></select>}
                    </div>
                    {isWeekend ? (
                        <div className="bg-white rounded-2xl border border-slate-100 p-10 text-center min-h-[300px] flex flex-col items-center justify-center">
                            <div className="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-4 text-green-500"><Icon name="coffee" className="w-10 h-10" /></div>
                            <h3 className="text-xl font-black text-slate-700">é€±æœ«æ„‰å¿«ï¼</h3>
                        </div>
                    ) : (
                        <div className="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm">
                            {list.length > 0 ? list.map((item, i) => (
                                <div key={i} className={`flex items-center gap-4 py-3 border-b border-slate-50 last:border-0 ${item.type!=='lesson'?'bg-slate-50/50 -mx-4 px-4 py-2':''}`}>
                                    {item.type === 'lesson' ? (<><div className="w-12 text-xs font-mono font-bold text-slate-400 text-right">{item.time}</div><div className="w-2 h-2 rounded-full bg-indigo-400"></div><div className="font-bold text-slate-700 text-sm">{item.subject}</div></>) : (<div className="w-full text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">{item.name}</div>)}
                                </div>
                            )) : <div className="text-center py-10 text-slate-400">æš«ç„¡è³‡æ–™</div>}
                        </div>
                    )}
                </div>
            );
        }

        function UserSettings({ subjects, onSave, onBack }) {
            const [list, setList] = useState(subjects || []);
            const [newName, setNewName] = useState('');
            const [newColor, setNewColor] = useState(COLOR_PRESETS[0].value);
            const handleAdd = () => { if(!newName.trim()) return; setList([...list, { name: newName, color: newColor, category: 'è‡ªè¨‚' }]); setNewName(''); };
            return (
                <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 min-h-[500px] page-enter">
                    <div className="flex items-center gap-3 mb-6"><button onClick={onBack}><Icon name="arrow-left"/></button><h2 className="text-xl font-bold">ç§‘ç›®è¨­å®š</h2></div>
                    <div className="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div className="flex gap-2 mb-3"><input value={newName} onChange={e=>setNewName(e.target.value)} className="flex-1 p-2 rounded-lg border text-sm" placeholder="ç§‘ç›®åç¨±" /><button onClick={handleAdd} className="bg-indigo-600 text-white px-4 rounded-lg text-sm font-bold">æ–°å¢</button></div>
                        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{COLOR_PRESETS.map((c,i)=><button key={i} onClick={()=>setNewColor(c.value)} className={`w-6 h-6 rounded-full border-2 shrink-0 ${c.value.split(' ')[0]} ${newColor===c.value?'ring-2 ring-indigo-400':''}`}></button>)}</div>
                    </div>
                    <div className="space-y-2 max-h-[300px] overflow-y-auto">{list.map((s,i)=><div key={i} className="flex justify-between p-3 bg-white border rounded-xl"><span className="text-sm font-bold">{s.name}</span><button onClick={()=>{const n=[...list];n.splice(i,1);setList(n)}} className="text-slate-300 hover:text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button></div>)}</div>
                    <button onClick={()=>onSave(list)} className="w-full mt-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
                </div>
            );
        }

        // --- Admin Views ---
        function AdminDashboard({ users, requests, config, setActiveView }) {
            const pending = requests.filter(r => r.status === 'pending');
            const Stat = ({title, val, icon, color, onClick}) => (
                <div onClick={onClick} className="glass-card bg-white/80 p-4 rounded-2xl flex items-center justify-between cursor-pointer hover:scale-105 transition">
                    <div><p className="text-xs font-bold text-slate-400">{title}</p><h3 className="text-2xl font-black text-slate-800">{val}</h3></div>
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white ${color}`}><Icon name={icon} className="w-5 h-5"/></div>
                </div>
            );
            return (
                <div className="space-y-6 page-enter">
                    <h2 className="text-2xl font-black text-slate-800">å„€è¡¨æ¿</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <Stat title="ç¸½ç”¨æˆ¶" val={users.length} icon="users" color="bg-blue-500" onClick={()=>setActiveView('admin_users')} />
                        <Stat title="å¾…å¯©æ ¸" val={pending.length} icon="user-plus" color="bg-orange-500" onClick={()=>setActiveView('admin_requests')} />
                        <Stat title="ç‹€æ…‹" val={config?.maintenanceMode==='normal'?'æ­£å¸¸':'ç¶­è­·'} icon="activity" color={config?.maintenanceMode==='normal'?'bg-emerald-500':'bg-red-500'} onClick={()=>setActiveView('admin_settings')} />
                        <Stat title="æ¨¡å¼" val={config?.whitelistEnabled?'ç™½åå–®':'å…¬é–‹'} icon="shield" color="bg-slate-700" onClick={()=>setActiveView('admin_settings')} />
                    </div>
                </div>
            );
        }

        function AdminBroadcast({ publicItems, onCreate, onDelete, showAlert }) {
            const [desc, setDesc] = useState('');
            const [date, setDate] = useState(getNextSchoolDay());
            const [sub, setSub] = useState('é€šå‘Š');
            const handle = (e) => {
                e.preventDefault(); if(!desc) return;
                onCreate({description:desc, dueDate:date, subject:sub, createdAt:new Date().toISOString(), senderName:'å­¸æ ¡', forceExpired:false, type:'broadcast'});
                setDesc(''); setDate(getNextSchoolDay());
            };
            return (
                <div className="space-y-6 page-enter">
                    <div className="glass-card bg-white/90 p-6 rounded-[2rem]">
                        <h3 className="font-bold text-lg mb-4 text-indigo-900">ç™¼ä½ˆå…¨æ ¡é€šå‘Š</h3>
                        <form onSubmit={handle} className="space-y-4">
                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                {[{name:'é€šå‘Š',color:'bg-indigo-600 text-white'}, ...SUBJECTS].slice(0,6).map(s=><button key={s.name} type="button" onClick={()=>setSub(s.name)} className={`whitespace-nowrap px-3 py-1.5 rounded-lg text-xs font-bold border transition ${sub===s.name ? 'bg-slate-800 text-white' : 'bg-white text-slate-500'}`}>{s.name}</button>)}
                            </div>
                            <textarea value={desc} onChange={e=>setDesc(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm" rows="3" placeholder="å…§å®¹..." required></textarea>
                            <div className="flex gap-3"><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="flex-1 p-3 bg-slate-50 rounded-xl text-xs font-bold" /><button className="flex-1 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">ç™¼é€</button></div>
                        </form>
                    </div>
                    <div className="space-y-3 pb-20">
                        <h3 className="font-bold text-slate-400 text-xs">æ­·å²ç´€éŒ„</h3>
                        {publicItems.map(i=>(
                            <div key={i.id} className="bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                                <div><span className="text-xs bg-slate-100 px-2 py-0.5 rounded mr-2">{i.subject}</span><span className="font-bold text-sm text-slate-700">{i.description}</span></div>
                                <button onClick={()=>onDelete(i.id)} className="text-slate-300 hover:text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function AdminRequests({ requests, onAction }) {
            const pending = requests.filter(r => r.status === 'pending');
            return (
                <div className="space-y-4 page-enter pb-20">
                    <h2 className="text-2xl font-black text-slate-800">å…¥å­¸ç”³è«‹ ({pending.length})</h2>
                    {pending.map(req => (
                        <div key={req.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold">{req.displayName[0]}</div>
                                <div><div className="font-bold">{req.displayName}</div><div className="text-xs text-slate-400">{req.email}</div></div>
                            </div>
                            <div className="flex gap-2"><button onClick={()=>onAction(req,false)} className="flex-1 py-2 border rounded-lg text-xs font-bold">æ‹’çµ•</button><button onClick={()=>onAction(req,true)} className="flex-1 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold">æ‰¹å‡†</button></div>
                        </div>
                    ))}
                    {pending.length===0 && <div className="text-center py-10 text-slate-400">ç„¡å¾…è™•ç†ç”³è«‹</div>}
                </div>
            );
        }

        function AdminUsers({ users, config, onDelete, onToggleWL }) {
             return (
                 <div className="space-y-4 page-enter pb-20">
                     <h2 className="text-2xl font-black text-slate-800">ç”¨æˆ¶ç®¡ç† ({users.length})</h2>
                     {users.map(u => {
                         const isWL = config?.allowedEmails?.includes(u.email);
                         return (
                             <div key={u.id} className="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center">
                                 <div className="flex items-center gap-3">
                                     <div className="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">{u.displayName?.[0]}</div>
                                     <div><div className="font-bold text-sm text-slate-700">{u.displayName}</div><div className="text-xs text-slate-400">{u.email}</div></div>
                                 </div>
                                 <div className="flex gap-2">
                                     <button onClick={()=>onToggleWL(u.email)} className={`p-2 rounded-lg ${isWL?'text-green-600 bg-green-50':'text-slate-400 bg-slate-100'}`}><Icon name={isWL?'shield-check':'lock'} className="w-4 h-4"/></button>
                                     <button onClick={()=>onDelete(u)} className="p-2 text-red-500 bg-red-50 rounded-lg"><Icon name="trash-2" className="w-4 h-4"/></button>
                                 </div>
                             </div>
                         );
                     })}
                 </div>
             );
        }

        function AdminSettings({ config, onUpdate }) {
            return (
                <div className="space-y-6 page-enter pb-20">
                    <h2 className="text-2xl font-black text-slate-800">ç³»çµ±è¨­å®š</h2>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold">ç¶­è­·æ¨¡å¼</h3><div className="flex bg-slate-100 p-1 rounded-lg"><button onClick={()=>onUpdate('maintenanceMode','normal')} className={`px-3 py-1 text-xs font-bold rounded ${config?.maintenanceMode==='normal'?'bg-white shadow':''}`}>æ­£å¸¸</button><button onClick={()=>onUpdate('maintenanceMode','updating')} className={`px-3 py-1 text-xs font-bold rounded ${config?.maintenanceMode!=='normal'?'bg-white shadow':''}`}>ç¶­è­·</button></div></div>
                        {config?.maintenanceMode!=='normal' && (
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-2">{MAINTENANCE_PRESETS.map(p=><button key={p.id} onClick={()=>{onUpdate('customBlockTitle',p.title);onUpdate('customBlockMessage',p.msg)}} className="p-2 border rounded text-xs">{p.title}</button>)}</div>
                                <input value={config?.estimatedTime||''} onChange={e=>onUpdate('estimatedTime',e.target.value)} className="w-full p-2 border rounded text-sm" placeholder="æ¢å¾©æ™‚é–“" />
                            </div>
                        )}
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                        <h3 className="font-bold">ç™½åå–®æ¨¡å¼</h3>
                        <button onClick={()=>onUpdate('whitelistEnabled',!config?.whitelistEnabled)} className={`w-10 h-6 rounded-full relative transition ${config?.whitelistEnabled?'bg-indigo-600':'bg-slate-300'}`}><div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition ${config?.whitelistEnabled?'translate-x-4':''}`}></div></button>
                    </div>
                </div>
            );
        }

        // --- APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');
            const [items, setItems] = useState([]);
            const [config, setConfig] = useState(null);
            const [authModalOpen, setAuthModalOpen] = useState(false);
            const [notify, setNotify] = useState({open:false, type:'', msg:'', action:null});

            // Admin Data
            const [allUsers, setAllUsers] = useState([]);
            const [allReqs, setAllReqs] = useState([]);
            const [publicItems, setPublicItems] = useState([]);

            // User Data
            const [manualDay, setManualDay] = useState(new Date().getDay());
            const [schedule, setSchedule] = useState(DEFAULT_SCHEDULE);
            const [subjects, setSubjects] = useState(SUBJECTS);
            const [times, setTimes] = useState(DEFAULT_START_TIMES);
            const [durations, setDurations] = useState(DEFAULT_DURATIONS);
            
            // Inputs
            const [desc, setDesc] = useState('');
            const [date, setDate] = useState('');
            const [sub, setSub] = useState('ä¸­æ–‡');
            const [filterSubject, setFilterSubject] = useState('å…¨éƒ¨');
            const [sortOption, setSortOption] = useState('date_asc');

            const alertMsg = (msg, type='info') => setNotify({open:true, type, msg});
            const confirmMsg = (msg, action) => setNotify({open:true, type:'confirm', msg, action});

            useEffect(() => {
                const init = () => {
                    if(window.fb && window.fb.isReady) {
                        const { auth, db, onAuthStateChanged, doc, onSnapshot } = window.fb;
                        onAuthStateChanged(auth, u => { setUser(u); setLoading(false); if(u) setDate(new Date().toISOString().split('T')[0]); });
                        onSnapshot(doc(db, "system_settings", "config"), s => setConfig(s.data()));
                    } else { setTimeout(init, 100); }
                };
                init();
            }, []);

            useEffect(() => {
                if(!user || !window.fb) return;
                const { db, collection, doc, onSnapshot, query, orderBy, where, getDocs, addDoc } = window.fb;
                
                // Admin Listeners
                if(user.email === ADMIN_EMAIL) {
                     onSnapshot(query(collection(db, "users_public"), orderBy("lastSeen", "desc")), s => setAllUsers(s.docs.map(d=>({id:d.id,...d.data()}))));
                     onSnapshot(query(collection(db, "access_requests"), orderBy("requestTime", "desc")), s => setAllReqs(s.docs.map(d=>({id:d.id,...d.data()}))));
                     onSnapshot(query(collection(db, "public_assignments"), orderBy("createdAt", "desc")), s => setPublicItems(s.docs.map(d=>({id:d.id,...d.data()}))));
                }

                // User Listeners
                if(config?.whitelistEnabled && !config?.allowedEmails?.includes(user.email) && user.email !== ADMIN_EMAIL) return;

                const unsubItems = onSnapshot(query(collection(db, "users", user.uid, "items")), s => setItems(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubSettings = onSnapshot(doc(db, "users", user.uid, "settings", "timetable"), s => { if(s.exists()) { const d=s.data(); if(d.schedule) setSchedule(d.schedule); }});
                const unsubSubj = onSnapshot(doc(db, "users", user.uid, "settings", "subjects"), s => { if(s.exists() && s.data().list) setSubjects(s.data().list); });
                
                const qPublic = query(collection(db, "public_assignments"), orderBy("createdAt", "desc"));
                const unsubPublic = onSnapshot(qPublic, snapshot => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const publicId = change.doc.id;
                            const checkSnap = await getDocs(query(collection(db, "users", user.uid, "items"), where("publicRefId", "==", publicId)));
                            if(checkSnap.empty) {
                                await addDoc(collection(db, "users", user.uid, "items"), { ...change.doc.data(), publicRefId: publicId, completed: false });
                                alertMsg(`ğŸ“¢ æ–°åŠŸèª²: ${change.doc.data().subject}`);
                            }
                        }
                    });
                });

                return () => { unsubItems(); unsubSettings(); unsubSubj(); unsubPublic(); }
            }, [user, config]);

            // Handlers
            const handleGoogleLogin = () => window.fb.signInWithPopup(window.fb.auth, window.fb.provider).then(()=>setAuthModalOpen(false)).catch(e=>alert(e.message));
            const handleEmailAuth = async (email, pwd, isReg, name) => { const { auth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, db, doc, setDoc, serverTimestamp } = window.fb; try { if(isReg) { const cred = await createUserWithEmailAndPassword(auth, email, pwd); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users_public", cred.user.uid), { email: email, displayName: name, lastSeen: serverTimestamp() }, { merge: true }); } else { await signInWithEmailAndPassword(auth, email, pwd); } setAuthModalOpen(false); } catch(e) { alert("æ“ä½œå¤±æ•—: " + e.message); } };
            
            // User Actions
            const handleAddHomework = async (e) => { e.preventDefault(); if(!desc || !date) return; await window.fb.addDoc(window.fb.collection(window.fb.db, "users", user.uid, "items"), { description: desc, subject: sub, dueDate: date, completed: false, type: 'homework', createdAt: new Date().toISOString() }); setDesc(''); alertMsg("å·²æ–°å¢", 'success'); };
            const toggleItem = async (item) => { await window.fb.updateDoc(window.fb.doc(window.fb.db, "users", user.uid, "items", item.id), { completed: !item.completed }); };
            const deleteItem = async (id) => { confirmMsg("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ", async () => await window.fb.deleteDoc(window.fb.doc(window.fb.db, "users", user.uid, "items", id))); };
            const saveSubjects = async (newList) => { await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "settings", "subjects"), { list: newList }, { merge: true }); setSubjects(newList); setView('home'); };

            // Admin Actions
            const adminBroadcast = async (data) => { confirmMsg("ç¢ºå®šç™¼é€é€šå‘Šï¼Ÿ", async () => { try { await window.fb.addDoc(window.fb.collection(window.fb.db,"public_assignments"), data); alertMsg("å·²ç™¼é€", 'success'); } catch(e) { alertMsg("å¤±æ•—", 'error'); } }); };
            const adminDeleteBroadcast = async (id) => { confirmMsg("åˆªé™¤é€šå‘Šä¸¦æ¸…ç†å­¸ç”Ÿç´€éŒ„ï¼Ÿ", async () => { 
                await window.fb.deleteDoc(window.fb.doc(window.fb.db,"public_assignments",id));
                const allU = await window.fb.getDocs(window.fb.collection(window.fb.db, "users_public"));
                for(const u of allU.docs) {
                    const q = window.fb.query(window.fb.collection(window.fb.db, "users", u.id, "items"), window.fb.where("publicRefId", "==", id));
                    const snap = await window.fb.getDocs(q);
                    snap.forEach(d => window.fb.deleteDoc(d.ref));
                }
                alertMsg("å·²å®Œæˆæ¸…ç†", 'success');
            }); };
            const adminReq = async (req, ok) => { if(ok) await window.fb.updateDoc(window.fb.doc(window.fb.db,"system_settings","config"), {allowedEmails: window.fb.arrayUnion(req.email)}); await window.fb.deleteDoc(window.fb.doc(window.fb.db,"access_requests",req.id)); alertMsg(ok?"å·²æ‰¹å‡†":"å·²æ‹’çµ•"); };
            const adminUpdateConfig = (k,v) => window.fb.updateDoc(window.fb.doc(window.fb.db,"system_settings","config"), {[k]:v});
            const adminDeleteUser = (u) => { confirmMsg(`åˆªé™¤ ${u.displayName}?`, async () => { 
                // ... (Deep delete logic simplified for space)
                const {db,doc,deleteDoc} = window.fb;
                await deleteDoc(doc(db,"users_public",u.id));
                alertMsg("å·²åˆªé™¤", 'success');
            }); };

            // Helpers
            const activeItems = items.filter(i => !i.completed);
            const finishedItems = items.filter(i => i.completed);
            const getFilteredItems = () => { let f = [...activeItems]; if(filterSubject!=='å…¨éƒ¨') f = f.filter(i=>i.subject===filterSubject); if(sortOption==='date_asc') f.sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate)); else f.sort((a,b)=>new Date(b.dueDate)-new Date(a.dueDate)); return f; };
            const todayCount = activeItems.filter(i => getDaysRemaining(i.dueDate) <= 0).length;
            const tomorrowCount = activeItems.filter(i => getDaysRemaining(i.dueDate) === 1).length;
            const futureCount = activeItems.filter(i => getDaysRemaining(i.dueDate) > 1).length;
            const testCount = activeItems.filter(i => i.subject.includes('æ¸¬é©—') || i.description.includes('æ¸¬é©—')).length;

            if(loading) return <div className="h-screen flex items-center justify-center text-slate-400 font-bold">è¼‰å…¥ä¸­...</div>;

            // Block Screen
            if(user && config?.whitelistEnabled && !config?.allowedEmails?.includes(user.email) && user.email !== ADMIN_EMAIL) return <BlockScreen type="access_denied" user={user} onLogin={()=>{}} triggerAlert={alertMsg} />;

            // Login Screen
            if(!user) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden mesh-bg">
                         <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-500 rounded-full blur-[150px] opacity-30 animate-float"></div>
                         <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-purple-500 rounded-full blur-[150px] opacity-30 animate-float" style={{animationDelay:'-3s'}}></div>
                         <div className="glass-card p-10 rounded-[2.5rem] w-full max-w-md text-center relative z-10 modal-animate border border-white/20 shadow-2xl">
                             <div className="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-xl rotate-6 text-white transform hover:rotate-12 transition duration-500 hover:scale-105"><Icon name="graduation-cap" className="w-12 h-12"/></div>
                             <h1 className="text-4xl font-black text-slate-800 mb-3 tracking-tight">é›»å­æ‰‹å†Š</h1>
                             <p className="text-slate-500 mb-10 font-medium text-lg">ä½ çš„æ™ºèƒ½å­¸ç¿’åŠ©æ‰‹</p>
                             <button onClick={handleGoogleLogin} className="w-full py-4 bg-white border border-slate-100 rounded-2xl font-bold text-slate-700 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3 group"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6 group-hover:scale-110 transition-transform"/> <span className="text-base">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span></button>
                             <div className="mt-6"><button onClick={()=>setAuthModalOpen(true)} className="text-sm font-bold text-slate-400 hover:text-indigo-600 transition">æˆ–ä½¿ç”¨ Email ç™»å…¥/è¨»å†Š</button></div>
                         </div>
                         {authModalOpen && <AuthModal onClose={()=>setAuthModalOpen(false)} onLogin={handleGoogleLogin} onEmailLogin={handleEmailAuth} triggerAlert={alertMsg} />}
                    </div>
                );
            }

            // --- ADMIN VIEW ---
            if(view.startsWith('admin')) {
                return (
                    <div className="min-h-screen bg-slate-50 relative pb-28 md:pb-8 max-w-md mx-auto mesh-bg-soft">
                        <header className="flex justify-between items-center p-4">
                            <h1 className="text-2xl font-black text-slate-800">ç®¡ç†å¾Œå°</h1>
                            <button onClick={()=>setView('home')} className="px-4 py-2 bg-white rounded-xl shadow text-xs font-bold text-indigo-600">è¿”å›å­¸ç”Ÿç‰ˆ</button>
                        </header>
                        <div className="p-4">
                            {view==='admin_dashboard' && <AdminDashboard users={allUsers} requests={allReqs} config={config} setActiveView={setView} />}
                            {view==='admin_broadcast' && <AdminBroadcast publicItems={publicItems} onCreate={adminBroadcast} onDelete={adminDeleteBroadcast} showAlert={alertMsg} />}
                            {view==='admin_requests' && <AdminRequests requests={allReqs} onAction={adminReq} />}
                            {view==='admin_users' && <AdminUsers users={allUsers} config={config} onDelete={adminDeleteUser} onToggleWL={(e)=>adminUpdateConfig('allowedEmails', config.allowedEmails.includes(e)?window.fb.arrayRemove(e):window.fb.arrayUnion(e))} />}
                            {view==='admin_settings' && <AdminSettings config={config} onUpdate={adminUpdateConfig} />}
                        </div>
                         {/* Admin Nav */}
                         <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-xl text-white px-4 py-2 rounded-full shadow-2xl flex gap-4 z-40 border border-white/10">
                            <button onClick={()=>setView('admin_dashboard')} className={`p-2 rounded-full ${view==='admin_dashboard'?'text-white':'text-slate-400'}`}><Icon name="layout-dashboard"/></button>
                            <button onClick={()=>setView('admin_broadcast')} className={`p-2 rounded-full ${view==='admin_broadcast'?'text-white':'text-slate-400'}`}><Icon name="megaphone"/></button>
                            <button onClick={()=>setView('admin_requests')} className={`p-2 rounded-full ${view==='admin_requests'?'text-white':'text-slate-400'}`}><Icon name="inbox"/></button>
                            <button onClick={()=>setView('admin_settings')} className={`p-2 rounded-full ${view==='admin_settings'?'text-white':'text-slate-400'}`}><Icon name="settings"/></button>
                        </div>
                         <NotificationModal isOpen={notify.open} type={notify.type} message={notify.msg} onConfirm={notify.action} onClose={()=>setNotify({open:false})}/>
                    </div>
                )
            }

            // --- STUDENT VIEW ---
            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4 pb-28 md:pb-8 max-w-md mx-auto relative">
                    <NotificationModal isOpen={notify.open} type={notify.type} message={notify.msg} onConfirm={notify.action} onClose={()=>setNotify({open:false})}/>
                    <header className="flex justify-between items-center mb-6 py-2">
                        <div className="flex flex-col"><span className="text-xs font-bold text-slate-500 uppercase tracking-widest">Welcome</span><h1 className="text-3xl font-black text-slate-800 tracking-tight">{user.displayName}</h1></div>
                        <div className="flex gap-2">
                            {user.email===ADMIN_EMAIL && <button onClick={()=>setView('admin_dashboard')} className="p-3 bg-slate-800 text-white rounded-2xl shadow-lg transition hover:scale-105 active:scale-95"><Icon name="shield" className="w-5 h-5"/></button>}
                            <button onClick={()=>setView(view==='settings'?'home':'settings')} className="p-3 bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-white/50 text-slate-600 hover:text-indigo-600 transition hover:scale-105 active:scale-95"><Icon name="settings" className="w-5 h-5"/></button>
                            <button onClick={()=>window.fb.signOut(window.fb.auth)} className="p-3 bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-white/50 text-slate-400 hover:text-red-500 transition hover:scale-105 active:scale-95"><Icon name="log-out" className="w-5 h-5"/></button>
                        </div>
                    </header>

                    {view === 'timetable' ? (
                        <div className="glass-card bg-white/90 rounded-[2rem] p-6 shadow-xl min-h-[500px] page-enter">
                            <div className="flex items-center gap-4 mb-6"><button onClick={()=>setView('home')} className="p-2 hover:bg-slate-100 rounded-full transition"><Icon name="arrow-left" className="w-6 h-6"/></button><h2 className="text-2xl font-black text-slate-800">å®Œæ•´æ™‚é–“è¡¨</h2></div>
                            <Timetable currentDay={manualDay} subjects={schedule} timeConfig={DEFAULT_START_TIMES} durations={DEFAULT_DURATIONS} manualDay={manualDay} setManualDay={setManualDay} />
                        </div>
                    ) : view === 'settings' ? (
                        <UserSettings subjects={subjects} onSave={saveSubjects} onBack={()=>setView('home')} />
                    ) : (
                        <div className="page-enter space-y-6">
                            <LiveLessonCard schedule={schedule} times={DEFAULT_START_TIMES} durations={DEFAULT_DURATIONS} currentDay={manualDay} user={user} />
                            
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center"><div className="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-500 mb-2"><Icon name="flame" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{todayCount}</div><div className="text-[10px] font-bold text-slate-400 uppercase">ä»Šæ—¥è¦äº¤</div></div>
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center"><div className="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 mb-2"><Icon name="sun" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{tomorrowCount}</div><div className="text-[10px] font-bold text-slate-400 uppercase">è½æ—¥è¦äº¤</div></div>
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center"><div className="w-10 h-10 rounded-full bg-sky-50 flex items-center justify-center text-sky-500 mb-2"><Icon name="calendar-range" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{futureCount}</div><div className="text-[10px] font-bold text-slate-400 uppercase">æ—¥å¾Œè¦äº¤</div></div>
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center"><div className="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 mb-2"><Icon name="brain-circuit" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{testCount}</div><div className="text-[10px] font-bold text-slate-400 uppercase">æº«ç¿’è€ƒæ ¸</div></div>
                            </div>

                            <div className="glass-card bg-white/90 p-6 rounded-[2rem] shadow-xl relative overflow-hidden">
                                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2 relative z-10"><Icon name="plus-circle" className="w-5 h-5 text-indigo-600"/> å¿«é€Ÿæ–°å¢</h3>
                                <form onSubmit={handleAddHomework} className="space-y-4 relative z-10">
                                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2">
                                        {subjects.map(s=><button key={s.name} type="button" onClick={()=>setSub(s.name)} className={`whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold border-2 transition ${sub===s.name ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-500 border-slate-100 hover:border-slate-300'}`}>{s.name}</button>)}
                                    </div>
                                    <div className="flex gap-3">
                                        <input value={desc} onChange={e=>setDesc(e.target.value)} className="flex-1 p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-100 focus:bg-white transition" placeholder="åŠŸèª²å…§å®¹..." required />
                                        <button className="w-14 h-14 bg-slate-900 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-black transition active:scale-95 shrink-0"><Icon name="arrow-up" className="w-6 h-6"/></button>
                                    </div>
                                    <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full p-3 bg-white border border-slate-100 rounded-xl text-xs font-bold text-slate-500 outline-none" required />
                                </form>
                            </div>

                            <div className="space-y-3 pb-4">
                                {getFilteredItems().map((item, idx) => (
                                    <div key={item.id} className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex gap-4 items-start group list-item-enter" style={{animationDelay: `${idx*0.05}s`}}>
                                        <button onClick={()=>toggleItem(item)} className="mt-1 w-6 h-6 rounded-full border-2 border-slate-200 flex items-center justify-center hover:border-emerald-500 hover:bg-emerald-50 transition shrink-0 group/btn bg-white">
                                            <Icon name="check" className="w-3.5 h-3.5 text-emerald-500 opacity-0 group-hover/btn:opacity-100 transition"/>
                                        </button>
                                        <div className="flex-1">
                                            <div className="flex justify-between mb-1">
                                                <span className="text-[10px] font-black bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md">{item.subject}</span>
                                                <span className={`text-[10px] font-mono font-bold ${getDaysRemaining(item.dueDate)<0?'text-red-500':'text-slate-400'}`}>{item.dueDate}</span>
                                            </div>
                                            <p className="text-sm font-bold text-slate-700 leading-relaxed">{item.description}</p>
                                            {item.senderName && <div className="mt-2 text-[10px] text-slate-400 flex items-center gap-1 bg-slate-50 w-fit px-2 py-0.5 rounded-full"><Icon name="rss" className="w-3 h-3"/> {item.senderName}</div>}
                                        </div>
                                        <button onClick={()=>deleteItem(item.id)} className="text-slate-300 hover:text-red-400 transition opacity-0 group-hover:opacity-100"><Icon name="trash-2" className="w-4 h-4"/></button>
                                    </div>
                                ))}
                                {activeItems.length === 0 && <div className="text-center text-slate-400 py-12 flex flex-col items-center"><Icon name="coffee" className="w-12 h-12 mb-3 opacity-20"/>å¤ªæ£’äº†ï¼æš«æ™‚æ²’æœ‰åŠŸèª²</div>}
                                
                                {finishedItems.length > 0 && (
                                    <div className="mt-8 pt-8 border-t border-slate-200/50">
                                        <h3 className="font-bold text-slate-400 text-xs uppercase tracking-wider mb-4 px-2">å·²å®Œæˆ ({finishedItems.length})</h3>
                                        <div className="space-y-2 opacity-60 hover:opacity-100 transition duration-300">
                                            {finishedItems.map(item => (
                                                <div key={item.id} className="bg-slate-50 p-3 rounded-xl flex gap-3 items-center mb-2 border border-transparent hover:border-slate-200 transition">
                                                    <div className="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white shrink-0"><Icon name="check" className="w-3 h-3"/></div>
                                                    <div className="flex-1 line-through text-slate-400 text-xs font-medium">{item.description}</div>
                                                    <button onClick={()=>deleteItem(item.id)} className="text-slate-300 hover:text-red-400"><Icon name="trash-2" className="w-3 h-3"/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Modern Bottom Nav */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-xl text-white px-2 py-2 rounded-full shadow-2xl flex gap-2 z-40 border border-white/10 ring-1 ring-black/5">
                        <button onClick={()=>setView('home')} className={`p-3 rounded-full transition-all duration-300 ${view==='home'?'bg-white text-slate-900 scale-105 shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="layout-grid" className="w-5 h-5"/></button>
                        <button onClick={()=>setView('timetable')} className={`p-3 rounded-full transition-all duration-300 ${view==='timetable'?'bg-white text-slate-900 scale-105 shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="calendar" className="w-5 h-5"/></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>