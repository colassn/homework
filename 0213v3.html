<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>é›»å­æ‰‹å†Š</title>

    <!-- 
        === é›»å­æ‰‹å†Š v2.5 Premium === 
        å‡ç´šé‡é»ï¼šUI/UX è³ªæ„Ÿã€Inter å­—é«”ã€æ¥µå…‰èƒŒæ™¯ã€äº’å‹•å¾®å‹•ç•«
    -->

    <!-- 1. å­—é«”: Inter (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- 2. React æ ¸å¿ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin onerror="this.onerror=null; this.src='https://unpkg.com/react@18/umd/react.production.min.js'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin onerror="this.onerror=null; this.src='https://unpkg.com/react-dom@18/umd/react-dom.production.min.js'"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" onerror="this.onerror=null; this.src='https://unpkg.com/@babel/standalone/babel.min.js'"></script>

    <!-- 3. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' } // æ›´æ·±é‚ƒçš„å¤œé–“æ¨¡å¼èƒŒæ™¯
                    },
                    animation: {
                        'pop-in': 'popIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'gradient-x': 'gradient-x 8s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 10s infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' },
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'blob': {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        'fadeInUp': {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/lucide@latest'"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.4s ease, color 0.4s ease; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è—æª”æ¡ˆè¼¸å…¥æ¡† */
        input[type="file"]::file-selector-button { display: none; }

        /* å…¨å±€æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* å‹•ç•«é¡åˆ¥ */
        .modal-animate { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-item { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        
        @keyframes popIn { 
            0% { opacity: 0; transform: scale(0.95) translateY(10px); } 
            100% { opacity: 1; transform: scale(1) translateY(0); } 
        }

        @keyframes popInError {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .pop-in-error { animation: popInError 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .guest-blur { filter: blur(8px) grayscale(80%); opacity: 0.6; pointer-events: none; user-select: none; transition: all 0.8s ease; transform: scale(0.98); }

        @keyframes glowing { 0% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 20px currentColor; } 100% { box-shadow: 0 0 5px currentColor; } }
        .btn-glow { animation: glowing 2s infinite; }

        @keyframes marquee { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 20s linear infinite; will-change: transform; }
        .animate-marquee:hover { animation-play-state: paused; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }

        /* Loading Screen */
        #loading-screen {
            position: fixed; inset: 0; z-index: 9999;
            background-color: #f8fafc; color: #475569;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Inter', sans-serif; transition: opacity 0.5s ease;
        }
        .dark #loading-screen { background-color: #020617; color: #cbd5e1; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-loader { opacity: 0; pointer-events: none; }

        /* Glass Utility */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 selection:bg-indigo-500 selection:text-white">
    
    <div id="loading-screen">
        <div class="spinner"></div>
        <h2 style="font-size: 1.2rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -0.025em;">æ­£åœ¨å•Ÿå‹•é›»å­æ‰‹å†Š...</h2>
        <p style="font-size: 0.8rem; opacity: 0.6; font-weight: 500;">Premium v2.5</p>
        <p id="error-message" style="font-size: 0.8rem; color: #ef4444; margin-top: 1rem; display: none;">
            âš ï¸ ç³»çµ±åµæ¸¬åˆ°ç¶²è·¯è³‡æºè¼‰å…¥ç•°å¸¸ã€‚<br>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚
        </p>
    </div>

    <div id="root"></div>

    <!-- Firebase æ¨¡çµ„ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3gYuwnyoTUwO7PFh4Nuue-Ud8GTruuRk",
            authDomain: "recordhwv2.firebaseapp.com",
            projectId: "recordhwv2",
            storageBucket: "recordhwv2.firebasestorage.app",
            messagingSenderId: "599261009391",
            appId: "1:599261009391:web:66cd7f932650bebc0e521a",
            measurementId: "G-C51XDYW67W"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const googleProvider = new GoogleAuthProvider();

            window.firebaseServices = { 
                auth, db, googleProvider, 
                signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, 
                collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc, writeBatch 
            };
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').innerText = "ç„¡æ³•é€£æ¥è³‡æ–™åº« (Firebase CDN Error)";
        }
    </script>

    <!-- PWA Setup -->
    <script>
        (function setupPWA() {
            const manifest = {
                name: "é›»å­æ‰‹å†Š", short_name: "é›»å­æ‰‹å†Š", start_url: ".", display: "standalone",
                background_color: "#ffffff", theme_color: "#4f46e5",
                icons: [{ src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%234f46e5' rx='24'/%3E%3Cpath fill='%23fff' d='M30 30h40v40H30z'/%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestURL}">`);
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const ADMIN_EMAIL = 'chimhinhin@gmail.com'; 

        const DEFAULT_SUBJECTS = [
            { name: 'ä¸­æ–‡', color: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800' },
            { name: 'è‹±æ–‡', color: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800' },
            { name: 'æ•¸å­¸', color: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800' },
            { name: 'å…¬ç¤¾', color: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800' },
            { name: 'ä½›å­¸', color: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800' },
            { name: 'ç”Ÿç‰©', color: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800' },
            { name: 'ç‰©ç†', color: 'bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-400 dark:border-cyan-800' },
            { name: 'åŒ–å­¸', color: 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800' },
            { name: 'æ­·å²', color: 'bg-stone-100 text-stone-700 border-stone-200 dark:bg-stone-900/30 dark:text-stone-400 dark:border-stone-800' },
            { name: 'é›»è…¦', color: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800' },
            { name: 'å…¶ä»–', color: 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700' }
        ];

        const COLOR_PALETTE = [
            { label: 'ç´…', value: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800' },
            { label: 'æ©™', value: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800' },
            { label: 'é»ƒ', value: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800' },
            { label: 'ç¶ ', value: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800' },
            { label: 'ç¿¡ç¿ ', value: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800' },
            { label: 'å¤©è—', value: 'bg-sky-100 text-sky-700 border-sky-200 dark:bg-sky-900/30 dark:text-sky-400 dark:border-sky-800' },
            { label: 'è—', value: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800' },
            { label: 'é›', value: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800' },
            { label: 'ç´«', value: 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800' },
            { label: 'çŸ³æ¿', value: 'bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700' },
        ];

        const THEME_CONFIG = {
            indigo: { name: 'é›è—', text: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-600 hover:bg-indigo-700', ring: 'ring-indigo-100 dark:ring-indigo-900', gradient: 'from-indigo-600 to-blue-600', lightBg: 'bg-indigo-50 dark:bg-indigo-900/20', border: 'border-indigo-200 dark:border-indigo-800', shadow: 'shadow-indigo-200/50 dark:shadow-indigo-900/20' },
            rose: { name: 'æ«»ç²‰', text: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-600 hover:bg-rose-700', ring: 'ring-rose-100 dark:ring-rose-900', gradient: 'from-rose-600 to-pink-600', lightBg: 'bg-rose-50 dark:bg-rose-900/20', border: 'border-rose-200 dark:border-rose-800', shadow: 'shadow-rose-200/50 dark:shadow-rose-900/20' },
            emerald: { name: 'ç¿¡ç¿ ', text: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-600 hover:bg-emerald-700', ring: 'ring-emerald-100 dark:ring-emerald-900', gradient: 'from-emerald-600 to-teal-600', lightBg: 'bg-emerald-50 dark:bg-emerald-900/20', border: 'border-emerald-200 dark:border-emerald-800', shadow: 'shadow-emerald-200/50 dark:shadow-emerald-900/20' },
            amber: { name: 'ç¥ç€', text: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-500 hover:bg-amber-600', ring: 'ring-amber-100 dark:ring-amber-900', gradient: 'from-amber-500 to-orange-500', lightBg: 'bg-amber-50 dark:bg-amber-900/20', border: 'border-amber-200 dark:border-amber-800', shadow: 'shadow-amber-200/50 dark:shadow-amber-900/20' },
            violet: { name: 'ç´«ç¾…è˜­', text: 'text-violet-600 dark:text-violet-400', bg: 'bg-violet-600 hover:bg-violet-700', ring: 'ring-violet-100 dark:ring-violet-900', gradient: 'from-violet-600 to-purple-600', lightBg: 'bg-violet-50 dark:bg-violet-900/20', border: 'border-violet-200 dark:border-violet-800', shadow: 'shadow-violet-200/50 dark:shadow-violet-900/20' },
            sky: { name: 'å¤©ç©º', text: 'text-sky-600 dark:text-sky-400', bg: 'bg-sky-500 hover:bg-sky-600', ring: 'ring-sky-100 dark:ring-sky-900', gradient: 'from-sky-500 to-blue-500', lightBg: 'bg-sky-50 dark:bg-sky-900/20', border: 'border-sky-200 dark:border-sky-800', shadow: 'shadow-sky-200/50 dark:shadow-sky-900/20' },
            zinc: { name: 'é‹…ç°', text: 'text-zinc-600 dark:text-zinc-300', bg: 'bg-zinc-700 hover:bg-zinc-800', ring: 'ring-zinc-100 dark:ring-zinc-800', gradient: 'from-zinc-600 to-slate-800', lightBg: 'bg-zinc-100 dark:bg-zinc-800/50', border: 'border-zinc-200 dark:border-zinc-700', shadow: 'shadow-zinc-200/50 dark:shadow-zinc-900/20' }
        };

        const DEFAULT_TIME_SLOTS = [
            { id: 'l1', label: 'ç¬¬1ç¯€', type: 'lesson', startTime: '08:30', duration: 35 },
            { id: 'l2', label: 'ç¬¬2ç¯€', type: 'lesson', startTime: '09:05', duration: 35 },
            { id: 'b1', label: 'å°æ¯', type: 'break', startTime: '09:40', duration: 15 },
            { id: 'l3', label: 'ç¬¬3ç¯€', type: 'lesson', startTime: '09:55', duration: 35 }
        ];

        const DEFAULT_SCHEDULE = { 1: [], 2: [], 3: [], 4: [], 5: [] };

        const Icon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' }); } catch(e) {}
                }
            }, [name, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        // Custom Dropdown Component (Moved up to prevent ReferenceError)
        function CustomDropdown({ value, onChange, options }) { 
            const [isOpen, setIsOpen] = useState(false); 
            const dropdownRef = useRef(null); 
            
            useEffect(() => { 
                const handleClickOutside = (event) => { 
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) { 
                        setIsOpen(false); 
                    } 
                }; 
                document.addEventListener('mousedown', handleClickOutside); 
                return () => document.removeEventListener('mousedown', handleClickOutside); 
            }, []); 
            
            const selectedLabel = options.find(o => o.value === value)?.label || 'æ’åº'; 
            
            return ( 
                <div className="relative" ref={dropdownRef}> 
                    <button type="button" onClick={() => setIsOpen(!isOpen)} className="glass-panel flex items-center gap-2 text-slate-600 dark:text-slate-300 text-xs rounded-xl px-4 py-2 font-bold hover:bg-white/50 dark:hover:bg-slate-700/50 transition-all shadow-sm active:scale-95"> 
                        <span>{selectedLabel}</span> <Icon name="chevron-down" className={`w-3 h-3 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} /> 
                    </button> 
                    {isOpen && ( 
                        <div className="absolute right-0 mt-2 w-48 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-xl border border-white/20 dark:border-slate-700 z-50 overflow-hidden animate-pop-in origin-top-right"> 
                            {options.map((opt) => ( 
                                <button key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`w-full text-left px-4 py-3 text-xs font-bold flex items-center gap-2 transition-colors ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800'}`}> 
                                    {opt.icon && <Icon name={opt.icon} className="w-3.5 h-3.5" />}
                                    {opt.label} 
                                </button> 
                            ))} 
                        </div> 
                    )} 
                </div> 
            ); 
        }

        const formatCountdown = (ms) => { const totalSeconds = Math.floor(ms / 1000); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };

        const formatTimeStr = (date) => { 
            try {
                if (!(date instanceof Date) || isNaN(date.getTime())) return '--:--';
                return date.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' }); 
            } catch(e) { return '--:--'; }
        };

        const formatRelativeTime = (lastSeen) => {
            if (!lastSeen || typeof lastSeen.toDate !== 'function') return 'ç„¡ç´€éŒ„';
            const date = lastSeen.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) return 'å‰›å‰›';
            if (diffMin < 60) return `${diffMin} åˆ†é˜å‰`;
            if (diffHour < 24) return `${diffHour} å°æ™‚å‰`;
            if (diffDay < 30) return `${diffDay} å¤©å‰`;
            return date.toLocaleDateString('zh-HK');
        };

        const generateFullSchedule = (config, now, dayOverride = null) => {
            if (!config || !Array.isArray(config.timeSlots)) return [];
            const day = dayOverride !== null ? dayOverride : now.getDay();
            if (day === 0 || day === 6) return []; 
            const daySubjects = config.schedule?.[day] || [];
            let lessonIndex = 0;
            const baseDate = new Date(now); baseDate.setHours(0,0,0,0);

            return config.timeSlots.map(slot => {
                const timeStr = slot.startTime || "00:00";
                const parts = timeStr.split(':');
                const h = parseInt(parts[0]) || 0;
                const m = parseInt(parts[1]) || 0;

                const start = new Date(baseDate); start.setHours(h, m, 0, 0);
                const end = new Date(start.getTime() + (parseInt(slot.duration) || 35) * 60000);

                let subject = slot.label || '';
                if (slot.type === 'lesson') { subject = daySubjects[lessonIndex] || '---'; lessonIndex++; }
                return { ...slot, start, end, subjectName: subject };
            });
        };

        const getNextLesson = (subjectName, now, config) => {
            if (!subjectName || subjectName === 'å…¶ä»–') return null;
            const schedule = generateFullSchedule(config, now);
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const currentSeconds = now.getSeconds();

            for (let slot of schedule) {
                if (slot.type === 'lesson' && (slot.subjectName.includes(subjectName) || subjectName.includes(slot.subjectName))) {
                    const startH = slot.start.getHours();
                    const startM = slot.start.getMinutes();
                    const startTotalMins = startH * 60 + startM;
                    const endTotalMins = startTotalMins + slot.duration;

                    if (currentMinutes >= startTotalMins && currentMinutes < endTotalMins) return { type: 'now', diff: 0 };
                    if (currentMinutes < startTotalMins) {
                        const diffMs = ((startTotalMins * 60) - (currentMinutes * 60 + currentSeconds)) * 1000;
                        return { type: 'future', diff: diffMs };
                    }
                }
            }
            return null;
        };

        // --- View Components ---
        function LessonCountdown({ subject, config }) {
            const [now, setNow] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(timer); }, []);

            const nextLesson = getNextLesson(subject, now, config);
            if (!nextLesson) return null;
            if (nextLesson.type === 'now') {
                return <div className="text-[10px] font-bold text-red-600 flex items-center gap-1 mt-1 animate-pulse"><Icon name="flame" className="w-3 h-3" /> ä¸Šèª²ä¸­</div>;
            } else if (nextLesson.diff < 24 * 60 * 60 * 1000) { 
                return <div className="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-1 mt-1"><Icon name="alarm-clock" className="w-3 h-3" /> è·é›¢ä¸Šèª² {formatCountdown(nextLesson.diff)}</div>;
            }
            return null;
        }

        function CurrentLessonWidget({ config, t, onClick }) {
            const [now, setNow] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(timer); }, []);

            const day = now.getDay();
            if (day === 0 || day === 6) return <div className="glass-panel rounded-2xl p-6 mb-6 text-center shadow-lg"><div className="font-bold text-slate-500 dark:text-slate-400 flex items-center justify-center gap-2"><Icon name="coffee" className="w-6 h-6 text-orange-500"/> æ”¾å‡å•¦ï¼å¥½å¥½ä¼‘æ¯</div></div>;

            const schedule = generateFullSchedule(config, now);
            const currentMs = now.getTime();
            
            let currentSlot = null;
            let nextSlot = null;
            let status = 'ended';

            for (let i = 0; i < schedule.length; i++) {
                const s = schedule[i];
                if (currentMs >= s.start.getTime() && currentMs < s.end.getTime()) {
                    currentSlot = s;
                    status = s.type === 'lesson' ? 'current' : 'break';
                    nextSlot = schedule[i+1];
                    break;
                }
                if (currentMs < s.start.getTime()) {
                    nextSlot = s;
                    status = 'not-started';
                    break;
                }
            }

            if (!currentSlot && !nextSlot) status = 'ended';
            const diff = currentSlot ? (currentSlot.end.getTime() - currentMs) : (nextSlot ? (nextSlot.start.getTime() - currentMs) : 0);

            return (
                <div onClick={onClick} className="cursor-pointer mb-8 relative group">
                    <div className="absolute -inset-0.5 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-2xl blur opacity-30 group-hover:opacity-60 transition duration-500"></div>
                    <div className="relative glass-panel rounded-2xl p-5 flex items-center justify-between h-full transition-transform duration-300 hover:scale-[1.01]">
                        {/* Progress Bar within card */}
                        <div className="absolute top-0 left-0 h-[3px] bg-slate-200 dark:bg-slate-700 w-full opacity-30"></div>
                        <div className={`absolute top-0 left-0 h-[3px] transition-all duration-1000 ${status === 'current' ? 'bg-gradient-to-r from-violet-500 to-fuchsia-500 shadow-[0_0_10px_rgba(217,70,239,0.8)]' : 'bg-transparent'}`} style={{ width: currentSlot ? `${100 - (diff / (currentSlot.end - currentSlot.start)) * 100}%` : '0%' }}></div>

                        <div className="flex-1 text-left min-w-0 z-10">
                            <div className="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase mb-1 flex items-center gap-1 tracking-wider">
                                {status === 'current' ? <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> : <Icon name="clock" className="w-3 h-3"/>}
                                {status === 'current' ? 'æ­£åœ¨ä¸Šèª²' : status === 'break' ? 'å°æ¯æ™‚é–“' : status === 'not-started' ? 'æº–å‚™ä¸Šèª²' : 'æ”¾å­¸'}
                            </div>
                            <div className="font-black text-2xl text-transparent bg-clip-text bg-gradient-to-r from-slate-900 to-slate-700 dark:from-white dark:to-slate-300 truncate">
                                {status === 'ended' ? 'ğŸ‰ æ˜¯æ—¥å·²å®Œçµ' : (currentSlot ? currentSlot.subjectName : '---')}
                            </div>
                        </div>

                        {(status !== 'ended') && (
                            <div className="flex-1 text-center z-10">
                                <div className={`text-3xl font-black font-mono tracking-tighter text-transparent bg-clip-text bg-gradient-to-br ${status === 'current' ? 'from-violet-600 to-fuchsia-600 dark:from-violet-400 dark:to-fuchsia-400' : 'from-slate-400 to-slate-600'}`}>
                                    {formatCountdown(diff)}
                                </div>
                                <div className="text-[9px] text-slate-400 font-bold tracking-widest uppercase mt-0.5">
                                    {status === 'current' ? 'REMAINING' : 'NEXT LESSON'}
                                </div>
                            </div>
                        )}

                        <div className="flex-1 text-right min-w-0 pl-2 z-10">
                            <div className="text-[10px] text-slate-400 font-bold uppercase mb-1 tracking-wider">ä¸‹ä¸€ç¯€</div>
                            <div className="font-bold text-sm text-slate-600 dark:text-slate-300 truncate">
                                {nextSlot ? nextSlot.subjectName : 'æ”¾å­¸'}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function CalendarWidget({ items, selectedDate, onSelectDate, t }) {
            const [currentMonth, setCurrentMonth] = useState(new Date());

            const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const endOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const startDate = startOfMonth.getDay(); 
            const daysInMonth = endOfMonth.getDate();

            const days = [];
            for (let i = 0; i < startDate; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i));

            const nextMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
            const prevMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
            
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const today = new Date();
            const todayWeekday = weekDays[today.getDay()];

            return (
                <div className="glass-panel rounded-3xl p-6 mb-6">
                    <div className="flex justify-between items-center mb-5">
                        <div className="flex flex-col">
                            <h3 className="font-bold text-xl dark:text-white flex items-center gap-2">
                                <Icon name="calendar" className={`w-5 h-5 ${t.text}`} />
                                {currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ
                            </h3>
                            <span className="text-xs text-slate-400 font-bold ml-7 mt-1 tracking-wide">ä»Šå¤©æ˜¯ æ˜ŸæœŸ{todayWeekday}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={prevMonth} className="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition active:scale-90"><Icon name="chevron-left" className="w-5 h-5 dark:text-white" /></button>
                            <button onClick={nextMonth} className="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition active:scale-90"><Icon name="chevron-right" className="w-5 h-5 dark:text-white" /></button>
                        </div>
                    </div>
                    <div className="calendar-grid text-center text-xs font-bold text-slate-400 dark:text-slate-500 mb-3">
                        {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((d, i) => <div key={d} className={`py-1 ${i===0||i===6 ? 'text-rose-500' : ''}`}>{d}</div>)}
                    </div>
                    <div className="calendar-grid">
                        {days.map((date, i) => {
                            if (!date) return <div key={`empty-${i}`} className="p-2"></div>;
                            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                            const dayItems = items.filter(item => item.dueDate === dateStr && !item.forceExpired && !item.completed);
                            const isSelected = selectedDate === dateStr;
                            const isToday = new Date().toDateString() === date.toDateString();
                            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                            const count = dayItems.length;

                            let badgeColor = 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300';
                            if (count >= 3) badgeColor = 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300';
                            if (count >= 6) badgeColor = 'bg-rose-100 text-rose-700 dark:bg-rose-900/50 dark:text-rose-300';

                            return (
                                <button 
                                    key={i} 
                                    onClick={() => onSelectDate(isSelected ? null : dateStr)}
                                    className={`relative aspect-square flex flex-col items-center justify-center rounded-2xl transition-all duration-300 border-2
                                        ${isSelected 
                                            ? `${t.border} ${t.lightBg} shadow-inner scale-95` 
                                            : (isToday 
                                                ? 'border-indigo-400 dark:border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 shadow-sm' 
                                                : 'border-transparent hover:bg-slate-50 dark:hover:bg-slate-800 hover:scale-105')
                                        }
                                    `}
                                >
                                    <span className={`text-sm sm:text-base font-bold ${isSelected ? t.text : (isToday ? 'text-indigo-700 dark:text-indigo-300' : (isWeekend ? 'text-rose-500' : 'text-slate-700 dark:text-slate-300'))}`}>
                                        {date.getDate()}
                                    </span>
                                    
                                    {isToday && <span className="text-[9px] font-bold text-indigo-500 dark:text-indigo-400 -mt-0.5 mb-0.5">ä»Šå¤©</span>}

                                    {count > 0 ? (
                                        <span className={`mt-1 text-[9px] sm:text-[10px] font-bold px-1.5 py-0.5 rounded-full ${badgeColor} transition-transform hover:scale-110`}>{count}</span>
                                    ) : (
                                        !isToday && <div className="h-4"></div>
                                    )}
                                </button>
                            );
                        })}
                    </div>
                    {selectedDate && (
                        <div className="mt-5 pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-sm animate-fade-in-up">
                            <span className="font-bold dark:text-white flex items-center gap-2"><Icon name="filter" className="w-4 h-4"/> ç¯©é¸: {selectedDate}</span>
                            <button onClick={() => onSelectDate(null)} className="text-slate-400 hover:text-rose-500 font-bold px-3 py-1 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors">æ¸…é™¤ç¯©é¸</button>
                        </div>
                    )}
                </div>
            );
        }

        function QuickViewModal({ isOpen, onClose, title, items, subjects, onEdit, onDelete, isAdmin, userUid }) {
            if (!isOpen) return null;

            const getDaysRemaining = (dString) => { 
                const today = new Date(); today.setHours(0,0,0,0); 
                const due = new Date(dString); due.setHours(0,0,0,0); 
                return Math.ceil((due - today) / 86400000); 
            };

            return (
                <div className="fixed inset-0 z-[160] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-900/95 rounded-3xl shadow-2xl w-full max-w-md p-6 relative z-10 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black text-slate-800 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors active:scale-90"><Icon name="x" className="w-6 h-6 text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="overflow-y-auto flex-1 pr-1 space-y-3">
                            {items.length === 0 ? (
                                <div className="text-center py-12 text-slate-400 flex flex-col items-center gap-4">
                                     <div className="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center"><Icon name="check-circle" className="w-8 h-8 text-slate-300"/></div>
                                     <p>æ²’æœ‰ç›¸é—œç´€éŒ„ ğŸ‰</p>
                                </div>
                            ) : items.map((item, idx) => {
                                const subjectStyle = subjects.find(s => s.name === item.subject)?.color || 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700';
                                const dl = getDaysRemaining(item.dueDate);
                                let statusText = `${dl} å¤©å¾Œ`;
                                let statusColor = "text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30";
                                if(dl < 0) { statusText = `éæœŸ ${Math.abs(dl)} å¤©`; statusColor = "text-rose-600 bg-rose-100 dark:bg-rose-900/30"; }
                                if(dl === 0) { statusText = "ä»Šæ—¥åˆ°æœŸ"; statusColor = "text-orange-600 bg-orange-100 dark:bg-orange-900/30 animate-pulse"; }

                                return (
                                    <div key={item.id} style={{ animationDelay: `${idx * 0.05}s` }} className="animate-item p-4 rounded-2xl border border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 flex flex-col gap-2 group hover:border-indigo-300 dark:hover:border-indigo-700 hover:shadow-md transition-all">
                                        <div className="flex justify-between items-start">
                                            <div className="flex gap-2 items-center">
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded border ${subjectStyle}`}>{item.subject}</span>
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${statusColor}`}>{statusText}</span>
                                            </div>
                                            <div className="flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                {!item.forceExpired && <button onClick={() => { onEdit(item); onClose(); }} className="p-1.5 text-slate-400 hover:text-blue-500 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:scale-110 transition"><Icon name="pencil" className="w-3.5 h-3.5" /></button>}
                                                <button onClick={() => { onDelete(item.id); }} className="p-1.5 text-slate-400 hover:text-rose-500 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:scale-110 transition"><Icon name="trash-2" className="w-3.5 h-3.5" /></button>
                                            </div>
                                        </div>
                                        <div className="font-bold text-slate-800 dark:text-slate-200 text-sm break-words leading-relaxed">{item.description}</div>
                                        <div className="text-xs text-slate-400 font-mono text-right">{item.dueDate}</div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        function BlockScreen({ type, estimatedTime, customMessage, customTitle, onLogin, user }) {
            const defaultMessage = (type === 'access_denied' || type === 'whitelist_blocked') ? 'æŠ±æ­‰ï¼Œæ­¤ç¶²ç«™ç›®å‰åƒ…é™ç™½åå–®ç”¨æˆ¶è¨ªå•ã€‚\nè«‹è¯çµ¡ç®¡ç†å“¡é–‹é€šæ¬Šé™ã€‚' : 'ç®¡ç†å“¡æ­£åœ¨é€²è¡Œç³»çµ±ç¶­è­·ï¼Œè«‹ç¨å¾Œå†å›ä¾†ã€‚';
            const iconName = (type === 'access_denied' || type === 'whitelist_blocked') ? 'shield-ban' : (type === 'updating' ? 'hammer' : (type === 'restructuring' ? 'database' : 'lock'));
            
            const defaultTitle = type === 'access_denied' || type === 'whitelist_blocked' ? 'å­˜å–è¢«æ‹’' : type === 'updating' ? 'ç¶²ç«™æ›´æ–°ä¸­' : type === 'restructuring' ? 'è³‡æ–™é‡æ•´ä¸­' : 'ç³»çµ±ç¶­è­·ä¸­';
            
            return (
                <div className="fixed inset-0 z-40 flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 p-6 text-center overflow-hidden">
                    <div className="absolute inset-0 z-0 opacity-30">
                        <div className="absolute top-10 left-10 w-96 h-96 bg-indigo-500 dark:bg-indigo-900 rounded-full mix-blend-multiply filter blur-[100px] animate-blob"></div>
                        <div className="absolute bottom-10 right-10 w-96 h-96 bg-rose-500 dark:bg-rose-900 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-2000"></div>
                    </div>
                    <div className="glass-panel p-10 rounded-3xl shadow-2xl max-w-md w-full relative z-10 flex flex-col items-center">
                        <div className="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner">
                            <Icon name={iconName} className="w-12 h-12 text-rose-500" />
                        </div>
                        <h1 className="text-3xl font-black text-slate-800 dark:text-white mb-3 tracking-tight">
                            {customTitle || defaultTitle}
                        </h1>
                        <p className="text-slate-500 dark:text-slate-400 font-medium mb-8 whitespace-pre-wrap leading-relaxed">{customMessage || defaultMessage}</p>
                        {estimatedTime && (type === 'updating' || type === 'restructuring') && (
                            <div className="w-full bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-2xl p-4 flex items-center gap-4 mb-6">
                                <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg"><Icon name="timer" className="w-6 h-6 text-indigo-600 dark:text-indigo-400" /></div>
                                <div className="text-left">
                                    <div className="text-xs font-bold text-indigo-400 dark:text-indigo-500 uppercase tracking-wide">é è¨ˆæ¢å¾©æ™‚é–“</div>
                                    <div className="text-lg font-black text-indigo-700 dark:text-indigo-300">{estimatedTime}</div>
                                </div>
                            </div>
                        )}
                        {!user && (<button onClick={onLogin} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg hover:shadow-indigo-500/30 active:scale-95 flex items-center justify-center gap-2"><Icon name="log-in" className="w-5 h-5" /> ç™»å…¥ç³»çµ±</button>)}
                        {user && (<div className="mt-4 w-full"><p className="text-xs text-slate-400 mb-2">ç•¶å‰å¸³è™Ÿ: {user.email}</p><button onClick={() => window.firebaseServices?.signOut(window.firebaseServices.auth)} className="text-sm font-bold text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 hover:underline">ç™»å‡º / åˆ‡æ›å¸³è™Ÿ</button></div>)}
                    </div>
                </div>
            );
        }

        // Updated AppearanceModal for Layout Settings
        function AppearanceModal({ isOpen, onClose, t, themeColor, setThemeColor, isDarkMode, setIsDarkMode, layoutMode, setLayoutMode, customLayout, setCustomLayout }) {
            if (!isOpen) return null;
            
            const handleCustomToggle = (key) => {
                setCustomLayout({ ...customLayout, [key]: !customLayout[key] });
            };

            return (
                <div className="fixed inset-0 z-[160] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-900/95 rounded-3xl shadow-2xl w-full max-w-sm p-6 relative z-10 max-h-[85vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icon name="palette" className={`w-6 h-6 ${t.text}`} /> å¤–è§€è¨­å®š</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors active:scale-90"><Icon name="x" className="w-6 h-6 dark:text-slate-300" /></button>
                        </div>

                        <div className="space-y-8">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">ç‰ˆé¢æ¨¡å¼</label>
                                <div className="grid grid-cols-3 gap-2 bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl">
                                    {['normal', 'minimal', 'custom'].map(mode => (
                                        <button key={mode} onClick={() => setLayoutMode(mode)} className={`py-2.5 rounded-xl text-xs font-bold transition-all ${layoutMode === mode ? 'bg-white dark:bg-slate-700 shadow-sm dark:text-white scale-100' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 scale-95 hover:scale-100'}`}>
                                            {mode === 'normal' ? 'æ­£å¸¸' : mode === 'minimal' ? 'æ¥µç°¡' : 'è‡ªå®šç¾©'}
                                        </button>
                                    ))}
                                </div>
                                {layoutMode === 'custom' && (
                                    <div className="mt-4 space-y-3 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-slate-100 dark:border-slate-800 animate-fade-in-up">
                                        {[
                                            { key: 'cards', label: 'ç‹€æ…‹å¡ç‰‡' },
                                            { key: 'timetable', label: 'æµå‹•æ™‚é–“è¡¨' },
                                            { key: 'input', label: 'æ–°å¢æ¬„ä½' },
                                            { key: 'list', label: 'ä»»å‹™åˆ—è¡¨' }
                                        ].map(item => (
                                            <label key={item.key} className="flex items-center justify-between cursor-pointer group">
                                                <span className="text-sm font-bold text-slate-600 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-slate-200 transition-colors">{item.label}</span>
                                                <div className="relative">
                                                    <input type="checkbox" className="sr-only peer" checked={customLayout[item.key]} onChange={() => handleCustomToggle(item.key)} />
                                                    <div className={`w-11 h-6 bg-slate-200 dark:bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all ${t.bg} peer-checked:bg-indigo-500 shadow-inner`}></div>
                                                </div>
                                            </label>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">ä¸»é¡Œé¡è‰²</label>
                                <div className="grid grid-cols-4 gap-3">
                                    {Object.entries(THEME_CONFIG).map(([key, config]) => (
                                        <button key={key} onClick={() => setThemeColor(key)} className={`flex flex-col items-center gap-2 p-3 rounded-2xl border-2 transition-all active:scale-90 ${themeColor === key ? `${config.border} ${config.lightBg}` : 'border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                            <div className={`w-8 h-8 rounded-full bg-gradient-to-br ${config.gradient} shadow-md`}></div>
                                            <span className={`text-[10px] font-bold ${themeColor === key ? config.text : 'dark:text-slate-400'}`}>{config.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">ä»‹é¢æ¨¡å¼</label>
                                <div className="flex bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl">
                                    <button onClick={() => setIsDarkMode(false)} className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all ${!isDarkMode ? 'bg-white shadow-sm text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>
                                        <Icon name="sun" className="w-4 h-4 text-orange-500" /> æ·ºè‰²
                                    </button>
                                    <button onClick={() => setIsDarkMode(true)} className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all ${isDarkMode ? 'bg-slate-700 shadow-sm text-white' : 'text-slate-500 hover:text-slate-700'}`}>
                                        <Icon name="moon" className="w-4 h-4 text-indigo-400" /> æ·±è‰²
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function NameSetupModal({ user, onSave, loading, triggerAlert, t }) {
            const [name, setName] = useState(user?.displayName || '');
            const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) { triggerAlert("è«‹è¼¸å…¥åå­—"); return; } onSave(name.trim()); };
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-2xl w-full max-w-sm p-8 relative z-10 text-center border border-white/20">
                        <div className={`w-20 h-20 ${t.lightBg} rounded-full flex items-center justify-center mx-auto mb-6 ${t.text} shadow-inner`}><Icon name="user" className="w-10 h-10" /></div>
                        <h2 className="text-3xl font-black text-slate-800 dark:text-white mb-3">å€‹äººæ¨¡å¼è¨­å®š</h2>
                        <p className="text-slate-500 dark:text-slate-400 mb-8 text-sm font-medium">è«‹è¼¸å…¥ä½ çš„<strong>è‹±æ–‡çŸ­å</strong>ï¼Œæ–¹ä¾¿è€å¸«è¾¨è­˜</p>
                        <form onSubmit={handleSubmit}>
                            <input type="text" className={`w-full px-4 py-4 rounded-2xl border-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 dark:text-white text-center font-bold text-xl focus:ring-4 focus:${t.ring} outline-none mb-6 transition-all focus:border-indigo-500`} placeholder="åå­— (ä¾‹å¦‚: Peter)" value={name} onChange={e => setName(e.target.value)} autoFocus required />
                            <button type="submit" disabled={loading} className={`w-full py-4 rounded-2xl text-white font-bold text-lg transition-all shadow-lg active:scale-95 disabled:opacity-50 hover:shadow-xl hover:-translate-y-0.5 ${t.bg}`}>{loading ? 'è¨­å®šä¸­...' : 'é–‹å§‹ä½¿ç”¨'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function JoinClassModal({ isOpen, onClose, systemClasses, joinedClasses, onJoin, t }) {
            const [code, setCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [floatingError, setFloatingError] = useState('');

            if (!isOpen) return null;

            const showError = (msg) => { setFloatingError(msg); setTimeout(() => setFloatingError(''), 3000); };

            const handleJoin = async (e) => {
                e.preventDefault();
                const upperCode = code.trim().toUpperCase();
                const targetClass = systemClasses.find(c => c.code === upperCode);
                if (!targetClass) return showError('ç„¡æ•ˆçš„ç­ç´šä»£ç¢¼ï¼è«‹ç¢ºèªå¾Œå†è©¦ã€‚');
                if (joinedClasses.includes(upperCode)) return showError('ä½ å·²ç¶“åŠ å…¥éé€™å€‹ç­ç´šäº†ï¼');
                setLoading(true);
                try { await onJoin(upperCode, targetClass.name); setCode(''); } catch (err) { showError('åŠ å…¥å¤±æ•—ï¼Œè«‹é‡è©¦'); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-2xl w-full max-w-sm p-8 relative z-10 text-center">
                        {floatingError && (
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white px-5 py-3 rounded-2xl shadow-[0_10px_30px_rgba(239,68,68,0.4)] z-50 font-bold text-sm whitespace-nowrap pop-in-error flex items-center gap-2">
                                <Icon name="alert-circle" className="w-5 h-5" />
                                {floatingError}
                            </div>
                        )}
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors active:scale-90"><Icon name="x" className="w-6 h-6 dark:text-slate-300" /></button>
                        <div className={`w-20 h-20 ${t.lightBg} rounded-full flex items-center justify-center mx-auto mb-6 mt-2 ${t.text} shadow-inner`}><Icon name="school" className="w-10 h-10" /></div>
                        <h2 className="text-2xl font-black text-slate-800 dark:text-white mb-2">åŠ å…¥ç­ç´š</h2>
                        <p className="text-slate-500 dark:text-slate-400 mb-8 text-sm font-medium">è«‹è¼¸å…¥ç”±è€å¸«æä¾›çš„ 6 ä½æ•¸ç­ç´šä»£ç¢¼</p>
                        <form onSubmit={handleJoin}>
                            <input type="text" maxLength={6} className={`w-full px-4 py-4 rounded-2xl border-2 ${floatingError ? 'border-red-400 bg-red-50 dark:bg-red-900/10 focus:ring-red-400' : `border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 focus:ring-4 focus:${t.ring}`} dark:text-white text-center font-mono font-bold text-3xl tracking-[0.5em] outline-none mb-6 uppercase placeholder:tracking-normal placeholder:text-base placeholder:font-sans transition-all focus:border-indigo-500`} placeholder="è¼¸å…¥ä»£ç¢¼" value={code} onChange={e => {setCode(e.target.value); setFloatingError('');}} autoFocus required />
                            <button type="submit" disabled={loading || code.length !== 6} className={`w-full py-4 rounded-2xl text-white font-bold text-lg transition-all shadow-lg active:scale-95 disabled:opacity-50 hover:shadow-xl hover:-translate-y-0.5 ${t.bg}`}>{loading ? 'è™•ç†ä¸­...' : 'ç¢ºèªåŠ å…¥'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function AuthModal({ isOpen, onClose, triggerAlert }) { 
            const [isLogin, setIsLogin] = useState(true); 
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const { auth, googleProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword } = window.firebaseServices || {};

            useEffect(() => { if (isOpen) { setLoading(false); setEmail(''); setPassword(''); setIsLogin(true); } }, [isOpen]); 
            if (!isOpen) return null; 

            const handleGoogleLogin = async () => { try { setLoading(true); await signInWithPopup(auth, googleProvider); onClose(); } catch (error) { console.error(error); triggerAlert("Google ç™»å…¥å¤±æ•—: " + error.message); setLoading(false); } };
            const handleEmailAuth = async (e) => { 
                e.preventDefault(); if(!email || !password) return;
                try { 
                    setLoading(true); 
                    if (isLogin) { await signInWithEmailAndPassword(auth, email, password); } else { await createUserWithEmailAndPassword(auth, email, password); } 
                    onClose(); 
                } catch (error) { console.error(error); triggerAlert(isLogin ? "ç™»å…¥å¤±æ•—: " + error.message : "è¨»å†Šå¤±æ•—: " + error.message); setLoading(false); } 
            };

            return ( 
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4"> 
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div> 
                    <div className="modal-animate glass-panel bg-white/90 dark:bg-slate-900/90 rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.3)] w-full max-w-md p-8 relative z-10 overflow-hidden"> 
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors active:scale-90"><Icon name="x" className="w-6 h-6" /></button> 
                        <div className="absolute -top-20 -left-20 w-64 h-64 bg-purple-300 dark:bg-purple-900 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob pointer-events-none"></div> 
                        <div className="absolute -bottom-20 -right-20 w-64 h-64 bg-blue-300 dark:bg-blue-900 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-2000 pointer-events-none"></div> 
                        <div className="text-center mb-8 relative"><h2 className="text-3xl font-black text-slate-800 dark:text-white tracking-tight mb-2">{isLogin ? 'æ­¡è¿å›ä¾†' : 'å‰µå»ºå¸³æˆ¶'}</h2><p className="text-slate-500 dark:text-slate-400 font-medium">{isLogin ? 'ç™»å…¥ä»¥åŒæ­¥æ‚¨çš„å­¸ç¿’é€²åº¦' : 'å¹¾ç§’é˜å³å¯é–‹å§‹æ‚¨çš„å­¸ç¿’ä¹‹æ—…'} </p></div> 
                        <form onSubmit={handleEmailAuth} className="space-y-4 relative"> 
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors"><Icon name="mail" className="w-5 h-5" /></div><input type="email" className="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:outline-none focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-bold" placeholder="é›»å­éƒµä»¶" value={email} onChange={e => setEmail(e.target.value)} required /></div> 
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors"><Icon name="lock" className="w-5 h-5" /></div><input type="password" className="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:outline-none focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-bold" placeholder="å¯†ç¢¼" value={password} onChange={e => setPassword(e.target.value)} required /></div> 
                            <button type="submit" disabled={loading} className="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-lg shadow-lg shadow-indigo-500/30 transform transition-all active:scale-[0.98] hover:shadow-indigo-500/50 flex items-center justify-center hover:-translate-y-0.5 disabled:opacity-70">{loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}</button> 
                        </form> 
                        <div className="relative my-8"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200 dark:border-slate-700"></div></div><div className="relative flex justify-center text-xs uppercase tracking-widest font-black text-slate-400"><span className="px-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur rounded-full">æˆ–è€…</span></div></div> <button onClick={handleGoogleLogin} disabled={loading} className="w-full py-4 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-3 shadow-sm hover:shadow-md active:scale-[0.98] hover:-translate-y-0.5"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-5 h-5" />Google ç™»å…¥</button>
                        <div className="mt-8 text-center"><p className="text-slate-500 dark:text-slate-400 font-medium text-sm">{isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ' : 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ'} <button onClick={() => setIsLogin(!isLogin)} className="text-indigo-600 dark:text-indigo-400 font-bold hover:text-indigo-700 dark:hover:text-indigo-300 ml-1 transition-colors underline decoration-2 underline-offset-4">{isLogin ? 'ç«‹å³è¨»å†Š' : 'ç›´æ¥ç™»å…¥'}</button></p></div> 
                    </div> 
                </div> 
            ); 
        }

        function EditModal({ item, onClose, onSave, triggerAlert, subjects }) { 
            const [description, setDescription] = useState(item.description || ''); 
            const [subject, setSubject] = useState(item.subject || 'å…¶ä»–'); 
            const [dueDate, setDueDate] = useState(item.dueDate || ''); 
            const [loading, setLoading] = useState(false); 
            const handleSave = async (e) => { e.preventDefault(); setLoading(true); try { await onSave(item.id, { description, subject, dueDate }); onClose(); } catch (error) { console.error(error); triggerAlert("æ›´æ–°å¤±æ•—"); } finally { setLoading(false); } }; 
            return ( 
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4"> 
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div> 
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-2xl w-full max-w-md p-6 relative z-10 overflow-hidden"> 
                        <div className="flex justify-between items-center mb-6"> 
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white">ä¿®æ”¹ç´€éŒ„</h3> 
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors active:scale-90"><Icon name="x" className="w-5 h-5 text-slate-500 dark:text-slate-400" /></button> 
                        </div> 
                        <form onSubmit={handleSave} className="space-y-5"> 
                            <div> 
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wider">ç§‘ç›®</label> 
                                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide"> 
                                    {subjects.map(sub => ( <button key={sub.name} type="button" onClick={() => setSubject(sub.name)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border-2 transition-all shadow-sm active:scale-95 ${subject === sub.name ? sub.color + ' ring-2 ring-offset-1 ring-indigo-100 dark:ring-indigo-900 scale-105' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 opacity-70 hover:opacity-100'}`}>{sub.name}</button>))} 
                                </div> 
                            </div> 
                            <div> 
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wider">å…§å®¹</label> 
                                <textarea value={description} onChange={(e) => setDescription(e.target.value)} rows="3" className="w-full rounded-2xl border-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 dark:focus:ring-indigo-900/30 transition-all p-4 font-medium text-slate-700 dark:text-slate-200 text-sm outline-none resize-none" required /> 
                            </div> 
                            <div> 
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wider">ç¹³äº¤/è€ƒè©¦æ—¥æœŸ</label> 
                                <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full h-12 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 dark:focus:ring-indigo-900/30 transition-all px-4 font-medium text-slate-600 dark:text-slate-300 text-sm outline-none" required /> 
                            </div> 
                            <button type="submit" disabled={loading} className="w-full py-3.5 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 dark:shadow-indigo-900/20 transition-all active:scale-95 disabled:opacity-70 flex items-center justify-center gap-2 hover:-translate-y-0.5">{loading ? 'å„²å­˜ä¸­...' : <><Icon name="save" className="w-4 h-4" /> å„²å­˜ä¿®æ”¹</>}</button> 
                        </form> 
                    </div> 
                </div> 
            ); 
        }

        // ... (å…¶ä»–çµ„ä»¶ä¿æŒä¸è®Šï¼Œå› ç‚ºç¯‡å¹…é—œä¿‚ï¼Œå¦‚æœéœ€è¦å¯ä»¥å›è¦†ã€Œç¹¼çºŒã€) ...

        function SubjectSelectionModal({ onClose, onSelect, subjects }) {
            return (
                <div className="fixed inset-0 z-[160] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-2xl w-full max-w-2xl p-6 relative z-10 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-bold text-slate-800 dark:text-white">é¸æ“‡ç§‘ç›®</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors active:scale-90"><Icon name="x" className="w-6 h-6 text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 overflow-y-auto p-1">
                            <button onClick={() => onSelect("")} className="p-4 rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-400 dark:text-slate-500 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 hover:border-slate-400 transition-all flex flex-col items-center justify-center gap-2 min-h-[100px] hover:scale-[1.02] active:scale-95">
                                <Icon name="minus-circle" className="w-8 h-8" />
                                ç©ºå ‚
                            </button>
                            {subjects.map(sub => (
                                <button key={sub.name} onClick={() => onSelect(sub.name)} className={`p-4 rounded-2xl border-2 font-bold transition-all shadow-sm hover:shadow-md hover:scale-[1.02] active:scale-95 flex flex-col items-center justify-center gap-2 min-h-[100px] ${sub.color}`}>
                                    <span className="text-lg">{sub.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function SubjectManagerModal({ isOpen, onClose, currentSubjects, onSave, triggerConfirm }) {
            const [newSubjectName, setNewSubjectName] = useState('');
            const [newSubjectColor, setNewSubjectColor] = useState(COLOR_PALETTE[0].value);
            const [tempSubjects, setTempSubjects] = useState([]);

            useEffect(() => { if (isOpen) setTempSubjects(currentSubjects); }, [isOpen, currentSubjects]);
            if (!isOpen) return null;

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newSubjectName.trim()) return;
                if (tempSubjects.some(s => s.name === newSubjectName.trim())) { alert("ç§‘ç›®åç¨±é‡è¤‡"); return; }
                setTempSubjects([...tempSubjects, { name: newSubjectName.trim(), color: newSubjectColor }]);
                setNewSubjectName('');
            };
            const handleDelete = (name) => { triggerConfirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`, () => setTempSubjects(tempSubjects.filter(s => s.name !== name))); };
            
            const moveSubject = (index, direction) => {
                const newSubjects = [...tempSubjects];
                if (direction === 'up' && index > 0) {
                    [newSubjects[index], newSubjects[index - 1]] = [newSubjects[index - 1], newSubjects[index]];
                } else if (direction === 'down' && index < newSubjects.length - 1) {
                    [newSubjects[index], newSubjects[index + 1]] = [newSubjects[index + 1], newSubjects[index]];
                }
                setTempSubjects(newSubjects);
            };

            const handleAISort = () => {
                const priority = ['ä¸­æ–‡', 'è‹±æ–‡', 'æ•¸å­¸', 'å¸¸è­˜', 'é€šè­˜', 'å…¬ç¤¾', 'ç‰©ç†', 'åŒ–å­¸', 'ç”Ÿç‰©'];
                const sorted = [...tempSubjects].sort((a, b) => {
                    const idxA = priority.indexOf(a.name);
                    const idxB = priority.indexOf(b.name);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    if (a.name.length !== b.name.length) return a.name.length - b.name.length;
                    return a.name.localeCompare(b.name);
                });
                setTempSubjects(sorted);
            };

            const handleSaveInternal = () => { onSave(tempSubjects); onClose(); };
            const handleReset = () => { triggerConfirm("ç¢ºå®šé‡ç½®ç‚ºé è¨­ç§‘ç›®ï¼Ÿé€™å°‡è¦†è“‹æ‚¨çš„è‡ªè¨‚ç§‘ç›®ã€‚", () => { onSave(DEFAULT_SUBJECTS); onClose(); }); };

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate glass-panel bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-2xl w-full max-w-xl p-6 relative z-10 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-black text-slate-800 dark:text-white">ç§‘ç›®è¨­å®š</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors active:scale-90"><Icon name="x" className="w-6 h-6 text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                            <div className="flex justify-between items-center mb-3">
                                <span className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">ç§‘ç›®åˆ—è¡¨</span>
                                <button onClick={handleAISort} className="text-xs font-bold bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-1.5 rounded-lg shadow-md hover:shadow-lg transition-all active:scale-95 flex items-center gap-1">
                                    <Icon name="sparkles" className="w-3 h-3" /> AI æ™ºèƒ½æ’åº
                                </button>
                            </div>

                            <form onSubmit={handleAdd} className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 mb-6">
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">æ–°å¢ç§‘ç›®</label>
                                <div className="flex gap-2 mb-3">
                                    <input type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="flex-1 px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-white text-sm outline-none focus:ring-2 focus:ring-indigo-500 font-medium" placeholder="ç§‘ç›®åç¨± (ä¾‹å¦‚: æ•¸å­¸)" required />
                                </div>
                                <div className="grid grid-cols-5 gap-2 max-h-32 overflow-y-auto pr-1 pb-1">
                                    {COLOR_PALETTE.map((c, i) => (
                                        <button key={i} type="button" onClick={() => setNewSubjectColor(c.value)} className={`h-8 rounded-lg border-2 transition-transform hover:scale-105 ${c.value} ${newSubjectColor === c.value ? 'ring-2 ring-offset-2 ring-slate-400 dark:ring-slate-500 border-transparent scale-105' : 'border-transparent opacity-60 hover:opacity-100'}`} title={c.label} />
                                    ))}
                                </div>
                                <button type="submit" className="w-full mt-4 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 transition-colors shadow-sm">æ–°å¢</button>
                            </form>
                            <div className="space-y-2.5">
                                {tempSubjects.map((sub, index) => (
                                    <div key={sub.name + index} className="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm group hover:border-indigo-200 dark:hover:border-indigo-800 transition-colors">
                                        <span className={`px-3 py-1 rounded-lg text-xs font-bold border ${sub.color}`}>{sub.name}</span>
                                        <div className="flex items-center gap-1">
                                            <button type="button" onClick={() => moveSubject(index, 'up')} disabled={index === 0} className="p-1.5 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"><Icon name="arrow-up" className="w-4 h-4" /></button>
                                            <button type="button" onClick={() => moveSubject(index, 'down')} disabled={index === tempSubjects.length - 1} className="p-1.5 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"><Icon name="arrow-down" className="w-4 h-4" /></button>
                                            <div className="w-px h-4 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                                            <button onClick={() => handleDelete(sub.name)} className="text-slate-400 hover:text-red-500 transition-colors p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg"><Icon name="trash-2" className="w-4 h-4" /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="mt-6 pt-5 border-t border-slate-100 dark:border-slate-700 flex gap-4">
                            <button onClick={handleReset} className="px-5 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-bold text-sm">é‡ç½®é è¨­</button>
                            <button onClick={handleSaveInternal} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg hover:shadow-indigo-500/30 active:scale-95">å„²å­˜è®Šæ›´</button>
                        </div>
                    </div>
                </div>
            );
        }

        function SlotTypeSelector({ value, onChange }) {
            const types = [ { id: 'lesson', label: 'èª²å ‚', icon: 'book-open' }, { id: 'break', label: 'å°æ¯', icon: 'coffee' }, { id: 'lunch', label: 'åˆè†³', icon: 'utensils' } ];
            return (
                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl">
                    {types.map(t => (
                        <button key={t.id} onClick={() => onChange(t.id)} className={`flex-1 flex items-center justify-center gap-1.5 py-2 px-2 rounded-lg text-xs font-bold transition-all ${value === t.id ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm scale-100' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 scale-95 hover:scale-100'}`}>
                            <Icon name={t.icon} className="w-3.5 h-3.5" /> {t.label}
                        </button>
                    ))}
                </div>
            );
        }

        function TimetableEditor({ initialConfig, onSave, onCancel, subjects, triggerConfirm }) {
            const [activeTab, setActiveTab] = useState('slots'); 
            const [timeSlots, setTimeSlots] = useState(initialConfig?.timeSlots || [...DEFAULT_TIME_SLOTS]);
            const [schedule, setSchedule] = useState(initialConfig?.schedule || { ...DEFAULT_SCHEDULE });
            const [editDay, setEditDay] = useState(1); 
            const [editingCell, setEditingCell] = useState(null); 

            const handleSlotChange = (index, field, value) => { const newSlots = [...timeSlots]; newSlots[index] = { ...newSlots[index], [field]: value }; setTimeSlots(newSlots); };
            const addSlot = () => setTimeSlots([...timeSlots, { id: 's' + Date.now(), label: 'æ–°èª²ç¯€', type: 'lesson', startTime: '08:00', duration: 35 }]);
            const removeSlot = (index) => setTimeSlots(timeSlots.filter((_, i) => i !== index));
            const moveSlot = (index, direction) => {
                const newSlots = [...timeSlots];
                if (direction === 'up' && index > 0) { [newSlots[index], newSlots[index - 1]] = [newSlots[index - 1], newSlots[index]]; } 
                else if (direction === 'down' && index < newSlots.length - 1) { [newSlots[index], newSlots[index + 1]] = [newSlots[index + 1], newSlots[index]]; }
                setTimeSlots(newSlots);
            };

            const openSubjectModal = (day, lessonIndex) => setEditingCell({ day, lessonIndex });
            const handleSubjectSelect = (subjectName) => {
                if (editingCell) {
                    const { day, lessonIndex } = editingCell; const newSchedule = { ...schedule };
                    if (!newSchedule[day]) newSchedule[day] = [];
                    while (newSchedule[day].length <= lessonIndex) newSchedule[day].push("");
                    newSchedule[day][lessonIndex] = subjectName;
                    setSchedule(newSchedule); setEditingCell(null); 
                }
            };
            const handleSave = () => onSave({ timeSlots, schedule });
            const resetToDefault = () => { triggerConfirm("ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­æ™‚é–“è¡¨å—ï¼Ÿ", () => { setTimeSlots([...DEFAULT_TIME_SLOTS]); setSchedule({ ...DEFAULT_SCHEDULE }); }); };
            const lessonSlots = timeSlots.map((s, i) => ({ ...s, originalIndex: i })).filter(s => s.type === 'lesson');

            return (
                <div className="glass-panel bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-xl border border-white/20 dark:border-slate-700 overflow-hidden flex flex-col h-[80vh] max-w-4xl mx-auto relative">
                    <div className="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icon name="edit" className="w-5 h-5 text-indigo-500 dark:text-indigo-400"/> ç·¨è¼¯æ™‚é–“è¡¨</h2>
                        <div className="flex gap-2">
                            <button onClick={resetToDefault} className="px-4 py-2 text-xs font-bold text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors">é‡ç½®é è¨­</button>
                            <button onClick={onCancel} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-400 transition-colors active:scale-90"><Icon name="x" className="w-5 h-5"/></button>
                        </div>
                    </div>

                    <div className="flex border-b border-slate-100 dark:border-slate-700">
                        <button onClick={() => setActiveTab('slots')} className={`flex-1 py-4 text-sm font-bold transition-all ${activeTab === 'slots' ? 'text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400 bg-indigo-50/50 dark:bg-indigo-900/20' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}>æ™‚é–“è¨­å®š</button>
                        <button onClick={() => setActiveTab('schedule')} className={`flex-1 py-4 text-sm font-bold transition-all ${activeTab === 'schedule' ? 'text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400 bg-indigo-50/50 dark:bg-indigo-900/20' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}>èª²ç¨‹ç·¨æ’</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-5 bg-slate-50 dark:bg-slate-900/50 custom-scrollbar">
                        {activeTab === 'slots' ? (
                            <div className="space-y-4">
                                {timeSlots.map((slot, index) => (
                                    <div key={index} className="flex flex-wrap items-center gap-3 bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm transition-all hover:border-indigo-300 dark:hover:border-indigo-700">
                                        <div className="flex flex-col gap-1 mr-2">
                                            <button onClick={() => moveSlot(index, 'up')} disabled={index === 0} className="p-1 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 active:scale-90 transition-transform"><Icon name="chevron-up" className="w-4 h-4" /></button>
                                            <button onClick={() => moveSlot(index, 'down')} disabled={index === timeSlots.length - 1} className="p-1 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 active:scale-90 transition-transform"><Icon name="chevron-down" className="w-4 h-4" /></button>
                                        </div>
                                        <input type="time" value={slot.startTime} onChange={(e) => handleSlotChange(index, 'startTime', e.target.value)} className="w-28 p-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-sm font-mono bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500 font-bold" />
                                        <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-900 px-3 rounded-xl border border-slate-200 dark:border-slate-700 h-10">
                                            <input type="number" value={slot.duration} onChange={(e) => handleSlotChange(index, 'duration', parseInt(e.target.value) || 0)} className="w-12 bg-transparent text-sm text-center outline-none text-slate-800 dark:text-white font-bold" />
                                            <span className="text-xs text-slate-500 pr-1">åˆ†</span>
                                        </div>
                                        <div className="min-w-[200px] flex-1"><SlotTypeSelector value={slot.type} onChange={(val) => handleSlotChange(index, 'type', val)} /></div>
                                        <input type="text" value={slot.label} onChange={(e) => handleSlotChange(index, 'label', e.target.value)} className="flex-1 min-w-[120px] p-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-900 text-slate-800 dark:text-white font-medium" placeholder="æ¨™ç±¤" />
                                        <button onClick={() => removeSlot(index)} className="p-2.5 text-slate-400 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-xl transition-colors"><Icon name="trash-2" className="w-5 h-5" /></button>
                                    </div>
                                ))}
                                <button onClick={addSlot} className="w-full py-4 border-2 border-dashed border-indigo-200 dark:border-indigo-800 text-indigo-500 dark:text-indigo-400 rounded-2xl font-bold hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all flex items-center justify-center gap-2 mt-4 hover:border-solid hover:shadow-md"><Icon name="plus" className="w-5 h-5" /> æ–°å¢æ™‚é–“æ®µ</button>
                            </div>
                        ) : (
                            <div className="space-y-5">
                                <div className="flex gap-2 overflow-x-auto pb-3 scrollbar-hide">
                                    {['ä¸€','äºŒ','ä¸‰','å››','äº”'].map((d, i) => (
                                        <button key={i} onClick={() => setEditDay(i + 1)} className={`px-5 py-2.5 rounded-xl font-bold text-sm whitespace-nowrap transition-all ${editDay === i + 1 ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 dark:shadow-none scale-105' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>æ˜ŸæœŸ{d}</button>
                                    ))}
                                </div>
                                <div className="bg-white dark:bg-slate-800 p-5 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm space-y-4">
                                    <h3 className="font-bold text-slate-800 dark:text-white mb-2 flex items-center gap-2 text-lg">
                                        <span className="w-1.5 h-6 bg-indigo-500 rounded-full"></span>
                                        æ˜ŸæœŸ{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][editDay]} èª²ç¨‹
                                    </h3>
                                    {lessonSlots.length === 0 ? <p className="text-slate-400 text-center py-8 bg-slate-50 dark:bg-slate-900 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700">è«‹å…ˆåœ¨ã€Œæ™‚é–“è¨­å®šã€æ–°å¢èª²å ‚é¡å‹çš„æ™‚é–“æ®µ</p> : 
                                    lessonSlots.map((slot, lessonIdx) => {
                                        const currentSubjectName = schedule[editDay]?.[lessonIdx];
                                        const subObj = subjects.find(s => s.name === currentSubjectName);
                                        const colorClass = subObj ? subObj.color : 'bg-slate-100 dark:bg-slate-900/50 text-slate-400 dark:text-slate-500 border-slate-200 dark:border-slate-700';

                                        return (
                                            <div key={lessonIdx} className="flex items-center gap-4 group">
                                                <div className="w-24 text-xs font-bold text-slate-500 dark:text-slate-400 text-right uppercase tracking-wider">{slot.label}</div>
                                                <div className="flex-1">
                                                    <button onClick={() => openSubjectModal(editDay, lessonIdx)} className={`w-full p-4 rounded-2xl border-2 text-left font-bold transition-all hover:shadow-md hover:-translate-y-0.5 flex justify-between items-center ${currentSubjectName ? colorClass : 'bg-slate-50 dark:bg-slate-900/50 border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-500'}`}>
                                                        <span className="text-base">{currentSubjectName || '(ç©ºå ‚)'}</span>
                                                        <Icon name="chevron-right" className="w-5 h-5 opacity-30 group-hover:opacity-100 transition-opacity" />
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-5 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
                        <button onClick={handleSave} className="w-full py-3.5 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-500/30 active:scale-95 flex items-center justify-center gap-2 hover:-translate-y-0.5"><Icon name="save" className="w-5 h-5" /> å„²å­˜è¨­å®š</button>
                    </div>

                    {editingCell && <SubjectSelectionModal onClose={() => setEditingCell(null)} onSelect={handleSubjectSelect} subjects={subjects} />}
                </div>
            );
        }