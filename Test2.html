<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>電子手冊 Pro v2.2</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' }
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        input[type="file"]::file-selector-button { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes popIn { 
            0% { opacity: 0; transform: scale(0.9) translateY(10px); } 
            100% { opacity: 1; transform: scale(1) translateY(0); } 
        }
        .dialog-animate { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-item { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }

        .guest-blur { filter: blur(6px) grayscale(100%); opacity: 0.8; pointer-events: none; user-select: none; transition: all 0.8s ease; }

        @keyframes glowing { 0% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 20px currentColor; } 100% { box-shadow: 0 0 5px currentColor; } }
        .btn-glow { animation: glowing 2s infinite; }

        @keyframes marquee { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 20s linear infinite; will-change: transform; }
        .animate-marquee:hover { animation-play-state: paused; }

        /* Custom Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }

        /* 浮空錯誤動畫 */
        @keyframes popInError {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .pop-in-error { animation: popInError 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3gYuwnyoTUwO7PFh4Nuue-Ud8GTruuRk",
            authDomain: "recordhwv2.firebaseapp.com",
            projectId: "recordhwv2",
            storageBucket: "recordhwv2.firebasestorage.app",
            messagingSenderId: "599261009391",
            appId: "1:599261009391:web:66cd7f932650bebc0e521a",
            measurementId: "G-C51XDYW67W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        window.firebaseServices = { 
            auth, db, googleProvider, 
            signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, 
            collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, arrayUnion, arrayRemove, getDoc, writeBatch 
        };
    </script>

    <script>
        (function setupPWA() {
            const manifest = {
                name: "電子手冊 Pro", short_name: "電子手冊", start_url: ".", display: "standalone",
                background_color: "#ffffff", theme_color: "#4f46e5",
                icons: [{ src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%234f46e5' rx='20'/%3E%3Cpath fill='%23fff' d='M30 30h40v40H30z'/%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestURL}">`);
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const ADMIN_EMAIL = 'chimhinhin@gmail.com'; 

        // --- Configuration Constants ---
        const DEFAULT_SUBJECTS = [
            { name: '中文', color: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800' },
            { name: '英文', color: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800' },
            { name: '數學', color: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800' },
            { name: '公社', color: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800' },
            { name: '佛學', color: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800' },
            { name: '生物', color: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800' },
            { name: '物理', color: 'bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-400 dark:border-cyan-800' },
            { name: '化學', color: 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800' },
            { name: '歷史', color: 'bg-stone-100 text-stone-700 border-stone-200 dark:bg-stone-900/30 dark:text-stone-400 dark:border-stone-800' },
            { name: '電腦', color: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800' },
            { name: '其他', color: 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700' }
        ];

        const COLOR_PALETTE = [
            { label: '紅', value: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800' },
            { label: '橙', value: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800' },
            { label: '黃', value: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800' },
            { label: '綠', value: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800' },
            { label: '翡翠', value: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800' },
            { label: '天藍', value: 'bg-sky-100 text-sky-700 border-sky-200 dark:bg-sky-900/30 dark:text-sky-400 dark:border-sky-800' },
            { label: '藍', value: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800' },
            { label: '靛', value: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800' },
            { label: '紫', value: 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800' },
            { label: '石板', value: 'bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700' },
        ];

        // --- Theme Configuration ---
        const THEME_CONFIG = {
            indigo: { name: '靛藍', text: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-600 hover:bg-indigo-700', ring: 'ring-indigo-100 dark:ring-indigo-900', gradient: 'from-indigo-600 to-blue-600', lightBg: 'bg-indigo-50 dark:bg-indigo-900/20', border: 'border-indigo-200 dark:border-indigo-800', shadow: 'shadow-indigo-200/50 dark:shadow-indigo-900/20' },
            rose: { name: '櫻粉', text: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-600 hover:bg-rose-700', ring: 'ring-rose-100 dark:ring-rose-900', gradient: 'from-rose-600 to-pink-600', lightBg: 'bg-rose-50 dark:bg-rose-900/20', border: 'border-rose-200 dark:border-rose-800', shadow: 'shadow-rose-200/50 dark:shadow-rose-900/20' },
            emerald: { name: '翡翠', text: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-600 hover:bg-emerald-700', ring: 'ring-emerald-100 dark:ring-emerald-900', gradient: 'from-emerald-600 to-teal-600', lightBg: 'bg-emerald-50 dark:bg-emerald-900/20', border: 'border-emerald-200 dark:border-emerald-800', shadow: 'shadow-emerald-200/50 dark:shadow-emerald-900/20' }
        };

        const DEFAULT_TIME_SLOTS = [
            { id: 'l1', label: '第1節', type: 'lesson', startTime: '08:30', duration: 35 },
            { id: 'l2', label: '第2節', type: 'lesson', startTime: '09:05', duration: 35 },
            { id: 'b1', label: '小息', type: 'break', startTime: '09:40', duration: 15 },
            { id: 'l3', label: '第3節', type: 'lesson', startTime: '09:55', duration: 35 }
        ];

        const DEFAULT_SCHEDULE = { 1: [], 2: [], 3: [], 4: [], 5: [] };

        const Icon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' }); } catch(e) {}
                }
            }, [name, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        const formatCountdown = (ms) => { const totalSeconds = Math.floor(ms / 1000); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };

        const formatTimeStr = (date) => { 
            try {
                if (!(date instanceof Date) || isNaN(date.getTime())) return '--:--';
                return date.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' }); 
            } catch(e) { return '--:--'; }
        };

        const generateFullSchedule = (config, now, dayOverride = null) => {
            if (!config || !Array.isArray(config.timeSlots)) return [];
            const day = dayOverride !== null ? dayOverride : now.getDay();
            if (day === 0 || day === 6) return []; 
            const daySubjects = config.schedule?.[day] || [];
            let lessonIndex = 0;
            const baseDate = new Date(now); baseDate.setHours(0,0,0,0);

            return config.timeSlots.map(slot => {
                const timeStr = slot.startTime || "00:00";
                const parts = timeStr.split(':');
                const h = parseInt(parts[0]) || 0;
                const m = parseInt(parts[1]) || 0;

                const start = new Date(baseDate); start.setHours(h, m, 0, 0);
                const end = new Date(start.getTime() + (parseInt(slot.duration) || 35) * 60000);

                let subject = slot.label || '';
                if (slot.type === 'lesson') { subject = daySubjects[lessonIndex] || '---'; lessonIndex++; }
                return { ...slot, start, end, subjectName: subject };
            });
        };

        const getNextLesson = (subjectName, now, config) => {
            if (!subjectName || subjectName === '其他') return null;
            const schedule = generateFullSchedule(config, now);
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const currentSeconds = now.getSeconds();

            for (let slot of schedule) {
                if (slot.type === 'lesson' && (slot.subjectName.includes(subjectName) || subjectName.includes(slot.subjectName))) {
                    const startH = slot.start.getHours();
                    const startM = slot.start.getMinutes();
                    const startTotalMins = startH * 60 + startM;
                    const endTotalMins = startTotalMins + slot.duration;

                    if (currentMinutes >= startTotalMins && currentMinutes < endTotalMins) return { type: 'now', diff: 0 };
                    if (currentMinutes < startTotalMins) {
                        const diffMs = ((startTotalMins * 60) - (currentMinutes * 60 + currentSeconds)) * 1000;
                        return { type: 'future', diff: diffMs };
                    }
                }
            }
            return null;
        };

        // --- View Components ---
        function LessonCountdown({ subject, config }) {
            const [now, setNow] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(timer); }, []);

            const nextLesson = getNextLesson(subject, now, config);
            if (!nextLesson) return null;
            if (nextLesson.type === 'now') {
                return <div className="text-[10px] font-bold text-red-600 flex items-center gap-1 mt-1 animate-pulse"><Icon name="flame" className="w-3 h-3" /> 上課中</div>;
            } else if (nextLesson.diff < 24 * 60 * 60 * 1000) { 
                return <div className="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-1 mt-1"><Icon name="alarm-clock" className="w-3 h-3" /> 距離上課 {formatCountdown(nextLesson.diff)}</div>;
            }
            return null;
        }

        function CalendarWidget({ items, selectedDate, onSelectDate, t }) {
            const [currentMonth, setCurrentMonth] = useState(new Date());

            const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const endOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const startDate = startOfMonth.getDay(); 
            const daysInMonth = endOfMonth.getDate();

            const days = [];
            for (let i = 0; i < startDate; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i));

            const nextMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
            const prevMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));

            return (
                <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 p-4 sm:p-6 mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg dark:text-white flex items-center gap-2">
                            <Icon name="calendar" className={`w-5 h-5 ${t.text}`} />
                            {currentMonth.getFullYear()}年 {currentMonth.getMonth() + 1}月
                        </h3>
                        <div className="flex gap-2">
                            <button onClick={prevMonth} className="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition"><Icon name="chevron-left" className="w-5 h-5 dark:text-white" /></button>
                            <button onClick={nextMonth} className="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition"><Icon name="chevron-right" className="w-5 h-5 dark:text-white" /></button>
                        </div>
                    </div>
                    <div className="calendar-grid text-center text-xs font-bold text-slate-400 dark:text-slate-500 mb-2">
                        {['日','一','二','三','四','五','六'].map(d => <div key={d} className="py-1">{d}</div>)}
                    </div>
                    <div className="calendar-grid">
                        {days.map((date, i) => {
                            if (!date) return <div key={`empty-${i}`} className="p-2"></div>;
                            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                            const dayItems = items.filter(item => item.dueDate === dateStr && !item.forceExpired && !item.completed);
                            const isSelected = selectedDate === dateStr;
                            const isToday = new Date().toDateString() === date.toDateString();

                            return (
                                <button 
                                    key={i} 
                                    onClick={() => onSelectDate(isSelected ? null : dateStr)}
                                    className={`relative aspect-square flex flex-col items-center justify-center rounded-xl sm:rounded-2xl transition-all border-2 ${isSelected ? `${t.border} ${t.lightBg} shadow-sm` : 'border-transparent hover:bg-slate-50 dark:hover:bg-slate-700'} ${isToday && !isSelected ? 'border-slate-200 dark:border-slate-600' : ''}`}
                                >
                                    <span className={`text-sm sm:text-base font-bold ${isSelected ? t.text : 'text-slate-700 dark:text-slate-300'}`}>{date.getDate()}</span>
                                    <div className="flex gap-0.5 mt-1 h-1.5">
                                        {dayItems.slice(0, 3).map((_, idx) => <span key={idx} className={`w-1.5 h-1.5 rounded-full ${t.bg}`}></span>)}
                                        {dayItems.length > 3 && <span className="w-1.5 h-1.5 rounded-full bg-slate-300 dark:bg-slate-600"></span>}
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                    {selectedDate && (
                        <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-sm">
                            <span className="font-bold dark:text-white">篩選: {selectedDate}</span>
                            <button onClick={() => onSelectDate(null)} className="text-slate-400 hover:text-red-500 font-bold">清除篩選</button>
                        </div>
                    )}
                </div>
            );
        }

        // --- Modals ---

        function BlockScreen({ type, estimatedTime, customMessage, onLogin, user }) {
            const defaultMessage = type === 'access_denied' ? '抱歉，此網站目前僅限白名單用戶訪問。\n請聯絡管理員開通權限。' : '管理員正在進行系統維護，請稍後再回來。';
            return (
                <div className="fixed inset-0 z-40 flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 p-6 text-center overflow-hidden">
                    <div className="absolute inset-0 z-0 opacity-30">
                        <div className="absolute top-10 left-10 w-64 h-64 bg-indigo-300 dark:bg-indigo-900 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
                        <div className="absolute bottom-10 right-10 w-64 h-64 bg-pink-300 dark:bg-pink-900 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
                    </div>
                    <div className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl p-8 rounded-3xl shadow-xl border border-white/50 dark:border-slate-700 max-w-md w-full relative z-10">
                        <div className="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6">
                            {type === 'updating' ? <Icon name="hammer" className="w-10 h-10 text-orange-500" /> : type === 'restructuring' ? <Icon name="database" className="w-10 h-10 text-blue-500" /> : <Icon name="lock" className="w-10 h-10 text-red-500" />}
                        </div>
                        <h1 className="text-2xl font-black text-slate-800 dark:text-white mb-2">{type === 'updating' ? '網站更新中' : type === 'restructuring' ? '資料重整中' : '存取被拒'}</h1>
                        <p className="text-slate-500 dark:text-slate-400 font-medium mb-6 whitespace-pre-wrap">{customMessage || defaultMessage}</p>
                        {estimatedTime && (type === 'updating' || type === 'restructuring') && (
                            <div className="bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-xl p-4 flex items-center gap-3">
                                <Icon name="timer" className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
                                <div className="text-left">
                                    <div className="text-xs font-bold text-indigo-400 dark:text-indigo-500 uppercase">預計恢復時間</div>
                                    <div className="text-sm font-bold text-indigo-700 dark:text-indigo-300">{estimatedTime}</div>
                                </div>
                            </div>
                        )}
                        {!user && (<button onClick={onLogin} className="mt-6 w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-all shadow-md flex items-center justify-center gap-2"><Icon name="log-in" className="w-4 h-4" /> 登入</button>)}
                        {user && (<div className="mt-6"><p className="text-xs text-slate-400 mb-2">當前帳號: {user.email}</p><button onClick={() => window.firebaseServices?.signOut(window.firebaseServices.auth)} className="text-sm font-bold text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 underline">登出 / 切換帳號</button></div>)}
                    </div>
                </div>
            );
        }

        function AppearanceModal({ isOpen, onClose, t, themeColor, setThemeColor, isDarkMode, setIsDarkMode }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[160] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm p-6 relative z-10">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icon name="palette" className={`w-5 h-5 ${t.text}`} /> 外觀設定</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors"><Icon name="x" className="w-5 h-5 dark:text-slate-300" /></button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-3">主題顏色</label>
                                <div className="grid grid-cols-3 gap-3">
                                    {Object.entries(THEME_CONFIG).map(([key, config]) => (
                                        <button key={key} onClick={() => setThemeColor(key)} className={`flex flex-col items-center gap-2 p-3 rounded-xl border-2 transition-all ${themeColor === key ? `${config.border} ${config.lightBg}` : 'border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                            <div className={`w-6 h-6 rounded-full bg-gradient-to-br ${config.gradient}`}></div>
                                            <span className={`text-xs font-bold ${themeColor === key ? config.text : 'dark:text-slate-300'}`}>{config.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-3">介面模式</label>
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl">
                                    <button onClick={() => setIsDarkMode(false)} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${!isDarkMode ? 'bg-white dark:bg-slate-700 shadow-sm dark:text-white' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>
                                        <Icon name="sun" className="w-4 h-4 text-orange-500" /> 淺色
                                    </button>
                                    <button onClick={() => setIsDarkMode(true)} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${isDarkMode ? 'bg-white dark:bg-slate-700 shadow-sm dark:text-white' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>
                                        <Icon name="moon" className="w-4 h-4 text-indigo-400" /> 深色
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function NameSetupModal({ user, onSave, loading, triggerAlert, t }) {
            const [name, setName] = useState(user?.displayName || '');
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!name.trim()) { triggerAlert("請輸入名字"); return; } 
                onSave(name.trim()); 
            };
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
                    <div className="modal-animate bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm p-8 relative z-10 text-center border border-slate-100 dark:border-slate-700">
                        <div className={`w-16 h-16 ${t.lightBg} rounded-full flex items-center justify-center mx-auto mb-4 ${t.text}`}><Icon name="user" className="w-8 h-8" /></div>
                        <h2 className="text-2xl font-black text-slate-800 dark:text-white mb-2">個人模式設定</h2>
                        <p className="text-slate-500 dark:text-slate-400 mb-6 text-sm">請輸入你的<strong>英文短名</strong>，方便老師辨識</p>
                        <form onSubmit={handleSubmit}>
                            <input type="text" className={`w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 dark:text-white text-center font-bold text-lg focus:ring-2 focus:${t.ring} outline-none mb-4`} placeholder="名字 (例如: Peter)" value={name} onChange={e => setName(e.target.value)} autoFocus required />
                            <button type="submit" disabled={loading} className={`w-full py-3 rounded-xl text-white font-bold transition-all shadow-lg active:scale-95 disabled:opacity-50 ${t.bg}`}>{loading ? '設定中...' : '開始使用'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function JoinClassModal({ isOpen, onClose, systemClasses, joinedClasses, onJoin, t }) {
            const [code, setCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [floatingError, setFloatingError] = useState('');

            if (!isOpen) return null;

            const showError = (msg) => {
                setFloatingError(msg);
                setTimeout(() => setFloatingError(''), 3000);
            };

            const handleJoin = async (e) => {
                e.preventDefault();
                const upperCode = code.trim().toUpperCase();
                const targetClass = systemClasses.find(c => c.code === upperCode);

                if (!targetClass) return showError('無效的班級代碼！請確認後再試。');
                if (joinedClasses.includes(upperCode)) return showError('你已經加入過這個班級了！');

                setLoading(true);
                try {
                    await onJoin(upperCode, targetClass.name);
                    setCode('');
                } catch (err) {
                    showError('加入失敗，請重試');
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="modal-animate bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm p-6 relative z-10 text-center">

                        {/* 浮空錯誤提示 */}
                        {floatingError && (
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white px-5 py-3 rounded-2xl shadow-[0_10px_30px_rgba(239,68,68,0.4)] z-50 font-bold text-sm whitespace-nowrap pop-in-error flex items-center gap-2">
                                <Icon name="alert-circle" className="w-5 h-5" />
                                {floatingError}
                            </div>
                        )}

                        <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors"><Icon name="x" className="w-5 h-5 dark:text-slate-300" /></button>
                        <div className={`w-16 h-16 ${t.lightBg} rounded-full flex items-center justify-center mx-auto mb-4 mt-2 ${t.text}`}><Icon name="school" className="w-8 h-8" /></div>
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-2">加入班級</h2>
                        <p className="text-slate-500 dark:text-slate-400 mb-6 text-sm">請輸入由老師提供的 6 位數班級代碼</p>
                        <form onSubmit={handleJoin}>
                            <input 
                                type="text" 
                                maxLength={6} 
                                className={`w-full px-4 py-4 rounded-2xl border ${floatingError ? 'border-red-400 bg-red-50 dark:bg-red-900/10 focus:ring-red-400' : `border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:${t.ring}`} dark:text-white text-center font-mono font-bold text-2xl tracking-[0.5em] outline-none mb-4 uppercase placeholder:tracking-normal placeholder:text-base placeholder:font-sans transition-colors`} 
                                placeholder="輸入代碼" 
                                value={code} 
                                onChange={e => {setCode(e.target.value); setFloatingError('');}} 
                                autoFocus 
                                required 
                            />
                            <button type="submit" disabled={loading || code.length !== 6} className={`w-full py-3 rounded-xl text-white font-bold transition-all shadow-lg active:scale-95 disabled:opacity-50 ${t.bg}`}>{loading ? '處理中...' : '確認加入'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function CustomDropdown({ value, onChange, options }) { 
            const [isOpen, setIsOpen] = useState(false); const dropdownRef = useRef(null); 
            useEffect(() => { const handleClickOutside = (event) => { if (dropdownRef.current && !dropdownRef.current.contains(event.target)) { setIsOpen(false); } }; document.addEventListener('mousedown', handleClickOutside); return () => document.removeEventListener('mousedown', handleClickOutside); }, []); 
            const selectedLabel = options.find(o => o.value === value)?.label || '排序'; 
            return ( 
                <div className="relative" ref={dropdownRef}> 
                    <button type="button" onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-xs rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-900 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm active:scale-95"> 
                        <span>{selectedLabel}</span> <Icon name="chevron-down" className={`w-3 h-3 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} /> 
                    </button> 
                    {isOpen && ( <div className="absolute right-0 mt-2 w-48 bg-white/95 dark:bg-slate-800/95 backdrop-blur-xl rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 z-50 overflow-hidden animate-in fade-in zoom-in-95 duration-200 origin-top-right"> {options.map((opt) => ( <button key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`w-full text-left px-4 py-3 text-xs font-bold flex items-center gap-2 transition-colors ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}> {opt.icon && <Icon name={opt.icon} className="w-3.5 h-3.5" />}{opt.label} </button> ))} </div> )} 
                </div> 
            ); 
        }

        function AuthModal({ isOpen, onClose, triggerAlert }) { 
            const [isLogin, setIsLogin] = useState(true); 
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const { auth, googleProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword } = window.firebaseServices || {};

            useEffect(() => { if (isOpen) { setLoading(false); setEmail(''); setPassword(''); setIsLogin(true); } }, [isOpen]); 
            if (!isOpen) return null; 

            const handleGoogleLogin = async () => { try { setLoading(true); await signInWithPopup(auth, googleProvider); onClose(); } catch (error) { console.error(error); triggerAlert("Google 登入失敗: " + error.message); setLoading(false); } };
            const handleEmailAuth = async (e) => { 
                e.preventDefault(); if(!email || !password) return;
                try { 
                    setLoading(true); 
                    if (isLogin) { 
                        await signInWithEmailAndPassword(auth, email, password); 
                    } else { 
                        await createUserWithEmailAndPassword(auth, email, password); 
                    } 
                    onClose(); 
                } catch (error) { 
                    console.error(error); 
                    triggerAlert(isLogin ? "登入失敗: " + error.message : "註冊失敗: " + error.message); 
                    setLoading(false); 
                } 
            };

            return ( 
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4"> 
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div> 
                    <div className="modal-animate bg-white/90 dark:bg-slate-800/90 backdrop-blur-2xl rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.3)] w-full max-w-md p-8 relative z-10 border border-white/50 dark:border-slate-700 overflow-hidden"> 
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors"><Icon name="x" className="w-6 h-6" /></button> 
                        <div className="absolute -top-10 -left-10 w-40 h-40 bg-purple-300 dark:bg-purple-900 rounded-full mix-blend-multiply filter blur-2xl opacity-50 animate-blob pointer-events-none"></div> 
                        <div className="absolute -bottom-10 -right-10 w-40 h-40 bg-blue-300 dark:bg-blue-900 rounded-full mix-blend-multiply filter blur-2xl opacity-50 animate-blob animation-delay-2000 pointer-events-none"></div> 
                        <div className="text-center mb-8 relative"><h2 className="text-2xl font-black text-slate-800 dark:text-white tracking-tight">{isLogin ? '登入帳戶' : '立即註冊'}</h2><p className="text-slate-500 dark:text-slate-400 mt-1 text-sm">{isLogin ? '登入即可儲存及同步你的資料' : '只需幾秒，開始雲端記錄'} </p></div> 
                        <form onSubmit={handleEmailAuth} className="space-y-4 relative"> 
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors"><Icon name="mail" className="w-5 h-5" /></div><input type="email" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-medium" placeholder="電子郵件" value={email} onChange={e => setEmail(e.target.value)} required /></div> 
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors"><Icon name="lock" className="w-5 h-5" /></div><input type="password" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-medium" placeholder="密碼" value={password} onChange={e => setPassword(e.target.value)} required /></div> 
                            <button type="submit" disabled={loading} className="w-full py-3.5 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-lg shadow-lg shadow-indigo-500/30 transform transition-all active:scale-[0.98] disabled:opacity-70 flex items-center justify-center">{loading ? '處理中...' : (isLogin ? '登入' : '註冊')}</button> 
                        </form> 
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-100 dark:border-slate-700"></div></div><div className="relative flex justify-center text-xs uppercase tracking-wider font-bold text-slate-400"><span className="px-3 bg-white/80 dark:bg-slate-800/80 backdrop-blur">或</span></div></div> <button onClick={handleGoogleLogin} disabled={loading} className="w-full py-3 rounded-xl bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 font-bold hover:bg-slate-50 dark:hover:bg-slate-600 transition-all flex items-center justify-center gap-3 shadow-sm active:scale-[0.98]"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-5 h-5" />Google 登入</button>
                        <div className="mt-6 text-center"><p className="text-slate-500 dark:text-slate-400 text-sm">{isLogin ? '還沒有帳號？' : '已經有帳號了？'} <button onClick={() => setIsLogin(!isLogin)} className="text-indigo-600 dark:text-indigo-400 font-bold hover:text-indigo-700 dark:hover:text-indigo-300 ml-1 transition-colors">{isLogin ? '立即註冊' : '直接登入'}</button></p></div> 
                    </div> 
                </div> 
            ); 
        }

        function EditModal({ item, onClose, onSave, triggerAlert, subjects }) { 
            const [description, setDescription] = useState(item.description || ''); 
            const [subject, setSubject] = useState(item.subject || '其他'); 
            const [dueDate, setDueDate] = useState(item.dueDate || ''); 
            const [loading, setLoading] = useState(false); 
            const handleSave = async (e) => { e.preventDefault(); setLoading(true); try { await onSave(item.id, { description, subject, dueDate }); onClose(); } catch (error) { console.error(error); triggerAlert("更新失敗"); } finally { setLoading(false); } }; 
            return ( 
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4"> 
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div> 
                    <div className="modal-animate bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 overflow-hidden"> 
                        <div className="flex justify-between items-center mb-4"> 
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white">修改紀錄</h3> 
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors"><Icon name="x" className="w-5 h-5 text-slate-500 dark:text-slate-400" /></button> 
                        </div> 
                        <form onSubmit={handleSave} className="space-y-4"> 
                            <div> 
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">科目</label> 
                                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide"> 
                                    {subjects.map(sub => ( <button key={sub.name} type="button" onClick={() => setSubject(sub.name)} className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold border-2 transition-all ${subject === sub.name ? sub.color + ' ring-2 ring-offset-1 ring-indigo-100 dark:ring-indigo-900' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{sub.name}</button> ))} 
                                </div> 
                            </div> 
                            <div> 
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">內容</label> 
                                <textarea value={description} onChange={(e) => setDescription(e.target.value)} rows="3" className="w-full rounded-xl border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 dark:focus:ring-indigo-900/30 transition-all p-3 border text-slate-700 dark:text-slate-200 text-sm outline-none" required /> 
                            </div> 
                            <div> 
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">繳交/考試日期</label> 
                                <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full h-10 rounded-xl border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 dark:focus:ring-indigo-900/30 transition-all px-3 border text-slate-600 dark:text-slate-300 font-medium text-sm outline-none" required /> 
                            </div> 
                            <button type="submit" disabled={loading} className="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 dark:shadow-indigo-900/20 transition-all active:scale-95 disabled:opacity-70 flex items-center justify-center gap-2">{loading ? '儲存中...' : <><Icon name="save" className="w-4 h-4" /> 儲存修改</>}</button> 
                        </form> 
                    </div> 
                </div> 
            ); 
        }

        function SubjectSelectionModal({ onClose, onSelect, subjects }) {
            return (
                <div className="fixed inset-0 z-[160] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-2xl p-6 relative z-10 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-bold text-slate-800 dark:text-white">選擇科目</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors"><Icon name="x" className="w-6 h-6 text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 overflow-y-auto p-1">
                            <button onClick={() => onSelect("")} className="p-4 rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-400 dark:text-slate-500 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 hover:border-slate-400 transition-all flex flex-col items-center justify-center gap-2 min-h-[80px]">
                                <Icon name="minus-circle" className="w-6 h-6" />
                                空堂
                            </button>
                            {subjects.map(sub => (
                                <button key={sub.name} onClick={() => onSelect(sub.name)} className={`p-4 rounded-2xl border-2 font-bold transition-all shadow-sm hover:shadow-md hover:scale-[1.02] flex flex-col items-center justify-center gap-2 min-h-[80px] ${sub.color}`}>
                                    <span className="text-lg">{sub.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function SubjectManagerModal({ isOpen, onClose, currentSubjects, onSave, triggerConfirm }) {
            const [newSubjectName, setNewSubjectName] = useState('');
            const [newSubjectColor, setNewSubjectColor] = useState(COLOR_PALETTE[0].value);
            const [tempSubjects, setTempSubjects] = useState([]);

            useEffect(() => { if (isOpen) setTempSubjects(currentSubjects); }, [isOpen, currentSubjects]);
            if (!isOpen) return null;

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newSubjectName.trim()) return;
                if (tempSubjects.some(s => s.name === newSubjectName.trim())) { alert("科目名稱重複"); return; }
                setTempSubjects([...tempSubjects, { name: newSubjectName.trim(), color: newSubjectColor }]);
                setNewSubjectName('');
            };
            const handleDelete = (name) => { triggerConfirm(`確定要刪除「${name}」嗎？`, () => setTempSubjects(tempSubjects.filter(s => s.name !== name))); };
            
            // --- Custom Sorting Logic (v2.1) ---
            const moveSubject = (index, direction) => {
                const newSubjects = [...tempSubjects];
                if (direction === 'up' && index > 0) {
                    [newSubjects[index], newSubjects[index - 1]] = [newSubjects[index - 1], newSubjects[index]];
                } else if (direction === 'down' && index < newSubjects.length - 1) {
                    [newSubjects[index], newSubjects[index + 1]] = [newSubjects[index + 1], newSubjects[index]];
                }
                setTempSubjects(newSubjects);
            };

            const handleAISort = () => {
                const priority = ['中文', '英文', '數學', '常識', '通識', '公社', '物理', '化學', '生物'];
                const sorted = [...tempSubjects].sort((a, b) => {
                    const idxA = priority.indexOf(a.name);
                    const idxB = priority.indexOf(b.name);
                    
                    // 1. Priority Subjects First
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;

                    // 2. Then by length (shorter names usually more important/generic)
                    if (a.name.length !== b.name.length) return a.name.length - b.name.length;

                    // 3. Fallback to locale compare
                    return a.name.localeCompare(b.name);
                });
                setTempSubjects(sorted);
            };

            const handleSaveInternal = () => { onSave(tempSubjects); onClose(); };
            const handleReset = () => { triggerConfirm("確定重置為預設科目？這將覆蓋您的自訂科目。", () => { onSave(DEFAULT_SUBJECTS); onClose(); }); };

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-xl p-6 relative z-10 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white">科目設定</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors"><Icon name="x" className="w-5 h-5 text-slate-500 dark:text-slate-400" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto pr-1">
                            <div className="flex justify-between items-center mb-3">
                                <span className="text-xs font-bold text-slate-500 dark:text-slate-400">科目列表</span>
                                <button onClick={handleAISort} className="text-xs font-bold bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-1.5 rounded-lg shadow-md hover:shadow-lg transition-all active:scale-95 flex items-center gap-1">
                                    <Icon name="sparkles" className="w-3 h-3" /> AI 智能排序
                                </button>
                            </div>

                            <form onSubmit={handleAdd} className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700 mb-4">
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">新增科目</label>
                                <div className="flex gap-2 mb-2">
                                    <input type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="flex-1 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-white text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="科目名稱 (例如: 數學)" required />
                                </div>
                                <div className="grid grid-cols-5 gap-2 max-h-32 overflow-y-auto pr-1 pb-1">
                                    {COLOR_PALETTE.map((c, i) => (
                                        <button key={i} type="button" onClick={() => setNewSubjectColor(c.value)} className={`h-8 rounded-lg border-2 ${c.value} ${newSubjectColor === c.value ? 'ring-2 ring-offset-1 ring-slate-400 dark:ring-slate-500 border-transparent' : 'border-transparent opacity-60 hover:opacity-100'}`} title={c.label} />
                                    ))}
                                </div>
                                <button type="submit" className="w-full mt-3 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors">新增</button>
                            </form>
                            <div className="space-y-2">
                                {tempSubjects.map((sub, index) => (
                                    <div key={sub.name + index} className="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm group">
                                        <span className={`px-2 py-1 rounded text-xs font-bold border ${sub.color}`}>{sub.name}</span>
                                        <div className="flex items-center gap-1">
                                            <button type="button" onClick={() => moveSubject(index, 'up')} disabled={index === 0} className="p-1.5 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"><Icon name="arrow-up" className="w-3.5 h-3.5" /></button>
                                            <button type="button" onClick={() => moveSubject(index, 'down')} disabled={index === tempSubjects.length - 1} className="p-1.5 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"><Icon name="arrow-down" className="w-3.5 h-3.5" /></button>
                                            <div className="w-px h-4 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                                            <button onClick={() => handleDelete(sub.name)} className="text-slate-400 hover:text-red-500 transition-colors p-1"><Icon name="trash-2" className="w-4 h-4" /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex gap-3">
                            <button onClick={handleReset} className="px-4 py-2 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-bold text-sm">重置預設</button>
                            <button onClick={handleSaveInternal} className="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors">儲存變更</button>
                        </div>
                    </div>
                </div>
            );
        }

        function SlotTypeSelector({ value, onChange }) {
            const types = [ { id: 'lesson', label: '課堂', icon: 'book-open' }, { id: 'break', label: '小息', icon: 'coffee' }, { id: 'lunch', label: '午膳', icon: 'utensils' } ];
            return (
                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl">
                    {types.map(t => (
                        <button key={t.id} onClick={() => onChange(t.id)} className={`flex-1 flex items-center justify-center gap-1.5 py-1.5 px-2 rounded-lg text-xs font-bold transition-all ${value === t.id ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>
                            <Icon name={t.icon} className="w-3 h-3" /> {t.label}
                        </button>
                    ))}
                </div>
            );
        }

        function TimetableEditor({ initialConfig, onSave, onCancel, subjects, triggerConfirm }) {
            const [activeTab, setActiveTab] = useState('slots'); 
            const [timeSlots, setTimeSlots] = useState(initialConfig?.timeSlots || [...DEFAULT_TIME_SLOTS]);
            const [schedule, setSchedule] = useState(initialConfig?.schedule || { ...DEFAULT_SCHEDULE });
            const [editDay, setEditDay] = useState(1); 
            const [editingCell, setEditingCell] = useState(null); 

            const handleSlotChange = (index, field, value) => { const newSlots = [...timeSlots]; newSlots[index] = { ...newSlots[index], [field]: value }; setTimeSlots(newSlots); };
            const addSlot = () => setTimeSlots([...timeSlots, { id: 's' + Date.now(), label: '新課節', type: 'lesson', startTime: '08:00', duration: 35 }]);
            const removeSlot = (index) => setTimeSlots(timeSlots.filter((_, i) => i !== index));
            const moveSlot = (index, direction) => {
                const newSlots = [...timeSlots];
                if (direction === 'up' && index > 0) { [newSlots[index], newSlots[index - 1]] = [newSlots[index - 1], newSlots[index]]; } 
                else if (direction === 'down' && index < newSlots.length - 1) { [newSlots[index], newSlots[index + 1]] = [newSlots[index + 1], newSlots[index]]; }
                setTimeSlots(newSlots);
            };

            const openSubjectModal = (day, lessonIndex) => setEditingCell({ day, lessonIndex });
            const handleSubjectSelect = (subjectName) => {
                if (editingCell) {
                    const { day, lessonIndex } = editingCell; const newSchedule = { ...schedule };
                    if (!newSchedule[day]) newSchedule[day] = [];
                    while (newSchedule[day].length <= lessonIndex) newSchedule[day].push("");
                    newSchedule[day][lessonIndex] = subjectName;
                    setSchedule(newSchedule); setEditingCell(null); 
                }
            };
            const handleSave = () => onSave({ timeSlots, schedule });
            const resetToDefault = () => { triggerConfirm("確定要重置為預設時間表嗎？", () => { setTimeSlots([...DEFAULT_TIME_SLOTS]); setSchedule({ ...DEFAULT_SCHEDULE }); }); };
            const lessonSlots = timeSlots.map((s, i) => ({ ...s, originalIndex: i })).filter(s => s.type === 'lesson');

            return (
                <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col h-[80vh] max-w-4xl mx-auto relative">
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                        <h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icon name="edit" className="w-5 h-5 text-indigo-500 dark:text-indigo-400"/> 編輯時間表</h2>
                        <div className="flex gap-2">
                            <button onClick={resetToDefault} className="px-3 py-1.5 text-xs font-bold text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">重置預設</button>
                            <button onClick={onCancel} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-400"><Icon name="x" className="w-5 h-5"/></button>
                        </div>
                    </div>

                    <div className="flex border-b border-slate-100 dark:border-slate-700">
                        <button onClick={() => setActiveTab('slots')} className={`flex-1 py-3 text-sm font-bold transition-colors ${activeTab === 'slots' ? 'text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400 bg-indigo-50/50 dark:bg-indigo-900/20' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}>時間設定</button>
                        <button onClick={() => setActiveTab('schedule')} className={`flex-1 py-3 text-sm font-bold transition-colors ${activeTab === 'schedule' ? 'text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400 bg-indigo-50/50 dark:bg-indigo-900/20' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}>課程編排</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 bg-slate-50 dark:bg-slate-900/50">
                        {activeTab === 'slots' ? (
                            <div className="space-y-3">
                                {timeSlots.map((slot, index) => (
                                    <div key={index} className="flex flex-wrap items-center gap-2 bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm transition-all">
                                        <div className="flex flex-col gap-1 mr-2">
                                            <button onClick={() => moveSlot(index, 'up')} disabled={index === 0} className="p-1 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 active:scale-90 transition-transform"><Icon name="chevron-up" className="w-4 h-4" /></button>
                                            <button onClick={() => moveSlot(index, 'down')} disabled={index === timeSlots.length - 1} className="p-1 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-20 active:scale-90 transition-transform"><Icon name="chevron-down" className="w-4 h-4" /></button>
                                        </div>
                                        <input type="time" value={slot.startTime} onChange={(e) => handleSlotChange(index, 'startTime', e.target.value)} className="w-24 p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm font-mono bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" />
                                        <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-900 px-2 rounded-lg border border-slate-200 dark:border-slate-700">
                                            <input type="number" value={slot.duration} onChange={(e) => handleSlotChange(index, 'duration', parseInt(e.target.value) || 0)} className="w-12 p-2 bg-transparent text-sm text-center outline-none text-slate-800 dark:text-white" />
                                            <span className="text-xs text-slate-500 pr-1">分</span>
                                        </div>
                                        <div className="min-w-[180px]"><SlotTypeSelector value={slot.type} onChange={(val) => handleSlotChange(index, 'type', val)} /></div>
                                        <input type="text" value={slot.label} onChange={(e) => handleSlotChange(index, 'label', e.target.value)} className="flex-1 min-w-[100px] p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-900 text-slate-800 dark:text-white" placeholder="標籤" />
                                        <button onClick={() => removeSlot(index)} className="p-2 text-slate-400 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg"><Icon name="trash-2" className="w-4 h-4" /></button>
                                    </div>
                                ))}
                                <button onClick={addSlot} className="w-full py-3 border-2 border-dashed border-indigo-200 dark:border-indigo-800 text-indigo-500 dark:text-indigo-400 rounded-xl font-bold hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all flex items-center justify-center gap-2"><Icon name="plus" className="w-4 h-4" /> 新增時間段</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                    {['一','二','三','四','五'].map((d, i) => (
                                        <button key={i} onClick={() => setEditDay(i + 1)} className={`px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap transition-all ${editDay === i + 1 ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 dark:shadow-none' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>星期{d}</button>
                                    ))}
                                </div>
                                <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm space-y-3">
                                    <h3 className="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                        <span className="w-2 h-6 bg-indigo-500 rounded-full"></span>
                                        星期{['日','一','二','三','四','五','六'][editDay]} 課程
                                    </h3>
                                    {lessonSlots.length === 0 ? <p className="text-slate-400 text-center py-4">請先在「時間設定」新增課堂類型的時間段</p> : 
                                    lessonSlots.map((slot, lessonIdx) => {
                                        const currentSubjectName = schedule[editDay]?.[lessonIdx];
                                        const subObj = subjects.find(s => s.name === currentSubjectName);
                                        const colorClass = subObj ? subObj.color : 'bg-slate-100 dark:bg-slate-900/50 text-slate-400 dark:text-slate-500 border-slate-200 dark:border-slate-700';

                                        return (
                                            <div key={lessonIdx} className="flex items-center gap-3">
                                                <div className="w-20 text-xs font-bold text-slate-500 dark:text-slate-400 text-right">{slot.label}</div>
                                                <div className="flex-1">
                                                    <button onClick={() => openSubjectModal(editDay, lessonIdx)} className={`w-full p-3 rounded-xl border-2 text-left font-bold transition-all hover:brightness-95 flex justify-between items-center ${currentSubjectName ? colorClass : 'bg-slate-50 dark:bg-slate-900/50 border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-500'}`}>
                                                        <span>{currentSubjectName || '(空堂)'}</span>
                                                        <Icon name="chevron-right" className="w-4 h-4 opacity-50" />
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
                        <button onClick={handleSave} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2"><Icon name="save" className="w-4 h-4" /> 儲存設定</button>
                    </div>

                    {editingCell && <SubjectSelectionModal onClose={() => setEditingCell(null)} onSelect={handleSubjectSelect} subjects={subjects} />}
                </div>
            );
        }

        // --- Timetable Component ---
        function Timetable({ currentDay, config, onDayChange, subjects }) { 
            const weekDays = ['日', '一', '二', '三', '四', '五', '六']; 
            const [now, setNow] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(timer); }, []);

            const scheduleData = generateFullSchedule(config, now, currentDay); 
            const formatTimeStr = (date) => { 
                try {
                    if (!(date instanceof Date) || isNaN(date.getTime())) return '--:--';
                    return date.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' }); 
                } catch(e) { return '--:--'; }
            };

            return ( 
                <div className="space-y-4"> 
                    <div className="flex bg-white dark:bg-slate-800 rounded-xl p-1 shadow-sm overflow-x-auto">{[1, 2, 3, 4, 5].map(day => (<button key={day} onClick={() => onDayChange(day)} className={`flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${currentDay === day ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>星期{weekDays[day]}</button>))}</div> 
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-4">
                        {scheduleData.length > 0 ? scheduleData.map((slot, idx) => { 
                            const nowTime = now.getTime(); const startTime = slot.start.getTime(); const endTime = slot.end.getTime();
                            let status = 'future'; let diff = 0;
                            if (nowTime > endTime) { status = 'past'; } else if (nowTime >= startTime && nowTime <= endTime) { status = 'current'; diff = endTime - nowTime; }
                            return (
                                <div key={idx} className={`relative pl-6 pb-6 last:pb-0 border-l-2 transition-colors duration-500 ${status === 'current' ? 'border-purple-500 dark:border-purple-400' : (status === 'past' ? 'border-slate-200 dark:border-slate-700' : 'border-green-300 dark:border-green-700')}`}>
                                    <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 transition-all duration-500 ${status === 'current' ? 'bg-purple-500 border-purple-100 animate-pulse scale-110' : (status === 'past' ? 'bg-slate-200 dark:bg-slate-700 border-slate-100 dark:border-slate-600' : 'bg-white dark:bg-slate-800 border-green-400 dark:border-green-500')}`}></div>
                                    <div className={`rounded-xl p-3 transition-all duration-500 ${status === 'current' ? 'bg-purple-50 dark:bg-purple-900/30 shadow-md border border-purple-100 dark:border-purple-800 transform scale-[1.02]' : (status === 'past' ? 'opacity-60 grayscale' : 'bg-green-50/50 dark:bg-green-900/20 border border-green-100 dark:border-green-800')}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className={`text-xs font-mono mb-0.5 ${status === 'current' ? 'text-purple-600 dark:text-purple-400 font-bold' : 'text-slate-400 dark:text-slate-500'}`}>{formatTimeStr(slot.start)} - {formatTimeStr(slot.end)}</div>
                                                <div className={`text-base font-bold ${slot.type === 'lesson' ? 'text-slate-800 dark:text-slate-200' : 'text-slate-500 dark:text-slate-400 italic'} ${status === 'current' ? 'text-purple-900 dark:text-purple-300' : ''}`}>{slot.subjectName}</div>
                                            </div>
                                            {status === 'current' && (<div className="text-right"><span className="inline-block text-[10px] bg-purple-600 text-white px-2 py-0.5 rounded-full font-bold mb-1 animate-pulse">進行中</span><div className="text-xs font-mono font-bold text-purple-600 dark:text-purple-400">剩 {formatCountdown(diff)}</div></div>)}
                                            {status === 'past' && <Icon name="check" className="w-4 h-4 text-slate-300 dark:text-slate-600" />}
                                        </div>
                                    </div>
                                </div>
                            ); 
                        }) : (<div className="text-center py-10 text-slate-400">是日休息或未設定課程</div>)}
                    </div> 
                </div> 
            ); 
        }

        // --- 全新超級管理控制台 AdminConsole ---
        function AdminConsole({ db, systemConfig, systemClasses, onBack, subjects, triggerAlert, triggerConfirm }) {
            const [activeTab, setActiveTab] = useState('overview');
            const [users, setUsers] = useState([]);
            const [publicTasks, setPublicTasks] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedUser, setSelectedUser] = useState(null);
            const [userHomeworks, setUserHomeworks] = useState([]);
            const [newEmail, setNewEmail] = useState('');
            const [newClassName, setNewClassName] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [newName, setNewName] = useState('');
            
            // v2.2 Admin Editing State
            const [editingAdminItem, setEditingAdminItem] = useState(null);

            const { collection, getDocs, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, deleteDoc, setDoc } = window.firebaseServices || {};
            const allowedEmails = systemConfig?.allowedEmails || [];

            useEffect(() => {
                if (!db || !collection) return;
                const q = query(collection(db, "users_public"), orderBy("lastSeen", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => setUsers(snapshot.docs.map(d => ({ uid: d.id, ...d.data() }))), (err) => console.warn("Admin users err:", err));
                return () => unsubscribe();
            }, [db, collection]);

            useEffect(() => {
                if (!db || !collection) return;
                const q = query(collection(db, "public_assignments"), orderBy("createdAt", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => setPublicTasks(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))), (err) => console.warn("Admin tasks err:", err));
                return () => unsubscribe();
            }, [db, collection]);

            useEffect(() => {
                if (!selectedUser || !db || !collection) return;
                const q = query(collection(db, "users", selectedUser.uid, "items"), orderBy("dueDate", "asc"));
                const unsubscribe = onSnapshot(q, (snapshot) => setUserHomeworks(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))), (err) => console.warn("Admin user items err:", err));
                setNewName(selectedUser.displayName || '');
                return () => unsubscribe();
            }, [selectedUser, db, collection]);

            const updateConfig = async (key, value) => { try { await setDoc(doc(db, "system_settings", "config"), { [key]: value }, { merge: true }); triggerAlert("設定已更新"); } catch (e) { triggerAlert("設定更新失敗"); } };
            const handleAddWhitelist = async (e) => { e.preventDefault(); if (!newEmail.trim()) return; setIsSubmitting(true); try { await updateDoc(doc(db, "system_settings", "config"), { allowedEmails: arrayUnion(newEmail.trim()) }); setNewEmail(''); triggerAlert("已新增至白名單"); } catch (e) { triggerAlert("新增失敗"); } setIsSubmitting(false); };
            const handleRemoveWhitelist = async (email) => { triggerConfirm(`確定要移除白名單 ${email} 嗎？`, async () => { try { await updateDoc(doc(db, "system_settings", "config"), { allowedEmails: arrayRemove(email) }); triggerAlert("已移除"); } catch (e) { } }); };

            const handleCreateClass = async (e) => {
                e.preventDefault(); const name = newClassName.trim(); if (!name) return;
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                try {
                    await updateDoc(doc(db, 'system_settings', 'classes'), { list: arrayUnion({ code, name, createdAt: new Date().toISOString() }) });
                    setNewClassName(''); triggerAlert(`成功建立班級：${name} (代碼: ${code})`);
                } catch(e) { 
                    await setDoc(doc(db, 'system_settings', 'classes'), { list: arrayUnion({ code, name, createdAt: new Date().toISOString() }) }, { merge: true });
                    setNewClassName(''); triggerAlert(`成功建立班級：${name} (代碼: ${code})`);
                }
            };
            const handleDeleteClass = async (classObj) => {
                triggerConfirm(`確定刪除班級 ${classObj.name} 嗎？學生的歷史紀錄仍會保留。`, async () => {
                    try { await updateDoc(doc(db, 'system_settings', 'classes'), { list: arrayRemove(classObj) }); triggerAlert("已刪除班級"); } catch (e) { }
                });
            };

            const handleDeleteUser = async (targetUser) => {
                triggerConfirm(`⚠️ 危險操作！確定要刪除用戶 ${targetUser.displayName} (${targetUser.email}) 的所有資料？此操作無法復原！`, async () => {
                    try {
                        const itemsQ = query(collection(db, "users", targetUser.uid, "items"));
                        const itemsSnap = await getDocs(itemsQ);
                        await Promise.all(itemsSnap.docs.map(d => deleteDoc(d.ref)));
                        await deleteDoc(doc(db, "users", targetUser.uid, "settings", "timetable"));
                        await deleteDoc(doc(db, "users", targetUser.uid, "settings", "subjects"));
                        await deleteDoc(doc(db, "users_public", targetUser.uid));
                        triggerAlert("用戶資料已徹底刪除");
                        if (selectedUser?.uid === targetUser.uid) setSelectedUser(null);
                    } catch (e) { triggerAlert("刪除失敗: " + e.message); }
                });
            };
            
            const handleUpdateUserName = async () => {
                if(!selectedUser || !newName.trim()) return;
                try {
                    await updateDoc(doc(db, "users_public", selectedUser.uid), { displayName: newName.trim() });
                    triggerAlert("用戶名稱已更新");
                } catch(e) { triggerAlert("更新失敗"); }
            };

            // v2.2 Admin Editing Logic
            const handleAdminUpdateItem = async (itemId, updatedData) => {
                if (!selectedUser) return;
                try {
                    await updateDoc(doc(db, "users", selectedUser.uid, "items", itemId), updatedData);
                    triggerAlert("已修改該用戶紀錄");
                } catch(e) {
                    triggerAlert("修改失敗: " + e.message);
                    throw e;
                }
            };

            // v2.2 Admin Delete Item (Individual)
            const handleAdminDeleteItem = async (itemId) => {
                if (!selectedUser) return;
                triggerConfirm("確定要刪除此條紀錄嗎？", async () => {
                    try {
                        await deleteDoc(doc(db, "users", selectedUser.uid, "items", itemId));
                    } catch(e) { triggerAlert("刪除失敗"); }
                });
            };

            const handleDeletePublicTask = (taskId) => {
                triggerConfirm("確定要撤回這份廣播功課嗎？這會同時從所有同學的清單中移除。", async () => {
                    try { await deleteDoc(doc(db, "public_assignments", taskId)); triggerAlert("廣播功課已撤回"); } catch (e) { triggerAlert("撤回失敗"); }
                });
            };
            
            const getUserStatus = (lastSeen) => {
                if (!lastSeen || typeof lastSeen.toDate !== 'function') return 'offline';
                const diff = new Date() - lastSeen.toDate();
                if (diff < 2 * 60 * 1000) return 'online'; // 2 mins
                if (diff < 10 * 60 * 1000) return 'idle'; // 10 mins
                return 'offline';
            };

            const activeTodayCount = users.filter(u => u.lastSeen && typeof u.lastSeen.toDate === 'function' && (new Date() - u.lastSeen.toDate()) < 24 * 60 * 60 * 1000).length;
            const filteredUsers = users.filter(u => (u.displayName || '').toLowerCase().includes(searchQuery.toLowerCase()) || (u.email || '').toLowerCase().includes(searchQuery.toLowerCase()));

            return (
                <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-slate-100 dark:border-slate-800 overflow-hidden flex flex-col md:flex-row min-h-[700px] relative z-20">
                    <div className="w-full md:w-64 bg-slate-900 dark:bg-slate-950 text-slate-300 p-6 flex flex-col gap-2 shrink-0 border-r border-slate-800">
                        <div className="flex items-center gap-3 mb-8 text-white px-2">
                            <button onClick={onBack} className="p-2 -ml-2 hover:bg-slate-800 rounded-full transition-colors"><Icon name="arrow-left" className="w-5 h-5" /></button>
                            <h2 className="text-xl font-black tracking-wide">超級管理中心</h2>
                        </div>
                        <div className="flex flex-row md:flex-col gap-2 overflow-x-auto scrollbar-hide pb-2 md:pb-0">
                            {[ { id: 'overview', icon: 'pie-chart', label: '系統概覽' }, { id: 'users', icon: 'users', label: '用戶數據管理' }, { id: 'classes', icon: 'school', label: '班級代碼管理' }, { id: 'tasks', icon: 'radio', label: '廣播任務中心' }, { id: 'settings', icon: 'settings-2', label: '核心系統設定' } ].map(tab => (
                                <button key={tab.id} onClick={() => { setActiveTab(tab.id); setSelectedUser(null); }} className={`flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all whitespace-nowrap md:whitespace-normal ${activeTab === tab.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'hover:bg-slate-800 hover:text-white'}`}>
                                    <Icon name={tab.icon} className={`w-5 h-5 ${activeTab === tab.id ? 'text-indigo-200' : 'text-slate-500'}`} /> {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 p-6 md:p-8 overflow-y-auto bg-slate-50/50 dark:bg-slate-900/50 text-slate-800 dark:text-slate-200 relative">
                        {/* Admin-side Edit Modal */}
                        {editingAdminItem && (
                            <EditModal item={editingAdminItem} onClose={() => setEditingAdminItem(null)} onSave={handleAdminUpdateItem} triggerAlert={triggerAlert} subjects={subjects} />
                        )}

                        {activeTab === 'overview' && (
                            <div className="space-y-6 animate-fadeIn">
                                <h3 className="text-2xl font-bold dark:text-white mb-6">系統概覽</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg shadow-blue-500/20 relative overflow-hidden group">
                                        <div className="text-blue-100 text-sm font-bold mb-1 flex items-center gap-2"><Icon name="users" className="w-4 h-4"/> 總註冊用戶</div>
                                        <div className="text-4xl font-black">{users.length}</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-emerald-400 to-teal-500 rounded-2xl p-6 text-white shadow-lg shadow-teal-500/20 relative overflow-hidden group">
                                        <div className="text-emerald-100 text-sm font-bold mb-1 flex items-center gap-2"><Icon name="activity" className="w-4 h-4"/> 24小時內活躍</div>
                                        <div className="text-4xl font-black">{activeTodayCount}</div>
                                    </div>
                                    <div className="bg-gradient-to-br from-orange-400 to-red-500 rounded-2xl p-6 text-white shadow-lg shadow-orange-500/20 relative overflow-hidden group">
                                        <div className="text-orange-100 text-sm font-bold mb-1 flex items-center gap-2"><Icon name="radio" className="w-4 h-4"/> 廣播任務總數</div>
                                        <div className="text-4xl font-black">{publicTasks.length}</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'classes' && (
                            <div className="space-y-6 animate-fadeIn h-full flex flex-col">
                                <h3 className="text-2xl font-bold dark:text-white">班級代碼管理</h3>
                                <p className="text-sm text-slate-500 dark:text-slate-400 -mt-2">建立班級群組，系統會自動生成隨機代碼。學生憑代碼加入後，即可接收該班級專屬的廣播功課。</p>

                                <form onSubmit={handleCreateClass} className="flex gap-3 mt-4">
                                    <input type="text" placeholder="輸入班級名稱 (例如: 3A 班)..." value={newClassName} onChange={e => setNewClassName(e.target.value)} className="flex-1 px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all shadow-sm" required />
                                    <button type="submit" className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-indigo-700 transition-all shadow-md active:scale-95 flex items-center gap-2 whitespace-nowrap"><Icon name="plus" className="w-4 h-4" /> 建立班級</button>
                                </form>

                                <div className="flex-1 bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden flex flex-col mt-4">
                                    <div className="overflow-y-auto flex-1">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50/80 dark:bg-slate-800/80 text-slate-500 dark:text-slate-400 font-bold sticky top-0 backdrop-blur-md z-10 border-b border-slate-100 dark:border-slate-700">
                                                <tr><th className="px-6 py-4">班級名稱</th><th className="px-6 py-4">加入代碼 (6碼)</th><th className="px-6 py-4 text-right">操作</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50 dark:divide-slate-700">
                                                {systemClasses.map(c => (
                                                    <tr key={c.code} className="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                                        <td className="px-6 py-4 font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icon name="school" className="w-4 h-4 text-indigo-500"/> {c.name}</td>
                                                        <td className="px-6 py-4"><span className="px-3 py-1 bg-slate-100 dark:bg-slate-900 rounded-lg font-mono font-bold text-indigo-600 dark:text-indigo-400 tracking-widest">{c.code}</span></td>
                                                        <td className="px-6 py-4 text-right">
                                                            <button onClick={() => handleDeleteClass(c)} className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {systemClasses.length === 0 && <tr><td colSpan="3" className="px-6 py-12 text-center text-slate-400">目前尚無任何班級</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'users' && !selectedUser && (
                            <div className="space-y-6 animate-fadeIn h-full flex flex-col">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                    <h3 className="text-2xl font-bold dark:text-white">用戶數據管理</h3>
                                    <div className="relative w-full sm:w-64">
                                        <Icon name="search" className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                        <input type="text" placeholder="搜尋用戶名字或 Email..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all shadow-sm" />
                                    </div>
                                </div>
                                <div className="flex-1 bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden flex flex-col">
                                    <div className="overflow-y-auto flex-1">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50/80 dark:bg-slate-800/80 text-slate-500 dark:text-slate-400 font-bold sticky top-0 backdrop-blur-md z-10 border-b border-slate-100 dark:border-slate-700">
                                                <tr><th className="px-6 py-4">用戶資訊</th><th className="px-6 py-4">身分權限</th><th className="px-6 py-4">最後上線</th><th className="px-6 py-4 text-right">操作</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50 dark:divide-slate-700">
                                                {filteredUsers.map(u => {
                                                    const isAdm = u.email === ADMIN_EMAIL;
                                                    const isWhite = allowedEmails.includes(u.email);
                                                    const userClassesNames = (u.joinedClasses || []).map(code => { const cls = systemClasses.find(c => c.code === code); return cls ? cls.name : code; }).join(', ');
                                                    const onlineStatus = getUserStatus(u.lastSeen);

                                                    return (
                                                        <tr key={u.uid} className="hover:bg-indigo-50/30 dark:hover:bg-slate-700/50 transition-colors group cursor-pointer" onClick={() => setSelectedUser(u)}>
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`relative w-9 h-9 rounded-full flex items-center justify-center font-bold text-white shadow-sm shrink-0 ${isAdm ? 'bg-purple-500' : isWhite ? 'bg-emerald-500' : 'bg-slate-400 dark:bg-slate-600'}`}>
                                                                        {u.displayName?.[0]?.toUpperCase() || 'U'}
                                                                        {onlineStatus === 'online' && <span className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white dark:border-slate-800 rounded-full"></span>}
                                                                        {onlineStatus === 'idle' && <span className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-yellow-400 border-2 border-white dark:border-slate-800 rounded-full"></span>}
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-bold dark:text-white flex items-center gap-2">{u.displayName || '未命名'}</div>
                                                                        <div className="text-xs text-slate-400">{u.email}</div>
                                                                        {userClassesNames && <div className="text-[10px] text-indigo-500 dark:text-indigo-400 mt-1 truncate max-w-[150px]" title={userClassesNames}>班級: {userClassesNames}</div>}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                {isAdm ? <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-[10px] font-bold">管理員</span> :
                                                                 isWhite ? <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-[10px] font-bold">白名單</span> :
                                                                 <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[10px] font-bold">普通用戶</span>}
                                                            </td>
                                                            <td className="px-6 py-4 text-slate-500 dark:text-slate-400 text-xs font-mono">
                                                                {onlineStatus === 'online' ? <span className="text-green-500 font-bold">🟢 線上</span> :
                                                                 onlineStatus === 'idle' ? <span className="text-yellow-500 font-bold">🟡 剛離開</span> :
                                                                 <span className="text-slate-400">⚪ {u.lastSeen && typeof u.lastSeen.toDate === 'function' ? u.lastSeen.toDate().toLocaleString('zh-HK') : '無紀錄'}</span>}
                                                            </td>
                                                            <td className="px-6 py-4 text-right">
                                                                <div className="flex items-center justify-end gap-2">
                                                                    <Icon name="chevron-right" className="w-4 h-4 text-slate-300" />
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                                {filteredUsers.length === 0 && <tr><td colSpan="4" className="px-6 py-12 text-center text-slate-400">找不到符合條件的用戶</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'users' && selectedUser && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setSelectedUser(null)} className="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-full transition-colors bg-slate-200 dark:bg-slate-800 border border-slate-300 dark:border-slate-600"><Icon name="arrow-left" className="w-5 h-5 text-slate-600 dark:text-slate-300" /></button>
                                    <div>
                                        <h3 className="text-2xl font-bold dark:text-white flex items-center gap-2">{selectedUser.displayName} 的詳細紀錄 </h3>
                                        <p className="text-sm text-slate-500">{selectedUser.email}</p>
                                    </div>
                                </div>
                                
                                <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col md:flex-row gap-6 items-center md:items-start">
                                     <div className="w-full md:w-auto flex-1 space-y-4">
                                         <h4 className="font-bold text-slate-700 dark:text-slate-200">用戶檔案編輯</h4>
                                         <div className="flex gap-2">
                                             <input type="text" value={newName} onChange={e => setNewName(e.target.value)} className="flex-1 px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" placeholder="顯示名稱" />
                                             <button onClick={handleUpdateUserName} className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700">更新</button>
                                         </div>
                                         <div className="flex gap-2 pt-2">
                                             {!allowedEmails.includes(selectedUser.email) && <button onClick={() => updateConfig('allowedEmails', arrayUnion(selectedUser.email))} className="text-xs font-bold text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 px-3 py-1.5 rounded-lg hover:bg-emerald-100 transition-colors">➕ 加入白名單</button>}
                                             <button onClick={() => handleDeleteUser(selectedUser)} className="text-xs font-bold text-red-600 bg-red-50 dark:bg-red-900/20 px-3 py-1.5 rounded-lg hover:bg-red-100 transition-colors flex items-center gap-1"><Icon name="trash-2" className="w-3 h-3" /> 強制刪除帳號</button>
                                         </div>
                                     </div>
                                     <div className="flex gap-4">
                                        <div className="text-center p-2"><div className="text-2xl font-black">{userHomeworks.length}</div><div className="text-xs font-bold text-slate-400 mt-1">總項目</div></div>
                                        <div className="text-center p-2"><div className="text-2xl font-black text-emerald-500">{userHomeworks.filter(h=>h.completed).length}</div><div className="text-xs font-bold text-slate-400 mt-1">已完成</div></div>
                                     </div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 overflow-hidden p-2">
                                    <div className="max-h-[400px] overflow-y-auto space-y-2 pr-2">
                                        {userHomeworks.map(h => (
                                            <div key={h.id} className={`p-4 rounded-xl border text-sm flex justify-between items-start transition-all ${h.completed ? 'bg-slate-50 dark:bg-slate-900/50 border-slate-100 dark:border-slate-800 opacity-60' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-indigo-200'}`}>
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1.5">
                                                        <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold border ${subjects.find(s => s.name === h.subject)?.color || 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600'}`}>{h.subject || '其他'}</span>
                                                        {h.completed ? <span className="text-[10px] bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-2 py-0.5 rounded font-bold">已完成</span> : <span className="text-[10px] bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 px-2 py-0.5 rounded font-bold">未完成</span>}
                                                    </div>
                                                    <div className={`font-medium ${h.completed ? 'line-through text-slate-400 dark:text-slate-500' : 'text-slate-700 dark:text-slate-200'}`}>{h.description}</div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <div className="text-xs font-mono text-slate-400 dark:text-slate-500 bg-slate-50 dark:bg-slate-900 px-2 py-1 rounded border border-slate-100 dark:border-slate-800">{h.dueDate}</div>
                                                    {/* v2.2 Admin Editing Buttons */}
                                                    <div className="flex gap-1">
                                                        <button onClick={() => setEditingAdminItem(h)} className="p-1.5 text-slate-400 hover:text-indigo-600 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors"><Icon name="pencil" className="w-3.5 h-3.5" /></button>
                                                        <button onClick={() => handleAdminDeleteItem(h.id)} className="p-1.5 text-slate-400 hover:text-red-600 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors"><Icon name="trash-2" className="w-3.5 h-3.5" /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'tasks' && (
                            <div className="space-y-6 animate-fadeIn">
                                <h3 className="text-2xl font-bold dark:text-white">廣播任務中心</h3>
                                <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col">
                                    <div className="overflow-y-auto max-h-[500px]">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50/80 dark:bg-slate-800/80 text-slate-500 dark:text-slate-400 font-bold sticky top-0 backdrop-blur-md z-10 border-b border-slate-100 dark:border-slate-700">
                                                <tr><th className="px-6 py-4">任務內容</th><th className="px-6 py-4">科目/目標班級</th><th className="px-6 py-4 text-right">操作</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50 dark:divide-slate-700">
                                                {publicTasks.map(task => {
                                                    const cls = systemClasses.find(c => c.code === task.targetClass);
                                                    const targetName = cls ? cls.name : (task.targetClass || '全校');
                                                    return (
                                                        <tr key={task.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                                            <td className="px-6 py-4">
                                                                <div className="font-bold max-w-[200px] truncate dark:text-white" title={task.description}>{task.description}</div>
                                                                <div className="text-[10px] text-slate-400 mt-1">Due: {task.dueDate} {task.forceExpired && <span className="text-red-500 font-bold ml-2">(強制過期)</span>}</div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <div className="flex flex-col gap-1 items-start">
                                                                    <span className={`px-2 py-0.5 rounded text-[10px] font-bold border ${subjects.find(s => s.name === task.subject)?.color || 'bg-slate-100 text-slate-600 border-slate-200 dark:border-slate-700'}`}>{task.subject}</span>
                                                                    <span className="text-[10px] bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded font-bold max-w-[120px] truncate" title={targetName}>{targetName}</span>
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4 text-right">
                                                                <button onClick={() => handleDeletePublicTask(task.id)} className="px-3 py-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-500 hover:text-white rounded-lg font-bold text-xs">撤回</button>
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                                {publicTasks.length === 0 && <tr><td colSpan="3" className="px-6 py-12 text-center text-slate-400">暫無廣播任務</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-8 animate-fadeIn max-w-2xl">
                                <div><h3 className="text-2xl font-bold dark:text-white mb-2">核心系統設定</h3></div>

                                <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden p-1">
                                    <div className="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
                                        <h4 className="font-bold dark:text-white flex items-center gap-2"><Icon name="megaphone" className="w-5 h-5 text-amber-500"/> 系統跑馬燈公告</h4>
                                    </div>
                                    <div className="p-5 flex flex-col sm:flex-row gap-3">
                                        <input type="text" id="announcementInput" className="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-amber-500 outline-none" placeholder="輸入後點擊發佈..." defaultValue={systemConfig?.announcementText || ''} />
                                        <div className="flex gap-2">
                                            <button onClick={() => updateConfig('announcementText', document.getElementById('announcementInput').value)} className="bg-amber-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-amber-600 whitespace-nowrap">發佈</button>
                                            <button onClick={() => { document.getElementById('announcementInput').value = ''; updateConfig('announcementText', ''); }} className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-2.5 rounded-xl font-bold text-sm whitespace-nowrap">清空</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden p-1">
                                    <div className="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
                                        <h4 className="font-bold dark:text-white flex items-center gap-2"><Icon name="power" className="w-5 h-5 text-indigo-500"/> 系統維護模式</h4>
                                    </div>
                                    <div className="p-5 space-y-4">
                                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            {[ { id: 'normal', icon: 'check-circle-2', title: '正常運作', colors: { border: 'border-green-500 dark:border-green-400', bg: 'bg-green-50 dark:bg-green-900/30', text: 'text-green-500 dark:text-green-400', textBold: 'text-green-700 dark:text-green-300', dot: 'bg-green-500' } }, { id: 'updating', icon: 'hammer', title: '網站更新', colors: { border: 'border-orange-500 dark:border-orange-400', bg: 'bg-orange-50 dark:bg-orange-900/30', text: 'text-orange-500 dark:text-orange-400', textBold: 'text-orange-700 dark:text-orange-300', dot: 'bg-orange-500' } }, { id: 'restructuring', icon: 'database', title: '資料重整', colors: { border: 'border-blue-500 dark:border-blue-400', bg: 'bg-blue-50 dark:bg-blue-900/30', text: 'text-blue-500 dark:text-blue-400', textBold: 'text-blue-700 dark:text-blue-300', dot: 'bg-blue-500' } } ].map(mode => (
                                                <button key={mode.id} onClick={() => updateConfig('maintenanceMode', mode.id)} className={`relative flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all group ${systemConfig?.maintenanceMode === mode.id ? `${mode.colors.border} ${mode.colors.bg}` : 'border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800'}`}>
                                                    <Icon name={mode.icon} className={`w-8 h-8 mb-2 ${systemConfig?.maintenanceMode === mode.id ? mode.colors.text : 'text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300'}`} />
                                                    <span className={`font-bold text-sm ${systemConfig?.maintenanceMode === mode.id ? mode.colors.textBold : 'text-slate-600 dark:text-slate-400'}`}>{mode.title}</span>
                                                    {systemConfig?.maintenanceMode === mode.id && <div className={`absolute top-2 right-2 w-2 h-2 rounded-full ${mode.colors.dot} animate-pulse`}></div>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [configLoading, setConfigLoading] = useState(true); 
            const [items, setItems] = useState([]);
            const [timetableConfig, setTimetableConfig] = useState({ timeSlots: DEFAULT_TIME_SLOTS, schedule: DEFAULT_SCHEDULE });
            const [subjects, setSubjects] = useState(DEFAULT_SUBJECTS);

            const { auth, db, signOut, onAuthStateChanged, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc, updateProfile, arrayUnion } = window.firebaseServices || {};

            const [inputType, setInputType] = useState('homework');
            const [subject, setSubject] = useState('中文');
            const [description, setDescription] = useState('');
            const [dueDate, setDueDate] = useState(''); 
            const [selectedImage, setSelectedImage] = useState(null);

            // Broadcast states
            const [isBroadcast, setIsBroadcast] = useState(false);
            const [targetClassInput, setTargetClassInput] = useState('全校');

            const [viewMode, setViewMode] = useState('current'); 
            const [appMode, setAppMode] = useState('personal'); // 'personal' | 'class'
            const [viewLayout, setViewLayout] = useState('list'); 
            const [calendarSelectedDate, setCalendarSelectedDate] = useState(null);

            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('isDarkMode') === 'true');
            const [themeColor, setThemeColor] = useState(() => localStorage.getItem('themeColor') || 'indigo');
            const [isPreferencesOpen, setIsPreferencesOpen] = useState(false);
            const t = THEME_CONFIG[themeColor] || THEME_CONFIG.indigo;

            const [exitingIds, setExitingIds] = useState([]);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const [isSubjectManagerOpen, setIsSubjectManagerOpen] = useState(false);
            const [systemConfig, setSystemConfig] = useState(null);
            const [systemClasses, setSystemClasses] = useState([]);

            const [filterSubject, setFilterSubject] = useState('全部');
            const [sortOption, setSortOption] = useState('date_asc');
            const [isListVisible, setIsListVisible] = useState(true);
            const [editingItem, setEditingItem] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [notification, setNotification] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });

            const [showNameSetup, setShowNameSetup] = useState(false);
            const [nameSetupLoading, setNameSetupLoading] = useState(false);

            const [userProfile, setUserProfile] = useState(null);
            const joinedClasses = userProfile?.joinedClasses || [];
            const joinedClassesStr = joinedClasses.join(',');

            const [isJoinClassOpen, setIsJoinClassOpen] = useState(false);
            const [selectedClassBoard, setSelectedClassBoard] = useState(null);
            const [publicTasks, setPublicTasks] = useState([]);

            const [pageLoadTime] = useState(Date.now());
            const fileInputRef = useRef(null);
            const [currentTimetableDay, setCurrentTimetableDay] = useState(new Date().getDay() || 1); 

            useEffect(() => { if ("Notification" in window && Notification.permission === "default") Notification.requestPermission(); }, []);
            useEffect(() => { localStorage.setItem('isDarkMode', isDarkMode); if (isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }, [isDarkMode]);
            useEffect(() => localStorage.setItem('themeColor', themeColor), [themeColor]);

            // v2.1 Heartbeat Effect
            useEffect(() => {
                if(!user || !db) return;
                // Initial update
                updateDoc(doc(db, "users_public", user.uid), { lastSeen: serverTimestamp() }).catch(e=>{});
                // Loop update every 60s
                const interval = setInterval(() => {
                     updateDoc(doc(db, "users_public", user.uid), { lastSeen: serverTimestamp() }).catch(e=>{});
                }, 60000);
                return () => clearInterval(interval);
            }, [user, db]);

            useEffect(() => {
                if (!db) return;
                const unsubConfig = onSnapshot(doc(db, "system_settings", "config"), (docSnap) => { setSystemConfig(docSnap.exists() ? docSnap.data() : null); setConfigLoading(false); }, (err) => { console.warn("Config err:", err); setConfigLoading(false); });
                const unsubClasses = onSnapshot(doc(db, "system_settings", "classes"), (docSnap) => setSystemClasses(docSnap.exists() && docSnap.data().list ? docSnap.data().list : []), (err) => console.warn("Classes err:", err));
                return () => { unsubConfig(); unsubClasses(); };
            }, [db, user]);

            useEffect(() => {
                if (!window.firebaseServices) return;
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    try {
                        setUser(currentUser); setAuthLoading(false);
                        if (currentUser) {
                            const d = new Date(); d.setDate(d.getDate() + (d.getDay()===5?3:d.getDay()===6?2:1));
                            setDueDate(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`); 
                            setIsAuthModalOpen(false); setIsAdmin(currentUser.email === ADMIN_EMAIL);

                            const unsubProfile = onSnapshot(doc(db, "users_public", currentUser.uid), async (docSnap) => {
                                try {
                                    if (docSnap.exists()) {
                                        setUserProfile(docSnap.data());
                                        if (!currentUser.displayName) setShowNameSetup(true);
                                    } else {
                                        if (!currentUser.displayName) setShowNameSetup(true);
                                        else await setDoc(doc(db, "users_public", currentUser.uid), { email: currentUser.email, displayName: currentUser.displayName, joinedClasses: [], lastSeen: serverTimestamp() }, { merge: true });
                                    }
                                } catch (e) { console.warn("Profile inner err:", e); }
                            }, (err) => console.warn("Profile err:", err));

                            return () => unsubProfile();
                        } else { 
                            setItems([]); setIsAdmin(false); setShowNameSetup(false); setUserProfile(null); setTimetableConfig({ timeSlots: DEFAULT_TIME_SLOTS, schedule: DEFAULT_SCHEDULE }); setSubjects(DEFAULT_SUBJECTS);
                        }
                    } catch (e) { console.warn("Auth err:", e); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsubItems = onSnapshot(query(collection(db, "users", user.uid, "items"), orderBy("dueDate")), (snapshot) => setItems(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))), (err) => console.warn("Items err:", err));
                const unsubTimetable = onSnapshot(doc(db, 'users', user.uid, 'settings', 'timetable'), (docSnap) => setTimetableConfig(docSnap.exists() && docSnap.data().timeSlots ? docSnap.data() : { timeSlots: DEFAULT_TIME_SLOTS, schedule: DEFAULT_SCHEDULE }), (err) => console.warn("Timetable err:", err));
                const unsubSubjects = onSnapshot(doc(db, 'users', user.uid, 'settings', 'subjects'), (docSnap) => setSubjects(docSnap.exists() && docSnap.data().list ? docSnap.data().list : DEFAULT_SUBJECTS), (err) => console.warn("Subjects err:", err));
                return () => { unsubItems(); unsubTimetable(); unsubSubjects(); };
            }, [user, db]);

            // Sync Default Selected Board
            useEffect(() => {
                const currentClasses = joinedClassesStr ? joinedClassesStr.split(',') : [];
                if (currentClasses.length > 0 && !selectedClassBoard) {
                    setSelectedClassBoard(currentClasses[0]);
                } else if (currentClasses.length === 0) {
                    setSelectedClassBoard(null);
                }
            }, [joinedClassesStr, selectedClassBoard]);

            // Public Assignments listener
            useEffect(() => {
                if (!user || !db) return;
                const q = query(collection(db, "public_assignments"), orderBy("createdAt", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => { 
                    try {
                        setPublicTasks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        const currentClasses = joinedClassesStr ? joinedClassesStr.split(',') : [];

                        snapshot.docChanges().forEach(async (change) => { 
                            try {
                                const publicData = change.doc.data(); const publicId = change.doc.id; 
                                const target = publicData.targetClass || '全校';
                                const isForMe = isAdmin || target === '全校' || currentClasses.includes(target); 

                                if (change.type === "added" && isForMe) { 
                                    const userItemsRef = collection(db, "users", user.uid, "items"); const dupQuery = query(userItemsRef, where("publicRefId", "==", publicId)); 
                                    const dupSnapshot = await getDocs(dupQuery); 
                                    if (dupSnapshot.empty) { 
                                        await addDoc(userItemsRef, { ...publicData, publicRefId: publicId, completed: false, forceExpired: publicData.forceExpired || false }); 
                                        const createdTime = publicData.createdAt ? new Date(publicData.createdAt).getTime() : 0;
                                        if (createdTime > pageLoadTime && "Notification" in window && Notification.permission === "granted") new Notification(`📢 新廣播任務 (${target})`, { body: `[${publicData.subject}] ${publicData.description}` });
                                        else if (createdTime > pageLoadTime) triggerAlert(`收到新功課：[${publicData.subject || '其他'}] ${publicData.description}`); 
                                    } 
                                } 
                                if (change.type === "removed") { 
                                    const dupSnapshot = await getDocs(query(collection(db, "users", user.uid, "items"), where("publicRefId", "==", publicId))); 
                                    for (const docSnap of dupSnapshot.docs) await deleteDoc(docSnap.ref); 
                                } 
                                if (change.type === "modified") { 
                                    const dupSnapshot = await getDocs(query(collection(db, "users", user.uid, "items"), where("publicRefId", "==", publicId))); 
                                    for (const docSnap of dupSnapshot.docs) await updateDoc(docSnap.ref, { forceExpired: publicData.forceExpired === true }); 
                                } 
                            } catch (e) { console.warn("Task process err:", e); }
                        }); 
                    } catch (e) { console.warn("Public tasks wrapper err:", e); }
                }, (err) => console.warn("Public tasks err:", err)); 
                return () => unsubscribe(); 
            }, [user, db, joinedClassesStr, pageLoadTime, isAdmin]);

            const triggerAlert = (message) => setNotification({ isOpen: true, type: 'alert', message, onConfirm: null });
            const triggerConfirm = (message, onConfirmAction) => setNotification({ isOpen: true, type: 'confirm', message, onConfirm: onConfirmAction });
            const closeNotification = () => setNotification(prev => ({ ...prev, isOpen: false }));
            const handleNotificationConfirm = () => { if (notification.onConfirm) notification.onConfirm(); closeNotification(); };
            const handleFilterChange = (f) => { setIsListVisible(false); setTimeout(() => { setFilterSubject(f); setIsListVisible(true); }, 200); };
            const handleSortChange = (newSort) => { setIsListVisible(false); setTimeout(() => { setSortOption(newSort); setIsListVisible(true); }, 200); };
            const isGuest = !user;

            const handleNameSetupSave = async (name) => { 
                if (!user) return; setNameSetupLoading(true); 
                try { await updateProfile(user, { displayName: name }); await setDoc(doc(db, "users_public", user.uid), { email: user.email, displayName: name, lastSeen: serverTimestamp() }, { merge: true }); setShowNameSetup(false); triggerAlert(`歡迎, ${name}!`); } 
                catch (e) { triggerAlert("設定失敗，請重試"); } finally { setNameSetupLoading(false); } 
            };

            const handleJoinClassSubmit = async (code, name) => {
                try {
                    await updateDoc(doc(db, "users_public", user.uid), { joinedClasses: arrayUnion(code) });
                    triggerAlert(`成功加入班級：${name}`);
                    setIsJoinClassOpen(false);
                } catch(e) { triggerAlert("加入失敗，請重試"); }
            };

            const handleSubmit = async (e) => { 
                e.preventDefault(); if (isGuest) { setIsAuthModalOpen(true); return; }
                if ((!description.trim() && !selectedImage) || !dueDate) { triggerAlert("請輸入功課內容！"); return; }
                
                const performSubmit = async () => {
                    const newItem = { type: inputType, subject, description: description.trim(), image: selectedImage, dueDate, completed: false, createdAt: new Date().toISOString() }; 
                    try { 
                        if (isBroadcast && isAdmin) { 
                            newItem.senderName = user.displayName || '老師'; newItem.targetClass = targetClassInput;
                            await addDoc(collection(db, "public_assignments"), newItem); 
                            const className = targetClassInput === '全校' ? '全校' : (systemClasses.find(c => c.code === targetClassInput)?.name || targetClassInput);
                            triggerAlert(`已發放功課給 ${className}！`); 
                        } else { await addDoc(collection(db, "users", user.uid, "items"), newItem); triggerAlert("已新增紀錄"); } 
                        setDescription(''); setSelectedImage(null); if (fileInputRef.current) fileInputRef.current.value = ""; setAppMode('personal'); setIsBroadcast(false); setTargetClassInput('全校');
                    } catch (error) { triggerAlert("新增失敗"); } 
                };

                // v2.2 Broadcast Confirmation
                if (isBroadcast && isAdmin) {
                    const targetName = targetClassInput === '全校' ? '全校' : (systemClasses.find(c => c.code === targetClassInput)?.name || targetClassInput);
                    triggerConfirm(`確定要發送廣播功課給【${targetName}】嗎？`, performSubmit);
                } else {
                    performSubmit();
                }
            };

            const handleToggle = (id, currentCompletedStatus) => { 
                if (isGuest) { setIsAuthModalOpen(true); return; }
                if (!currentCompletedStatus) { 
                    setExitingIds(prev => [...prev, id]); setTimeout(async () => { try { await updateDoc(doc(db, "users", user.uid, "items", id), { completed: true }); } catch (e) {} setExitingIds(prev => prev.filter(eid => eid !== id)); }, 500); 
                } else { updateDoc(doc(db, "users", user.uid, "items", id), { completed: false }).catch(()=>{}); } 
            };

            const handleUpdateItem = async (id, updatedData) => { if (isGuest) return; try { await updateDoc(doc(db, "users", user.uid, "items", id), updatedData); triggerAlert("更新成功！"); } catch (e) { triggerAlert("更新失敗"); throw e; } };
            const deleteItem = (id) => { if (isGuest) return; triggerConfirm('確定要刪除這項紀錄？', async () => { try { await deleteDoc(doc(db, "users", user.uid, "items", id)); } catch (e) { triggerAlert("刪除失敗"); } }); };
            const deletePublicItem = (publicId, privateId) => { if (isGuest) return; triggerConfirm('⚠️ 確定要刪除全班的這份功課？', async () => { try { await deleteDoc(doc(db, "public_assignments", publicId)); if (privateId) await deleteDoc(doc(db, "users", user.uid, "items", privateId)); triggerAlert("已刪除"); } catch (e) { triggerAlert("刪除失敗"); } }); };
            const handleForceExpire = (publicId, currentStatus) => { if (isGuest) return; const action = currentStatus ? "取消過期" : "標記為過期"; triggerConfirm(`確定要將此功課${action}？(全班都會更新)`, async () => { try { await updateDoc(doc(db, "public_assignments", publicId), { forceExpired: !currentStatus }); triggerAlert(`已${action}`); } catch (e) { triggerAlert("操作失敗"); } }); };

            const saveTimetableConfig = async (newConfig) => { if (!user) return; try { await setDoc(doc(db, 'users', user.uid, 'settings', 'timetable'), JSON.parse(JSON.stringify(newConfig))); triggerAlert("時間表已儲存"); setViewMode('timetable'); } catch (e) { triggerAlert("儲存失敗"); } };
            const saveSubjects = async (newSubjects) => { if (!user) return; try { await setDoc(doc(db, 'users', user.uid, 'settings', 'subjects'), { list: JSON.parse(JSON.stringify(newSubjects)) }); triggerAlert("科目已更新"); } catch (e) { triggerAlert("儲存失敗"); } };

            const handleLogout = () => { triggerConfirm("確定要登出系統嗎？", () => window.firebaseServices.signOut(auth)); };

            const activeItems = items.filter(i => !i.completed && !i.forceExpired);
            const getDaysRemaining = (dString) => { const today = new Date(); today.setHours(0,0,0,0); const due = new Date(dString); due.setHours(0,0,0,0); return Math.ceil((due - today) / 86400000); };

            const displayedItems = items.filter(item => {
                if (viewMode === 'current' ? item.completed : !item.completed) return false;
                if (filterSubject !== '全部' && (item.subject || '其他') !== filterSubject) return false;
                if (calendarSelectedDate && viewLayout === 'calendar' && item.dueDate !== calendarSelectedDate) return false;
                return true;
            }).sort((a, b) => {
                const dateA = new Date(a.dueDate); const dateB = new Date(b.dueDate);
                if (a.forceExpired !== b.forceExpired) return a.forceExpired ? 1 : -1;
                return sortOption === 'date_desc' ? dateB - dateA : dateA - dateB;
            });

            const maintenanceMode = systemConfig?.maintenanceMode || 'normal';
            if (maintenanceMode !== 'normal' && !isAdmin && (!user || !systemConfig?.allowedEmails?.includes(user.email))) {
                return ( <div className="min-h-screen bg-slate-50 dark:bg-slate-900"><BlockScreen type={maintenanceMode} estimatedTime={systemConfig?.estimatedTime} customMessage={systemConfig?.message} onLogin={()=>setIsAuthModalOpen(true)} user={user} /></div> );
            }

            return (
                <div className={`min-h-screen transition-colors duration-500 bg-slate-50 dark:bg-slate-900 font-sans relative overflow-hidden p-4 sm:p-6 md:p-8 ${systemConfig?.announcementText ? 'pt-14 sm:pt-16 md:pt-20' : ''}`}>
                    <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
                        <div className={`absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full mix-blend-multiply filter blur-[100px] opacity-20 dark:opacity-10 animate-blob ${t.bg}`}></div>
                        <div className={`absolute top-[20%] -right-[10%] w-[40%] h-[60%] rounded-full mix-blend-multiply filter blur-[100px] opacity-20 dark:opacity-10 animate-blob animation-delay-2000 bg-purple-500`}></div>
                    </div>

                    {systemConfig?.announcementText && (
                        <div className="fixed top-0 left-0 w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white overflow-hidden shadow-md z-40 flex items-center h-10 sm:h-12">
                            <div className="px-3 sm:px-4 h-full bg-amber-500 z-20 shrink-0 flex items-center gap-2 font-bold text-xs sm:text-sm shadow-[5px_0_15px_rgba(245,158,11,0.5)]"><Icon name="megaphone" className="w-4 h-4 animate-bounce" /> 最新公告</div>
                            <div className="flex-1 overflow-hidden h-full flex items-center group"><div className="animate-marquee whitespace-nowrap text-xs sm:text-sm font-bold tracking-wider">{systemConfig.announcementText}</div></div>
                        </div>
                    )}

                    <div className={`max-w-[1200px] mx-auto relative z-10 transition-all duration-500 ${isGuest ? 'guest-blur' : ''}`}>
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-8 gap-4 max-w-3xl mx-auto bg-white/60 dark:bg-slate-800/60 backdrop-blur-xl p-4 sm:p-5 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <div>
                                <h1 className={`text-xl sm:text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r ${t.gradient} flex items-center gap-2`}>
                                    {viewMode === 'current' ? (<><Icon name="graduation-cap" className={`w-6 h-6 sm:w-8 sm:h-8 ${t.text}`} />學生小幫手</>) : viewMode === 'admin' ? (<><Icon name="shield-alert" className={`w-6 h-6 sm:w-8 sm:h-8 text-blue-600`} />系統管理員</>) : <><Icon name="history" className={`w-6 h-6 sm:w-8 sm:h-8 ${t.text}`} /> {viewMode === 'timetable' ? '上課時間表' : '完成紀錄'}</>}
                                </h1>
                                <p className="text-slate-500 dark:text-slate-400 text-sm mt-1 ml-1 font-medium">{new Date().toLocaleDateString('zh-HK', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</p>
                            </div>
                            <div className="flex gap-2 flex-wrap justify-end">
                                {viewMode === 'current' && appMode === 'personal' && (
                                    <button onClick={() => setViewLayout(viewLayout === 'list' ? 'calendar' : 'list')} className="p-2.5 rounded-full bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 shadow-sm hover:shadow-md transition border border-slate-100 dark:border-slate-600" title="切換視圖"><Icon name={viewLayout === 'list' ? "calendar" : "list"} className="w-5 h-5" /></button>
                                )}

                                {viewMode === 'timetable' && (
                                    <button onClick={() => setViewMode('timetable_edit')} className={`px-4 py-2.5 rounded-full font-bold text-sm bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 border border-indigo-200 dark:border-indigo-800 shadow-sm transition-all flex items-center gap-2`}><Icon name="edit" className="w-4 h-4" /> 編輯時間表</button>
                                )}

                                <button onClick={() => !user ? setIsAuthModalOpen(true) : setViewMode('timetable')} className={`px-4 py-2.5 rounded-full font-bold text-sm shadow-sm hover:shadow-md transition-all flex items-center gap-2 ${viewMode === 'timetable' || viewMode === 'timetable_edit' ? 'bg-orange-500 text-white' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-2 border-slate-100 dark:border-slate-700 hover:border-orange-200'}`}><Icon name="calendar-days" className="w-4 h-4" />時間表</button>

                                {isAdmin && (
                                    <button onClick={() => setViewMode('admin')} className={`px-4 py-2.5 rounded-full font-bold text-sm transition-all shadow-md hover:shadow-xl flex items-center gap-2 ${viewMode === 'admin' ? 'bg-slate-800 text-white' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-2 border-slate-100 dark:border-slate-700 hover:border-slate-300'}`}><Icon name="shield-alert" className="w-4 h-4" />管理後台</button>
                                )}

                                <button onClick={() => !user ? setIsAuthModalOpen(true) : setViewMode(viewMode === 'current' ? 'history' : 'current')} className={`px-4 py-2.5 rounded-full font-bold text-sm shadow-sm hover:shadow-md transition-all flex items-center gap-2 ${viewMode === 'current' ? 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-2 border-slate-100 dark:border-slate-700 hover:border-indigo-200' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white border-transparent'}`}>
                                    {viewMode === 'history' || viewMode === 'admin' || viewMode === 'timetable' || viewMode === 'timetable_edit' ? (<><Icon name="arrow-left" className="w-4 h-4" />返主頁</>) : (<><Icon name="history" className="w-4 h-4" />睇紀錄</>)}
                                </button>

                                {user && (
                                    <>
                                        <button onClick={() => setIsPreferencesOpen(true)} className="p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition shadow-sm border border-transparent"><Icon name="palette" className="w-5 h-5" /></button>
                                        <button onClick={() => setIsSubjectManagerOpen(true)} className="p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition shadow-sm border border-transparent"><Icon name="settings" className="w-5 h-5" /></button>
                                        <button onClick={handleLogout} className="p-2.5 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:text-red-500 dark:hover:text-red-400 transition shadow-sm"><Icon name="log-out" className="w-5 h-5" /></button>
                                    </>
                                )}
                            </div>
                        </div>

                        {viewMode === 'admin' ? ( <AdminConsole db={db} systemConfig={systemConfig} systemClasses={systemClasses} onBack={() => setViewMode('current')} subjects={subjects} triggerAlert={triggerAlert} triggerConfirm={triggerConfirm} /> ) : 
                         viewMode === 'timetable' ? ( <div className="max-w-3xl mx-auto"><Timetable currentDay={currentTimetableDay} config={timetableConfig} onDayChange={setCurrentTimetableDay} subjects={subjects} /></div> ) : 
                         viewMode === 'timetable_edit' ? ( <TimetableEditor initialConfig={timetableConfig} onSave={saveTimetableConfig} onCancel={() => setViewMode('timetable')} subjects={subjects} triggerConfirm={triggerConfirm} /> ) : (
                        <div className="max-w-3xl mx-auto">

                            {/* --- 雙模式切換器 --- */}
                            {viewMode === 'current' && (
                                <div className="flex bg-slate-200/50 dark:bg-slate-800/50 p-1.5 rounded-2xl w-full sm:w-fit mx-auto mb-8 shadow-inner border border-white/20 dark:border-slate-700">
                                    <button onClick={() => setAppMode('personal')} className={`flex-1 sm:flex-none px-8 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${appMode === 'personal' ? `bg-white dark:bg-slate-700 shadow-sm ${t.text}` : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>
                                        <Icon name="user" className="w-4 h-4" /> 個人模式
                                    </button>
                                    <button onClick={() => setAppMode('class')} className={`flex-1 sm:flex-none px-8 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${appMode === 'class' ? `bg-white dark:bg-slate-700 shadow-sm ${t.text}` : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>
                                        <Icon name="school" className="w-4 h-4" /> 班級模式
                                    </button>
                                </div>
                            )}

                            {viewMode === 'current' && appMode === 'personal' && (
                                <>
                                    <div className={`relative bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl rounded-3xl shadow-lg p-5 sm:p-8 mb-10 border border-slate-100 dark:border-slate-700 z-20`}>
                                        <div className="flex bg-slate-100 dark:bg-slate-900/50 p-1.5 rounded-xl mb-6">
                                            <button onClick={() => setInputType('homework')} className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold transition-all ${inputType === 'homework' ? `bg-white dark:bg-slate-700 shadow-sm ${t.text}` : 'text-slate-500 dark:text-slate-400'}`}><Icon name="book-open" className="w-4 h-4" /> 新增功課</button>
                                            <button onClick={() => setInputType('assessment')} className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold transition-all ${inputType === 'assessment' ? `bg-white dark:bg-slate-700 shadow-sm text-purple-600 dark:text-purple-400` : 'text-slate-500 dark:text-slate-400'}`}><Icon name="file-question" className="w-4 h-4" /> 新增測驗</button>
                                        </div>
                                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{subjects.map(sub => (<button key={sub.name} type="button" onClick={() => setSubject(sub.name)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold border-2 transition-all ${subject === sub.name ? `${t.border} ${t.lightBg} ${t.text}` : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-100 dark:border-slate-700 hover:border-slate-200 dark:hover:border-slate-600'}`}>{sub.name}</button>))}</div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div className="md:col-span-2 space-y-3">
                                                    <textarea placeholder={inputType === 'homework' ? "打返功課內容..." : "輸入範圍 (例如: 第3課 / P.20-25)"} value={description} onChange={(e) => setDescription(e.target.value)} rows="2" className={`w-full min-h-[100px] rounded-2xl border-2 border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 focus:${t.border} focus:ring-4 focus:${t.ring} transition-all p-4 text-slate-700 dark:text-slate-100 placeholder-slate-400 outline-none resize-none text-base`} />
                                                </div>
                                                <div className="flex flex-col gap-3 md:col-span-1">
                                                    <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className={`w-full h-12 rounded-xl border-2 border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 focus:${t.border} focus:ring-4 focus:${t.ring} transition-all px-4 text-slate-700 dark:text-slate-100 font-medium outline-none`} required />
                                                    <button type="submit" className={`w-full h-12 text-white font-bold rounded-xl transition-all shadow-lg active:scale-95 text-base flex items-center justify-center gap-2 ${t.bg} ${t.shadow}`}><Icon name="plus" className="w-5 h-5" />{isAdmin && isBroadcast ? '廣播發放' : '加入清單'}</button>
                                                </div>
                                            </div>
                                            {isAdmin && (
                                                <div className="mt-2 pt-4 border-t border-slate-100 dark:border-slate-700">
                                                    <label className="flex items-center cursor-pointer mb-2">
                                                        <input type="checkbox" className="sr-only peer" checked={isBroadcast} onChange={e => setIsBroadcast(e.target.checked)} />
                                                        <div className={`w-11 h-6 bg-slate-200 dark:bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all ${t.bg} peer-checked:bg-orange-500 relative`}></div>
                                                        <span className="ml-3 text-sm font-bold text-slate-600 dark:text-slate-300">📢 作為管理員廣播發放</span>
                                                    </label>
                                                    {isBroadcast && (
                                                        <div className="flex items-center gap-2 mt-2 animate-fadeIn">
                                                            <Icon name="users" className="w-4 h-4 text-slate-400" />
                                                            <select value={targetClassInput} onChange={e => setTargetClassInput(e.target.value)} className="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm dark:text-white outline-none focus:ring-2 focus:ring-orange-500 transition-all font-bold">
                                                                <option value="全校">📢 全校 (所有人)</option>
                                                                {systemClasses.map(c => <option key={c.code} value={c.code}>🏫 {c.name} ({c.code})</option>)}
                                                            </select>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </form>
                                    </div>

                                    {viewLayout === 'calendar' && <CalendarWidget items={activeItems} selectedDate={calendarSelectedDate} onSelectDate={setCalendarSelectedDate} t={t} />}

                                    <div className="flex flex-col sm:flex-row justify-between items-center gap-3 mb-6 relative">
                                        <div className={`flex items-center gap-2 w-full sm:w-auto overflow-x-auto scrollbar-hide pb-1 transition-opacity duration-300 ${!isListVisible ? 'opacity-50' : 'opacity-100'}`}>
                                            <span className="text-slate-400 text-xs font-bold whitespace-nowrap flex items-center gap-1"><Icon name="filter" className="w-3 h-3" />篩選:</span>
                                            <button onClick={() => handleFilterChange('全部')} className={`flex-shrink-0 px-2.5 py-1 rounded text-[10px] font-bold border transition-all ${filterSubject === '全部' ? 'bg-slate-800 dark:bg-slate-600 text-white border-slate-800 dark:border-slate-600' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>全部</button>
                                            {subjects.map(sub => (
                                                <button key={sub.name} onClick={() => handleFilterChange(sub.name)} className={`flex-shrink-0 px-2.5 py-1 rounded text-[10px] font-bold border transition-all ${filterSubject === sub.name ? `${t.border} ${t.lightBg} ${t.text}` : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{sub.name}</button>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-2 w-full sm:w-auto z-30">
                                            <span className="text-slate-400 text-xs font-bold whitespace-nowrap flex items-center gap-1"><Icon name="arrow-up-down" className="w-3 h-3" />排序:</span>
                                            <CustomDropdown value={sortOption} onChange={handleSortChange} options={[{ value: 'date_asc', label: '日期 (趕急先)' }, { value: 'date_desc', label: '日期 (長遠先)' }]} />
                                        </div>
                                    </div>

                                    <div className={`space-y-4 pb-20 transition-opacity duration-300 ${!isListVisible ? 'opacity-0' : 'opacity-100'}`}>
                                        {displayedItems.length === 0 ? (
                                            <div className="text-center py-20">
                                                <div className={`inline-flex p-6 rounded-full ${t.lightBg} mb-4`}><Icon name="sparkles" className={`w-12 h-12 ${t.text}`} /></div>
                                                <h3 className="text-xl font-bold text-slate-700 dark:text-slate-300">{calendarSelectedDate ? '這天沒有任何任務' : '太好了！任務清單空空如也'}</h3>
                                            </div>
                                        ) : displayedItems.map((item, index) => {
                                            const isExiting = exitingIds.includes(item.id);
                                            const isCompleted = item.completed || isExiting;
                                            const dl = getDaysRemaining(item.dueDate);
                                            let statusNode = <span className="text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400 px-2 py-0.5 rounded text-xs font-bold">{dl} 天後</span>;
                                            if(dl < 0) statusNode = <span className="text-red-600 bg-red-100 dark:bg-red-900/30 dark:text-red-400 px-2 py-0.5 rounded text-xs font-bold">過期 {Math.abs(dl)} 天</span>;
                                            if(dl === 0) statusNode = <span className="text-orange-600 bg-orange-100 dark:bg-orange-900/30 dark:text-orange-400 px-2 py-0.5 rounded text-xs font-bold animate-pulse">今日到期!</span>;
                                            const subjectStyle = subjects.find(s => s.name === item.subject)?.color || 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600';

                                            return (
                                                <div key={item.id} style={{ animationDelay: `${index * 0.05}s` }} className={`animate-item relative bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-100 dark:border-slate-700 transition-all ${isExiting ? 'scale-95 opacity-0' : ''}`}>
                                                    <div className="flex items-start gap-4">
                                                        <button onClick={() => handleToggle(item.id, item.completed)} className={`mt-1 w-7 h-7 rounded-full border-2 flex items-center justify-center shrink-0 transition-all ${isCompleted ? 'bg-emerald-500 border-emerald-500 text-white scale-110' : 'border-slate-300 dark:border-slate-600 hover:border-emerald-400'}`}>
                                                            <Icon name="check" className={`w-4 h-4 ${isCompleted ? 'opacity-100' : 'opacity-0'}`} />
                                                        </button>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex justify-between items-start mb-2">
                                                                <div className="flex gap-2 items-center flex-wrap">
                                                                    <span className={`text-[10px] font-bold px-2 py-1 rounded border ${subjectStyle}`}>{item.subject || '其他'}</span>
                                                                    {item.publicRefId && <span className={`text-[10px] font-bold px-2 py-1 rounded ${t.lightBg} ${t.text}`}>廣播</span>}
                                                                    {item.type !== 'homework' && <span className="text-[10px] font-bold px-2 py-1 rounded bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400">測驗</span>}
                                                                </div>
                                                                {statusNode}
                                                            </div>
                                                            <div className={`text-base font-bold mb-2 break-words ${isCompleted ? 'line-through text-slate-400 dark:text-slate-500' : 'text-slate-800 dark:text-slate-100'}`}>{item.description}</div>
                                                            {item.image && <div className="mt-2"><img src={item.image} alt="附件" className={`max-h-32 rounded-lg border border-slate-200 dark:border-slate-700 object-cover ${isCompleted ? 'opacity-50 grayscale' : ''}`} /></div>}
                                                            <div className="flex items-center justify-between mt-2">
                                                                <div className="text-xs text-slate-400 dark:text-slate-500 flex items-center gap-1 font-mono"><Icon name="calendar" className="w-3 h-3"/> {item.dueDate}</div>
                                                                <div className="flex gap-2">
                                                                    {!item.forceExpired && <button onClick={() => setEditingItem(item)} className="p-1.5 text-slate-400 hover:text-blue-500 dark:hover:text-blue-400 transition" title="編輯"><Icon name="pencil" className="w-4 h-4" /></button>}
                                                                    {isAdmin && item.publicRefId ? (
                                                                        <>
                                                                            <button onClick={() => deleteItem(item.id)} className="p-1.5 text-slate-400 hover:text-red-500 dark:hover:text-red-400 transition" title="刪除 (自己)"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                                            <button onClick={() => deletePublicItem(item.publicRefId, item.id)} className="p-1.5 text-indigo-400 hover:text-indigo-600 transition" title="刪除 (全班)"><Icon name="globe" className="w-4 h-4" /></button>
                                                                        </>
                                                                    ) : (
                                                                        <button onClick={() => deleteItem(item.id)} className="p-1.5 text-slate-400 hover:text-red-500 dark:hover:text-red-400 transition"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <LessonCountdown subject={item.subject} config={timetableConfig} />
                                                        </div>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </>
                            )}

                            {viewMode === 'current' && appMode === 'class' && (
                                <div className="space-y-6 animate-fadeIn pb-20">
                                    <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 flex justify-between items-center">
                                        <div>
                                            <h3 className="text-xl font-bold dark:text-white flex items-center gap-2"><Icon name="school" className={t.text} /> 我的班級</h3>
                                            <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">查看專屬的廣播任務</p>
                                        </div>
                                        <button onClick={() => setIsJoinClassOpen(true)} className={`px-4 py-2.5 rounded-xl font-bold text-sm text-white shadow-md active:scale-95 transition-all flex items-center gap-2 ${t.bg}`}>
                                            <Icon name="plus" className="w-4 h-4" /> 加入班級
                                        </button>
                                    </div>

                                    {joinedClasses.length === 0 ? (
                                        <div className="text-center py-20 bg-white dark:bg-slate-800 rounded-3xl border border-dashed border-slate-200 dark:border-slate-700">
                                            <Icon name="school" className="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-4" />
                                            <h4 className="text-lg font-bold text-slate-600 dark:text-slate-300 mb-2">尚未加入任何班級</h4>
                                            <p className="text-sm text-slate-400 mb-6">請向老師索取 6 位數班級代碼</p>
                                            <button onClick={() => setIsJoinClassOpen(true)} className={`px-8 py-3 rounded-xl font-bold text-sm text-white shadow-md transition-all active:scale-95 ${t.bg}`}>立即加入</button>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                                {joinedClasses.map(code => {
                                                    const cls = systemClasses.find(c => c.code === code);
                                                    const name = cls ? cls.name : code;
                                                    return (
                                                        <button key={code} onClick={() => setSelectedClassBoard(code)} className={`shrink-0 px-5 py-2.5 rounded-xl text-sm font-bold border-2 transition-all ${selectedClassBoard === code ? `${t.border} ${t.lightBg} ${t.text}` : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-100 dark:border-slate-700'}`}>
                                                            {name}
                                                        </button>
                                                    )
                                                })}
                                            </div>

                                            <div className="space-y-4">
                                                {publicTasks.filter(task => task.targetClass === selectedClassBoard).length === 0 ? (
                                                    <div className="text-center py-10"><p className="text-slate-500 dark:text-slate-400 font-medium">此班級目前沒有廣播任務 🎉</p></div>
                                                ) : publicTasks.filter(task => task.targetClass === selectedClassBoard).map((task, idx) => {
                                                    const subjectStyle = subjects.find(s => s.name === task.subject)?.color || 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600';
                                                    return (
                                                    <div key={task.id} style={{ animationDelay: `${idx * 0.05}s` }} className="animate-item bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden">
                                                        {task.forceExpired && <div className="absolute inset-0 bg-white/50 dark:bg-slate-800/50 backdrop-blur-[1px] z-10 flex items-center justify-center pointer-events-none"><span className="bg-red-500 text-white font-bold px-4 py-2 rounded-xl shadow-lg rotate-[-10deg]">已強制過期</span></div>}
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div className="flex gap-2 items-center">
                                                                <span className={`text-[10px] font-bold px-2.5 py-1 rounded border ${subjectStyle}`}>{task.subject}</span>
                                                                <span className="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-1 rounded font-bold">{task.type === 'homework' ? '功課' : '測驗'}</span>
                                                            </div>
                                                            <span className="text-xs text-slate-400 dark:text-slate-500 font-mono font-bold bg-slate-50 dark:bg-slate-900 px-2 py-1 rounded border border-slate-100 dark:border-slate-800">Due: {task.dueDate}</span>
                                                        </div>
                                                        <p className="font-bold text-lg text-slate-800 dark:text-slate-100 mb-3 break-words">{task.description}</p>
                                                        {task.image && <div className="mb-3"><img src={task.image} alt="附件" className={`max-h-32 rounded-xl border border-slate-200 dark:border-slate-700 object-cover`} /></div>}
                                                        <div className="text-xs text-slate-400 dark:text-slate-500 flex justify-between items-center border-t border-slate-50 dark:border-slate-700/50 pt-3">
                                                            <span className="flex items-center gap-1"><Icon name="user" className="w-3 h-3"/> 發佈人: {task.senderName || '老師'}</span>
                                                            <span>{new Date(task.createdAt).toLocaleString('zh-HK')}</span>
                                                        </div>
                                                    </div>
                                                )})}
                                            </div>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                        )}
                    </div>

                    {isGuest && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/20 backdrop-blur-sm">
                            <button onClick={() => setIsAuthModalOpen(true)} className={`btn-glow px-8 py-4 ${t.bg} text-white rounded-full font-bold text-xl shadow-2xl hover:scale-105 transition-transform flex items-center gap-3`}>
                                <Icon name="log-in" className="w-6 h-6" /> 登入系統
                            </button>
                        </div>
                    )}

                    {notification.isOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center px-4">
                            <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onClick={closeNotification}></div>
                            <div className="dialog-animate relative bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm p-6 text-center border border-slate-100 dark:border-slate-700">
                                <div className={`mx-auto w-14 h-14 rounded-full flex items-center justify-center mb-4 ${notification.type === 'confirm' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400' : 'bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>
                                    {notification.type === 'confirm' ? <Icon name="help-circle" className="w-8 h-8" /> : <Icon name="info" className="w-8 h-8" />}
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-2">{notification.type === 'confirm' ? '確認操作' : '提示'}</h3>
                                <p className="text-slate-600 dark:text-slate-300 mb-8 font-medium leading-relaxed">{notification.message}</p>
                                <div className="flex gap-3 justify-center">
                                    {notification.type === 'confirm' ? (
                                        <>
                                            <button onClick={closeNotification} className="flex-1 py-3 px-4 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">取消</button>
                                            <button onClick={handleNotificationConfirm} className="flex-1 py-3 px-4 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 dark:shadow-none transition-all active:scale-95">確認</button>
                                        </>
                                    ) : (
                                        <button onClick={closeNotification} className="w-full py-3 px-4 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 dark:shadow-none transition-all active:scale-95">知道了</button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <AppearanceModal isOpen={isPreferencesOpen} onClose={() => setIsPreferencesOpen(false)} t={t} themeColor={themeColor} setThemeColor={setThemeColor} isDarkMode={isDarkMode} setIsDarkMode={setIsDarkMode} />
                    <AuthModal isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} triggerAlert={triggerAlert} />
                    <JoinClassModal isOpen={isJoinClassOpen} onClose={() => setIsJoinClassOpen(false)} systemClasses={systemClasses} joinedClasses={joinedClasses} onJoin={handleJoinClassSubmit} t={t} />
                    {showNameSetup && <NameSetupModal user={user} onSave={handleNameSetupSave} loading={nameSetupLoading} triggerAlert={triggerAlert} t={t} />}
                    {editingItem && <EditModal item={editingItem} onClose={() => setEditingItem(null)} onSave={handleUpdateItem} triggerAlert={triggerAlert} subjects={subjects} />}
                    <SubjectManagerModal isOpen={isSubjectManagerOpen} onClose={() => setIsSubjectManagerOpen(false)} currentSubjects={subjects} onSave={saveSubjects} triggerConfirm={triggerConfirm} />
                </div>
            );
        }

        const initApp = () => {
            if (window.firebaseServices && window.firebaseServices.auth) {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            } else setTimeout(initApp, 50);
        };
        initApp();
    </script>
</body>
</html>