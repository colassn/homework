<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3B Hub 班級作業管理平台</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .hidden { display: none !important; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 animate-pulse">正在連接 3B Hub...</p>
    </div>

    <!-- Auth Screen (Login) -->
    <div id="auth-screen" class="hidden fixed inset-0 bg-slate-100 z-40 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            <div class="flex justify-center mb-6">
                <div class="bg-blue-100 p-4 rounded-full">
                    <i data-lucide="book-open-check" class="w-10 h-10 text-blue-600"></i>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">歡迎來到 3B Hub</h1>
            <p class="text-slate-500 mb-8">請登入以查看功課與進度</p>
            
            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium py-3 px-4 rounded-lg transition-all mb-4">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                使用 Google 帳號登入
            </button>

            <!-- 簡易電郵登入 (Fallback) -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-slate-500">或使用電郵</span></div>
            </div>

            <form id="email-login-form" class="space-y-4">
                <input type="email" id="email-input" placeholder="student@example.com" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <input type="password" id="password-input" placeholder="密碼 (至少6位)" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition-all">登入 / 註冊</button>
            </form>
        </div>
    </div>

    <!-- Nickname Modal -->
    <div id="nickname-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">設定暱稱</h2>
            <p class="text-slate-500 text-sm mb-4">為了方便老師辨識，請輸入你的英文短名 (例如: Justin)。</p>
            <input type="text" id="nickname-input" class="w-full border border-slate-300 rounded-lg p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="輸入英文名字">
            <button id="save-nickname-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">儲存並繼續</button>
        </div>
    </div>

    <!-- Privacy Disclaimer Screen -->
    <div id="privacy-screen" class="hidden fixed inset-0 bg-white z-40 flex flex-col items-center justify-center p-6 text-center">
        <div class="max-w-lg">
            <i data-lucide="shield-check" class="w-16 h-16 text-emerald-500 mx-auto mb-6"></i>
            <h2 class="text-2xl font-bold mb-4">保密聲明</h2>
            <p class="text-slate-600 mb-8 leading-relaxed">
                本平台僅供 3B 班級內部作業管理使用。你的作業完成狀態僅供管理員 (老師) 查看。
                請勿隨意洩漏同學資料。點擊「同意」即代表你了解並願意遵守此規則。
            </p>
            <button id="agree-privacy-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-full transition-transform transform hover:scale-105">
                我同意並進入
            </button>
        </div>
    </div>

    <!-- App Header -->
    <header id="app-header" class="hidden bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i data-lucide="graduation-cap" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">3B Hub</h1>
                <p id="user-display-name" class="text-xs text-slate-500">載入中...</p>
            </div>
        </div>
        <button id="logout-btn" class="text-slate-500 hover:text-red-500 p-2 transition-colors" title="登出">
            <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="hidden flex-1 overflow-hidden flex flex-col md:flex-row relative">
        
        <!-- Sidebar / Topbar for Student Stats -->
        <aside class="md:w-80 bg-slate-50 border-r border-slate-200 flex flex-col h-full shrink-0">
            <!-- Progress Card -->
            <div class="p-4 border-b border-slate-200 bg-white">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-sm font-medium text-slate-500">本學期進度</span>
                    <span id="progress-text" class="text-2xl font-bold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="pending-count" class="text-xs text-slate-400 mt-2 text-right">還有 0 份作業未完成</p>
            </div>

            <!-- Admin Actions (Only visible to Admin) -->
            <div id="admin-panel" class="hidden p-4 border-b border-slate-200 bg-amber-50">
                <h3 class="text-xs font-bold text-amber-700 uppercase tracking-wider mb-3">管理員控制台</h3>
                <button id="add-hw-modal-btn" class="w-full flex items-center justify-center gap-2 bg-amber-500 hover:bg-amber-600 text-white text-sm py-2 px-4 rounded-lg mb-2 shadow-sm transition-colors">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> 發布新功課
                </button>
                <button id="download-backup-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-amber-300 text-amber-700 hover:bg-amber-100 text-sm py-2 px-4 rounded-lg transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i> 下載資料備份
                </button>
            </div>

            <!-- Memos Section (Students only) -->
            <div id="memos-section" class="flex-1 overflow-y-auto p-4 flex flex-col">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i data-lucide="sticky-note" class="w-3 h-3"></i> 私人備忘錄
                </h3>
                <div id="memos-list" class="space-y-2 flex-1">
                    <!-- Memos injected here -->
                </div>
                <div class="mt-4 pt-2 border-t border-slate-200">
                    <div class="flex gap-2">
                        <input type="text" id="new-memo-input" placeholder="新增備忘..." class="flex-1 text-sm border border-slate-300 rounded px-2 py-1.5 focus:border-blue-500 outline-none">
                        <button id="add-memo-btn" class="bg-slate-800 text-white p-1.5 rounded hover:bg-slate-700">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Student List (Replaces Memos for Admin) -->
            <div id="admin-student-list-section" class="hidden flex-1 overflow-y-auto p-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">班級概況</h3>
                <div id="student-list-container" class="space-y-3">
                    <!-- Student stats injected here -->
                </div>
            </div>
        </aside>

        <!-- Homework Feed -->
        <div class="flex-1 overflow-y-auto bg-slate-50/50 p-4 md:p-8">
            <div class="max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">作業看板</h2>
                    <span id="current-date" class="text-sm text-slate-500 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200"></span>
                </div>

                <div id="homework-list" class="space-y-3">
                    <!-- Homework Items injected here -->
                    <div class="text-center py-12 text-slate-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>目前沒有作業</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Homework Modal -->
    <div id="add-hw-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">發布新功課</h3>
                <button id="close-hw-modal" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="add-hw-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">科目</label>
                    <select id="hw-subject" class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-amber-500 outline-none">
                        <option value="中文">中文</option>
                        <option value="英文">英文</option>
                        <option value="數學">數學</option>
                        <option value="常識">常識</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">內容</label>
                    <input type="text" id="hw-title" placeholder="例如：作業 P.10 (1-5)" class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-amber-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">截止日期</label>
                    <input type="date" id="hw-due" class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-amber-500 outline-none" required>
                </div>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-2.5 rounded-lg transition-colors">
                    發布
                </button>
            </form>
        </div>
    </div>

    <!-- Logic Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            addDoc, 
            deleteDoc,
            updateDoc,
            query,
            orderBy,
            serverTimestamp,
            getDocs 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- 1. CONFIGURATION ---
        const ADMIN_EMAIL = 'chimhinhin@gmail.com';
        
        // 使用者提供的配置
        const firebaseConfig = {
            apiKey: "AIzaSyDVj1OMXGD-51-9lX7N7rW8C4fEMLdp6M8",
            authDomain: "pkhw-f6bcf.firebaseapp.com",
            projectId: "pkhw-f6bcf",
            storageBucket: "pkhw-f6bcf.firebasestorage.app",
            messagingSenderId: "169847959955",
            appId: "1:169847959955:web:4d88fb31dfac054af17866",
            measurementId: "G-1W7W93WTY7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Environment Helper (for strict path rules in Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Path References (Strictly following Rule 1)
        // Public data: readable by all users (homework, user public profiles for leaderboard/admin view)
        const HOMEWORK_COLLECTION_REF = collection(db, 'artifacts', appId, 'public', 'data', 'homework');
        const USERS_PUBLIC_REF = collection(db, 'artifacts', appId, 'public', 'data', 'users');
        
        // --- 2. STATE MANAGEMENT ---
        let currentUser = null;
        let currentUserData = null;
        let homeworkList = [];
        let unsubscribeHomework = null;
        let unsubscribeUser = null;
        let unsubscribeAllUsers = null;
        let unsubscribeMemos = null;

        // UI Elements
        const els = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-screen'),
            nicknameModal: document.getElementById('nickname-modal'),
            privacy: document.getElementById('privacy-screen'),
            header: document.getElementById('app-header'),
            main: document.getElementById('main-content'),
            googleBtn: document.getElementById('google-login-btn'),
            emailForm: document.getElementById('email-login-form'),
            nicknameInput: document.getElementById('nickname-input'),
            saveNicknameBtn: document.getElementById('save-nickname-btn'),
            agreePrivacyBtn: document.getElementById('agree-privacy-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            homeworkList: document.getElementById('homework-list'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            pendingCount: document.getElementById('pending-count'),
            displayName: document.getElementById('user-display-name'),
            currentDate: document.getElementById('current-date'),
            adminPanel: document.getElementById('admin-panel'),
            memosSection: document.getElementById('memos-section'),
            adminStudentSection: document.getElementById('admin-student-list-section'),
            addHwModalBtn: document.getElementById('add-hw-modal-btn'),
            downloadBackupBtn: document.getElementById('download-backup-btn'),
            addHwModal: document.getElementById('add-hw-modal'),
            closeHwModal: document.getElementById('close-hw-modal'),
            addHwForm: document.getElementById('add-hw-form'),
            memosList: document.getElementById('memos-list'),
            newMemoInput: document.getElementById('new-memo-input'),
            addMemoBtn: document.getElementById('add-memo-btn'),
            studentListContainer: document.getElementById('student-list-container')
        };

        // Init Icons
        lucide.createIcons();
        els.currentDate.textContent = new Date().toLocaleDateString('zh-HK');

        // --- 3. AUTH LOGIC ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in:", user.uid);
                currentUser = user;
                els.auth.classList.add('hidden');
                els.loading.classList.remove('hidden');
                await handleUserLogin(user);
            } else {
                console.log("No user.");
                currentUser = null;
                currentUserData = null;
                showAuthScreen();
            }
        });

        function showAuthScreen() {
            els.loading.classList.add('hidden');
            els.header.classList.add('hidden');
            els.main.classList.add('hidden');
            els.auth.classList.remove('hidden');
            els.nicknameModal.classList.add('hidden');
            els.privacy.classList.add('hidden');
            
            // Cleanup listeners
            if (unsubscribeHomework) unsubscribeHomework();
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeAllUsers) unsubscribeAllUsers();
            if (unsubscribeMemos) unsubscribeMemos();
        }

        // Login Handlers
        els.googleBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert("登入失敗: " + error.message);
            }
        });

        els.emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            
            try {
                // Try login first
                await signInWithEmailAndPassword(auth, email, password);
            } catch (loginError) {
                if (loginError.code === 'auth/user-not-found' || loginError.code === 'auth/invalid-credential') {
                    // Try register
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } catch (regError) {
                        alert("註冊/登入失敗: " + regError.message);
                    }
                } else {
                    alert("登入錯誤: " + loginError.message);
                }
            }
        });

        els.logoutBtn.addEventListener('click', () => signOut(auth));

        // --- 4. USER FLOW LOGIC ---

        async function handleUserLogin(user) {
            const isAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const role = isAdmin ? 'admin' : 'student';
            const userDocRef = doc(USERS_PUBLIC_REF, user.uid);

            // Sync User Data to Public Collection (So Admin can see it)
            // Note: In a real app, strict security rules are needed.
            // We use setDoc with merge to update lastLogin without wiping completed array
            try {
                // 1. Check if doc exists to preserve 'completed' and 'nickname'
                const docSnap = await getDoc(userDocRef);
                
                let dataToUpdate = {
                    email: user.email,
                    role: role,
                    lastLogin: serverTimestamp(),
                };

                if (!docSnap.exists()) {
                    // New User
                    dataToUpdate.nickname = "";
                    dataToUpdate.completed = [];
                    await setDoc(userDocRef, dataToUpdate);
                    currentUserData = dataToUpdate;
                } else {
                    // Existing User
                    await updateDoc(userDocRef, dataToUpdate);
                    currentUserData = docSnap.data();
                }

                // 2. Routing Logic
                if (isAdmin) {
                    currentUserData.nickname = "Admin"; // Force Admin Nickname
                    currentUserData.role = "admin";
                    setupDashboard(true);
                } else {
                    // Check Nickname
                    if (!currentUserData.nickname) {
                        els.loading.classList.add('hidden');
                        els.nicknameModal.classList.remove('hidden');
                    } else {
                        // Show Privacy Disclaimer (Simple one-time session check or always)
                        els.loading.classList.add('hidden');
                        els.privacy.classList.remove('hidden');
                    }
                }

            } catch (err) {
                console.error("Error syncing user:", err);
                alert("資料庫連接錯誤: " + err.message);
            }
        }

        // Nickname Handler
        els.saveNicknameBtn.addEventListener('click', async () => {
            const val = els.nicknameInput.value.trim();
            if (!val) return alert("請輸入暱稱");
            
            try {
                await updateDoc(doc(USERS_PUBLIC_REF, currentUser.uid), { nickname: val });
                currentUserData.nickname = val;
                els.nicknameModal.classList.add('hidden');
                els.privacy.classList.remove('hidden');
            } catch (e) {
                alert("儲存失敗: " + e.message);
            }
        });

        // Privacy Handler
        els.agreePrivacyBtn.addEventListener('click', () => {
            els.privacy.classList.add('hidden');
            setupDashboard(false);
        });

        // --- 5. DASHBOARD LOGIC ---

        function setupDashboard(isAdmin) {
            els.loading.classList.add('hidden');
            els.main.classList.remove('hidden');
            els.header.classList.remove('hidden');
            
            els.displayName.textContent = `${currentUserData.nickname} (${isAdmin ? '管理員' : '學生'})`;

            // Common Listener: Homework
            setupHomeworkListener(isAdmin);

            if (isAdmin) {
                // Admin View Setup
                els.adminPanel.classList.remove('hidden');
                els.memosSection.classList.add('hidden');
                els.adminStudentSection.classList.remove('hidden');
                setupAllStudentsListener(); // See everyone's progress
            } else {
                // Student View Setup
                els.adminPanel.classList.add('hidden');
                els.memosSection.classList.remove('hidden');
                els.adminStudentSection.classList.add('hidden');
                setupUserListener(); // Listen to self for 'completed' sync
                setupMemosListener(); // Private memos
            }
            lucide.createIcons();
        }

        // --- 6. DATA LISTENERS ---

        function setupHomeworkListener(isAdmin) {
            // Sort by createdAt desc
            const q = query(HOMEWORK_COLLECTION_REF, orderBy('due', 'asc')); // Show earliest due first
            
            unsubscribeHomework = onSnapshot(q, (snapshot) => {
                homeworkList = [];
                snapshot.forEach(doc => {
                    homeworkList.push({ id: doc.id, ...doc.data() });
                });
                renderHomeworkList(isAdmin);
                if (!isAdmin) calculateMyProgress();
            });
        }

        function setupUserListener() {
            // Listen to current user's public doc for 'completed' changes
            unsubscribeUser = onSnapshot(doc(USERS_PUBLIC_REF, currentUser.uid), (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    renderHomeworkList(false); // Re-render checks
                    calculateMyProgress();
                }
            });
        }

        function setupMemosListener() {
            // Private path: artifacts/{appId}/users/{uid}/memos
            const MEMO_REF = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'memos');
            const q = query(MEMO_REF, orderBy('createdAt', 'desc'));
            
            unsubscribeMemos = onSnapshot(q, (snapshot) => {
                els.memosList.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'bg-yellow-50 p-3 rounded border border-yellow-200 text-sm relative group animate-fade-in';
                    el.innerHTML = `
                        <p class="text-slate-700 break-words pr-6">${data.text}</p>
                        <button class="delete-memo absolute top-2 right-2 text-slate-400 hover:text-red-500 hidden group-hover:block" data-id="${docSnap.id}">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    `;
                    els.memosList.appendChild(el);
                });
                
                // Attach delete handlers
                document.querySelectorAll('.delete-memo').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        await deleteDoc(doc(MEMO_REF, btn.dataset.id));
                    });
                });
                lucide.createIcons();
            });
        }

        function setupAllStudentsListener() {
            // Admin only: Listen to all users to calculate stats
            const q = query(USERS_PUBLIC_REF);
            unsubscribeAllUsers = onSnapshot(q, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.role !== 'admin') {
                        students.push(data);
                    }
                });
                renderStudentStats(students);
            });
        }

        // --- 7. RENDERING & INTERACTIONS ---

        function renderHomeworkList(isAdmin) {
            els.homeworkList.innerHTML = '';
            
            if (homeworkList.length === 0) {
                els.homeworkList.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>目前沒有作業</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            homeworkList.forEach(hw => {
                const isCompleted = currentUserData?.completed?.includes(hw.id);
                const item = document.createElement('div');
                item.className = `bg-white p-4 rounded-xl border ${isCompleted ? 'border-emerald-200 bg-emerald-50/30' : 'border-slate-200'} shadow-sm flex items-center justify-between transition-all hover:shadow-md`;
                
                // Color coding for subject
                const subjectColors = {
                    '中文': 'bg-red-100 text-red-700',
                    '英文': 'bg-blue-100 text-blue-700',
                    '數學': 'bg-green-100 text-green-700',
                    '常識': 'bg-purple-100 text-purple-700'
                };
                const badgeClass = subjectColors[hw.subject] || 'bg-slate-100 text-slate-700';

                let actionHtml = '';
                if (isAdmin) {
                    actionHtml = `
                        <button class="delete-hw-btn text-slate-400 hover:text-red-500 p-2" data-id="${hw.id}" title="刪除">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                        </button>
                    `;
                } else {
                    actionHtml = `
                        <button class="toggle-hw-btn w-6 h-6 rounded border-2 ${isCompleted ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'} flex items-center justify-center transition-colors" data-id="${hw.id}">
                            ${isCompleted ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                        </button>
                    `;
                }

                item.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div class="flex flex-col items-center justify-center w-14 h-14 bg-slate-50 rounded-lg border border-slate-100 text-xs font-bold text-slate-500 shrink-0">
                            <span>${hw.due.split('-')[1]}/${hw.due.split('-')[2]}</span>
                            <span class="text-[10px] font-normal">截止</span>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${badgeClass}">${hw.subject}</span>
                                <span class="text-xs text-slate-400">${hw.due}</span>
                            </div>
                            <h3 class="font-bold text-slate-800 ${isCompleted ? 'line-through text-slate-400' : ''}">${hw.title}</h3>
                        </div>
                    </div>
                    ${actionHtml}
                `;

                els.homeworkList.appendChild(item);
            });

            // Attach Listeners
            if (isAdmin) {
                document.querySelectorAll('.delete-hw-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteHomework(btn.dataset.id));
                });
            } else {
                document.querySelectorAll('.toggle-hw-btn').forEach(btn => {
                    btn.addEventListener('click', () => toggleHomework(btn.dataset.id));
                });
            }
            lucide.createIcons();
        }

        function calculateMyProgress() {
            if (!currentUserData || !currentUserData.completed) return;
            const completedCount = currentUserData.completed.length;
            const total = homeworkList.length;
            
            // Note: completed array might contain IDs of deleted homeworks. 
            // In a robust app, we filter them. For now, simple length check or intersection.
            const validCompleted = currentUserData.completed.filter(id => homeworkList.some(h => h.id === id)).length;
            
            const pct = total === 0 ? 0 : Math.round((validCompleted / total) * 100);
            const pending = total - validCompleted;

            els.progressBar.style.width = `${pct}%`;
            els.progressText.textContent = `${pct}%`;
            els.pendingCount.textContent = total === 0 ? "目前沒有作業" : (pending === 0 ? "太棒了！全部完成" : `還有 ${pending} 份作業未完成`);
        }

        function renderStudentStats(students) {
            els.studentListContainer.innerHTML = '';
            
            const totalHw = homeworkList.length;

            if (students.length === 0) {
                els.studentListContainer.innerHTML = '<p class="text-slate-400 text-sm text-center">暫無學生資料</p>';
                return;
            }

            students.forEach(student => {
                const completed = student.completed || [];
                const validCompleted = completed.filter(id => homeworkList.some(h => h.id === id)).length;
                const pct = totalHw === 0 ? 0 : Math.round((validCompleted / totalHw) * 100);
                
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-lg border border-slate-200';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs">
                                ${student.nickname.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <p class="font-bold text-sm text-slate-800">${student.nickname}</p>
                                <p class="text-[10px] text-slate-400">上次登入: ${student.lastLogin ? new Date(student.lastLogin.seconds * 1000).toLocaleDateString() : '未知'}</p>
                            </div>
                        </div>
                        <span class="text-sm font-bold ${pct === 100 ? 'text-emerald-500' : 'text-blue-600'}">${pct}%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${pct}%"></div>
                    </div>
                `;
                els.studentListContainer.appendChild(card);
            });
        }

        // --- 8. ACTIONS ---

        async function toggleHomework(hwId) {
            if (!currentUserData) return;
            const completed = currentUserData.completed || [];
            let newCompleted;

            if (completed.includes(hwId)) {
                newCompleted = completed.filter(id => id !== hwId);
            } else {
                newCompleted = [...completed, hwId];
            }

            try {
                // Update local state immediately for snappy UI
                currentUserData.completed = newCompleted;
                renderHomeworkList(false);
                calculateMyProgress();

                await updateDoc(doc(USERS_PUBLIC_REF, currentUser.uid), {
                    completed: newCompleted
                });
            } catch (e) {
                console.error(e);
                alert("更新失敗，請檢查網絡");
            }
        }

        async function deleteHomework(hwId) {
            if (!confirm("確定要刪除這份功課嗎？學生將不再看到它。")) return;
            try {
                await deleteDoc(doc(HOMEWORK_COLLECTION_REF, hwId));
            } catch (e) {
                alert("刪除失敗: " + e.message);
            }
        }

        // Add Homework UI Handlers
        els.addHwModalBtn.addEventListener('click', () => els.addHwModal.classList.remove('hidden'));
        els.closeHwModal.addEventListener('click', () => els.addHwModal.classList.add('hidden'));

        els.addHwForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subject = document.getElementById('hw-subject').value;
            const title = document.getElementById('hw-title').value;
            const due = document.getElementById('hw-due').value;

            try {
                await addDoc(HOMEWORK_COLLECTION_REF, {
                    subject,
                    title,
                    due,
                    createdAt: serverTimestamp()
                });
                els.addHwModal.classList.add('hidden');
                els.addHwForm.reset();
            } catch (err) {
                alert("發布失敗: " + err.message);
            }
        });

        // Add Memo Handler
        els.addMemoBtn.addEventListener('click', async () => {
            const text = els.newMemoInput.value.trim();
            if (!text) return;

            const MEMO_REF = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'memos');
            try {
                await addDoc(MEMO_REF, {
                    text,
                    createdAt: serverTimestamp()
                });
                els.newMemoInput.value = '';
            } catch (e) {
                alert("新增備忘失敗");
            }
        });

        // Download Backup (Admin)
        els.downloadBackupBtn.addEventListener('click', async () => {
            try {
                // Fetch Users
                const usersSnap = await getDocs(query(USERS_PUBLIC_REF));
                const users = [];
                usersSnap.forEach(d => users.push(d.data()));

                // Fetch Homework
                const hwSnap = await getDocs(query(HOMEWORK_COLLECTION_REF));
                const homework = [];
                hwSnap.forEach(d => homework.push({id: d.id, ...d.data()}));

                const backup = {
                    date: new Date().toISOString(),
                    homework,
                    users
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `3b-hub-backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

            } catch (e) {
                alert("備份失敗: " + e.message);
            }
        });

    </script>
</body>
</html>

