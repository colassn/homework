<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠŸèª²èˆ‡é»˜æ›¸è¿½è¹¤å°å¹«æ‰‹</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; touch-action: manipulation; }
        input[type="file"]::file-selector-button { display: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        .notification-animate { animation: fadeIn 0.15s ease-out forwards; }
        .animate-item { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root" class="flex h-screen items-center justify-center text-slate-400 font-bold">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            App è¼‰å…¥ä¸­...<br/><span class="text-xs font-normal opacity-50">é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«</span>
        </div>
    </div>

    <!-- Firebase SDK (Stable) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3gYuwnyoTUwO7PFh4Nuue-Ud8GTruuRk",
            authDomain: "recordhwv2.firebaseapp.com",
            projectId: "recordhwv2",
            storageBucket: "recordhwv2.firebasestorage.app",
            messagingSenderId: "599261009391",
            appId: "1:599261009391:web:66cd7f932650bebc0e521a",
            measurementId: "G-C51XDYW67W"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const googleProvider = new GoogleAuthProvider();

            window.firebaseServices = { 
                auth, db, googleProvider,
                signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup,
                signOut, onAuthStateChanged, updateProfile,
                collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, setDoc
            };
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const ADMIN_EMAIL = 'chimhinhin@gmail.com'; 
        
        const SUBJECTS = [
            { name: 'ä¸­æ–‡', color: 'bg-red-100 text-red-700 border-red-200' },
            { name: 'è‹±æ–‡', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { name: 'æ•¸å­¸', color: 'bg-green-100 text-green-700 border-green-200' },
            { name: 'å…¬ç¤¾', color: 'bg-orange-100 text-orange-700 border-orange-200' },
            { name: 'ä½›å­¸', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
            { name: 'ç”Ÿç‰©', color: 'bg-emerald-100 text-emerald-700 border-emerald-200' },
            { name: 'ç‰©ç†', color: 'bg-cyan-100 text-cyan-700 border-cyan-200' },
            { name: 'åŒ–å­¸', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { name: 'åœ°ç†', color: 'bg-teal-100 text-teal-700 border-teal-200' },
            { name: 'æ­·å²', color: 'bg-stone-100 text-stone-700 border-stone-200' },
            { name: 'ä¸­å²', color: 'bg-amber-100 text-amber-800 border-amber-200' },
            { name: 'é«”è‚²', color: 'bg-lime-100 text-lime-700 border-lime-200' },
            { name: 'é›»è…¦', color: 'bg-indigo-100 text-indigo-700 border-indigo-200' },
            { name: 'STEAM', color: 'bg-violet-100 text-violet-700 border-violet-200' },
            { name: 'æ™®é€šè©±', color: 'bg-pink-100 text-pink-700 border-pink-200' },
            { name: 'è¦–è—', color: 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200' },
            { name: 'å…¨æ–¹ä½', color: 'bg-rose-100 text-rose-700 border-rose-200' },
            { name: 'éŸ³æ¨‚', color: 'bg-sky-100 text-sky-700 border-sky-200' },
            { name: 'å…¶ä»–', color: 'bg-gray-100 text-gray-700 border-gray-200' }
        ];

        const CLASS_SCHEDULE = {
            1: ["æ™®é€šé›»è…¦", "æ™®é€šé›»è…¦", "è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "æ™®é€šè©±", "ä½›å­¸", "æ­·å²", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ"],
            2: ["è‹±æ–‡", "è‹±æ–‡", "éŸ³æ¨‚", "åœ°ç†", "ç‰©ç†", "ç‰©ç†", "ä¸­æ–‡", "ä¸­æ–‡", "æ•¸å­¸", "æ•¸å­¸"],
            3: ["åŒ–å­¸", "åŒ–å­¸", "è‹±æ–‡", "è‹±æ–‡", "æ•¸å­¸", "ä¸­æ–‡", "è¦–è—", "è¦–è—", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ", "ä¸­å²"],
            4: ["STEAM", "STEAM", "æ•¸å­¸", "æ­·å²", "è‹±æ–‡", "è‹±æ–‡", "ç”Ÿç‰©", "ç”Ÿç‰©", "ä¸­å²", "åœ°ç†"],
            5: ["è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "é«”è‚²", "é«”è‚²", "æ•¸å­¸", "æ•¸å­¸", "å…¨æ–¹ä½", "å…¨æ–¹ä½"]
        };
        const LESSON_START_TIMES = [510, 545, 595, 630, 675, 710, 815, 850, 895, 930];

        const Icon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' }); } catch(e) {}
                }
            }, [name, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        const formatCountdown = (ms) => { const totalSeconds = Math.floor(ms / 1000); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
        const getTodayDateString = () => new Date().toLocaleDateString('zh-HK', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        const getNextSchoolDay = () => { const d = new Date(); const day = d.getDay(); let addDays = 1; if (day === 5) addDays = 3; else if (day === 6) addDays = 2; else if (day === 0) addDays = 1; d.setDate(d.getDate() + addDays); const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); return `${y}-${m}-${dd}`; };
        const getDaysRemaining = (dateString) => { const today = new Date(); today.setHours(0,0,0,0); const due = new Date(dateString); return Math.ceil((due - today) / (1000 * 60 * 60 * 24)); };
        
        const getNextLesson = (subjectName, now) => {
            if (!subjectName || subjectName === 'å…¶ä»–') return null;
            const currentDay = now.getDay(); const currentMinutes = now.getHours() * 60 + now.getMinutes(); const currentSeconds = now.getSeconds();
            for (let d = 0; d < 7; d++) {
                const checkDay = (currentDay + d) % 7; if (checkDay === 0 || checkDay === 6) continue;
                const subjects = CLASS_SCHEDULE[checkDay]; if (!subjects) continue;
                for (let i = 0; i < subjects.length; i++) {
                    if (subjects[i].includes(subjectName) || subjectName.includes(subjects[i])) {
                        const startMin = LESSON_START_TIMES[i]; const endMin = startMin + 35;
                        if (d === 0) { if (currentMinutes >= startMin && currentMinutes < endMin) { return { type: 'now', diff: 0 }; } if (currentMinutes < startMin) { const diffMs = ((startMin * 60) - (currentMinutes * 60 + currentSeconds)) * 1000; return { type: 'future', diff: diffMs, date: new Date(now.getTime() + diffMs) }; } } else { const dayDiff = d; const targetTimeMs = startMin * 60 * 1000; const currentTimeMs = (currentMinutes * 60 + currentSeconds) * 1000; const msInDay = 24 * 60 * 60 * 1000; const diffMs = (dayDiff * msInDay) - currentTimeMs + targetTimeMs; return { type: 'future', diff: diffMs }; }
                    }
                }
            }
            return null;
        };

        const getStatusBadge = (item, isExiting) => {
            const daysLeft = getDaysRemaining(item.dueDate);
            const isCompleted = item.completed || isExiting;
            
            if (isCompleted) return { text: 'å·²å®Œæˆ', color: 'bg-blue-100 text-blue-700', border: 'border-blue-200' };
            if (item.type === 'homework') {
                if (daysLeft < 0) return { text: `é²å’— ${Math.abs(daysLeft)} æ—¥`, color: 'bg-red-500 text-white', border: 'border-red-500' };
                if (daysLeft === 0) return { text: 'ä»Šæ—¥è¦äº¤ï¼', color: 'bg-orange-500 text-white font-bold', border: 'border-orange-500' };
                if (daysLeft === 1) return { text: 'è½æ—¥è¦äº¤', color: 'bg-amber-100 text-amber-800', border: 'border-amber-200' };
                return { text: `ä»²æœ‰ ${daysLeft} æ—¥`, color: 'bg-emerald-100 text-emerald-700', border: 'border-emerald-200' };
            } else {
                if (daysLeft < 0) return { text: 'å·²çµæŸ', color: 'bg-gray-100 text-gray-500', border: 'border-gray-200' };
                if (daysLeft === 0) return { text: 'ä»Šæ—¥è€ƒï¼', color: 'bg-red-600 text-white font-bold animate-pulse', border: 'border-red-600' };
                if (daysLeft === 1) return { text: 'è½æ—¥è€ƒï¼', color: 'bg-red-100 text-red-700 font-bold', border: 'border-red-200' };
                return { text: `ä»²æœ‰ ${daysLeft} æ—¥`, color: 'bg-indigo-100 text-indigo-700', border: 'border-indigo-200' };
            }
        };

        // --- Auth Modal ---
        function AuthModal({ isOpen, onClose, triggerAlert }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            const [loading, setLoading] = useState(false);
            
            if (!isOpen) return null;

            const handleGoogleLogin = async () => {
                setLoading(true);
                const { auth, googleProvider, signInWithPopup, db, doc, setDoc, serverTimestamp } = window.firebaseServices;
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    await setDoc(doc(db, "users_public", result.user.uid), {
                        email: result.user.email, displayName: result.user.displayName, photoURL: result.user.photoURL, lastSeen: serverTimestamp()
                    }, { merge: true });
                    onClose();
                } catch (e) { 
                    console.error(e);
                    if (e.code === 'auth/unauthorized-domain') {
                        triggerAlert("ç¶²åŸŸæœªæˆæ¬Šï¼šè«‹åœ¨ Firebase Console åŠ å…¥æ­¤ç¶²åŸŸ");
                    } else {
                        triggerAlert("Google ç™»å…¥å¤±æ•—"); 
                    }
                } finally { setLoading(false); }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                const { auth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, db, doc, setDoc, serverTimestamp } = window.firebaseServices;
                try {
                    let userCred;
                    if (isLogin) {
                        userCred = await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        if (!displayName) { triggerAlert("è«‹è¼¸å…¥åå­—"); setLoading(false); return; }
                        userCred = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCred.user, { displayName });
                    }
                    await setDoc(doc(db, "users_public", userCred.user.uid), {
                        email: userCred.user.email, displayName: userCred.user.displayName || displayName, lastSeen: serverTimestamp()
                    }, { merge: true });
                    onClose();
                } catch (e) { triggerAlert(e.message); } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate bg-white/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-md p-8 relative z-10 border border-white/50">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600"><Icon name="x" className="w-6 h-6" /></button>
                        <div className="text-center mb-8">
                            <h2 className="text-2xl font-black text-slate-800 tracking-tight">{isLogin ? 'ç™»å…¥å¸³æˆ¶' : 'ç«‹å³è¨»å†Š'}</h2>
                            <p className="text-slate-500 mt-1 text-sm">è«‹ç™»å…¥ä»¥åŒæ­¥è³‡æ–™</p>
                        </div>
                        <button onClick={handleGoogleLogin} disabled={loading} className="w-full flex items-center justify-center gap-3 py-3 px-4 rounded-xl bg-white border border-slate-200 text-slate-700 font-bold hover:bg-slate-50 transition-all shadow-sm mb-6 disabled:opacity-50"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" alt="Google"/> ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
                        <div className="flex items-center gap-4 mb-6"><div className="flex-1 h-[1px] bg-slate-100"></div><span className="text-xs text-slate-400 font-medium">æˆ–ä½¿ç”¨ Email</span><div className="flex-1 h-[1px] bg-slate-100"></div></div>
                        <form onSubmit={handleEmailAuth} className="space-y-4">
                            {!isLogin && <input type="text" placeholder="ä½ çš„åå­—" className="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" value={displayName} onChange={e=>setDisplayName(e.target.value)} />}
                            <input type="email" placeholder="é›»å­éƒµä»¶" className="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input type="password" placeholder="å¯†ç¢¼" className="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200" value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button type="submit" disabled={loading} className="w-full py-3.5 rounded-xl bg-indigo-600 text-white font-bold text-lg shadow-lg hover:bg-indigo-700 transition-all disabled:opacity-70">{loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}</button>
                        </form>
                        <p className="mt-6 text-center text-sm text-slate-500">{isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ' : 'å·²æœ‰å¸³è™Ÿï¼Ÿ'}<button onClick={()=>setIsLogin(!isLogin)} className="ml-1 text-indigo-600 font-bold underline">{isLogin ? 'ç«‹å³è¨»å†Š' : 'ç›´æ¥ç™»å…¥'}</button></p>
                    </div>
                </div>
            );
        }

        // --- Other Modals & Components ---
        function NameSetupModal({ onSave, loading }) { const [name, setName] = useState(''); return ( <div className="fixed inset-0 z-[150] flex items-center justify-center p-4"> <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div> <div className="modal-animate bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 relative z-10 text-center"> <h2 className="text-2xl font-black text-slate-800 mb-2">æ­¡è¿åŠ å…¥ï¼</h2> <form onSubmit={(e)=>{e.preventDefault(); onSave(name);}}><input type="text" className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-center font-bold mb-4" placeholder="ä¾‹å¦‚: Peter" value={name} onChange={e=>setName(e.target.value)} required /><button type="submit" disabled={loading} className="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold">é–‹å§‹ä½¿ç”¨</button></form> </div> </div> ); }
        function EditModal({ item, onClose, onSave }) { const [desc, setDesc] = useState(item.description); const [sub, setSub] = useState(item.subject); const [due, setDue] = useState(item.dueDate); const [load, setLoad] = useState(false); return ( <div className="fixed inset-0 z-[110] flex items-center justify-center p-4"> <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div> <div className="modal-animate bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10"> <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">ä¿®æ”¹</h3><button onClick={onClose}><Icon name="x" className="w-5 h-5"/></button></div> <form onSubmit={async(e)=>{e.preventDefault(); setLoad(true); await onSave(item.id, {description:desc, subject:sub, dueDate:due}); onClose();}}> <div className="mb-4"><label className="block text-xs font-bold text-slate-500 mb-2">ç§‘ç›®</label><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{SUBJECTS.map(s=><button key={s.name} type="button" onClick={()=>setSub(s.name)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${sub===s.name?s.color:'bg-white text-slate-500 border-slate-200'}`}>{s.name}</button>)}</div></div> <textarea value={desc} onChange={e=>setDesc(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 mb-4 text-sm" rows="3"></textarea> <input type="date" value={due} onChange={e=>setDue(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 mb-4 text-sm" /> <button disabled={load} className="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold">{load?'å„²å­˜ä¸­...':'å„²å­˜'}</button> </form> </div> </div> ); }
        function CustomDropdown({ value, onChange, options }) { const [isOpen, setIsOpen] = useState(false); return ( <div className="relative"> <button onClick={()=>setIsOpen(!isOpen)} className="flex items-center gap-2 bg-white border border-slate-200 text-slate-600 text-xs rounded-lg px-3 py-1.5 font-bold shadow-sm"><span>{options.find(o=>o.value===value)?.label}</span><Icon name="chevron-down" className="w-3 h-3"/></button> {isOpen && <div className="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden">{options.map(opt=><button key={opt.value} onClick={()=>{onChange(opt.value); setIsOpen(false);}} className="w-full text-left px-4 py-3 text-xs font-bold hover:bg-slate-50 flex items-center gap-2">{opt.icon && <Icon name={opt.icon} className="w-3 h-3"/>}{opt.label}</button>)}</div>} </div> ); }
        
        function Timetable({ currentDay, subjects, onDayChange, now }) { 
            const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; 
            const getSchedule = (subs) => { if(!subs) return []; const start = new Date(now); start.setHours(8,30,0,0); const list=[]; let cur=start; let idx=0; const add=(dur, type, name)=>{ const next=new Date(cur.getTime()+dur*60000); list.push({timeStr:`${cur.toLocaleTimeString('zh-HK',{hour:'2-digit',minute:'2-digit'})} - ${next.toLocaleTimeString('zh-HK',{hour:'2-digit',minute:'2-digit'})}`, start:new Date(cur), end:new Date(next), type, subject:name}); cur=next; }; for(let i=0;i<2;i++) add(35,'lesson',subs[idx++]||'è‡ªä¿®'); add(15,'break','å°æ¯'); for(let i=0;i<2;i++) add(35,'lesson',subs[idx++]||'è‡ªä¿®'); add(10,'break','å°æ¯'); for(let i=0;i<2;i++) add(35,'lesson',subs[idx++]||'è‡ªä¿®'); add(70,'lunch','åˆè†³'); for(let i=0;i<2;i++) add(35,'lesson',subs[idx++]||'è‡ªä¿®'); add(10,'break','å°æ¯'); for(let i=0;i<2;i++) add(35,'lesson',subs[idx++]||'è‡ªä¿®'); return list; }; 
            const data = getSchedule(subjects[currentDay]); 
            return ( 
                <div className="space-y-4 w-full h-full"> 
                    <div className="flex bg-white rounded-xl p-1 shadow-sm overflow-x-auto w-full">{[1,2,3,4,5].map(d=><button key={d} onClick={()=>onDayChange(d)} className={`flex-1 py-2 px-3 rounded-lg text-sm font-bold whitespace-nowrap ${currentDay===d?'bg-indigo-600 text-white shadow':'text-slate-500'}`}>æ˜ŸæœŸ{weekDays[d]}</button>)}</div> 
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 relative w-full">{data.map((slot,i)=>{ const active=now>=slot.start&&now<slot.end; const past=now>=slot.end; let prog=0, left=0; if(active){ const total=slot.end-slot.start; const elap=now-slot.start; prog=Math.min(100, Math.max(0,(elap/total)*100)); left=Math.ceil((total-elap)/60000); } return ( <div key={i} className={`relative pl-8 pb-8 last:pb-0 border-l-2 transition-all ${active?'border-green-500':past?'border-slate-100':'border-green-200'}`}> <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 transition-all ${active?'bg-green-600 border-green-200 scale-125':past?'bg-slate-200 border-slate-300':'bg-green-50 border-green-300'}`}></div> <div className={`transition-all ${active?'translate-x-2':''} ${past?'opacity-40 grayscale blur-[1px]':''}`}> <div className="flex justify-between items-start mb-1"> <div><div className={`text-xs font-mono mb-1 flex items-center gap-2 ${active?'text-green-600 font-bold':'text-slate-400'}`}>{slot.timeStr} {active&&<span className="text-[10px] bg-green-100 text-green-700 px-1.5 rounded font-bold">é€²è¡Œä¸­</span>}</div><div className={`text-base font-bold flex items-center gap-2 ${active?'text-green-900 text-xl':slot.type!=='lesson'?'text-slate-500 text-sm italic':'text-slate-700'}`}>{slot.subject}</div></div> {active&&<div className="text-right bg-green-50 px-3 py-1.5 rounded-lg border border-green-100"><div className="text-2xl font-black text-green-600">{left}<span className="text-xs ml-1">min</span></div></div>} </div> {active&&<div className="w-full h-2 bg-slate-100 rounded-full mt-3 overflow-hidden shadow-inner"><div className="h-full bg-gradient-to-r from-green-500 to-teal-500 transition-all duration-1000 relative" style={{width:`${prog}%`}}><div className="absolute right-0 top-0 bottom-0 w-1 bg-white/50 animate-pulse"></div></div></div>} </div> </div> ); })}</div> 
                </div> 
            ); 
        }
        
        function AdminUserView({ onBack }) { const [users, setUsers] = useState([]); useEffect(()=>{ if(!window.firebaseServices)return; const {db,collection,query,orderBy,onSnapshot}=window.firebaseServices; const q=query(collection(db,"users_public"),orderBy("lastSeen","desc")); const unsub=onSnapshot(q,s=>{setUsers(s.docs.map(d=>({uid:d.id,...d.data()})));}); return ()=>unsub(); },[]); return (<div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 min-h-[500px] w-full"><div className="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><button onClick={onBack}><Icon name="arrow-left" className="w-5 h-5 text-slate-500"/></button><h2 className="text-xl font-bold text-slate-800">ç”¨æˆ¶ç‹€æ…‹</h2></div><div className="space-y-3 max-h-[600px] overflow-y-auto">{users.map(u=>{ const online=u.lastSeen&&((new Date()-u.lastSeen.toDate())<300000); return (<div key={u.uid} className={`flex items-center justify-between p-4 rounded-xl border ${online?'bg-green-50 border-green-200':'bg-white border-slate-100'}`}><div className="flex items-center gap-3"><div className="relative">{u.photoURL?<img src={u.photoURL} className="w-10 h-10 rounded-full"/>:<div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">{u.displayName?.[0]||'U'}</div>}<div className={`absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-2 border-white ${online?'bg-green-500':'bg-slate-300'}`}></div></div><div><div className="font-bold text-slate-800">{u.displayName||'æœªå‘½å'}</div><div className="text-xs text-slate-400">{u.email}</div></div></div></div>); })}</div></div>); }
        function AdminSystemPanel({ onBack }) { return (<div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 min-h-[500px] w-full"><div className="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icon name="arrow-left" className="w-5 h-5 text-slate-500" /></button><h2 className="text-xl font-bold text-slate-800">ç³»çµ±æ§åˆ¶å°</h2></div><div className="p-6 text-center text-slate-500 bg-slate-50 rounded-xl">ç³»çµ±è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...</div></div>); }

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const [notification, setNotification] = useState({ isOpen: false, type: 'alert', message: '' });
            const [viewMode, setViewMode] = useState('current');
            const [inputType, setInputType] = useState('homework');
            const [subject, setSubject] = useState('ä¸­æ–‡');
            const [description, setDescription] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [now, setNow] = useState(new Date());
            const [selectedImage, setSelectedImage] = useState(null);
            const [currentTimetableDay, setCurrentTimetableDay] = useState(new Date().getDay() || 1); 
            const [isAdmin, setIsAdmin] = useState(false);
            const [filterSubject, setFilterSubject] = useState('å…¨éƒ¨');
            const [sortOption, setSortOption] = useState('date_asc');
            const [activeModal, setActiveModal] = useState(null);
            const [exitingIds, setExitingIds] = useState([]);
            const [showNameSetup, setShowNameSetup] = useState(false);
            const [nameSetupLoading, setNameSetupLoading] = useState(false);
            const [isListVisible, setIsListVisible] = useState(true);
            const [editingItem, setEditingItem] = useState(null);
            const fileInputRef = useRef(null);

            const triggerAlert = (message) => setNotification({ isOpen: true, type: 'alert', message });
            const triggerConfirm = (message, onConfirmAction) => setNotification({ isOpen: true, type: 'confirm', message, onConfirm: onConfirmAction });
            const handleNotificationConfirm = () => { if (notification.onConfirm) notification.onConfirm(); setNotification(prev => ({...prev, isOpen: false})); };
            const handleFilterChange = (newFilter) => { if (newFilter === filterSubject) return; setIsListVisible(false); setTimeout(() => { setFilterSubject(newFilter); setIsListVisible(true); }, 200); };
            const handleSortChange = (newSort) => { if (newSort === sortOption) return; setIsListVisible(false); setTimeout(() => { setSortOption(newSort); setIsListVisible(true); }, 200); };
            const handleDashboardClick = (mode) => setActiveModal(mode);

            const handleSignOut = () => { triggerConfirm("ç¢ºå®šç™»å‡º?", async () => { await window.firebaseServices.signOut(window.firebaseServices.auth); setUser(null); }); };

            useEffect(() => { const timer = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(timer); }, []);

            useEffect(() => {
                const init = () => {
                    if (window.firebaseServices) {
                        const { auth, db, onAuthStateChanged, collection, query, orderBy, onSnapshot, doc, setDoc, serverTimestamp } = window.firebaseServices;
                        onAuthStateChanged(auth, async (currentUser) => {
                            setUser(currentUser);
                            setLoading(false);
                            if (currentUser) {
                                setIsAdmin(currentUser.email === ADMIN_EMAIL);
                                setDueDate(getNextSchoolDay());
                                setIsAuthModalOpen(false);
                                if (!currentUser.displayName) setShowNameSetup(true);
                                const updatePresence = async () => { await setDoc(doc(db, "users_public", currentUser.uid), { email: currentUser.email, displayName: currentUser.displayName, photoURL: currentUser.photoURL, lastSeen: serverTimestamp() }, { merge: true }); };
                                updatePresence();
                                setInterval(updatePresence, 5 * 60 * 1000);
                                const q = query(collection(db, "users", currentUser.uid, "items"), orderBy("dueDate"));
                                const unsubscribe = onSnapshot(q, (snap) => setItems(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                                return () => unsubscribe();
                            } else {
                                setItems([]); setIsAdmin(false);
                            }
                        });
                    }
                };
                window.firebaseServices ? init() : window.addEventListener('firebase-ready', init);
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
                try {
                    await addDoc(collection(db, "users", user.uid, "items"), { type: inputType, subject, description, image: selectedImage, dueDate, completed: false, createdAt: serverTimestamp() });
                    setDescription(''); setSelectedImage(null); if(fileInputRef.current) fileInputRef.current.value = "";
                } catch (e) { triggerAlert("æ–°å¢å¤±æ•—"); }
            };

            const handleToggle = async (id, status) => {
                const { db, doc, updateDoc } = window.firebaseServices;
                const itemRef = doc(db, "users", user.uid, "items", id);
                if (!status) { setExitingIds(prev => [...prev, id]); setTimeout(async () => { await updateDoc(itemRef, { completed: true }); setExitingIds(prev => prev.filter(eid => eid !== id)); }, 1000); } else { await updateDoc(itemRef, { completed: false }); }
            };

            const deleteItem = (id) => { const { db, doc, deleteDoc } = window.firebaseServices; triggerConfirm("ç¢ºå®šåˆªé™¤ï¼Ÿ", async () => await deleteDoc(doc(db, "users", user.uid, "items", id))); };
            const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { if (file.size > 800000) { triggerAlert("åœ–ç‰‡éå¤§"); return; } const reader = new FileReader(); reader.onloadend = () => setSelectedImage(reader.result); reader.readAsDataURL(file); } };
            const handleUpdateItem = async (id, data) => { const { db, doc, updateDoc } = window.firebaseServices; try { await updateDoc(doc(db, "users", user.uid, "items", id), data); triggerAlert("å·²æ›´æ–°"); } catch (e) { triggerAlert("æ›´æ–°å¤±æ•—"); } };
            const handleNameSetupSave = async (name) => { if (!user) return; setNameSetupLoading(true); const { updateProfile, db, doc, setDoc, serverTimestamp } = window.firebaseServices; try { await updateProfile(user, { displayName: name }); await setDoc(doc(db, "users_public", user.uid), { email: user.email, displayName: name, lastSeen: serverTimestamp() }, { merge: true }); setShowNameSetup(false); triggerAlert(`æ­¡è¿, ${name}!`); } catch (e) { triggerAlert("è¨­å®šå¤±æ•—"); } finally { setNameSetupLoading(false); } };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>;

            const activeItems = items.filter(i => !i.completed);
            const todayHomeworks = activeItems.filter(i => i.type === 'homework' && getDaysRemaining(i.dueDate) <= 0);
            const tomorrowHomeworks = activeItems.filter(i => i.type === 'homework' && getDaysRemaining(i.dueDate) === 1);
            const futureHomeworks = activeItems.filter(i => i.type === 'homework' && getDaysRemaining(i.dueDate) > 1);
            const activeTests = activeItems.filter(i => i.type !== 'homework');
            activeTests.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            const nextTest = activeTests[0]; const nextTestDays = nextTest ? getDaysRemaining(nextTest.dueDate) : null;

            const getModalTitle = () => { if (activeModal === 'today') return 'ä»Šæ—¥è¦äº¤'; if (activeModal === 'tomorrow') return 'è½æ—¥è¦äº¤'; if (activeModal === 'future') return 'æ—¥å¾Œè¦äº¤'; if (activeModal === 'revision') return 'é»˜æ›¸æ¸¬é©—'; };
            const getModalItems = () => { if (activeModal === 'today') return todayHomeworks; if (activeModal === 'tomorrow') return tomorrowHomeworks; if (activeModal === 'future') return futureHomeworks; if (activeModal === 'revision') return activeTests; return []; };

            const displayedItems = items.filter(item => {
                const visible = viewMode === 'current' ? !item.completed : item.completed;
                if (!visible) return false;
                if (filterSubject !== 'å…¨éƒ¨' && (item.subject || 'å…¶ä»–') !== filterSubject) return false;
                return true;
            }).sort((a, b) => {
                const da = new Date(a.dueDate), db = new Date(b.dueDate);
                if (sortOption === 'date_asc') return da - db;
                if (sortOption === 'date_desc') return db - da;
                if (sortOption === 'type_assess') return (b.type==='assessment'?1:0) - (a.type==='assessment'?1:0);
                if (sortOption === 'type_hw') return (a.type==='homework'?1:0) - (b.type==='homework'?1:0);
                return 0;
            });

            const renderItemCard = (item, idx) => {
                const daysLeft = getDaysRemaining(item.dueDate); const isExiting = exitingIds.includes(item.id);
                const status = getStatusBadge(item, isExiting);
                const nextLesson = getNextLesson(item.subject, now);
                return (
                    <div key={item.id} style={{ animationDelay: `${idx * 0.05}s` }} className={`animate-item relative group overflow-hidden bg-white rounded-xl p-4 shadow-sm border transition-all duration-300 ${isExiting ? 'scale-95 opacity-0 translate-y-4' : 'hover:shadow-md'} border-slate-100 ${item.type !== 'homework' ? 'border-l-4 border-l-purple-400' : ''}`}>
                        {item.type==='homework' && <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${daysLeft < 0 ? 'bg-red-500' : daysLeft === 0 ? 'bg-orange-500' : 'bg-transparent'}`}></div>}
                        <div className="flex items-start gap-3">
                            <button onClick={() => handleToggle(item.id, item.completed)} className={`flex-shrink-0 mt-1 w-6 h-6 rounded-full border-2 transition-all flex items-center justify-center ${item.type!=='homework'?'border-purple-300 hover:border-purple-500':'border-slate-300 hover:border-indigo-500'}`}><Icon name="check-circle" className={`w-3.5 h-3.5 transition-transform scale-0`} /></button>
                            <div className="flex-grow min-w-0">
                                <div className="flex flex-col gap-1">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${SUBJECTS.find(s=>s.name===item.subject)?.color || 'bg-gray-100'}`}>{item.subject}</span>
                                            <span className="text-xs font-bold text-slate-500">{item.type==='homework'?'åŠŸèª²':'é»˜æ›¸'}</span>
                                        </div>
                                        <span className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-bold shadow-sm border ${status.color} ${status.border}`}>{status.text}</span>
                                    </div>
                                    <div className={`text-base font-medium whitespace-pre-wrap leading-relaxed text-slate-800`}>{item.description}</div>
                                    {item.image && <div className="mt-2 relative w-fit"><img src={item.image} className="max-h-32 rounded-lg border border-slate-200 object-cover" /></div>}
                                    <div className="flex items-center justify-between mt-1">
                                        <div className="flex items-center gap-1 text-xs text-slate-400"><Icon name="calendar" className="w-3 h-3"/>{item.dueDate}</div>
                                        {nextLesson && viewMode==='current' && !item.completed && <div className="text-[10px] font-bold text-indigo-600 flex items-center gap-1"><Icon name="clock" className="w-3 h-3"/>è·é›¢ä¸Šèª² {formatCountdown(nextLesson.diff)}</div>}
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-1">
                                <button onClick={() => setEditingItem(item)} className="flex-shrink-0 p-1.5 text-slate-300 hover:text-blue-500 rounded-lg"><Icon name="pencil" className="w-4 h-4" /></button>
                                <button onClick={() => deleteItem(item.id)} className="flex-shrink-0 p-1.5 text-slate-300 hover:text-red-500 rounded-xl"><Icon name="trash-2" className="w-4 h-4" /></button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4 sm:p-6 md:p-8 font-sans text-slate-800 relative overflow-x-hidden">
                    {!user && <div className="fixed inset-0 z-40 cursor-pointer" onClick={() => { triggerAlert("ğŸ‘‹ æ­¡è¿ï¼è«‹å…ˆç™»å…¥ä»¥é–‹å§‹ä½¿ç”¨ã€‚"); setIsAuthModalOpen(true); }}></div>}
                    <div className={`w-full max-w-2xl mx-auto min-h-[80vh] transition-all duration-700 ${!user ? 'blur-[2px] grayscale opacity-60 pointer-events-none' : ''}`}>
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4 relative z-50">
                            <div>
                                <h1 className="text-2xl sm:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center gap-2"><Icon name="graduation-cap" className="w-6 h-6 sm:w-8 sm:h-8 text-indigo-600"/> å­¸ç”Ÿå°å¹«æ‰‹</h1>
                                <p className="text-slate-500 text-sm mt-1 ml-1 font-medium">{getTodayDateString()}</p>
                            </div>
                            <div className="flex gap-2 flex-wrap justify-end">
                                <button onClick={() => setViewMode('timetable')} className={`group relative flex items-center gap-2 px-3 py-2.5 rounded-full font-bold text-sm transition-all shadow-md hover:shadow-xl hover:-translate-y-1 ${viewMode === 'timetable' ? 'bg-orange-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-100'}`}><Icon name="calendar-days" className="w-4 h-4"/>æ™‚é–“è¡¨</button>
                                {isAdmin && <button onClick={() => setViewMode('admin_users')} className={`group relative flex items-center gap-2 px-3 py-2.5 rounded-full font-bold text-sm transition-all shadow-md hover:shadow-xl hover:-translate-y-1 ${viewMode === 'admin_users' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700 border-2 border-slate-100'}`}><Icon name="users" className="w-4 h-4"/>ç”¨æˆ¶</button>}
                                <button onClick={() => setViewMode(viewMode === 'current' ? 'history' : 'current')} className={`group relative flex items-center gap-2 px-3 py-2.5 rounded-full font-bold text-sm transition-all shadow-md hover:shadow-xl hover:-translate-y-1 ${viewMode === 'history' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white' : 'bg-white text-slate-700 border-2 border-slate-100'}`}>{viewMode === 'history' || viewMode === 'admin_users' ? 'è¿”ä¸»é ' : 'ç‡ç´€éŒ„'}</button>
                                {user ? <button onClick={handleSignOut} className="px-3 py-2.5 rounded-full font-bold text-sm bg-slate-200 text-slate-600 hover:bg-slate-300 shadow-sm relative z-50"><Icon name="log-out" className="w-4 h-4"/></button> : <button onClick={(e)=>{e.stopPropagation(); setIsAuthModalOpen(true);}} className="px-4 py-2.5 rounded-full font-bold text-sm bg-indigo-600 text-white shadow-md relative z-50 pointer-events-auto">ç™»å…¥</button>}
                            </div>
                        </div>

                        {viewMode === 'system_admin' ? <AdminSystemPanel onBack={() => setViewMode('current')} /> : 
                         viewMode === 'admin_users' ? <AdminUserView onBack={()=>setViewMode('current')} /> : 
                         viewMode === 'timetable' ? <Timetable currentDay={currentTimetableDay} subjects={CLASS_SCHEDULE} onDayChange={setCurrentTimetableDay} now={now} /> : (
                            <>
                                {viewMode === 'current' && (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-6 sm:mb-8">
                                        <div onClick={() => handleDashboardClick('today')} className="cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border border-red-100 flex flex-col items-center justify-center text-center ring-1 ring-red-50 hover:scale-105 hover:shadow-md transition-all active:scale-95"><div className="text-red-500 mb-1"><Icon name="flame" className="w-5 h-5 sm:w-6 sm:h-6"/></div><div className="text-2xl sm:text-3xl font-bold text-slate-800">{todayHomeworks.length}</div><div className="text-xs sm:text-sm font-medium text-slate-500">ä»Šæ—¥è¦äº¤</div></div>
                                        <div onClick={() => handleDashboardClick('tomorrow')} className="cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border border-orange-100 flex flex-col items-center justify-center text-center ring-1 ring-orange-50 hover:scale-105 hover:shadow-md transition-all active:scale-95"><div className="text-orange-500 mb-1"><Icon name="sun" className="w-5 h-5 sm:w-6 sm:h-6"/></div><div className="text-2xl sm:text-3xl font-bold text-slate-800">{tomorrowHomeworks.length}</div><div className="text-xs sm:text-sm font-medium text-slate-500">è½æ—¥è¦äº¤</div></div>
                                        <div onClick={() => handleDashboardClick('future')} className="cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border border-sky-100 flex flex-col items-center justify-center text-center ring-1 ring-sky-50 hover:scale-105 hover:shadow-md transition-all active:scale-95"><div className="text-sky-500 mb-1"><Icon name="calendar-range" className="w-5 h-5 sm:w-6 sm:h-6"/></div><div className="text-2xl sm:text-3xl font-bold text-slate-800">{futureHomeworks.length}</div><div className="text-xs sm:text-sm font-medium text-slate-500">æ—¥å¾Œè¦äº¤</div></div>
                                        <div onClick={() => handleDashboardClick('revision')} className={`cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border flex flex-col items-center justify-center text-center ring-1 hover:scale-105 hover:shadow-md transition-all active:scale-95 ${nextTestDays !== null && nextTestDays <= 3 ? 'border-purple-200 ring-purple-100 bg-purple-50/50' : 'border-indigo-100 ring-indigo-50'}`}><div className="text-purple-500 mb-1"><Icon name="brain-circuit" className="w-5 h-5 sm:w-6 sm:h-6"/></div><div className="text-2xl sm:text-3xl font-bold text-slate-800">{activeTests.length}</div><div className="text-xs sm:text-sm font-medium text-slate-500">æº«ç¿’è€ƒæ ¸</div></div>
                                    </div>
                                )}

                                {viewMode === 'current' && (
                                    <div className="relative bg-white/80 backdrop-blur-xl rounded-2xl sm:rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-4 sm:p-6 mb-8 sm:mb-10 border border-white/50 ring-1 ring-indigo-50 transition-all z-20">
                                        <div className="flex bg-slate-100/80 p-1 rounded-xl mb-4">
                                            <button onClick={() => setInputType('homework')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${inputType === 'homework' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Icon name="book-open" className="w-4 h-4"/> åšåŠŸèª²</button>
                                            <button onClick={() => setInputType('assessment')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${inputType === 'assessment' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Icon name="file-question" className="w-4 h-4"/> æº«é»˜æ›¸/æ¸¬é©—</button>
                                        </div>
                                        <form onSubmit={handleSubmit} className="flex flex-col gap-3 sm:gap-4">
                                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{SUBJECTS.map(sub => (<button key={sub.name} type="button" onClick={() => setSubject(sub.name)} className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${subject === sub.name ? sub.color + ' ring-1 ring-offset-1 ring-indigo-100' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{sub.name}</button>))}</div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
                                                <div className="md:col-span-2 space-y-3">
                                                    <textarea placeholder={inputType === 'homework' ? "æ‰“è¿”åŠŸèª²å…§å®¹..." : "è¼¸å…¥ç¯„åœ (ä¾‹å¦‚: ç¬¬3èª² / P.20-25)"} value={description} onChange={(e) => setDescription(e.target.value)} rows="2" className="w-full min-h-[80px] rounded-xl sm:rounded-2xl border-slate-200 bg-slate-50/50 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all p-3 sm:p-4 border text-slate-700 placeholder:text-slate-400 resize-none text-sm sm:text-base" />
                                                    {inputType !== 'homework' && (<div className="flex items-center gap-2"><label className="cursor-pointer flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 text-sm transition-colors border border-slate-200"><Icon name="image" className="w-4 h-4"/>{selectedImage ? 'æ›å¼µç›¸' : 'ä¸Šå‚³ç¯„åœåœ–ç‰‡'}<input type="file" accept="image/*" ref={fileInputRef} onChange={handleImageUpload} className="hidden" /></label>{selectedImage && (<div className="flex items-center gap-2 bg-indigo-50 px-2 py-1 rounded text-xs text-indigo-600 border border-indigo-100"><span>å·²é¸åœ–ç‰‡</span><button type="button" onClick={() => {setSelectedImage(null); fileInputRef.current.value="";}} className="hover:text-red-500"><Icon name="x" className="w-3 h-3"/></button></div>)}</div>)}
                                                </div>
                                                <div className="flex flex-col gap-2 md:col-span-1">
                                                    <label className="block text-xs font-medium text-slate-500 mb-1 ml-1">{inputType === 'homework' ? 'ç¹³äº¤æ—¥æœŸ' : 'è€ƒè©¦æ—¥æœŸ'}</label>
                                                    <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full h-10 sm:h-12 rounded-lg sm:rounded-xl border-slate-200 bg-slate-50/50 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all px-3 sm:px-4 border text-slate-600 font-medium text-sm sm:text-base" required />
                                                    <button type="submit" className={`w-full h-10 sm:h-12 text-white font-bold rounded-lg sm:rounded-xl transition-all duration-200 flex items-center justify-center gap-2 shadow-lg active:scale-95 text-sm sm:text-base ${inputType === 'homework' ? 'bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 shadow-indigo-200' : 'bg-gradient-to-r from-purple-500 to-violet-500 hover:from-purple-600 hover:to-violet-600 shadow-purple-200'}`}><Icon name="plus" className="w-4 h-4 sm:w-5 sm:h-5"/>{inputType === 'homework' ? 'åŠ åŠŸèª²' : 'Mark ä½'}</button>
                                                </div>
                                            </div>
                                        </form>
                                        <div className="flex flex-col sm:flex-row justify-between items-center gap-3 mt-6 pt-4 border-t border-slate-100 relative">
                                            <div className={`flex items-center gap-2 w-full sm:w-auto overflow-x-auto scrollbar-hide pb-1 transition-opacity duration-300 ${!isListVisible ? 'opacity-50' : 'opacity-100'}`}>
                                                <span className="text-slate-400 text-xs font-bold whitespace-nowrap flex items-center gap-1"><Icon name="filter" className="w-3 h-3"/>ç¯©é¸:</span>
                                                <button onClick={() => handleFilterChange('å…¨éƒ¨')} className={`flex-shrink-0 px-2.5 py-1 rounded text-[10px] font-bold border transition-all ${filterSubject === 'å…¨éƒ¨' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>å…¨éƒ¨</button>
                                                {SUBJECTS.map(sub => (<button key={sub.name} onClick={() => handleFilterChange(sub.name)} className={`flex-shrink-0 px-2.5 py-1 rounded text-[10px] font-bold border transition-all ${filterSubject === sub.name ? sub.color + ' ring-1 ring-offset-1 ring-indigo-100' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{sub.name}</button>))}
                                            </div>
                                            <div className="flex items-center gap-2 w-full sm:w-auto z-30"><span className="text-slate-400 text-xs font-bold whitespace-nowrap flex items-center gap-1"><Icon name="arrow-up-down" className="w-3 h-3"/>æ’åº:</span><CustomDropdown value={sortOption} onChange={handleSortChange} options={[{ value: 'date_asc', label: 'æ—¥æœŸ (è¶•æ€¥å…ˆ)', icon: 'calendar' }, { value: 'date_desc', label: 'æ—¥æœŸ (é•·é å…ˆ)', icon: 'calendar-off' }, { value: 'type_assess', label: 'é»˜æ›¸æ¸¬é©— å„ªå…ˆ', icon: 'flame' }, { value: 'type_hw', label: 'åŠŸèª² å„ªå…ˆ', icon: 'book-open' }]} /></div>
                                        </div>
                                    </div>
                                )}

                                <div className={`space-y-3 sm:space-y-4 pb-12 transition-all duration-300 ${!isListVisible ? 'opacity-0 translate-y-4' : 'opacity-100 translate-y-0'}`}>
                                    {displayedItems.length === 0 ? (<div className="text-center py-12 sm:py-20"><div className="relative inline-block"><div className="absolute inset-0 bg-indigo-200 blur-2xl opacity-20 rounded-full animate-pulse"></div><div className="relative bg-white p-4 sm:p-6 rounded-full shadow-sm mb-4 inline-flex"><Icon name="sparkles" className="w-8 h-8 sm:w-12 sm:h-12 text-indigo-300" /></div></div><h3 className="text-lg sm:text-xl font-bold text-slate-700 mb-2">{user ? (filterSubject !== 'å…¨éƒ¨' ? 'é€™å€‹ç§‘ç›®æš«æ™‚æ²’æœ‰åŠŸèª²' : 'å¤ªå¥½äº†ï¼æš«æ™‚å†‡å˜¢åš') : 'ç™»å…¥å¾Œå°±å¯ä»¥ä½¿ç”¨'}</h3></div>) : (displayedItems.map((item, index) => renderItemCard(item, index)))}
                                </div>
                            </>
                         )}
                    </div>
                    
                    {activeModal && <div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={()=>setActiveModal(null)}></div><div className="modal-animate relative bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden"><div className="p-5 border-b border-slate-100 flex items-center justify-between bg-white z-10"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">{activeModal === 'today' && <Icon name="flame" className="w-6 h-6 text-red-500" />}{activeModal === 'tomorrow' && <Icon name="sun" className="w-6 h-6 text-orange-500" />}{activeModal === 'future' && <Icon name="calendar-range" className="w-6 h-6 text-sky-500" />}{activeModal === 'revision' && <Icon name="brain-circuit" className="w-6 h-6 text-purple-500" />}{getModalTitle()}</h3><button onClick={() => setActiveModal(null)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"><Icon name="x" className="w-5 h-5 text-slate-500" /></button></div><div className="p-4 overflow-y-auto space-y-3 bg-slate-50 flex-1">{getModalItems().length === 0 ? (<div className="text-center py-10 text-slate-400">æš«æ™‚æ²’æœ‰ç›¸é—œé …ç›®</div>) : (getModalItems().map((item, i) => renderItemCard(item, i)))}</div></div></div>}
                    <AuthModal isOpen={isAuthModalOpen} onClose={()=>setIsAuthModalOpen(false)} triggerAlert={triggerAlert} />
                    {showNameSetup && <NameSetupModal onSave={handleNameSetupSave} loading={nameSetupLoading} triggerAlert={triggerAlert}/>}
                    {editingItem && <EditModal item={editingItem} onClose={()=>setEditingItem(null)} onSave={handleUpdateItem} triggerAlert={triggerAlert}/>}
                    {notification.isOpen && <div className="fixed inset-0 z-[300] flex items-center justify-center p-4"><div className="absolute inset-0 bg-black/30 backdrop-blur-sm"></div><div className="notification-animate bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center relative z-10"><div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${notification.type==='confirm'?'bg-red-100 text-red-500':'bg-indigo-100 text-indigo-500'}`}><Icon name={notification.type==='confirm'?'alert-triangle':'info'} className="w-6 h-6"/></div><h3 className="text-lg font-bold text-slate-800 mb-2">{notification.type==='confirm'?'ç¢ºèªæ“ä½œ':'æç¤º'}</h3><p className="text-slate-600 mb-6 leading-relaxed">{notification.message}</p><div className="flex gap-3 justify-center">{notification.type==='confirm'?(<><button onClick={()=>setNotification({isOpen:false})} className="flex-1 py-2.5 px-4 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">å–æ¶ˆ</button><button onClick={handleNotificationConfirm} className="flex-1 py-2.5 px-4 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition-all active:scale-95">ç¢ºèª</button></>):<button onClick={()=>setNotification({isOpen:false})} className="w-full py-2.5 px-4 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95">çŸ¥é“äº†</button>}</div></div></div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>