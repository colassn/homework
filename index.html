<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å­æ‰‹å†Š | å­¸ç”Ÿç«¯</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; }
        input[type="file"]::file-selector-button { display: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 70% { transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        
        /* Advanced Mesh Gradient Animation */
        @keyframes meshFlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
        @keyframes float { 
            0% { transform: translateY(0px); } 
            50% { transform: translateY(-15px); } 
            100% { transform: translateY(0px); } 
        }

        .mesh-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: meshFlow 15s ease infinite;
        }

        .mesh-bg-soft {
            background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            background-size: 200% 200%;
            animation: meshFlow 10s ease infinite;
        }

        .animate-float { animation: float 6s ease-in-out infinite; }
        .modal-animate { animation: popIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .page-enter { animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        
        /* Glassmorphism */
        .glass-card { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-slate-50 overflow-x-hidden">
    <div id="root"></div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyB3gYuwnyoTUwO7PFh4Nuue-Ud8GTruuRk",
            authDomain: "recordhwv2.firebaseapp.com",
            projectId: "recordhwv2",
            storageBucket: "recordhwv2.firebasestorage.app",
            messagingSenderId: "599261009391",
            appId: "1:599261009391:web:66cd7f932650bebc0e521a",
            measurementId: "G-C51XDYW67W"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, setDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const app = initializeApp(firebaseConfig);
            window.fb = { 
                auth: getAuth(app), 
                db: getFirestore(app), 
                provider: new GoogleAuthProvider(), 
                signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, 
                collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, setDoc, arrayUnion, arrayRemove, serverTimestamp,
                isReady: true 
            };
            window.dispatchEvent(new Event('fb-ready'));
            console.log("Firebase initialized");
        } catch (e) {
            console.error(e);
            document.body.innerHTML = `<div style="padding:20px;text-align:center;color:red;">é€£ç·šå¤±æ•—: ${e.message}</div>`;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // [CONSTANTS]
        const SUBJECTS = [{ name: 'ä¸­æ–‡', color: 'bg-red-100 text-red-700 border-red-200', category: 'ä¸»ç§‘' }, { name: 'è‹±æ–‡', color: 'bg-blue-100 text-blue-700 border-blue-200', category: 'ä¸»ç§‘' }, { name: 'æ•¸å­¸', color: 'bg-green-100 text-green-700 border-green-200', category: 'ä¸»ç§‘' }, { name: 'å¸¸è­˜/å…¬ç¤¾', color: 'bg-orange-100 text-orange-700 border-orange-200', category: 'ä¸»ç§‘' }, { name: 'ç‰©ç†', color: 'bg-cyan-100 text-cyan-700 border-cyan-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'åŒ–å­¸', color: 'bg-purple-100 text-purple-700 border-purple-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ç”Ÿç‰©', color: 'bg-emerald-100 text-emerald-700 border-emerald-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ä¸­å²', color: 'bg-amber-100 text-amber-800 border-amber-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'æ­·å²', color: 'bg-stone-100 text-stone-700 border-stone-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'åœ°ç†', color: 'bg-teal-100 text-teal-700 border-teal-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ç¶“æ¿Ÿ', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ä¼æœƒè²¡', color: 'bg-lime-100 text-lime-700 border-lime-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'è³‡è¨Šç§‘æŠ€', color: 'bg-indigo-100 text-indigo-700 border-indigo-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ä½›å­¸/å®—æ•™', color: 'bg-yellow-50 text-yellow-600 border-yellow-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'æ™®é€šè©±', color: 'bg-pink-100 text-pink-700 border-pink-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'è¦–è—', color: 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'éŸ³æ¨‚', color: 'bg-sky-100 text-sky-700 border-sky-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'é«”è‚²', color: 'bg-lime-50 text-lime-600 border-lime-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'è¨­è¨ˆèˆ‡ç§‘æŠ€', color: 'bg-zinc-100 text-zinc-700 border-zinc-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'å®¶æ”¿', color: 'bg-rose-100 text-rose-700 border-rose-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'æ–‡å­¸', color: 'bg-violet-100 text-violet-700 border-violet-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'STEAM', color: 'bg-violet-50 text-violet-600 border-violet-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'å…¨æ–¹ä½', color: 'bg-rose-50 text-rose-600 border-rose-100', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'å…¶ä»–', color: 'bg-gray-100 text-gray-700 border-gray-200', category: 'å‰¯ç§‘/å…¶ä»–' }, { name: 'ç©ºå ‚', color: 'bg-slate-100 text-slate-500 border-slate-200', category: 'å‰¯ç§‘/å…¶ä»–' }];
        const COLOR_PRESETS = [{ label: 'ç´…', value: 'bg-red-100 text-red-700 border-red-200' }, { label: 'æ©™', value: 'bg-orange-100 text-orange-700 border-orange-200' }, { label: 'é»ƒ', value: 'bg-yellow-100 text-yellow-700 border-yellow-200' }, { label: 'ç¶ ', value: 'bg-green-100 text-green-700 border-green-200' }, { label: 'è—', value: 'bg-blue-100 text-blue-700 border-blue-200' }, { label: 'ç´«', value: 'bg-purple-100 text-purple-700 border-purple-200' }, { label: 'ç²‰', value: 'bg-pink-100 text-pink-700 border-pink-200' }, { label: 'ç°', value: 'bg-gray-100 text-gray-700 border-gray-200' }, { label: 'é’', value: 'bg-cyan-100 text-cyan-700 border-cyan-200' }, { label: 'çŸ³', value: 'bg-stone-100 text-stone-700 border-stone-200' }];
        const DEFAULT_SCHEDULE = { 1: ["æ™®é€šé›»è…¦", "æ™®é€šé›»è…¦", "è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "æ™®é€šè©±", "ä½›å­¸", "æ­·å²", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ"], 2: ["è‹±æ–‡", "è‹±æ–‡", "éŸ³æ¨‚", "åœ°ç†", "ç‰©ç†", "ç‰©ç†", "ä¸­æ–‡", "ä¸­æ–‡", "æ•¸å­¸", "æ•¸å­¸"], 3: ["åŒ–å­¸", "åŒ–å­¸", "è‹±æ–‡", "è‹±æ–‡", "æ•¸å­¸", "ä¸­æ–‡", "è¦–è—", "è¦–è—", "å…¬æ°‘ç¶“æ¿Ÿèˆ‡ç¤¾æœƒ", "ä¸­å²"], 4: ["STEAM", "STEAM", "æ•¸å­¸", "æ­·å²", "è‹±æ–‡", "è‹±æ–‡", "ç”Ÿç‰©", "ç”Ÿç‰©", "ä¸­å²", "åœ°ç†"], 5: ["è‹±æ–‡", "è‹±æ–‡", "ä¸­æ–‡", "ä¸­æ–‡", "é«”è‚²", "é«”è‚²", "æ•¸å­¸", "æ•¸å­¸", "å…¨æ–¹ä½", "å…¨æ–¹ä½"] };
        const DEFAULT_START_TIMES = [510, 545, 595, 630, 675, 710, 815, 850, 895, 930]; 
        const DEFAULT_DURATIONS = [35, 35, 35, 35, 35, 35, 35, 35, 35, 35];
        const ADMIN_EMAIL = 'chimhinhin@gmail.com';

        // --- Helpers ---
        function Icon({name, className}) {
            const ref = useRef(null);
            useEffect(() => {
                if(window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if(className) i.className = className;
                    ref.current.appendChild(i);
                    window.lucide.createIcons({root:ref.current});
                }
            }, [name, className]);
            return <span ref={ref} style={{display:'inline-flex', alignItems:'center', justifyContent:'center'}}></span>;
        }

        const normalizeDate = (d) => { const n = d ? new Date(d) : new Date(); n.setHours(0,0,0,0); return n; };
        const getDaysRemaining = (dateString) => { const today = normalizeDate(); const due = normalizeDate(dateString); return Math.ceil((due - today) / (1000 * 60 * 60 * 24)); };
        const minutesToTimeStr = (m) => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
        const timeStrToMinutes = (s) => { const [h,m] = s.split(':').map(Number); return h*60+m; };
        const compressImage = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const MAX_WIDTH = 1024; const scale = MAX_WIDTH / img.width; if(scale < 1) { canvas.width = MAX_WIDTH; canvas.height = img.height * scale; } else { canvas.width = img.width; canvas.height = img.height; } const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; img.onerror = reject; }; reader.onerror = reject; });

        // --- COMPONENTS ---

        function LiveLessonCard({ schedule, times, durations, currentDay, user }) {
            const [now, setNow] = useState(new Date());
            useEffect(() => { const t = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(t); }, []);
            
            const daySubjects = schedule[currentDay] || [];
            const curMin = now.getHours() * 60 + now.getMinutes();
            let status = "æ”¾å­¸å•¦ / ä¼‘æ¯ä¸­", subStatus = "", nextInfo = "æ²’æœ‰ä¸‹ä¸€ç¯€", icon = "moon", bg = "from-slate-700 to-slate-900";

            if (currentDay === 0 || currentDay === 6) {
                status = "æ”¾å‡å•¦ï¼"; subStatus = "å¥½å¥½ä¼‘æ¯ï¼Œäº«å—é€±æœ« ğŸ–ï¸"; nextInfo = "ä¸‹é€±è¦‹"; icon = "coffee"; bg = "from-teal-400 to-emerald-500";
            } else {
                const getEnd = (i) => times[i] + (durations[i]||35);
                if (times.length > 0 && curMin < times[0]) {
                    status = "æ—©æ™¨ï¼æœªä¸Šå ‚"; const diff = times[0] - curMin; subStatus = `è·é›¢ç¬¬ä¸€å ‚ä»²æœ‰ ${Math.floor(diff/60)}å°æ™‚ ${diff%60}åˆ†é˜`; nextInfo = `ç¬¬ä¸€å ‚: ${daySubjects[0]||'æœªçŸ¥'}`; icon = "sun"; bg = "from-orange-400 to-red-500";
                } else if (times.length > 0) {
                    let found = false;
                    for(let i=0; i<10; i++) {
                        const start = times[i]; const end = getEnd(i);
                        if(curMin >= start && curMin < end) {
                            const left = end - curMin; status = `ä¸Šç·Š: ${daySubjects[i]||'ç©ºå ‚'}`; subStatus = `ä»²æœ‰ ${left} åˆ†é˜è½å ‚`;
                            if(i===1||i===3||i===7) nextInfo="ä¸‹ä¸€ç¯€: å°æ¯"; else if(i===5) nextInfo="ä¸‹ä¸€ç¯€: åˆè†³"; else if(i===9) nextInfo="ä¹‹å¾Œæ”¾å­¸"; else nextInfo=`ä¸‹ä¸€ç¯€: ${daySubjects[i+1]}`;
                            icon = "book-open"; bg = "from-indigo-500 to-purple-600"; found = true; break;
                        }
                        if(i<9) {
                            const nextStart = times[i+1];
                            if(curMin >= end && curMin < nextStart) {
                                const left = nextStart - curMin; let gapName = (i===5) ? "åˆè†³æ™‚é–“" : "å°æ¯";
                                status = `${gapName}ä¸­`; subStatus = `ä»²æœ‰ ${left} åˆ†é˜ä¸Šå ‚`; nextInfo = `ä¸‹ä¸€ç¯€: ${daySubjects[i+1]}`;
                                icon = (i===5) ? "utensils" : "coffee"; bg = (i===5) ? "from-emerald-400 to-teal-600" : "from-amber-400 to-orange-500"; found = true; break;
                            }
                        }
                    }
                    if(!found && curMin >= getEnd(9)) { status = "æ”¾å­¸å•¦ï¼"; subStatus = "å¥½å¥½ä¼‘æ¯"; nextInfo="æ˜å¤©è¦‹"; icon="moon"; bg="from-slate-600 to-slate-800"; }
                }
            }
            let dayDisplay = currentDay === 0 ? "æ˜ŸæœŸæ—¥" : currentDay === 6 ? "æ˜ŸæœŸå…­" : `Day ${currentDay}`;
            const dateStr = now.toLocaleDateString('zh-HK', { month: 'long', day: 'numeric', weekday: 'long' });

            return (
                <div className={`relative overflow-hidden rounded-3xl p-6 text-white shadow-xl bg-gradient-to-r ${bg} mb-6 gradient-bg transition-all duration-500`}>
                    <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name={icon} className="w-32 h-32" /></div>
                    <div className="relative z-10">
                        <div className="flex justify-between items-start mb-4">
                            <div><div className="text-xs opacity-80 mb-1 flex items-center gap-1"><Icon name="user" className="w-3 h-3"/> {user?.displayName||'åŒå­¸'}</div><h2 className="text-2xl font-black">{status}</h2><p className="text-lg font-bold opacity-90 mt-1">{subStatus}</p></div>
                            <div className="text-right"><div className="text-2xl font-black font-mono">{now.toLocaleTimeString('zh-HK',{hour:'2-digit',minute:'2-digit'})}</div><div className="text-xs font-bold opacity-80 mt-1">{dateStr}</div><div className="mt-2 inline-block bg-white/20 px-3 py-1 rounded-full text-xs font-bold border border-white/30">{dayDisplay}</div></div>
                        </div>
                        <div className="inline-flex items-center gap-2 bg-black/20 px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-sm border border-white/10"><Icon name="arrow-right-circle" className="w-4 h-4"/> {nextInfo}</div>
                    </div>
                </div>
            );
        }

        function BlockScreen({ type, estimatedTime, customConfig, onLogin, user, triggerAlert }) {
            const [showRequest, setShowRequest] = useState(false);
            const [email, setEmail] = useState(''); const [name, setName] = useState(''); const [submitting, setSubmitting] = useState(false);
            const { db, setDoc, doc } = window.firebaseServices || {};
            useEffect(() => { if(user) { setEmail(user.email||''); setName(user.displayName||''); } }, [user]);

            const title = customConfig?.customBlockTitle || (type === 'access_denied' ? "å­˜å–æ¬Šé™å—é™" : "ç¶²ç«™ç¶­è­·ä¸­");
            const msg = customConfig?.customBlockMessage || (type === 'access_denied' ? "æœ¬ç¶²ç«™åƒ…é–‹æ”¾ç™½åå–®ç”¨æˆ¶ã€‚\nå¦‚éœ€é–‹é€šï¼Œè«‹æäº¤ç”³è«‹ã€‚" : "ç³»çµ±å‡ç´šä¸­ï¼Œè«‹ç¨å¾Œã€‚");

            const handleReq = async (e) => {
                e.preventDefault(); if(!user) { onLogin(); return; }
                setSubmitting(true);
                try {
                    await setDoc(doc(db, "access_requests", user.uid), { email, displayName: name, status: 'pending', requestTime: new Date().toISOString(), uid: user.uid });
                    triggerAlert("ç”³è«‹å·²é€å‡ºï¼è«‹ç­‰å¾…æ‰¹æ ¸ã€‚"); setShowRequest(false);
                } catch(e) { console.error(e); triggerAlert("ç”³è«‹å¤±æ•—: " + e.message); } finally { setSubmitting(false); }
            };

            return (
                <div className="fixed inset-0 z-40 flex flex-col items-center justify-center bg-slate-50 p-6 text-center">
                    <div className="bg-white/90 backdrop-blur-xl p-8 rounded-3xl shadow-xl max-w-md w-full relative z-10 modal-animate">
                        <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name={type==='access_denied'?'lock':'hammer'} className="w-8 h-8 text-slate-500"/></div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">{title}</h2>
                        <p className="text-slate-500 font-medium mb-6 whitespace-pre-wrap">{msg}</p>
                        {type === 'access_denied' && (
                            !showRequest ? <button onClick={()=>setShowRequest(true)} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">ç”³è«‹è¨ªå•æ¬Šé™</button> 
                            : <form onSubmit={handleReq} className="text-left space-y-3"><input value={name} onChange={e=>setName(e.target.value)} className="w-full p-2 border rounded" placeholder="åå­—" required /><input value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-2 border rounded" placeholder="Email" required /><button disabled={submitting} className="w-full py-2 bg-indigo-600 text-white rounded font-bold">{submitting?'é€å‡ºä¸­...':'ç¢ºèªç”³è«‹'}</button></form>
                        )}
                        {!user && <button onClick={onLogin} className="mt-4 w-full py-3 border rounded-xl font-bold text-slate-600">ç™»å…¥</button>}
                        {user && <div className="mt-4 text-xs text-slate-400">å¸³è™Ÿ: {user.email} <button onClick={()=>window.firebaseServices.signOut(window.firebaseServices.auth)} className="underline ml-2">ç™»å‡º</button></div>}
                    </div>
                </div>
            );
        }

        function AuthModal({ onClose, onLogin, onEmailLogin }) {
            const [email, setEmail] = useState('');
            const [pwd, setPwd] = useState('');
            const [isReg, setIsReg] = useState(false);
            const [name, setName] = useState('');

            const handleSubmit = (e) => { e.preventDefault(); onEmailLogin(email, pwd, isReg, name); };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="glass-card p-8 rounded-3xl w-full max-w-sm relative z-10 modal-animate">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100"><Icon name="x" className="w-5 h-5 text-slate-400"/></button>
                        <h2 className="text-2xl font-black text-center mb-6 text-slate-800">{isReg ? 'è¨»å†Šå¸³è™Ÿ' : 'æ­¡è¿å›ä¾†'}</h2>
                        
                        <button onClick={onLogin} className="w-full py-3.5 bg-white border border-slate-200 rounded-2xl font-bold text-slate-600 flex items-center justify-center gap-3 hover:bg-slate-50 transition mb-6 shadow-sm active:scale-95 group">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5 group-hover:scale-110 transition-transform" />
                            ä½¿ç”¨ Google ç™»å…¥
                        </button>
                        
                        <div className="relative mb-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-xs bg-white/0 px-2 text-slate-400"><span className="bg-white/80 px-2">æˆ–ä½¿ç”¨ Email</span></div></div>
                        
                        <form onSubmit={handleSubmit} className="space-y-3">
                            {isReg && <input type="text" placeholder="ä½ çš„åå­— (ä¾‹å¦‚: Peter)" className="w-full p-3.5 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 border border-transparent focus:bg-white transition" value={name} onChange={e=>setName(e.target.value)} required />}
                            <input type="email" placeholder="é›»å­éƒµä»¶" className="w-full p-3.5 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 border border-transparent focus:bg-white transition" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input type="password" placeholder="å¯†ç¢¼" className="w-full p-3.5 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 border border-transparent focus:bg-white transition" value={pwd} onChange={e=>setPwd(e.target.value)} required />
                            <button className="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition shadow-lg shadow-indigo-200 active:scale-95 mt-2">{isReg ? 'è¨»å†Šå¸³è™Ÿ' : 'ç«‹å³ç™»å…¥'}</button>
                        </form>
                        
                        <div className="mt-6 text-center text-xs text-slate-400">
                            {isReg ? 'å·²æœ‰å¸³è™Ÿï¼Ÿ' : 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ'} 
                            <button onClick={()=>setIsReg(!isReg)} className="text-indigo-600 font-bold hover:underline ml-1">{isReg ? 'ç›´æ¥ç™»å…¥' : 'å…è²»è¨»å†Š'}</button>
                        </div>
                    </div>
                </div>
            );
        }

        function Timetable({ currentDay, subjects, timeConfig, durations, onDayChange, isEditing, manualDay, setManualDay }) {
            const isWeekend = !isEditing && (manualDay === 0 || manualDay === 6);
            
            const renderSchedule = () => {
                const list = [];
                if(timeConfig && subjects[currentDay]) {
                    for(let i=0; i<timeConfig.length; i++) {
                        list.push({ time: minutesToTimeStr(timeConfig[i]), subject: subjects[currentDay][i] || 'ç©ºå ‚' });
                        if(i===1 || i===3 || i===5 || i===7) list.push({ type: 'break', name: i===5?'åˆè†³':'å°æ¯' });
                    }
                }
                return list;
            };
            const list = renderSchedule();

            return (
                <div className="space-y-4 page-enter">
                    <div className="flex justify-between items-center bg-white rounded-xl p-3 shadow-sm border border-slate-100">
                        <div className="relative w-full">
                            <select value={manualDay} onChange={(e)=>setManualDay(parseInt(e.target.value))} className="w-full p-2 bg-indigo-50 text-indigo-700 rounded-lg font-bold outline-none text-sm appearance-none cursor-pointer">
                                <option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option><option value="4">Day 4</option><option value="5">Day 5</option>
                                <option disabled>---</option><option value="6">æ˜ŸæœŸå…­ (ä¼‘æ¯)</option><option value="0">æ˜ŸæœŸæ—¥ (ä¼‘æ¯)</option>
                            </select>
                            <div className="absolute right-3 top-2.5 text-indigo-400 pointer-events-none"><Icon name="chevron-down" className="w-4 h-4"/></div>
                        </div>
                    </div>
                    {isWeekend ? (
                        <div className="bg-white rounded-2xl border border-slate-100 p-10 text-center min-h-[300px] flex flex-col items-center justify-center animate-fade-in">
                            <div className="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-4 text-green-500"><Icon name="coffee" className="w-10 h-10" /></div>
                            <h3 className="text-xl font-black text-slate-700">é€±æœ«æ„‰å¿«ï¼</h3>
                            <p className="text-slate-400 font-bold mt-2 text-sm">ä»Šå¤©æ²’æœ‰èª²å ‚ï¼Œå¥½å¥½ä¼‘æ¯å§</p>
                        </div>
                    ) : (
                        <div className="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm animate-fade-in">
                            {list.length > 0 ? list.map((item, i) => (
                                <div key={i} className={`flex items-center gap-4 py-3 border-b border-slate-50 last:border-0 ${item.type==='break'?'bg-slate-50/50 -mx-4 px-4 py-2':''}`}>
                                    {item.type !== 'break' ? (
                                        <>
                                            <div className="w-12 text-xs font-mono font-bold text-slate-400 text-right">{item.time}</div>
                                            <div className="w-2 h-2 rounded-full bg-indigo-400"></div>
                                            <div className="font-bold text-slate-700 text-sm">{item.subject}</div>
                                        </>
                                    ) : (
                                        <div className="w-full text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">{item.name}</div>
                                    )}
                                </div>
                            )) : <div className="text-center py-10 text-slate-400">æš«ç„¡èª²å ‚è³‡æ–™</div>}
                        </div>
                    )}
                </div>
            );
        }

        function UserSettings({ subjects, onSave, onBack }) {
            const [list, setList] = useState(subjects || []);
            const [newName, setNewName] = useState('');
            const [newColor, setNewColor] = useState(COLOR_PRESETS[0].value);

            const handleAdd = () => { if(!newName.trim()) return; setList([...list, { name: newName, color: newColor, category: 'è‡ªè¨‚' }]); setNewName(''); };

            return (
                <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 min-h-[500px] page-enter">
                    <div className="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                        <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full transition active:scale-95"><Icon name="arrow-left" className="w-5 h-5"/></button>
                        <h2 className="text-xl font-bold text-slate-800">ç§‘ç›®è¨­å®š</h2>
                    </div>
                    <div className="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h4 className="text-xs font-bold text-slate-500 mb-2">æ–°å¢ç§‘ç›®</h4>
                        <div className="flex gap-2 mb-3">
                            <input value={newName} onChange={e=>setNewName(e.target.value)} className="flex-1 p-2 rounded-lg border border-slate-300 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹å¦‚: æ—¥æ–‡" />
                            <button onClick={handleAdd} className="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-md active:scale-95">æ–°å¢</button>
                        </div>
                        <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                            {COLOR_PRESETS.map((c,i) => (<button key={i} onClick={()=>setNewColor(c.value)} className={`w-6 h-6 rounded-full border-2 shrink-0 ${c.value.split(' ')[0]} ${newColor===c.value ? 'ring-2 ring-indigo-400 border-white' : 'border-transparent'}`}></button>))}
                        </div>
                    </div>
                    <div className="space-y-2 max-h-[300px] overflow-y-auto pr-1">
                        {list.map((s, i) => (
                            <div key={i} className="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl">
                                <div className="flex items-center gap-3"><div className={`w-3 h-3 rounded-full ${s.color?.split(' ')[0] || 'bg-gray-400'}`}></div><span className="text-sm font-bold text-slate-700">{s.name}</span></div>
                                <button onClick={()=>{const n=[...list];n.splice(i,1);setList(n)}} className="text-slate-300 hover:text-red-500 transition"><Icon name="trash-2" className="w-4 h-4"/></button>
                            </div>
                        ))}
                    </div>
                    <button onClick={()=>onSave(list)} className="w-full mt-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition">å„²å­˜è¨­å®š</button>
                </div>
            );
        }

        // --- CUSTOM UI HELPERS ---
        function CustomDropdown({ value, onChange, options }) { const [isOpen, setIsOpen] = useState(false); const ref = useRef(null); useEffect(() => { const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); }; document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, []); const label = options.find(o => o.value === value)?.label || 'æ’åº'; return ( <div className="relative" ref={ref}> <button type="button" onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 bg-white border border-slate-200 text-slate-600 text-xs rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-100 font-bold hover:bg-slate-50 transition-all shadow-sm active:scale-95 min-w-[100px] justify-between"> <span>{label}</span> <Icon name="chevron-down" className={`w-3 h-3 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} /> </button> {isOpen && ( <div className="absolute right-0 mt-2 w-48 bg-white/95 backdrop-blur-xl rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden animate-in fade-in zoom-in-95 duration-200 origin-top-right">{options.map((opt, idx) => ( <button key={idx} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`w-full text-left px-4 py-3 text-xs font-bold flex items-center gap-2 transition-colors ${value === opt.value ? 'bg-indigo-50 text-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}> {opt.label} </button> ))} </div> )} </div> ); }

        function SubjectFilterDropdown({ currentFilter, onSelect, subjects }) { const [isOpen, setIsOpen] = useState(false); const ref = useRef(null); useEffect(() => { const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); }; document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, []); return ( <div className="relative" ref={ref}> <button onClick={() => setIsOpen(!isOpen)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold border transition-all min-w-[100px] justify-between ${currentFilter !== 'å…¨éƒ¨' ? 'bg-indigo-50 text-indigo-600 border-indigo-200' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}> <div className="flex items-center gap-2"><Icon name="filter" className="w-3.5 h-3.5" /> {currentFilter === 'å…¨éƒ¨' ? 'ç¯©é¸ç§‘ç›®' : currentFilter}</div> <Icon name="chevron-down" className="w-3 h-3" /> </button> {isOpen && ( <div className="absolute left-0 mt-2 w-48 bg-white/95 backdrop-blur-xl rounded-xl shadow-xl border border-slate-100 z-50 max-h-64 overflow-y-auto animate-in fade-in zoom-in-95"> <button onClick={() => {onSelect('å…¨éƒ¨'); setIsOpen(false);}} className="w-full text-left px-4 py-3 text-xs font-bold text-slate-700 hover:bg-slate-50 border-b border-slate-50">å…¨éƒ¨</button> {subjects.map((sub, idx) => ( <button key={idx} onClick={() => {onSelect(sub.name); setIsOpen(false);}} className={`w-full text-left px-4 py-2.5 text-xs font-bold hover:bg-indigo-50 transition-colors ${currentFilter === sub.name ? 'text-indigo-600 bg-indigo-50' : 'text-slate-600'}`}>{sub.name}</button> ))} </div> )} </div> ); }


        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');
            const [items, setItems] = useState([]);
            const [config, setConfig] = useState(null);
            const [authModalOpen, setAuthModalOpen] = useState(false);
            
            // Timetable
            const [manualDay, setManualDay] = useState(new Date().getDay());
            const [schedule, setSchedule] = useState(DEFAULT_SCHEDULE);
            const [subjects, setSubjects] = useState(SUBJECTS);

            // Inputs & Filters
            const [desc, setDesc] = useState('');
            const [date, setDate] = useState('');
            const [sub, setSub] = useState('ä¸­æ–‡');
            const [filterSubject, setFilterSubject] = useState('å…¨éƒ¨');
            const [sortOption, setSortOption] = useState('date_asc');

            // --- Init ---
            useEffect(() => {
                const init = () => {
                    if(window.fb && window.fb.isReady) {
                        const { auth, db, onAuthStateChanged, doc, onSnapshot } = window.fb;
                        onAuthStateChanged(auth, u => { setUser(u); setLoading(false); if(u) setDate(new Date().toISOString().split('T')[0]); });
                        onSnapshot(doc(db, "system_settings", "config"), s => setConfig(s.data()));
                    } else { setTimeout(init, 100); }
                };
                init();
            }, []);

            // --- Data Listeners ---
            useEffect(() => {
                if(!user || !window.fb) return;
                const { db, collection, doc, onSnapshot, query, orderBy, where, getDocs, addDoc } = window.fb;

                const unsubItems = onSnapshot(query(collection(db, "users", user.uid, "items")), s => {
                    setItems(s.docs.map(d => ({id:d.id, ...d.data()})));
                });

                const unsubSettings = onSnapshot(doc(db, "users", user.uid, "settings", "timetable"), s => {
                    if(s.exists()) setSchedule(s.data().schedule);
                });

                const unsubSubj = onSnapshot(doc(db, "users", user.uid, "settings", "subjects"), s => {
                    if(s.exists() && s.data().list) setSubjects(s.data().list);
                });

                const qPublic = query(collection(db, "public_assignments"), orderBy("createdAt", "desc"));
                const unsubPublic = onSnapshot(qPublic, snapshot => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const publicId = change.doc.id;
                            const qCheck = query(collection(db, "users", user.uid, "items"), where("publicRefId", "==", publicId));
                            const checkSnap = await getDocs(qCheck);
                            if(checkSnap.empty) {
                                await addDoc(collection(db, "users", user.uid, "items"), { ...change.doc.data(), publicRefId: publicId, completed: false });
                                alert(`ğŸ“¢ æ–°åŠŸèª²: ${change.doc.data().subject}`);
                            }
                        }
                    });
                });

                return () => { unsubItems(); unsubSettings(); unsubSubj(); unsubPublic(); }
            }, [user]);

            // --- Handlers ---
            const handleGoogleLogin = () => window.fb.signInWithPopup(window.fb.auth, window.fb.provider).then(()=>setAuthModalOpen(false)).catch(e=>alert(e.message));
            
            const handleEmailAuth = async (email, pwd, isReg, name) => {
                const { auth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, db, doc, setDoc, serverTimestamp } = window.fb;
                try {
                    if(isReg) {
                        const cred = await createUserWithEmailAndPassword(auth, email, pwd);
                        await updateProfile(cred.user, { displayName: name });
                        await setDoc(doc(db, "users_public", cred.user.uid), { email: email, displayName: name, lastSeen: serverTimestamp() }, { merge: true });
                    } else {
                        await signInWithEmailAndPassword(auth, email, pwd);
                    }
                    setAuthModalOpen(false);
                } catch(e) { alert("æ“ä½œå¤±æ•—: " + e.message); }
            };

            const handleAddHomework = async (e) => {
                e.preventDefault();
                if(!desc || !date) return;
                const { db, addDoc, collection } = window.fb;
                await addDoc(collection(db, "users", user.uid, "items"), {
                    description: desc, subject: sub, dueDate: date, completed: false, type: 'homework', createdAt: new Date().toISOString()
                });
                setDesc(''); alert("å·²æ–°å¢");
            };

            const toggleItem = async (item) => {
                const { db, doc, updateDoc } = window.fb;
                await updateDoc(doc(db, "users", user.uid, "items", item.id), { completed: !item.completed });
            };
            
            const deleteItem = async (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤?")) {
                    const { db, doc, deleteDoc } = window.fb;
                    await deleteDoc(doc(db, "users", user.uid, "items", id));
                }
            };

            const saveSubjects = async (newList) => {
                const { db, doc, setDoc } = window.fb;
                await setDoc(doc(db, "users", user.uid, "settings", "subjects"), { list: newList }, { merge: true });
                setSubjects(newList); setView('home');
            };

            // --- Filter & Sort Logic ---
            const activeItems = items.filter(i => !i.completed);
            const finishedItems = items.filter(i => i.completed);
            
            const getFilteredItems = () => {
                let filtered = [...activeItems];
                if(filterSubject !== 'å…¨éƒ¨') filtered = filtered.filter(i => i.subject === filterSubject);
                
                if(sortOption === 'date_asc') filtered.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                else if(sortOption === 'date_desc') filtered.sort((a,b) => new Date(b.dueDate) - new Date(a.dueDate));
                
                return filtered;
            };

            const todayCount = activeItems.filter(i => getDaysRemaining(i.dueDate) <= 0).length;
            const tomorrowCount = activeItems.filter(i => getDaysRemaining(i.dueDate) === 1).length;
            const futureCount = activeItems.filter(i => getDaysRemaining(i.dueDate) > 1).length;

            // --- Render ---
            if(loading) return <div className="h-screen flex items-center justify-center text-slate-400 font-bold">è¼‰å…¥ä¸­...</div>;

            if(user && config?.whitelistEnabled && !config?.allowedEmails?.includes(user.email)) {
                return <BlockScreen type="access_denied" user={user} onLogin={()=>{}} triggerAlert={alert} />;
            }

            if(!user) {
                // [NEW: High-End Login Page]
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden mesh-bg">
                         <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-500 rounded-full blur-[150px] opacity-30 animate-float"></div>
                         <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-purple-500 rounded-full blur-[150px] opacity-30 animate-float" style={{animationDelay:'-3s'}}></div>
                         
                         <div className="glass-card p-10 rounded-[2.5rem] w-full max-w-md text-center relative z-10 modal-animate border border-white/20 shadow-2xl">
                             <div className="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-xl rotate-6 text-white transform hover:rotate-12 transition duration-500 hover:scale-105">
                                 <Icon name="graduation-cap" className="w-12 h-12"/>
                             </div>
                             <h1 className="text-4xl font-black text-slate-800 mb-3 tracking-tight">é›»å­æ‰‹å†Š</h1>
                             <p className="text-slate-500 mb-10 font-medium text-lg">ä½ çš„æ™ºèƒ½å­¸ç¿’åŠ©æ‰‹</p>
                             
                             <button onClick={handleGoogleLogin} className="w-full py-4 bg-white border border-slate-100 rounded-2xl font-bold text-slate-700 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3 group">
                                 <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6 group-hover:scale-110 transition-transform"/> 
                                 <span className="text-base">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
                             </button>

                             <div className="mt-6">
                                <button onClick={()=>setAuthModalOpen(true)} className="text-sm font-bold text-slate-400 hover:text-indigo-600 transition">æˆ–ä½¿ç”¨ Email ç™»å…¥/è¨»å†Š</button>
                             </div>
                         </div>
                         {authModalOpen && <AuthModal onClose={()=>setAuthModalOpen(false)} onLogin={handleGoogleLogin} onEmailLogin={handleEmailAuth} triggerAlert={alert} />}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50/50 p-4 pb-28 md:pb-8 max-w-md mx-auto relative mesh-bg-soft">
                    <header className="flex justify-between items-center mb-6 py-2">
                        <div className="flex flex-col">
                            <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">Welcome back</span>
                            <h1 className="text-3xl font-black text-slate-800 tracking-tight">{user.displayName}</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setView(view==='settings'?'home':'settings')} className="p-3 bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-white/50 text-slate-600 hover:text-indigo-600 transition hover:scale-105 active:scale-95"><Icon name="settings" className="w-5 h-5"/></button>
                            <button onClick={()=>window.fb.signOut(window.fb.auth)} className="p-3 bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-white/50 text-slate-400 hover:text-red-500 transition hover:scale-105 active:scale-95"><Icon name="log-out" className="w-5 h-5"/></button>
                        </div>
                    </header>

                    {view === 'timetable' ? (
                        <div className="glass-card bg-white/90 rounded-[2rem] p-6 shadow-xl min-h-[500px] page-enter">
                            <div className="flex items-center gap-4 mb-6">
                                <button onClick={()=>setView('home')} className="p-2 hover:bg-slate-100 rounded-full transition"><Icon name="arrow-left" className="w-6 h-6"/></button>
                                <h2 className="text-2xl font-black text-slate-800">å®Œæ•´æ™‚é–“è¡¨</h2>
                            </div>
                            <Timetable currentDay={manualDay} subjects={schedule} timeConfig={DEFAULT_START_TIMES} durations={DEFAULT_DURATIONS} manualDay={manualDay} setManualDay={setManualDay} />
                        </div>
                    ) : view === 'settings' ? (
                        <UserSettings subjects={subjects} onSave={saveSubjects} onBack={()=>setView('home')} />
                    ) : (
                        <div className="page-enter space-y-6">
                            <LiveLessonCard schedule={schedule} times={DEFAULT_START_TIMES} durations={DEFAULT_DURATIONS} currentDay={manualDay} user={user} />
                            
                            <div className="grid grid-cols-3 gap-3">
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center group hover:scale-[1.02] transition"><div className="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-500 mb-2 group-hover:bg-red-500 group-hover:text-white transition-colors"><Icon name="flame" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{todayCount}</div><div className="text-[10px] font-bold text-slate-400 uppercase">ä»Šæ—¥è¦äº¤</div></div>
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center group hover:scale-[1.02] transition"><div className="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 mb-2 group-hover:bg-orange-500 group-hover:text-white transition-colors"><Icon name="sun" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">{tomorrowCount}</div><div className="text-[10px] font-bold text-slate-400 uppercase">è½æ—¥è¦äº¤</div></div>
                                <div className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex flex-col items-center justify-center text-center group hover:scale-[1.02] transition"><div className="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 mb-2 group-hover:bg-indigo-500 group-hover:text-white transition-colors"><Icon name="brain-circuit" className="w-5 h-5"/></div><div className="text-2xl font-black text-slate-800">0</div><div className="text-[10px] font-bold text-slate-400 uppercase">æº«ç¿’è€ƒæ ¸</div></div>
                            </div>

                            <div className="glass-card bg-white/90 p-6 rounded-[2rem] shadow-xl relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-100 rounded-full blur-3xl opacity-50 -mr-10 -mt-10"></div>
                                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2 relative z-10"><Icon name="plus-circle" className="w-5 h-5 text-indigo-600"/> å¿«é€Ÿæ–°å¢</h3>
                                <form onSubmit={handleAddHomework} className="space-y-4 relative z-10">
                                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2">
                                        {subjects.map(s=><button key={s.name} type="button" onClick={()=>setSub(s.name)} className={`whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold border-2 transition ${sub===s.name ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-500 border-slate-100 hover:border-slate-300'}`}>{s.name}</button>)}
                                    </div>
                                    <div className="flex gap-3">
                                        <input value={desc} onChange={e=>setDesc(e.target.value)} className="flex-1 p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-100 focus:bg-white transition" placeholder="åŠŸèª²å…§å®¹..." required />
                                        <button className="w-14 h-14 bg-slate-900 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-black transition active:scale-95 shrink-0"><Icon name="arrow-up" className="w-6 h-6"/></button>
                                    </div>
                                    <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full p-3 bg-white border border-slate-100 rounded-xl text-xs font-bold text-slate-500 outline-none" required />
                                </form>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-4 px-2">
                                    <h3 className="font-bold text-slate-800 text-lg">å¾…è¾¦æ¸…å–®</h3>
                                    <div className="flex gap-2">
                                        <CustomDropdown value={sortOption} onChange={setSortOption} options={[{value:'date_asc', label:'æ—¥æœŸ (è¶•æ€¥)'}, {value:'date_desc', label:'æ—¥æœŸ (é•·é )'}]} />
                                        <SubjectFilterDropdown currentFilter={filterSubject} onSelect={setFilterSubject} subjects={subjects} />
                                    </div>
                                </div>

                                <div className="space-y-3 pb-4">
                                    {getFilteredItems().map((item, idx) => (
                                        <div key={item.id} className="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-white flex gap-4 items-start group list-item-enter hover:scale-[1.01] transition-transform duration-200" style={{animationDelay: `${idx*0.05}s`}}>
                                            <button onClick={()=>toggleItem(item)} className="mt-1 w-6 h-6 rounded-full border-2 border-slate-200 flex items-center justify-center hover:border-emerald-500 hover:bg-emerald-50 transition shrink-0 group/btn bg-white">
                                                <Icon name="check" className="w-3.5 h-3.5 text-emerald-500 opacity-0 group-hover/btn:opacity-100 transition"/>
                                            </button>
                                            <div className="flex-1">
                                                <div className="flex justify-between mb-1">
                                                    <span className="text-[10px] font-black bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md">{item.subject}</span>
                                                    <span className={`text-[10px] font-mono font-bold ${getDaysRemaining(item.dueDate)<0?'text-red-500':'text-slate-400'}`}>{item.dueDate}</span>
                                                </div>
                                                <p className="text-sm font-bold text-slate-700 leading-relaxed">{item.description}</p>
                                                {item.senderName && <div className="mt-2 text-[10px] text-slate-400 flex items-center gap-1 bg-slate-50 w-fit px-2 py-0.5 rounded-full"><Icon name="rss" className="w-3 h-3"/> {item.senderName}</div>}
                                            </div>
                                            <button onClick={()=>deleteItem(item.id)} className="text-slate-300 hover:text-red-400 transition opacity-0 group-hover:opacity-100"><Icon name="trash-2" className="w-4 h-4"/></button>
                                        </div>
                                    ))}
                                    {activeItems.length === 0 && <div className="text-center text-slate-400 py-12 flex flex-col items-center"><Icon name="coffee" className="w-12 h-12 mb-3 opacity-20"/>å¤ªæ£’äº†ï¼æš«æ™‚æ²’æœ‰åŠŸèª²</div>}
                                    
                                    {finishedItems.length > 0 && (
                                        <div className="mt-8 pt-8 border-t border-slate-200/50">
                                            <h3 className="font-bold text-slate-400 text-xs uppercase tracking-wider mb-4 px-2">å·²å®Œæˆ ({finishedItems.length})</h3>
                                            <div className="space-y-2 opacity-60 hover:opacity-100 transition duration-300">
                                                {finishedItems.map(item => (
                                                    <div key={item.id} className="bg-slate-50 p-3 rounded-xl flex gap-3 items-center mb-2 border border-transparent hover:border-slate-200 transition">
                                                        <div className="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white shrink-0"><Icon name="check" className="w-3 h-3"/></div>
                                                        <div className="flex-1 line-through text-slate-400 text-xs font-medium">{item.description}</div>
                                                        <button onClick={()=>deleteItem(item.id)} className="text-slate-300 hover:text-red-400"><Icon name="trash-2" className="w-3 h-3"/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modern Bottom Nav */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-xl text-white px-2 py-2 rounded-full shadow-2xl flex gap-2 z-40 border border-white/10 ring-1 ring-black/5">
                        <button onClick={()=>setView('home')} className={`p-3 rounded-full transition-all duration-300 ${view==='home'?'bg-white text-slate-900 scale-105 shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="layout-grid" className="w-5 h-5"/></button>
                        <button onClick={()=>setView('timetable')} className={`p-3 rounded-full transition-all duration-300 ${view==='timetable'?'bg-white text-slate-900 scale-105 shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="calendar" className="w-5 h-5"/></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>