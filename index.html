<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3B Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .loader { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-active { transform: scale(0.97); }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex flex-col overflow-hidden bg-slate-50">

    <!-- TOAST é€šçŸ¥ -->
    <div id="toast-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs pointer-events-none"></div>

    <!-- GLOBAL LOADING (é è¨­é¡¯ç¤º) -->
    <div id="global-loader" class="fixed inset-0 bg-white z-[99] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="loader mb-4"></div>
        <p class="text-xs font-bold text-slate-400 tracking-[0.2em]" id="loading-text">CONNECTING</p>
    </div>

    <!-- 1. LOGIN -->
    <div id="view-login" class="view-section hidden absolute inset-0 z-10 flex flex-col items-center justify-center p-6 bg-white">
        <div class="w-full max-w-sm text-center fade-in">
            <div class="w-20 h-20 bg-slate-900 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl shadow-slate-900/20">
                <i data-lucide="graduation-cap" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">3B Hub</h1>
            <p class="text-slate-400 font-medium mb-10">ç­ç´šå°ˆå±¬ä½œæ¥­å¹³å°</p>

            <button id="btn-google" class="w-full bg-white border-2 border-slate-100 hover:border-indigo-500 text-slate-700 font-bold py-4 rounded-2xl flex items-center justify-center gap-3 transition-all shadow-sm group active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition-transform">
                <span>Google ç™»å…¥</span>
            </button>

            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-100"></div></div>
                <div class="relative flex justify-center text-xs font-bold text-slate-300 bg-white px-4">OR</div>
            </div>

            <button id="btn-toggle-email" class="text-sm font-bold text-indigo-600 hover:text-indigo-700 transition-colors">ä½¿ç”¨é›»éƒµç™»å…¥</button>

            <form id="form-auth" class="hidden space-y-3 mt-6 text-left animate-fade-in-down">
                <div id="field-nickname" class="hidden">
                    <input type="text" id="input-nickname" placeholder="è‹±æ–‡çŸ­å (e.g. Justin)" class="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
                <input type="email" id="input-email" placeholder="é›»éƒµåœ°å€" class="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                <input type="password" id="input-password" placeholder="å¯†ç¢¼" class="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                <button type="submit" id="btn-submit-auth" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg mt-4 active:scale-95 transition-transform">ç™»å…¥</button>
                <div class="text-center mt-4">
                    <button type="button" id="btn-switch-mode" class="text-xs font-bold text-slate-400 hover:text-indigo-500">åˆ‡æ›è‡³è¨»å†Š</button>
                </div>
            </form>
        </div>
        <p class="absolute bottom-8 text-[10px] font-bold text-slate-300 tracking-widest">CLASS 3B â€¢ 2026</p>
    </div>

    <!-- 2. NICKNAME MODAL -->
    <div id="view-nickname" class="view-section hidden absolute inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/95 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 text-center slide-up shadow-2xl">
            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><i data-lucide="user-plus" class="w-8 h-8"></i></div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">å»ºç«‹æª”æ¡ˆ</h2>
            <p class="text-slate-500 text-sm mb-6">è«‹è¼¸å…¥æ‚¨çš„è‹±æ–‡çŸ­å (English Name)</p>
            <input type="text" id="modal-nick-input" placeholder="e.g. Mary" class="w-full p-4 rounded-2xl border-2 border-slate-100 text-center text-lg font-bold mb-4 focus:border-indigo-500 outline-none">
            <button id="btn-save-nick" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform">ç¢ºèª</button>
        </div>
    </div>

    <!-- 3. CONSENT -->
    <div id="view-consent" class="view-section hidden absolute inset-0 z-40 flex items-center justify-center p-6 bg-white">
        <div class="max-w-md w-full text-center slide-up">
            <div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-6"><i data-lucide="shield-check" class="w-8 h-8 text-slate-800"></i></div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">ä¿å¯†è²æ˜</h2>
            <p class="text-xs font-bold text-indigo-500 tracking-widest uppercase mb-8">Internal Use Only</p>
            <div class="bg-slate-50 p-6 rounded-3xl text-left text-sm text-slate-600 leading-relaxed font-medium mb-8">
                æœ¬å¹³å°åƒ…ä¾› <strong>3B ç­ç´š</strong> å…§éƒ¨ä½¿ç”¨ã€‚<br><br>ç‚ºä¿éšœåŒå­¸éš±ç§ï¼Œè«‹å‹¿å°‡å¸³è™Ÿå€Ÿäºˆä»–äººæˆ–å°‡å…§å®¹æˆªåœ–å¤–å‚³ã€‚
            </div>
            <button id="btn-agree" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-transform"><span>æˆ‘ç†è§£ä¸¦åŒæ„</span> <i data-lucide="arrow-right" class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- 4. DASHBOARD -->
    <div id="view-dashboard" class="view-section hidden flex-grow flex flex-col h-full bg-[#F8FAFC]">
        <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-30 px-6 py-4 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20 text-white"><i data-lucide="book-open" class="w-5 h-5"></i></div>
                <div><h1 class="font-bold text-lg text-slate-800 leading-none">3B Hub</h1><span id="nav-role" class="text-[10px] font-bold text-slate-400 tracking-wide uppercase">Student</span></div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block"><div id="user-name" class="text-sm font-bold text-slate-700">User</div></div>
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 border-2 border-white shadow-sm">U</div>
                <button id="btn-logout" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-red-500 hover:border-red-100 transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </nav>

        <div class="flex-grow overflow-y-auto p-6 pb-24">
            <div class="max-w-5xl mx-auto space-y-8">
                <!-- ADMIN -->
                <div id="panel-admin" class="hidden space-y-8 animate-fade-in">
                    <div class="p-1 bg-white rounded-2xl shadow-sm border border-slate-100 inline-flex w-full sm:w-auto">
                        <button onclick="window.setAdminTab('monitor')" id="tab-mon" class="flex-1 sm:flex-none px-6 py-3 rounded-xl text-sm font-bold transition-all bg-slate-900 text-white shadow-md">å…¨ç­ç‹€æ…‹</button>
                        <button onclick="window.setAdminTab('homework')" id="tab-hw" class="flex-1 sm:flex-none px-6 py-3 rounded-xl text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">ç®¡ç†åŠŸèª²</button>
                    </div>
                    <div id="view-monitor" class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-400 uppercase text-xs tracking-wider"><tr><th class="p-6 font-bold">å­¸ç”Ÿ</th><th class="p-6 font-bold">ä¸Šç·š</th><th class="p-6 font-bold">é€²åº¦</th><th class="p-6"></th></tr></thead><tbody id="list-students" class="divide-y divide-slate-50"></tbody></table></div>
                    </div>
                    <div id="view-hw-admin" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 h-fit">
                            <h3 class="font-bold text-lg mb-6 flex items-center gap-2"><span class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600"><i data-lucide="plus" class="w-5 h-5"></i></span> ç™¼å¸ƒæ–°åŠŸèª²</h3>
                            <form id="form-hw" class="space-y-4">
                                <select id="hw-sub" class="w-full p-3 rounded-xl bg-slate-50 border-none font-bold text-slate-700 text-sm outline-none focus:ring-2 focus:ring-indigo-500"><option>ä¸­æ–‡</option><option>è‹±æ–‡</option><option>æ•¸å­¸</option><option>å¸¸è­˜</option><option>å…¶ä»–</option></select>
                                <input id="hw-tit" placeholder="å…§å®¹ (e.g. ä½œ P.10)" required class="w-full p-3 rounded-xl bg-slate-50 border-none font-bold text-slate-700 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                <input id="hw-due" type="date" class="w-full p-3 rounded-xl bg-slate-50 border-none font-bold text-slate-700 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                <button class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform">ç™¼å¸ƒ</button>
                            </form>
                            <button onclick="window.dlBackup()" class="w-full mt-6 py-3 border-2 border-slate-100 rounded-xl text-xs font-bold text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> å‚™ä»½è³‡æ–™</button>
                        </div>
                        <div class="md:col-span-2 space-y-4"><div id="list-hw-admin" class="space-y-3"></div></div>
                    </div>
                </div>
                <!-- STUDENT -->
                <div id="panel-student" class="hidden grid grid-cols-1 md:grid-cols-3 gap-8 animate-fade-in">
                    <div class="md:col-span-2 space-y-6">
                        <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-indigo-500/30 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                            <div class="relative z-10 flex justify-between items-end"><div><p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-2">Today's Progress</p><h2 class="text-4xl font-bold mb-2" id="prog-txt">0%</h2><p class="text-sm font-medium text-indigo-100 opacity-80">å®Œæˆæ‰€æœ‰ä½œæ¥­ï¼Œä¿æŒé ˜å…ˆï¼</p></div><div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/30"><i data-lucide="trending-up" class="w-8 h-8 text-white"></i></div></div>
                        </div>
                        <div id="list-hw-student" class="space-y-4"></div>
                    </div>
                    <div class="bg-white rounded-[2.5rem] shadow-xl p-6 border border-slate-100 h-fit">
                        <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-3"><span class="w-8 h-8 rounded-lg bg-yellow-100 flex items-center justify-center text-yellow-600"><i data-lucide="sticky-note" class="w-4 h-4"></i></span> å‚™å¿˜éŒ„</h2>
                        <form id="form-memo" class="flex gap-2 mb-6"><input id="memo-in" placeholder="æ–°å¢å¾…è¾¦..." class="flex-1 p-3 rounded-xl bg-slate-50 border-none font-bold text-sm focus:ring-2 focus:ring-yellow-400 outline-none"><button class="bg-yellow-400 text-yellow-900 p-3 rounded-xl active:scale-90 transition-transform"><i data-lucide="plus" class="w-5 h-5"></i></button></form>
                        <div id="list-memos" class="space-y-3 max-h-[400px] overflow-y-auto pr-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è…³æœ¬é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG (Ensure this matches your Firebase Console)
        const firebaseConfig = {
            apiKey: "AIzaSyDVj1OMXGD-51-9lX7N7rW8C4fEMLdp6M8",
            authDomain: "pkhw-f6bcf.firebaseapp.com",
            projectId: "pkhw-f6bcf",
            storageBucket: "pkhw-f6bcf.firebasestorage.app",
            messagingSenderId: "169847959955",
            appId: "1:169847959955:web:4d88fb31dfac054af17866",
            measurementId: "G-1W7W93WTY7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = 'chimhinhin@gmail.com';

        let currentUser = null;
        let isAdmin = false;
        let homeworks = [];
        let doneIds = [];
        let allUsers = [];
        let listeners = [];

        // Error Catcher
        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
            // If stuck on loader, show login
            if(!document.getElementById('global-loader').classList.contains('hidden')) {
                document.getElementById('loading-text').innerText = "ERROR - RETRYING";
                setTimeout(() => setView('view-login'), 1000);
            }
        };

        // FORCE TIMEOUT (Safety Valve)
        setTimeout(() => {
            const loader = document.getElementById('global-loader');
            if (!loader.classList.contains('hidden')) {
                console.warn("Loader timeout triggered. Forcing login view.");
                setView('view-login');
            }
        }, 5000); // 5 seconds timeout

        // --- UTILS ---
        window.toast = (msg, type='success') => {
            const el = document.createElement('div');
            el.className = `px-6 py-3 rounded-full shadow-xl font-bold text-sm text-white slide-up flex items-center gap-2 ${type==='error'?'bg-red-500':'bg-slate-800'}`;
            el.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check'}" class="w-4 h-4"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(el);
            lucide.createIcons();
            setTimeout(() => el.remove(), 3000);
        };

        function setView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
            const loader = document.getElementById('global-loader');
            loader.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => loader.classList.add('hidden'), 300);
            lucide.createIcons();
        }

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            listeners.forEach(u => u()); listeners = [];
            
            if (user) {
                currentUser = user;
                isAdmin = (user.email.toLowerCase().trim() === ADMIN_EMAIL.toLowerCase().trim());
                
                if (isAdmin) {
                    initData(); updateDash(); setView('view-dashboard');
                    setDoc(doc(db, 'users', user.uid), { email: user.email, role: 'admin', lastLogin: serverTimestamp() }, { merge: true });
                    return;
                }

                try {
                    const ref = doc(db, 'users', user.uid);
                    await setDoc(ref, { uid: user.uid, email: user.email, role: 'student', lastLogin: serverTimestamp() }, { merge: true });
                    const snap = await getDoc(ref);
                    
                    if (!snap.data()?.nickname) setView('view-nickname');
                    else setView('view-consent');
                    
                    initData(); updateDash();
                } catch (e) {
                    console.error(e);
                    setView('view-dashboard'); 
                }
            } else {
                currentUser = null;
                // Force show login if not logged in
                setView('view-login');
                // Ensure loader is definitely gone
                document.getElementById('global-loader').classList.add('hidden');
            }
        });

        // --- DATA ---
        function initData() {
            const q = query(collection(db, 'homework'), orderBy('createdAt', 'desc'));
            listeners.push(onSnapshot(q, (snap) => {
                homeworks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUI();
            }));

            if (isAdmin) {
                listeners.push(onSnapshot(collection(db, 'users'), (snap) => {
                    allUsers = snap.docs.map(d => d.data()).filter(u => u.email !== ADMIN_EMAIL).sort((a,b) => (b.lastLogin?.seconds||0) - (a.lastLogin?.seconds||0));
                    renderAdminMonitor();
                }));
            } else {
                listeners.push(onSnapshot(doc(db, 'users', currentUser.uid), (snap) => {
                    if(snap.exists()) doneIds = snap.data().completed || [];
                    renderStudentUI();
                }));
                const qM = query(collection(db, 'users', currentUser.uid, 'memos'), orderBy('createdAt', 'desc'));
                listeners.push(onSnapshot(qM, (snap) => {
                    renderMemos(snap.docs.map(d => ({id: d.id, ...d.data()})));
                }));
            }
        }

        // --- RENDER ---
        function updateDash() {
            const name = currentUser.displayName || currentUser.email.split('@')[0];
            document.getElementById('user-name').innerText = name;
            document.getElementById('user-avatar').innerText = name.charAt(0).toUpperCase();
            document.getElementById('user-role').innerText = isAdmin ? "ADMIN" : "STUDENT";
            document.getElementById('nav-role').innerText = isAdmin ? "ADMIN" : "STUDENT";
            if(isAdmin) {
                document.getElementById('panel-admin').classList.remove('hidden');
                document.getElementById('panel-student').classList.add('hidden');
            } else {
                document.getElementById('panel-admin').classList.add('hidden');
                document.getElementById('panel-student').classList.remove('hidden');
            }
        }

        function renderUI() { if(isAdmin) { renderAdminHW(); renderAdminMonitor(); } else renderStudentUI(); lucide.createIcons(); }

        function renderStudentUI() {
            const list = document.getElementById('list-hw-student'); list.innerHTML = '';
            const pct = homeworks.length ? Math.round((doneIds.length / homeworks.length)*100) : 0;
            document.getElementById('prog-txt').innerText = `${pct}%`;

            if (homeworks.length === 0) {
                list.innerHTML = `<div class="text-center py-12 border-2 border-dashed border-slate-200 rounded-[2rem]"><p class="text-slate-400 font-bold text-sm">æš«ç„¡åŠŸèª² ğŸ‰</p></div>`;
                return;
            }

            homeworks.forEach(hw => {
                const isDone = doneIds.includes(hw.id);
                const el = document.createElement('div');
                el.className = `group p-5 rounded-[1.5rem] border transition-all cursor-pointer flex items-start gap-4 active:scale-95 duration-200 ${isDone ? 'bg-slate-50/50 border-slate-100 opacity-60' : 'bg-white border-slate-100 shadow-sm hover:border-indigo-200 hover:shadow-md'}`;
                el.innerHTML = `<div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0 transition-colors ${isDone ? 'bg-green-500 text-white shadow-green-200' : 'bg-slate-100 text-slate-300 group-hover:bg-indigo-50 group-hover:text-indigo-500'}"><i data-lucide="${isDone ? 'check' : 'circle'}" class="w-6 h-6"></i></div><div class="flex-1 py-1"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-black px-2 py-1 rounded-lg uppercase tracking-wide ${isDone ? 'bg-slate-200 text-slate-500' : 'bg-indigo-50 text-indigo-600'}">${hw.subject}</span><h3 class="font-bold text-slate-800 text-lg leading-tight ${isDone ? 'line-through text-slate-400' : ''}">${hw.title}</h3></div><p class="text-xs font-bold text-slate-400 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${hw.due || 'ç„¡æœŸé™'}</p></div>`;
                el.onclick = async () => {
                    const ref = doc(db, 'users', currentUser.uid);
                    if(isDone) await updateDoc(ref, { completed: arrayRemove(hw.id) });
                    else { await setDoc(ref, { completed: arrayUnion(hw.id) }, { merge: true }); window.toast("å®Œæˆï¼"); }
                };
                list.appendChild(el);
            });
        }

        function renderMemos(memos) {
            const list = document.getElementById('list-memos'); list.innerHTML = '';
            if(memos.length===0) list.innerHTML = '<p class="text-center text-xs font-bold text-slate-300 py-6">ç„¡äº‹é …</p>';
            memos.forEach(m => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center group";
                el.innerHTML = `<span class="text-sm font-bold text-slate-700 break-all">${m.text}</span><button class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center opacity-0 group-hover:opacity-100 del-memo"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                el.querySelector('.del-memo').onclick = () => deleteDoc(doc(db, 'users', currentUser.uid, 'memos', m.id));
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- GLOBAL EXPORTS ---
        window.setAdminTab = (tab) => {
            const m = document.getElementById('view-monitor'); const h = document.getElementById('view-hw-admin');
            const tm = document.getElementById('tab-mon'); const th = document.getElementById('tab-hw');
            if(tab==='monitor') { m.classList.remove('hidden'); h.classList.add('hidden'); tm.className="px-6 py-2.5 rounded-xl text-sm font-bold bg-slate-900 text-white shadow-md transition-all"; th.className="px-6 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all"; }
            else { h.classList.remove('hidden'); m.classList.add('hidden'); th.className="px-6 py-2.5 rounded-xl text-sm font-bold bg-slate-900 text-white shadow-md transition-all"; tm.className="px-6 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all"; }
        };
        window.dlBackup = () => {
            if(!confirm("ä¸‹è¼‰å‚™ä»½?")) return;
            const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ts:new Date(), hw:homeworks, users:allUsers}));
            const a = document.createElement('a'); a.href=s; a.download="Backup.json"; document.body.appendChild(a); a.click(); a.remove();
        };

        // --- ACTIONS ---
        document.getElementById('btn-save-nick').onclick = async () => {
            const val = document.getElementById('modal-nick-input').value.trim();
            if(!val) return window.toast("è«‹è¼¸å…¥åå­—", "error");
            try {
                await setDoc(doc(db, 'users', currentUser.uid), { nickname: val }, { merge: true });
                await updateProfile(currentUser, { displayName: val });
                setView('view-consent');
            } catch(e) { window.toast(e.message, 'error'); }
        };
        document.getElementById('form-hw').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.innerText = "...";
            await addDoc(collection(db, 'homework'), { subject: document.getElementById('hw-sub').value, title: document.getElementById('hw-tit').value, due: document.getElementById('hw-due').value, createdAt: serverTimestamp() });
            e.target.reset(); btn.innerText = "ç«‹å³ç™¼å¸ƒ"; window.toast("å·²ç™¼å¸ƒ");
        };
        document.getElementById('form-memo').onsubmit = async (e) => {
            e.preventDefault();
            const val = document.getElementById('memo-in').value.trim(); if(!val) return;
            await addDoc(collection(db, 'users', currentUser.uid, 'memos'), { text: val, createdAt: serverTimestamp() });
            document.getElementById('memo-in').value = '';
        };
        document.getElementById('btn-google').onclick = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { window.toast(e.message, 'error'); } };
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        document.getElementById('btn-agree').onclick = () => setView('view-dashboard');
        
        // Forms
        const fAuth = document.getElementById('form-auth'); const bEmail = document.getElementById('btn-toggle-email'); const fNick = document.getElementById('field-nickname'); const bSub = document.getElementById('btn-submit-auth'); let isReg = false;
        bEmail.onclick = () => { fAuth.classList.remove('hidden'); bEmail.classList.add('hidden'); };
        document.getElementById('btn-switch-mode').onclick = () => { isReg = !isReg; fNick.classList.toggle('hidden', !isReg); bSub.innerText = isReg ? 'è¨»å†Šå¸³è™Ÿ' : 'ç™»å…¥'; document.getElementById('btn-switch-mode').innerText = isReg ? 'ç›´æ¥ç™»å…¥' : 'ç«‹å³è¨»å†Š'; };
        fAuth.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value; const pass = document.getElementById('input-password').value;
            try {
                if(isReg) {
                    const nick = document.getElementById('input-nickname').value.trim(); if(!nick) throw new Error("è«‹å¡«å¯«åå­—");
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, 'users', cred.user.uid), { nickname: nick, email, role: 'student', completed:[], lastLogin: serverTimestamp() });
                } else await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) { window.toast(e.message, 'error'); }
        };

        function renderAdminHW() {
            const list = document.getElementById('list-hw-admin'); list.innerHTML = '';
            homeworks.forEach(hw => {
                const el = document.createElement('div');
                el.className = "p-4 bg-white rounded-2xl border border-slate-100 flex justify-between items-center group hover:border-indigo-100 transition-colors";
                el.innerHTML = `<div><span class="text-[10px] font-bold px-2 py-1 bg-indigo-50 text-indigo-600 rounded mr-2 uppercase">${hw.subject}</span><span class="font-bold text-sm text-slate-700">${hw.title}</span></div><button class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity del-hw"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                el.querySelector('.del-hw').onclick = () => { if(confirm("åˆªé™¤?")) deleteDoc(doc(db, 'homework', hw.id)); };
                list.appendChild(el);
            });
            lucide.createIcons();
        }
        function renderAdminMonitor() {
            const body = document.getElementById('list-students'); body.innerHTML = '';
            allUsers.forEach(u => {
                const done = u.completed || []; const pct = homeworks.length ? Math.round((done.length/homeworks.length)*100) : 0;
                const name = u.nickname || u.email.split('@')[0];
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `<td class="p-6"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-indigo-600 text-white font-bold flex items-center justify-center shadow-md shadow-indigo-200 text-sm">${name.charAt(0).toUpperCase()}</div><div><div class="font-bold text-slate-800">${name}</div><div class="text-[10px] text-slate-400 font-bold uppercase">Student</div></div></div></td><td class="p-6 font-mono text-xs font-bold text-slate-500">${u.lastLogin?new Date(u.lastLogin.seconds*1000).toLocaleDateString():'-'}</td><td class="p-6"><div class="flex items-center gap-3"><div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden w-24"><div class="h-full rounded-full ${pct===100?'bg-green-500':'bg-indigo-500'}" style="width:${pct}%"></div></div><span class="text-xs font-bold text-slate-600">${pct}%</span></div></td><td class="p-6 text-right"><button class="text-slate-300 hover:text-indigo-600 transition-colors det"><i data-lucide="chevron-down" class="w-5 h-5"></i></button></td>`;
                body.appendChild(tr);
            });
            lucide.createIcons();
        }
    </script>
</body>
</html>


