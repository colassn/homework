<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèª²èˆ‡é»˜æ›¸è¿½è¹¤å°å¹«æ‰‹</title>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- å¼•å…¥ Babel ç”¨ä¾†è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        input[type="file"]::file-selector-button {
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate {
            animation: fadeIn 0.2s ease-out forwards;
        }
        .notification-animate {
            animation: fadeIn 0.15s ease-out forwards;
        }
        
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="module">
        // ==========================================
        // ä½ çš„ Firebase Config
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA7C10miZnBWXLBluCDU9nezCn9StmWZ3U",
            authDomain: "recordhw-ad1f9.firebaseapp.com",
            projectId: "recordhw-ad1f9",
            storageBucket: "recordhw-ad1f9.firebasestorage.app",
            messagingSenderId: "600838574849",
            appId: "1:600838574849:web:425fd3ede2eb6ebaae0100", 
            measurementId: "G-8VCPLTE2QT"
        };

        // å¼•å…¥ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            query, 
            orderBy,
            serverTimestamp,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // å°‡ Firebase åŠŸèƒ½æ›è¼‰åˆ° window
        window.firebaseServices = { auth, db, googleProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Auth Modal (ä¿æŒä¸è®Š) ---
        function AuthModal({ isOpen, onClose, triggerAlert }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const { auth, googleProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword } = window.firebaseServices;

            useEffect(() => {
                if (window.lucide && isOpen) window.lucide.createIcons();
            }, [isOpen, isLogin]);

            if (!isOpen) return null;

            const handleGoogleLogin = async () => {
                try {
                    setLoading(true);
                    await signInWithPopup(auth, googleProvider);
                    onClose();
                } catch (error) {
                    console.error(error);
                    triggerAlert("Google ç™»å…¥å¤±æ•—: " + error.message);
                    setLoading(false);
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                if(!email || !password) return;
                try {
                    setLoading(true);
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    onClose();
                } catch (error) {
                    console.error(error);
                    triggerAlert("é©—è­‰å¤±æ•—: " + error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="modal-animate bg-white/90 backdrop-blur-2xl rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.3)] w-full max-w-md p-8 relative z-10 border border-white/50 overflow-hidden">
                         <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" className="w-6 h-6"></i></button>
                        <div className="absolute -top-10 -left-10 w-40 h-40 bg-purple-300 rounded-full mix-blend-multiply filter blur-2xl opacity-50 animate-blob pointer-events-none"></div>
                        <div className="absolute -bottom-10 -right-10 w-40 h-40 bg-blue-300 rounded-full mix-blend-multiply filter blur-2xl opacity-50 animate-blob animation-delay-2000 pointer-events-none"></div>
                        <div className="text-center mb-8 relative">
                            <h2 className="text-2xl font-black text-slate-800 tracking-tight">{isLogin ? 'ç™»å…¥å¸³æˆ¶' : 'ç«‹å³è¨»å†Š'}</h2>
                            <p className="text-slate-500 mt-1 text-sm">{isLogin ? 'ç™»å…¥å³å¯å„²å­˜åŠåŒæ­¥ä½ çš„è³‡æ–™' : 'åªéœ€å¹¾ç§’ï¼Œé–‹å§‹é›²ç«¯è¨˜éŒ„'}</p>
                        </div>
                        <form onSubmit={handleEmailAuth} className="space-y-4 relative">
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors"><i data-lucide="mail" className="w-5 h-5"></i></div><input type="email" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-slate-50 border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-medium" placeholder="é›»å­éƒµä»¶" value={email} onChange={e => setEmail(e.target.value)} required /></div>
                            <div className="relative group"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-indigo-500 transition-colors"><i data-lucide="lock" className="w-5 h-5"></i></div><input type="password" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-slate-50 border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-medium" placeholder="å¯†ç¢¼" value={password} onChange={e => setPassword(e.target.value)} required /></div>
                            <button type="submit" disabled={loading} className="w-full py-3.5 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-lg shadow-lg shadow-indigo-500/30 transform transition-all active:scale-[0.98] disabled:opacity-70 flex items-center justify-center">{loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}</button>
                        </form>
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-100"></div></div><div className="relative flex justify-center text-xs uppercase tracking-wider font-bold text-slate-400"><span className="px-3 bg-white/80 backdrop-blur">æˆ–</span></div></div>
                        <button onClick={handleGoogleLogin} disabled={loading} className="w-full py-3 rounded-xl bg-white border border-slate-200 text-slate-700 font-bold hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center justify-center gap-3 shadow-sm active:scale-[0.98]"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-5 h-5" />Google ç™»å…¥</button>
                        <div className="mt-6 text-center"><p className="text-slate-500 text-sm">{isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ' : 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ'} <button onClick={() => setIsLogin(!isLogin)} className="text-indigo-600 font-bold hover:text-indigo-700 ml-1 transition-colors">{isLogin ? 'ç«‹å³è¨»å†Š' : 'ç›´æ¥ç™»å…¥'}</button></p></div>
                    </div>
                </div>
            );
        }

        // --- ä¸»ç¨‹å¼çµ„ä»¶ ---
        function App() {
            // --- State ---
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [items, setItems] = useState([]);
            
            // Firebase Services
            const { auth, db, signOut, onAuthStateChanged, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs } = window.firebaseServices || {};

            // è¼¸å…¥æ¡† State
            const [inputType, setInputType] = useState('homework');
            const [description, setDescription] = useState('');
            const [dueDate, setDueDate] = useState(''); 
            const [selectedImage, setSelectedImage] = useState(null);
            const [viewMode, setViewMode] = useState('current');
            const [exitingIds, setExitingIds] = useState([]);
            const [activeModal, setActiveModal] = useState(null);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            
            // ADMIN STATE
            const [isAdmin, setIsAdmin] = useState(false);
            const [isBroadcast, setIsBroadcast] = useState(false);
            
            const [notification, setNotification] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
            const fileInputRef = useRef(null);

            // --- Helpers ---
            const getNextSchoolDay = () => {
                const d = new Date();
                const day = d.getDay(); 
                let addDays = 1;
                if (day === 5) addDays = 3;
                else if (day === 6) addDays = 2;
                else if (day === 0) addDays = 1;
                d.setDate(d.getDate() + addDays);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${dd}`;
            };

            const getDaysRemaining = (dateString) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const due = new Date(dateString);
                due.setHours(0, 0, 0, 0);
                return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            };

            const triggerAlert = (message) => setNotification({ isOpen: true, type: 'alert', message, onConfirm: null });
            const triggerConfirm = (message, onConfirmAction) => setNotification({ isOpen: true, type: 'confirm', message, onConfirm: onConfirmAction });
            const closeNotification = () => setNotification(prev => ({ ...prev, isOpen: false }));
            const handleNotificationConfirm = () => { if (notification.onConfirm) notification.onConfirm(); closeNotification(); };

            // --- Effects ---

            // 1. ç›£è½ç™»å…¥èˆ‡ç®¡ç†å“¡ç‹€æ…‹
            useEffect(() => {
                if (!window.firebaseServices) return;
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setAuthLoading(false);
                    if (currentUser) {
                        setDueDate(getNextSchoolDay());
                        setIsAuthModalOpen(false);
                        // æª¢æŸ¥ç®¡ç†å“¡
                        if (currentUser.email === 'chimhinhin@gmail.com') {
                            setIsAdmin(true);
                        } else {
                            setIsAdmin(false);
                        }
                    } else {
                        setItems([]); 
                        setIsAdmin(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. ç›£è½ç§äººæ•¸æ“š
            useEffect(() => {
                if (!user || !db) {
                    setItems([]);
                    return;
                }
                const q = query(collection(db, "users", user.uid, "items"), orderBy("dueDate"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(newItems);
                }, (error) => console.error("Error fetching private data: ", error));
                return () => unsubscribe();
            }, [user]);

            // 3. ç›£è½å…¬å…±æ•¸æ“š (è‡ªå‹•æ¥æ”¶åŠŸèª²é‚è¼¯)
            useEffect(() => {
                if (!user || !db) return;

                // ç›£è½æœ€è¿‘å»ºç«‹çš„å…¬å…±åŠŸèª² (ä¾‹å¦‚ä»Šå¤©ä¹‹å¾Œå»ºç«‹çš„ï¼Œé¿å…æ‹‰å–èˆŠè³‡æ–™ï¼Œé€™è£¡ç°¡åŒ–ç‚ºç›£è½æ‰€æœ‰ï¼Œå¯¦å‹™ä¸Šå¯åŠ æ™‚é–“é™åˆ¶)
                // é€™è£¡æˆ‘å€‘ç›£è½ `public_assignments` é›†åˆçš„è®ŠåŒ–
                const q = query(collection(db, "public_assignments"), orderBy("createdAt", "desc"));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const publicData = change.doc.data();
                            const publicId = change.doc.id;

                            // æª¢æŸ¥é€™å€‹åŠŸèª²æ˜¯å¦å·²ç¶“å­˜åœ¨æ–¼ç”¨æˆ¶çš„ç§äººåˆ—è¡¨ä¸­ (é€é publicRefId)
                            // é€™è£¡æˆ‘å€‘éœ€è¦åœ¨å®¢æˆ¶ç«¯é€²è¡Œæª¢æŸ¥ (æˆ–ç™¼é€æŸ¥è©¢)
                            // ç‚ºäº†æ•ˆç‡ï¼Œæˆ‘å€‘å¯ä»¥åœ¨é€™è£¡ç™¼ä¸€å€‹ä¸€æ¬¡æ€§çš„ query æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                            const userItemsRef = collection(db, "users", user.uid, "items");
                            const dupQuery = query(userItemsRef, where("publicRefId", "==", publicId));
                            
                            try {
                                const dupSnapshot = await getDocs(dupQuery);
                                if (dupSnapshot.empty) {
                                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œä»£è¡¨é€™æ˜¯æ–°ç™¼æ”¾çš„åŠŸèª² -> è‡ªå‹•åŠ å…¥
                                    await addDoc(userItemsRef, {
                                        ...publicData,
                                        publicRefId: publicId, // æ¨™è¨˜ä¾†æº ID
                                        completed: false // é‡ç½®ç‚ºæœªå®Œæˆ
                                    });
                                    triggerAlert(`æ”¶åˆ°æ–°åŠŸèª²ï¼š${publicData.description}`);
                                }
                            } catch (e) {
                                console.error("Auto-sync error:", e);
                            }
                        }
                    });
                });

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // --- Handlers ---

            const handleGuestAction = () => {
                if (!user) {
                    setIsAuthModalOpen(true);
                    return true;
                }
                return false;
            };

            const handleImageUpload = (e) => {
                if (handleGuestAction()) return;
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 500000) { 
                        triggerAlert("åœ–ç‰‡å¤ªå¤§å•¦ï¼ç”±æ–¼è³‡æ–™åº«é™åˆ¶ï¼Œè«‹ç”¨ç´°é 500KB å˜…åœ–ã€‚");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => setSelectedImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (handleGuestAction()) return;
                if ((!description.trim() && !selectedImage) || !dueDate) return;

                const newItem = {
                    type: inputType,
                    description: description.trim(),
                    image: selectedImage,
                    dueDate,
                    completed: false,
                    createdAt: new Date().toISOString()
                };

                try {
                    if (isBroadcast && isAdmin) {
                        // ç®¡ç†å“¡ç™¼æ”¾æ¨¡å¼ï¼šå¯«å…¥å…¬å…±å€åŸŸ
                        await addDoc(collection(db, "public_assignments"), newItem);
                        triggerAlert("å·²ç™¼æ”¾åŠŸèª²çµ¦å…¨ç­ï¼");
                        // æ³¨æ„ï¼šé€™è£¡ä¸éœ€è¦æ‰‹å‹•åŠ å…¥è‡ªå·±çš„åˆ—è¡¨ï¼Œå› ç‚ºä¸Šæ–¹çš„ useEffect æœƒè‡ªå‹•åµæ¸¬åˆ°ä¸¦åŠ å…¥
                    } else {
                        // æ™®é€šæ¨¡å¼ï¼šå¯«å…¥ç§äººå€åŸŸ
                        await addDoc(collection(db, "users", user.uid, "items"), newItem);
                    }
                    
                    // Reset Form
                    setDescription('');
                    setSelectedImage(null);
                    if (fileInputRef.current) fileInputRef.current.value = "";
                    setDueDate(getNextSchoolDay());
                    setViewMode('current');
                    setIsBroadcast(false); // é‡ç½®ç™¼æ”¾æŒ‰éˆ•
                } catch (error) {
                    console.error("Error adding document: ", error);
                    triggerAlert("æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            };

            const handleToggle = async (id, currentCompletedStatus) => {
                if (handleGuestAction()) return;
                if (!currentCompletedStatus) {
                    setExitingIds(prev => [...prev, id]);
                    setTimeout(async () => {
                        try {
                            const itemRef = doc(db, "users", user.uid, "items", id);
                            await updateDoc(itemRef, { completed: true });
                        } catch (e) { console.error(e); }
                        setExitingIds(prev => prev.filter(eid => eid !== id));
                    }, 1000);
                } else {
                    try {
                        const itemRef = doc(db, "users", user.uid, "items", id);
                        await updateDoc(itemRef, { completed: false });
                    } catch (e) { console.error(e); }
                }
            };

            const deleteItem = (id) => {
                if (handleGuestAction()) return;
                triggerConfirm('å …ä¿‚è¦åˆªé™¤ï¼Ÿé›²ç«¯åˆªå’—å°±æ•‘å””è¿”æ¶å–ï¼', async () => {
                    try {
                        await deleteDoc(doc(db, "users", user.uid, "items", id));
                    } catch (e) { console.error(e); triggerAlert("åˆªé™¤å¤±æ•—"); }
                });
            };
            
            const handleSignOut = () => {
                triggerConfirm('ç¢ºå®šè¦ç™»å‡ºï¼Ÿ', async () => {
                    try { await signOut(auth); setActiveModal(null); setIsAdmin(false); } catch(e) { console.error(e); }
                });
            };

            const handleDashboardClick = (modalType) => {
                if (!user) { setIsAuthModalOpen(true); } else { setActiveModal(modalType); }
            };

            // --- Rendering Logic ---
            if (authLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="animate-pulse flex flex-col items-center"><div className="w-12 h-12 bg-indigo-200 rounded-full mb-4"></div><div className="h-4 w-32 bg-slate-200 rounded"></div></div></div>;

            const activeItems = items.filter(i => !i.completed);
            const todayHomeworks = activeItems.filter(i => i.type === 'homework' && getDaysRemaining(i.dueDate) <= 0);
            const upcomingHomeworks = activeItems.filter(i => i.type === 'homework' && getDaysRemaining(i.dueDate) >= 1);
            const activeTests = activeItems.filter(i => i.type !== 'homework');
            activeTests.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            const nextTest = activeTests[0];
            const nextTestDays = nextTest ? getDaysRemaining(nextTest.dueDate) : null;
            const testCount = activeTests.length;

            const getModalTitle = () => {
                if (activeModal === 'today') return 'ä»Šæ—¥è¦äº¤å˜…åŠŸèª²';
                if (activeModal === 'upcoming') return 'æ—¥å¾Œè¦äº¤å˜…åŠŸèª²';
                if (activeModal === 'revision') return 'æ‰€æœ‰æ¸¬é©—é»˜æ›¸';
                return '';
            };
            const getModalItems = () => {
                if (activeModal === 'today') return todayHomeworks;
                if (activeModal === 'upcoming') return upcomingHomeworks.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                if (activeModal === 'revision') return activeTests;
                return [];
            };

            const getStatusBadge = (item) => {
                const daysLeft = getDaysRemaining(item.dueDate);
                const isCompleted = item.completed || exitingIds.includes(item.id);
                if (isCompleted) return { text: 'å·²å®Œæˆ', color: 'bg-blue-100 text-blue-700', border: 'border-blue-200' };
                if (item.type === 'homework') {
                    if (daysLeft < 0) return { text: `é²å’— ${Math.abs(daysLeft)} æ—¥`, color: 'bg-red-500 text-white', border: 'border-red-500' };
                    if (daysLeft === 0) return { text: 'ä»Šæ—¥è¦äº¤ï¼', color: 'bg-orange-500 text-white font-bold', border: 'border-orange-500' };
                    if (daysLeft === 1) return { text: 'è½æ—¥è¦äº¤', color: 'bg-amber-100 text-amber-800', border: 'border-amber-200' };
                    return { text: `ä»²æœ‰ ${daysLeft} æ—¥`, color: 'bg-emerald-100 text-emerald-700', border: 'border-emerald-200' };
                } else {
                    if (daysLeft < 0) return { text: 'å·²çµæŸ', color: 'bg-gray-100 text-gray-500', border: 'border-gray-200' };
                    if (daysLeft === 0) return { text: 'ä»Šæ—¥è€ƒï¼', color: 'bg-red-600 text-white font-bold animate-pulse', border: 'border-red-600' };
                    if (daysLeft === 1) return { text: 'è½æ—¥è€ƒï¼', color: 'bg-red-100 text-red-700 font-bold', border: 'border-red-200' };
                    return { text: `ä»²æœ‰ ${daysLeft} æ—¥`, color: 'bg-indigo-100 text-indigo-700', border: 'border-indigo-200' };
                }
            };
            const getTypeIcon = (type) => type !== 'homework' ? <i data-lucide="file-question" className="w-4 h-4 text-purple-500"></i> : <i data-lucide="book-open" className="w-4 h-4 text-indigo-500"></i>;
            const getTypeName = (type) => type !== 'homework' ? 'é»˜æ›¸/æ¸¬é©—' : 'åŠŸèª²';
            
            const displayedItems = items.filter(item => viewMode === 'current' ? !item.completed : item.completed).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            const guestStyle = !user ? "opacity-60 grayscale" : "";

            const renderItemCard = (item) => {
                const daysLeft = getDaysRemaining(item.dueDate);
                const isExiting = exitingIds.includes(item.id);
                const isVisuallyCompleted = item.completed || isExiting;
                const status = getStatusBadge(item);
                const isTest = item.type !== 'homework';

                return (
                    <div key={item.id} className={`relative group overflow-hidden bg-white rounded-xl p-4 shadow-sm border transition-all duration-300 ${isExiting ? 'scale-95 opacity-0 translate-y-4' : 'hover:shadow-md'} ${isVisuallyCompleted ? 'bg-slate-50 border-slate-100' : 'border-slate-100'} ${!isVisuallyCompleted && isTest ? 'border-l-4 border-l-purple-400' : ''}`}>
                        {!isTest && (<div className={`absolute left-0 top-0 bottom-0 w-1.5 ${daysLeft < 0 && !isVisuallyCompleted ? 'bg-red-500' : (daysLeft === 0 && !isVisuallyCompleted ? 'bg-orange-500' : 'bg-transparent')}`}></div>)}
                        <div className="flex items-start gap-3">
                            <button onClick={() => handleToggle(item.id, item.completed)} disabled={isExiting} className={`flex-shrink-0 mt-1 w-6 h-6 rounded-full border-2 transition-all duration-300 flex items-center justify-center overflow-hidden ${isVisuallyCompleted ? 'bg-green-500 border-green-500 text-white scale-110 shadow-green-200' : (!isTest ? 'border-slate-300 hover:border-indigo-500 hover:bg-indigo-50' : 'border-purple-300 hover:border-purple-500 hover:bg-purple-50')}`}>
                                <i data-lucide="check-circle" className={`w-3.5 h-3.5 transition-transform duration-300 ${isVisuallyCompleted ? 'scale-100' : 'scale-0'}`}></i>
                            </button>
                            <div className="flex-grow min-w-0">
                                <div className="flex flex-col gap-1">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            {getTypeIcon(item.type)}
                                            <span className="text-xs font-bold text-slate-500">{getTypeName(item.type)}</span>
                                            {item.publicRefId && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 rounded">è€å¸«ç™¼æ”¾</span>}
                                        </div>
                                        <span className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-bold shadow-sm border ${status.color} ${status.border}`}>
                                            {daysLeft < 0 && <i data-lucide="alert-circle" className="w-3 h-3"></i>}
                                            {daysLeft <= 3 && daysLeft >= 0 && <i data-lucide="clock" className="w-3 h-3"></i>}
                                            {status.text}
                                        </span>
                                    </div>
                                    <div className={`text-base font-medium whitespace-pre-wrap leading-relaxed ${isVisuallyCompleted ? 'line-through text-slate-400' : 'text-slate-800'}`}>
                                        {item.description}
                                    </div>
                                    {item.image && (<div className="mt-2 relative group/image w-fit"><img src={item.image} alt="Upload" className={`max-h-32 rounded-lg border border-slate-200 object-cover ${isVisuallyCompleted ? 'opacity-50 grayscale' : ''}`} /></div>)}
                                    <div className="flex items-center gap-1 text-xs text-slate-400 mt-1"><i data-lucide="calendar" className="w-3 h-3"></i>{item.dueDate}</div>
                                </div>
                            </div>
                            <button onClick={() => deleteItem(item.id)} className="flex-shrink-0 p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4 sm:p-6 md:p-8 font-sans text-slate-800 relative">
                    <div className="max-w-3xl mx-auto">
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                            <div>
                                <h1 className="text-xl sm:text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center gap-2">
                                    {viewMode === 'current' ? (<><i data-lucide="graduation-cap" className="w-6 h-6 sm:w-8 sm:h-8 text-indigo-600"></i>å­¸ç”Ÿå°å¹«æ‰‹</>) : (<><i data-lucide="history" className="w-6 h-6 sm:w-8 sm:h-8 text-purple-600"></i>å®Œæˆç´€éŒ„</>)}
                                </h1>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => !user ? setIsAuthModalOpen(true) : setViewMode(viewMode === 'current' ? 'history' : 'current')} className={`group justify-center relative flex items-center gap-2 px-4 py-2.5 rounded-full font-bold text-sm transition-all duration-300 shadow-md hover:shadow-xl transform hover:-translate-y-1 ${viewMode === 'current' ? 'bg-white text-slate-700 border-2 border-slate-100 hover:border-indigo-200' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white border-transparent'} ${guestStyle}`}>
                                    {viewMode === 'current' ? (<><i data-lucide="history" className="w-4 h-4 group-hover:rotate-12 transition-transform"></i>ç‡ç´€éŒ„</>) : (<><i data-lucide="arrow-left" className="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>è¿”é¦–é </>)}
                                </button>
                                {user ? (<button onClick={handleSignOut} className="group justify-center relative flex items-center gap-2 px-4 py-2.5 rounded-full font-bold text-sm bg-slate-200 text-slate-600 hover:bg-slate-300 transition-all shadow-sm"><i data-lucide="log-out" className="w-4 h-4"></i>ç™»å‡º</button>) : (<button onClick={() => setIsAuthModalOpen(true)} className="group justify-center relative flex items-center gap-2 px-4 py-2.5 rounded-full font-bold text-sm bg-indigo-600 text-white hover:bg-indigo-700 transition-all shadow-md shadow-indigo-200"><i data-lucide="log-in" className="w-4 h-4"></i>ç™»å…¥/è¨»å†Š</button>)}
                            </div>
                        </div>

                        {viewMode === 'current' && (
                            <div className={`grid grid-cols-3 gap-3 sm:gap-4 mb-6 sm:mb-8 ${guestStyle}`}>
                                <div onClick={() => handleDashboardClick('today')} className="cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border border-red-100 flex flex-col items-center justify-center text-center ring-1 ring-red-50 hover:scale-105 hover:shadow-md transition-all active:scale-95">
                                    <div className="text-red-500 mb-1"><i data-lucide="flame" className="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                                    <div className="text-2xl sm:text-3xl font-bold text-slate-800">{todayHomeworks.length}</div>
                                    <div className="text-xs sm:text-sm font-medium text-slate-500">ä»Šæ—¥è¦äº¤</div>
                                </div>
                                <div onClick={() => handleDashboardClick('upcoming')} className="cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border border-sky-100 flex flex-col items-center justify-center text-center ring-1 ring-sky-50 hover:scale-105 hover:shadow-md transition-all active:scale-95">
                                    <div className="text-sky-500 mb-1"><i data-lucide="calendar-range" className="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                                    <div className="text-2xl sm:text-3xl font-bold text-slate-800">{upcomingHomeworks.length}</div>
                                    <div className="text-xs sm:text-sm font-medium text-slate-500">æ—¥å¾Œè¦äº¤</div>
                                </div>
                                <div onClick={() => handleDashboardClick('revision')} className={`cursor-pointer bg-white/80 backdrop-blur rounded-2xl p-3 sm:p-4 shadow-sm border flex flex-col items-center justify-center text-center ring-1 hover:scale-105 hover:shadow-md transition-all active:scale-95 ${nextTestDays !== null && nextTestDays <= 3 ? 'border-purple-200 ring-purple-100 bg-purple-50/50' : 'border-indigo-100 ring-indigo-50'}`}>
                                    <div className="text-purple-500 mb-1"><i data-lucide="brain-circuit" className="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                                    <div className="text-2xl sm:text-3xl font-bold text-slate-800">{testCount}</div>
                                    <div className="text-xs sm:text-sm font-medium text-slate-500">æº«ç¿’è€ƒæ ¸</div>
                                    {nextTestDays !== null && (<div className="text-[10px] text-purple-600 font-bold mt-1 bg-purple-100 px-1.5 py-0.5 rounded-full">{nextTestDays < 0 ? 'å·²å®Œ' : (nextTestDays === 0 ? 'ä»Šæ—¥è€ƒ' : `${nextTestDays}æ—¥å¾Œ`)}</div>)}
                                </div>
                            </div>
                        )}

                        {viewMode === 'current' && (
                            <div className="relative">
                                {!user && (<div className="absolute inset-0 z-20 cursor-pointer rounded-3xl" onClick={() => setIsAuthModalOpen(true)}></div>)}
                                <div className={`relative bg-white/80 backdrop-blur-xl rounded-2xl sm:rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-4 sm:p-6 mb-8 sm:mb-10 border border-white/50 ring-1 ring-indigo-50 transition-all ${guestStyle}`}>
                                    <div className="flex bg-slate-100/80 p-1 rounded-xl mb-4">
                                        <button onClick={() => setInputType('homework')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${inputType === 'homework' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><i data-lucide="book-open" className="w-4 h-4"></i> åšåŠŸèª²</button>
                                        <button onClick={() => setInputType('assessment')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${inputType === 'assessment' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><i data-lucide="file-question" className="w-4 h-4"></i> æº«é»˜æ›¸/æ¸¬é©—</button>
                                    </div>
                                    <form onSubmit={handleSubmit} className="flex flex-col gap-3 sm:gap-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
                                            <div className="md:col-span-2 space-y-3">
                                                <textarea placeholder={inputType === 'homework' ? "æ‰“è¿”åŠŸèª²å…§å®¹..." : "è¼¸å…¥ç¯„åœ (ä¾‹å¦‚: ç¬¬3èª² / P.20-25)"} value={description} onChange={(e) => setDescription(e.target.value)} rows="2" className="w-full min-h-[80px] rounded-xl sm:rounded-2xl border-slate-200 bg-slate-50/50 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all p-3 sm:p-4 border text-slate-700 placeholder:text-slate-400 resize-none text-sm sm:text-base" />
                                                {inputType !== 'homework' && (<div className="flex items-center gap-2"><label className="cursor-pointer flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 text-sm transition-colors border border-slate-200"><i data-lucide="image" className="w-4 h-4"></i>{selectedImage ? 'æ›å¼µç›¸' : 'ä¸Šå‚³ç¯„åœåœ–ç‰‡'}<input type="file" accept="image/*" ref={fileInputRef} onChange={handleImageUpload} className="hidden" /></label>{selectedImage && (<div className="flex items-center gap-2 bg-indigo-50 px-2 py-1 rounded text-xs text-indigo-600 border border-indigo-100"><span>å·²é¸åœ–ç‰‡</span><button type="button" onClick={() => {setSelectedImage(null); fileInputRef.current.value="";}} className="hover:text-red-500"><i data-lucide="x" className="w-3 h-3"></i></button></div>)}</div>)}
                                            </div>
                                            <div className="flex flex-row md:flex-col gap-2 sm:gap-3 justify-between">
                                                <div className="w-1/2 md:w-full"><label className="block text-xs font-medium text-slate-500 mb-1 ml-1">{inputType === 'homework' ? 'ç¹³äº¤æ—¥æœŸ' : 'è€ƒè©¦æ—¥æœŸ'}</label><input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full h-10 sm:h-12 rounded-lg sm:rounded-xl border-slate-200 bg-slate-50/50 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all px-3 sm:px-4 border text-slate-600 font-medium text-sm sm:text-base" required /></div>
                                                <button type="submit" className={`w-1/2 md:w-full h-auto md:flex-1 text-white font-bold rounded-lg sm:rounded-xl transition-all duration-200 flex items-center justify-center gap-2 shadow-lg active:scale-95 text-sm sm:text-base ${inputType === 'homework' ? 'bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 shadow-indigo-200' : 'bg-gradient-to-r from-purple-500 to-violet-500 hover:from-purple-600 hover:to-violet-600 shadow-purple-200'}`}><i data-lucide="plus" className="w-4 h-4 sm:w-5 sm:h-5"></i>{isAdmin && isBroadcast ? 'ç™¼æ”¾çµ¦å…¨ç­' : (inputType === 'homework' ? 'åŠ åŠŸèª²' : 'Mark ä½')}</button>
                                            </div>
                                        </div>
                                        {isAdmin && (<div className="flex items-center gap-2 mt-2 pt-2 border-t border-slate-100"><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" className="sr-only peer" checked={isBroadcast} onChange={e => setIsBroadcast(e.target.checked)} /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div><span className="ml-3 text-sm font-medium text-slate-600">ğŸ“¢ ç™¼æ”¾çµ¦å…¨ç­</span></label></div>)}
                                    </form>
                                </div>
                            </div>
                        )}

                        <div className="space-y-3 sm:space-y-4 pb-12">
                            {displayedItems.length === 0 ? (<div className="text-center py-12 sm:py-20"><div className="relative inline-block"><div className="absolute inset-0 bg-indigo-200 blur-2xl opacity-20 rounded-full animate-pulse"></div><div className="relative bg-white p-4 sm:p-6 rounded-full shadow-sm mb-4 inline-flex"><i data-lucide="sparkles" className="w-8 h-8 sm:w-12 sm:h-12 text-indigo-300"></i></div></div><h3 className="text-lg sm:text-xl font-bold text-slate-700 mb-2">{viewMode === 'current' ? (user ? 'å¤ªå¥½äº†ï¼æš«æ™‚å†‡å˜¢åš' : 'ç™»å…¥å¾Œå°±å¯ä»¥ä½¿ç”¨') : 'æš«æ™‚æœªæœ‰ç´€éŒ„'}</h3></div>) : (displayedItems.map(item => renderItemCard(item)))}
                        </div>
                    </div>

                    {activeModal && (<div className="fixed inset-0 z-50 flex items-center justify-center px-4"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setActiveModal(null)}></div><div className="modal-animate relative bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden"><div className="p-5 border-b border-slate-100 flex items-center justify-between bg-white z-10"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">{activeModal === 'today' && <i data-lucide="flame" className="w-6 h-6 text-red-500"></i>}{activeModal === 'upcoming' && <i data-lucide="calendar-range" className="w-6 h-6 text-sky-500"></i>}{activeModal === 'revision' && <i data-lucide="brain-circuit" className="w-6 h-6 text-purple-500"></i>}{getModalTitle()}</h3><button onClick={() => setActiveModal(null)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"><i data-lucide="x" className="w-5 h-5 text-slate-500"></i></button></div><div className="p-4 overflow-y-auto space-y-3 bg-slate-50 flex-1">{getModalItems().length === 0 ? (<div className="text-center py-10 text-slate-400">æš«æ™‚æ²’æœ‰ç›¸é—œé …ç›®</div>) : (getModalItems().map(item => renderItemCard(item)))}</div></div></div>)}
                    <AuthModal isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} triggerAlert={triggerAlert} />
                    {notification.isOpen && (<div className="fixed inset-0 z-[60] flex items-center justify-center px-4"><div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]"></div><div className="notification-animate relative bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center transform scale-100"><div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${notification.type === 'confirm' ? 'bg-red-100 text-red-500' : 'bg-indigo-100 text-indigo-500'}`}>{notification.type === 'confirm' ? <i data-lucide="alert-triangle" className="w-6 h-6"></i> : <i data-lucide="info" className="w-6 h-6"></i>}</div><h3 className="text-lg font-bold text-slate-800 mb-2">{notification.type === 'confirm' ? 'ç¢ºèªæ“ä½œ' : 'æç¤º'}</h3><p className="text-slate-600 mb-6 leading-relaxed">{notification.message}</p><div className="flex gap-3 justify-center">{notification.type === 'confirm' ? (<><button onClick={closeNotification} className="flex-1 py-2.5 px-4 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">å–æ¶ˆ</button><button onClick={handleNotificationConfirm} className="flex-1 py-2.5 px-4 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition-all active:scale-95">ç¢ºèª</button></>) : (<button onClick={closeNotification} className="w-full py-2.5 px-4 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95">çŸ¥é“äº†</button>)}</div></div></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


