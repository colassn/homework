<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3B Hub - 班級平台</title>
    
    <!-- 1. 載入函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- 2. UI 樣式 -->
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .page { display: none; min-height: 100vh; flex-direction: column; }
        .page.active { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn { transition: all 0.2s; transform: scale(1); }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="text-slate-800">

    <!-- 全局提示框 (Toast) -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl z-[9999] hidden text-sm font-bold flex items-center gap-2 transition-all duration-300">
        <span id="toast-msg">提示訊息</span>
    </div>

    <!-- 載入遮罩 -->
    <div id="global-loader" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="w-10 h-10 border-4 border-slate-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold text-slate-400 tracking-[0.2em]">CONNECTING</p>
    </div>

    <!-- 頁面 1: 登入 (Login) -->
    <div id="page-login" class="page active items-center justify-center p-6 bg-white">
        <div class="w-full max-w-sm text-center">
            <div class="w-20 h-20 bg-indigo-600 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-indigo-200 transform -rotate-3">
                <i data-lucide="graduation-cap" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-slate-900">3B Hub</h1>
            <p class="text-slate-400 mb-8 text-sm">班級專屬作業平台</p>

            <!-- Google 按鈕 -->
            <button onclick="app.doGoogleLogin()" id="btn-google" class="btn w-full bg-white border-2 border-slate-100 p-4 rounded-2xl font-bold text-slate-700 flex items-center justify-center gap-3 mb-6 hover:bg-slate-50 transition-colors shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                <span>Google 登入</span>
            </button>

            <div class="flex items-center gap-4 mb-6 opacity-60">
                <div class="h-px bg-slate-200 flex-1"></div>
                <span class="text-xs text-slate-400 font-bold">OR</span>
                <div class="h-px bg-slate-200 flex-1"></div>
            </div>

            <!-- 電郵表單 -->
            <div class="space-y-3 text-left">
                <div id="div-nick" class="hidden">
                    <label class="text-xs font-bold text-slate-400 ml-1">英文短名 (e.g. Justin)</label>
                    <input type="text" id="inp-nick" class="w-full p-3 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-indigo-500 outline-none font-bold">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-1">電郵</label>
                    <input type="email" id="inp-email" class="w-full p-3 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-indigo-500 outline-none font-bold">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-1">密碼</label>
                    <input type="password" id="inp-pass" class="w-full p-3 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-indigo-500 outline-none font-bold">
                </div>
                <button onclick="app.doEmailAuth()" id="btn-auth" class="btn w-full bg-slate-900 text-white p-4 rounded-2xl font-bold shadow-lg shadow-slate-300 mt-2">登入</button>
            </div>

            <p class="mt-6 text-sm">
                <span id="txt-mode" class="text-slate-400">沒有帳號？</span>
                <button onclick="app.toggleMode()" class="text-indigo-600 font-bold ml-1 hover:underline">立即註冊</button>
            </p>
        </div>
        <p class="absolute bottom-6 text-[10px] font-bold text-slate-300 tracking-widest">CLASS 3B • 2026</p>
    </div>

    <!-- 頁面 2: 設定暱稱 (Nickname) -->
    <div id="page-nickname" class="page items-center justify-center p-6 bg-slate-50 fixed inset-0 z-50">
        <div class="w-full max-w-sm bg-white p-8 rounded-[2rem] shadow-xl text-center">
            <div class="w-16 h-16 bg-indigo-100 rounded-full mx-auto mb-4 flex items-center justify-center text-indigo-600">
                <i data-lucide="user-plus" class="w-8 h-8"></i>
            </div>
            <h2 class="text-xl font-bold mb-2 text-slate-900">建立個人檔案</h2>
            <p class="text-xs text-slate-400 mb-6">請輸入您的英文短名，方便大家識別</p>
            <input type="text" id="inp-setup-nick" placeholder="e.g. Mary" class="w-full p-4 rounded-xl border-2 border-slate-100 text-center text-lg font-bold mb-4 outline-none focus:border-indigo-500 text-slate-800 placeholder:font-normal">
            <button onclick="app.saveNickname()" id="btn-save-nick" class="btn w-full bg-indigo-600 text-white p-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200">確認並開始</button>
        </div>
    </div>

    <!-- 頁面 3: 同意條款 (Consent) -->
    <div id="page-consent" class="page items-center justify-center p-6 bg-white z-40 fixed inset-0">
        <div class="w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-slate-800 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg">
                <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-slate-900">保密聲明</h2>
            <p class="text-xs font-bold text-indigo-500 tracking-widest uppercase mb-8">Internal Use Only</p>
            <div class="bg-slate-50 p-6 rounded-3xl text-left text-sm text-slate-600 mb-8 font-medium leading-relaxed border border-slate-100">
                本平台僅供 <strong>3B 班級</strong> 內部使用。<br><br>
                為保障同學隱私，請承諾不將帳號借予他人或將內容截圖外傳。
            </div>
            <button onclick="app.gotoDash()" class="btn w-full bg-slate-900 text-white p-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg hover:bg-slate-800">
                我理解並同意 <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- 頁面 4: 主介面 (Dashboard) -->
    <div id="page-dashboard" class="page bg-[#F8FAFC]">
        <!-- 導航 -->
        <div class="bg-white/80 backdrop-blur-md px-6 py-4 flex justify-between items-center sticky top-0 z-30 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i data-lucide="book-open" class="w-5 h-5"></i></div>
                <div>
                    <h1 class="font-bold text-lg leading-none text-slate-800">3B Hub</h1>
                    <span id="user-role" class="text-[10px] font-bold text-slate-400 tracking-wider uppercase">Student</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="user-display" class="text-sm font-bold text-slate-700 hidden sm:block">User</span>
                <button onclick="app.logout()" class="p-2 bg-white border border-slate-200 rounded-full hover:bg-red-50 hover:text-red-500 text-slate-400 transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-24">
            <div class="max-w-4xl mx-auto space-y-6">
                
                <!-- 管理員面板 -->
                <div id="panel-admin" class="hidden space-y-6">
                    <div class="flex gap-2 p-1 bg-white rounded-xl border border-slate-100 shadow-sm w-fit">
                        <button onclick="app.setAdminTab('monitor')" id="tab-mon" class="px-6 py-2 rounded-lg text-sm font-bold bg-slate-800 text-white shadow-md transition-all">全班狀態</button>
                        <button onclick="app.setAdminTab('hw')" id="tab-hw" class="px-6 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all">發布功課</button>
                    </div>

                    <!-- 監控 -->
                    <div id="view-monitor" class="bg-white rounded-[2rem] shadow-sm overflow-hidden border border-slate-100">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-50 text-slate-400 text-xs uppercase font-bold tracking-wider"><tr><th class="p-5">學生</th><th class="p-5">進度</th></tr></thead>
                                <tbody id="list-students" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 發布 -->
                    <div id="view-hw-pub" class="hidden bg-white rounded-[2rem] shadow-sm p-6 border border-slate-100">
                        <h3 class="font-bold mb-6 text-lg flex items-center gap-2"><span class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i data-lucide="plus" class="w-4 h-4"></i></span> 發布新功課</h3>
                        <div class="space-y-4">
                            <select id="hw-sub" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500"><option>中文</option><option>英文</option><option>數學</option><option>常識</option><option>其他</option></select>
                            <input id="hw-tit" placeholder="內容 (e.g. 作 P.1)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500">
                            <input id="hw-due" type="date" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500">
                            <button onclick="app.addHomework()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">立即發布</button>
                        </div>
                        <div id="list-admin-hw" class="mt-8 space-y-3"></div>
                    </div>
                </div>

                <!-- 學生面板 -->
                <div id="panel-student" class="hidden space-y-6">
                    <!-- 進度卡 -->
                    <div class="bg-gradient-to-br from-indigo-600 to-violet-600 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-indigo-200 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-1">Today's Progress</p>
                            <h2 class="text-4xl font-bold" id="prog-txt">0%</h2>
                            <div class="w-full bg-white/20 h-2 rounded-full mt-4 overflow-hidden"><div id="prog-bar" class="bg-white h-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                    </div>

                    <!-- 功課表 -->
                    <div id="list-student-hw" class="space-y-3"></div>

                    <!-- 備忘錄 -->
                    <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-lg">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="sticky-note" class="w-4 h-4 text-yellow-500"></i> 備忘錄</h3>
                        <div class="flex gap-2 mb-4">
                            <input id="memo-in" placeholder="新增..." class="flex-1 p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-yellow-400">
                            <button onclick="app.addMemo()" class="bg-yellow-400 text-yellow-900 p-3 rounded-xl hover:bg-yellow-500 transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        <div id="list-memos" class="space-y-2 max-h-40 overflow-y-auto pr-1"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 3. FIREBASE SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- 4. 核心邏輯 -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDVj1OMXGD-51-9lX7N7rW8C4fEMLdp6M8",
            authDomain: "pkhw-f6bcf.firebaseapp.com",
            projectId: "pkhw-f6bcf",
            storageBucket: "pkhw-f6bcf.firebasestorage.app",
            messagingSenderId: "169847959955",
            appId: "1:169847959955:web:4d88fb31dfac054af17866",
            measurementId: "G-1W7W93WTY7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_EMAIL = 'chimhinhin@gmail.com';

        // 全域應用程式
        window.app = {
            user: null,
            isAdmin: false,
            isReg: false,
            homeworks: [],
            doneIds: [],
            students: [],

            // Helper: 切換頁面
            showPage: (id) => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const el = document.getElementById(id);
                if(el) el.classList.add('active');
                document.getElementById('global-loader').classList.add('hidden');
                lucide.createIcons();
            },

            // Helper: 提示框
            toast: (msg) => {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('hidden');
                t.style.opacity = '1';
                t.style.transform = 'translate(-50%, 0)';
                setTimeout(() => {
                    t.style.opacity = '0';
                    t.style.transform = 'translate(-50%, -20px)';
                    setTimeout(() => t.classList.add('hidden'), 300);
                }, 3000);
            },

            setBtnLoading: (id, isLoading) => {
                const btn = document.getElementById(id);
                if(!btn) return;
                if(isLoading) {
                    btn.dataset.html = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner"></span>';
                    btn.disabled = true;
                } else {
                    btn.innerHTML = btn.dataset.html || '確認';
                    btn.disabled = false;
                }
            },

            // --- 1. 登入相關 ---
            toggleMode: () => {
                app.isReg = !app.isReg;
                document.getElementById('div-nick').classList.toggle('hidden', !app.isReg);
                document.getElementById('btn-auth').innerText = app.isReg ? "註冊帳號" : "登入";
                document.getElementById('txt-mode').innerText = app.isReg ? "已有帳號？" : "沒有帳號？";
            },

            doGoogleLogin: () => {
                app.setBtnLoading('btn-google', true);
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(e => {
                    app.toast(e.message);
                    app.setBtnLoading('btn-google', false);
                });
            },

            doEmailAuth: () => {
                const email = document.getElementById('inp-email').value;
                const pass = document.getElementById('inp-pass').value;
                const nick = document.getElementById('inp-nick').value;

                if(!email || !pass) return app.toast("請填寫完整");
                
                app.setBtnLoading('btn-auth', true);

                if(app.isReg) {
                    if(!nick) {
                        app.setBtnLoading('btn-auth', false);
                        return app.toast("請填寫英文短名");
                    }
                    auth.createUserWithEmailAndPassword(email, pass)
                        .then(cred => {
                            // 註冊成功，寫入暱稱
                            return db.collection('users').doc(cred.user.uid).set({
                                nickname: nick,
                                email: email,
                                role: 'student',
                                completed: [],
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true }).then(() => cred.user.updateProfile({ displayName: nick }));
                        })
                        .catch(e => {
                            app.toast(e.message);
                            app.setBtnLoading('btn-auth', false);
                        });
                } else {
                    auth.signInWithEmailAndPassword(email, pass).catch(e => {
                        app.toast(e.message);
                        app.setBtnLoading('btn-auth', false);
                    });
                }
            },

            logout: () => auth.signOut(),

            // --- 2. 登入後檢查流程 ---
            handleLoginSuccess: async (user) => {
                app.user = user;
                app.isAdmin = (user.email.toLowerCase().trim() === ADMIN_EMAIL.toLowerCase().trim());

                console.log("Logged in:", user.email);

                // 1. 強制寫入基本資料 (防止資料庫無此人)
                db.collection('users').doc(user.uid).set({
                    email: user.email,
                    uid: user.uid,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    role: app.isAdmin ? 'admin' : 'student'
                }, { merge: true });

                // 2. 管理員直接進
                if (app.isAdmin) {
                    app.initDash();
                    return;
                }

                // 3. 學生檢查暱稱
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (!doc.exists || !doc.data().nickname) {
                        app.showPage('page-nickname');
                    } else {
                        app.showPage('page-consent');
                    }
                } catch (e) {
                    console.error("Profile check failed", e);
                    app.showPage('page-consent'); // 容錯：失敗也讓進
                }
            },

            // 儲存暱稱 (修復卡住問題)
            saveNickname: () => {
                const val = document.getElementById('inp-setup-nick').value.trim();
                if(!val) return app.toast("請輸入名字");
                
                app.setBtnLoading('btn-save-nick', true);
                
                // 寫入 DB
                db.collection('users').doc(app.user.uid).set({ nickname: val }, { merge: true })
                  .then(() => {
                      // 更新 Profile (非阻塞)
                      app.user.updateProfile({ displayName: val });
                      // 強制跳轉
                      app.showPage('page-consent');
                  })
                  .catch(e => {
                      app.toast("儲存失敗: " + e.message);
                      app.setBtnLoading('btn-save-nick', false);
                      // 即使失敗也嘗試跳轉，避免卡死
                      setTimeout(() => app.showPage('page-consent'), 1000);
                  });
            },

            gotoDash: () => app.initDash(),

            // --- 3. 儀表板與數據 ---
            initDash: () => {
                app.showPage('page-dashboard');
                
                // UI Info
                const name = app.user.displayName || app.user.email.split('@')[0];
                document.getElementById('user-display').innerText = name;
                document.getElementById('user-role').innerText = app.isAdmin ? "ADMIN" : "STUDENT";

                // Toggle Panels
                if (app.isAdmin) {
                    document.getElementById('panel-admin').classList.remove('hidden');
                    document.getElementById('panel-student').classList.add('hidden');
                    app.listenAdmin();
                } else {
                    document.getElementById('panel-admin').classList.add('hidden');
                    document.getElementById('panel-student').classList.remove('hidden');
                    app.listenStudent();
                }
                
                // Listen Homework (Global)
                db.collection('homework').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    app.homeworks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    app.render();
                });
            },

            listenStudent: () => {
                // Self Status
                db.collection('users').doc(app.user.uid).onSnapshot(snap => {
                    if(snap.exists) app.doneIds = snap.data().completed || [];
                    app.renderStudent();
                });
                // Memos
                db.collection('users').doc(app.user.uid).collection('memos').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    const list = document.getElementById('list-memos');
                    list.innerHTML = '';
                    if(snap.empty) list.innerHTML = '<p class="text-center text-xs text-slate-300 py-4">無事項</p>';
                    snap.docs.forEach(doc => {
                        const m = doc.data();
                        list.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center group"><span class="font-bold text-sm text-slate-700">${m.text}</span><button onclick="app.delMemo('${doc.id}')" class="text-slate-300 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                    });
                    lucide.createIcons();
                });
            },

            listenAdmin: () => {
                db.collection('users').onSnapshot(snap => {
                    app.students = snap.docs.map(d => d.data()).filter(u => u.email !== ADMIN_EMAIL);
                    app.renderAdmin();
                });
            },

            // --- 動作 ---
            addMemo: () => {
                const v = document.getElementById('memo-in').value.trim();
                if(!v) return;
                db.collection('users').doc(app.user.uid).collection('memos').add({ text: v, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('memo-in').value = '';
            },
            delMemo: (id) => db.collection('users').doc(app.user.uid).collection('memos').doc(id).delete(),

            toggleHw: (id) => {
                const ref = db.collection('users').doc(app.user.uid);
                if (app.doneIds.includes(id)) ref.update({ completed: firebase.firestore.FieldValue.arrayRemove(id) });
                else {
                    ref.update({ completed: firebase.firestore.FieldValue.arrayUnion(id) });
                    app.toast("已完成！");
                }
            },

            addHomework: () => {
                const sub = document.getElementById('hw-sub').value;
                const tit = document.getElementById('hw-tit').value;
                const due = document.getElementById('hw-due').value;
                if(!tit) return app.toast("請填寫內容");

                db.collection('homework').add({
                    subject: sub, title: tit, due: due,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                app.toast("發布成功");
                document.getElementById('hw-tit').value = '';
            },
            delHw: (id) => { if(confirm("刪除?")) db.collection('homework').doc(id).delete(); },

            setAdminTab: (tab) => {
                const m = document.getElementById('view-monitor');
                const h = document.getElementById('view-hw-pub');
                const tm = document.getElementById('tab-mon');
                const th = document.getElementById('tab-hw');
                
                if(tab === 'monitor') {
                    m.classList.remove('hidden'); h.classList.add('hidden');
                    tm.className = "flex-1 bg-slate-800 text-white py-2 rounded-lg font-bold text-sm shadow-md";
                    th.className = "flex-1 bg-white text-slate-500 py-2 rounded-lg font-bold text-sm border";
                } else {
                    h.classList.remove('hidden'); m.classList.add('hidden');
                    th.className = "flex-1 bg-slate-800 text-white py-2 rounded-lg font-bold text-sm shadow-md";
                    tm.className = "flex-1 bg-white text-slate-500 py-2 rounded-lg font-bold text-sm border";
                }
            },

            dlBackup: () => {
                if(!confirm("下載備份?")) return;
                const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ts:new Date(), hw:app.homeworks, users:app.students}));
                const a = document.createElement('a'); a.href=s; a.download="Backup.json"; document.body.appendChild(a); a.click(); a.remove();
            },

            // --- 渲染 ---
            render: () => {
                if(app.isAdmin) app.renderAdmin();
                else app.renderStudent();
                lucide.createIcons();
            },

            renderStudent: () => {
                const list = document.getElementById('list-student-hw');
                list.innerHTML = '';
                
                const pct = app.homeworks.length ? Math.round((app.doneIds.length / app.homeworks.length)*100) : 0;
                document.getElementById('prog-txt').innerText = `${pct}%`;
                document.getElementById('prog-bar').style.width = `${pct}%`;

                if(app.homeworks.length === 0) { list.innerHTML = '<div class="text-center p-8 text-slate-300 font-bold border-2 border-dashed border-slate-200 rounded-2xl">暫無功課</div>'; return; }

                app.homeworks.forEach(hw => {
                    const done = app.doneIds.includes(hw.id);
                    list.innerHTML += `
                        <div onclick="app.toggleHw('${hw.id}')" class="bg-white p-5 rounded-2xl border ${done?'border-green-200 bg-green-50/50':'border-slate-100'} shadow-sm flex items-start gap-4 cursor-pointer transition-all active:scale-95">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${done?'bg-green-500 text-white':'bg-slate-100 text-slate-300'}"><i data-lucide="check" class="w-5 h-5"></i></div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold">${hw.subject}</span>
                                    <h3 class="font-bold text-slate-800 ${done?'line-through text-slate-400':''}">${hw.title}</h3>
                                </div>
                                <p class="text-xs text-slate-400 font-bold">Due: ${hw.due||'-'}</p>
                            </div>
                        </div>
                    `;
                });
            },

            renderAdmin: () => {
                // Monitor
                const tb = document.getElementById('list-students');
                tb.innerHTML = '';
                app.students.forEach(s => {
                    const doneCnt = s.completed ? s.completed.length : 0;
                    const pct = app.homeworks.length ? Math.round((doneCnt/app.homeworks.length)*100) : 0;
                    const name = s.nickname || s.email.split('@')[0];
                    const last = s.lastLogin ? new Date(s.lastLogin.seconds*1000).toLocaleDateString() : '-';
                    
                    let barColor = pct===100 ? 'bg-green-500' : (pct<50 ? 'bg-red-400' : 'bg-indigo-500');

                    tb.innerHTML += `
                        <tr class="border-b border-slate-50">
                            <td class="p-4">
                                <div class="font-bold text-slate-800">${name}</div>
                                <div class="text-[10px] text-slate-400 uppercase">${last}</div>
                            </td>
                            <td class="p-4">
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-2 bg-slate-100 rounded-full w-20 overflow-hidden"><div class="${barColor} h-full" style="width:${pct}%"></div></div>
                                    <span class="text-xs font-bold text-slate-500">${pct}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                // HW List
                const hl = document.getElementById('list-admin-hw');
                hl.innerHTML = '';
                app.homeworks.forEach(hw => {
                    hl.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <div><span class="text-xs font-bold bg-white px-2 py-1 rounded text-indigo-500 mr-2 border border-slate-100">${hw.subject}</span><span class="font-bold text-sm text-slate-700">${hw.title}</span></div>
                            <button onclick="app.delHw('${hw.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                });
            }
        };

        // --- 啟動監聽 ---
        auth.onAuthStateChanged(user => {
            if(user) app.handleLoginSuccess(user);
            else app.showPage('page-login');
        });

        // 登入頁按鈕切換
        document.getElementById('btn-toggle-email').onclick = () => {
            document.getElementById('form-auth').classList.remove('hidden');
            document.getElementById('form-auth').classList.add('fade-in');
            document.getElementById('btn-toggle-email').classList.add('hidden');
        };

        lucide.createIcons();
    </script>
</body>
</html>

